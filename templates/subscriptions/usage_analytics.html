{% extends 'base/base.html' %}
{% load static %}

{% block title %}Usage Analytics - {{ block.super }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/subscriptions.css' %}">
<style>
    .analytics-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 10px;
    }
    .usage-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #007bff;
    }
    .usage-percentage {
        height: 12px;
        background: #e9ecef;
        border-radius: 6px;
        overflow: hidden;
    }
    .usage-bar {
        height: 100%;
        border-radius: 6px;
        transition: width 0.6s ease-in-out;
    }
    .usage-bar.low { background: linear-gradient(90deg, #28a745, #34ce57); }
    .usage-bar.medium { background: linear-gradient(90deg, #ffc107, #ffda45); }
    .usage-bar.high { background: linear-gradient(90deg, #fd7e14, #ff922b); }
    .usage-bar.critical { background: linear-gradient(90deg, #dc3545, #e74c3c); }
    
    .metric-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
    }
    .metric-icon.orders { background: linear-gradient(135deg, #007bff, #0056b3); }
    .metric-icon.customers { background: linear-gradient(135deg, #28a745, #1e7e34); }
    .metric-icon.storage { background: linear-gradient(135deg, #ffc107, #e0a800); }
    .metric-icon.api { background: linear-gradient(135deg, #6f42c1, #5a32a3); }
    
    .usage-table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn-analytics {
        border-radius: 25px;
        padding: 0.5rem 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Analytics Header -->
    <div class="analytics-header text-center">
        <div class="container">
            <h1><i class="fas fa-chart-line me-2"></i>Usage Analytics</h1>
            <p class="lead mb-0">Monitor your subscription usage for {{ current_month }}</p>
        </div>
    </div>

    <!-- Usage Summary Cards -->
    <div class="row">
        {% for key, data in usage_summary.items %}
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="usage-card h-100">
                <div class="d-flex align-items-center mb-3">
                    <div class="metric-icon {{ key }} me-3">
                        {% if key == 'orders' %}
                            <i class="fas fa-shopping-cart"></i>
                        {% elif key == 'customers' %}
                            <i class="fas fa-users"></i>
                        {% elif key == 'storage' %}
                            <i class="fas fa-database"></i>
                        {% elif key == 'api_calls' %}
                            <i class="fas fa-exchange-alt"></i>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="text-muted mb-0">{{ key|title|cut:"_" }} Used</h6>
                        <h4 class="mb-0">{{ data.used|floatformat:0 }}</h4>
                    </div>
                </div>
                
                <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted">
                            {% if data.limit %}
                                {{ data.used|floatformat:0 }} of {{ data.limit|floatformat:0 }}
                                {% if key == 'storage' %}MB{% elif key == 'api_calls' %}calls{% endif %}
                            {% else %}
                                {{ data.used|floatformat:0 }} used
                            {% endif %}
                        </small>
                        <small class="fw-bold 
                            {% if data.percentage <= 50 %}text-success
                            {% elif data.percentage <= 75 %}text-warning
                            {% elif data.percentage <= 90 %}text-danger
                            {% else %}text-danger
                            {% endif %}">
                            {{ data.percentage|floatformat:1 }}%
                        </small>
                    </div>
                    <div class="usage-percentage">
                        <div class="usage-bar 
                            {% if data.percentage <= 50 %}low
                            {% elif data.percentage <= 75 %}medium
                            {% elif data.percentage <= 90 %}high
                            {% else %}critical
                            {% endif %}" 
                            style="width: {{ data.percentage }}%">
                        </div>
                    </div>
                </div>
                
                {% if data.percentage > 80 %}
                    <div class="alert alert-warning alert-sm py-1 px-2 mb-0">
                        <small><i class="fas fa-exclamation-triangle me-1"></i>Approaching limit</small>
                    </div>
                {% elif data.percentage >= 100 %}
                    <div class="alert alert-danger alert-sm py-1 px-2 mb-0">
                        <small><i class="fas fa-times-circle me-1"></i>Limit reached</small>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Subscription Plan Info -->
    {% if subscription %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="usage-card">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-2">
                            <i class="fas fa-crown text-warning me-2"></i>
                            Current Plan: {{ subscription.plan.name }}
                        </h5>
                        <p class="text-muted mb-2">{{ subscription.plan.description }}</p>
                        <div class="row">
                            <div class="col-sm-3">
                                <small class="text-muted">Max Services:</small>
                                <p class="mb-0 fw-bold">{{ subscription.plan.max_services|default:"Unlimited" }}</p>
                            </div>
                            <div class="col-sm-3">
                                <small class="text-muted">Max Customers:</small>
                                <p class="mb-0 fw-bold">{{ subscription.plan.max_customers|default:"Unlimited" }}</p>
                            </div>
                            <div class="col-sm-3">
                                <small class="text-muted">Max Employees:</small>
                                <p class="mb-0 fw-bold">{{ subscription.plan.max_employees|default:"Unlimited" }}</p>
                            </div>
                            <div class="col-sm-3">
                                <small class="text-muted">Storage Limit:</small>
                                <p class="mb-0 fw-bold">{{ subscription.plan.storage_limit|default:"Unlimited" }}{% if subscription.plan.storage_limit %}MB{% endif %}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <h3 class="text-primary mb-2">KES {{ subscription.amount }}</h3>
                        <p class="text-muted mb-3">per {{ subscription.plan.duration_months }} month{{ subscription.plan.duration_months|pluralize }}</p>
                        <a href="{% url 'subscriptions:upgrade' %}" class="btn btn-primary btn-analytics">
                            <i class="fas fa-arrow-up me-2"></i>Upgrade Plan
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Usage History -->
    {% if usage_metrics %}
    <div class="row">
        <div class="col-12">
            <div class="usage-card">
                <h5 class="mb-3">
                    <i class="fas fa-history me-2"></i>
                    Recent Usage History (Last 30 Days)
                </h5>
                <div class="usage-table">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Services</th>
                                    <th>Customers</th>
                                    <th>Storage (MB)</th>
                                    <th>API Calls</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for metric in usage_metrics %}
                                <tr>
                                    <td>{{ metric.created_at|date:"M d, Y" }}</td>
                                    <td>{{ metric.services_completed|default:0 }}</td>
                                    <td>{{ metric.customers_added|default:0 }}</td>
                                    <td>{{ metric.storage_used|default:0 }}</td>
                                    <td>{{ metric.api_calls|default:0 }}</td>
                                    <td>
                                        <span class="badge bg-success">Normal</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row">
        <div class="col-12">
            <div class="usage-card text-center py-5">
                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No Usage Data Available</h5>
                <p class="text-muted">Usage analytics will appear here once you start using the service.</p>
                <a href="{% url 'subscriptions:manage_subscription' %}" class="btn btn-primary btn-analytics">
                    <i class="fas fa-arrow-left me-2"></i>Back to Subscription
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <a href="{% url 'subscriptions:manage_subscription' %}" class="btn btn-outline-secondary btn-analytics me-2">
                <i class="fas fa-arrow-left me-2"></i>Back to Subscription
            </a>
            <a href="#" class="btn btn-outline-primary btn-analytics me-2" onclick="exportUsageData()">
                <i class="fas fa-download me-2"></i>Export Data
            </a>
            <a href="#" class="btn btn-outline-info btn-analytics" onclick="refreshUsageData()">
                <i class="fas fa-sync-alt me-2"></i>Refresh Data
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/subscriptions.js' %}"></script>
<script>
// Animate usage bars on page load
document.addEventListener('DOMContentLoaded', function() {
    const bars = document.querySelectorAll('.usage-bar');
    bars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.width = width;
        }, 100);
    });
});

function exportUsageData() {
    // Implementation for exporting usage data
    alert('Export functionality would be implemented here.');
}

function refreshUsageData() {
    // Implementation for refreshing usage data
    alert('Refreshing usage data...');
    location.reload();
}
</script>
{% endblock %}
