{% extends 'base/base.html' %}
{% load static %}

{% block title %}All Expenses{% endblock %}

{% block extra_css %}
<style>
    .expense-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        border: 1px solid #e3e6f0;
        margin-bottom: 1.5rem;
    }
    
    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-pending { background: #fff3cd; color: #856404; }
    .status-approved { background: #d4edda; color: #155724; }
    .status-rejected { background: #f8d7da; color: #721c24; }
    .status-paid { background: #d1ecf1; color: #0c5460; }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }
    
    .table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(0,123,255,.05);
    }
    
    .btn-group-sm .btn {
        font-size: 0.75rem;
    }
</style>
{% endblock %}

{% block page_title %}
    <h1 class="h3 mb-0 text-gray-800">
        <i class="fas fa-list me-2"></i>All Expenses
    </h1>
{% endblock %}

{% block content %}
<!-- Action Buttons -->
<div class="action-buttons">
    <a href="/business/{{ request.tenant.slug }}/expenses/create/" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>
        {% if user_role == 'attendant' %}Record Expense{% else %}Add Expense{% endif %}
    </a>
    
    {% if user_role and user_role in 'owner,manager,supervisor' %}
    <a href="/business/{{ request.tenant.slug }}/expenses/approvals/" class="btn btn-warning">
        <i class="fas fa-check-circle me-2"></i>Pending Approvals
    </a>
    
    <a href="/business/{{ request.tenant.slug }}/expenses/categories/" class="btn btn-info">
        <i class="fas fa-tags me-2"></i>Categories
    </a>
    
    <a href="/business/{{ request.tenant.slug }}/expenses/vendors/" class="btn btn-secondary">
        <i class="fas fa-truck me-2"></i>Vendors
    </a>
    {% endif %}
    
    {% if user_role == 'attendant' %}
    <a href="/business/{{ request.tenant.slug }}/expenses/my-expenses/" class="btn btn-info">
        <i class="fas fa-user-check me-2"></i>My Expenses
    </a>
    {% endif %}
    
    <a href="/business/{{ request.tenant.slug }}/expenses/" class="btn btn-outline-secondary">
        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
    </a>
</div>

<!-- Expenses List -->
<div class="expense-card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0">Expense Records</h5>
        <small class="text-muted">
            {% if expenses %}
            Showing {{ expenses.paginator.count }} expenses
            {% else %}
            No expenses found
            {% endif %}
        </small>
    </div>
    
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Title</th>
                    <th>Category</th>
                    <th>Vendor</th>
                    <th>Amount</th>
                    <th>Status</th>
                    {% if user_role and user_role in 'owner,manager,supervisor' %}
                    <th>Submitted By</th>
                    {% endif %}
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if expenses %}
                {% for expense in expenses %}
                <tr>
                    <td>{{ expense.expense_date|date:"M d, Y" }}</td>
                    <td>
                        <a href="/business/{{ request.tenant.slug }}/expenses/{{ expense.pk }}/" class="text-decoration-none">
                            {{ expense.title|truncatechars:40 }}
                        </a>
                        {% if expense.description %}
                        <br><small class="text-muted">{{ expense.description|truncatechars:50 }}</small>
                        {% endif %}
                    </td>
                    <td>{{ expense.category.name }}</td>
                    <td>{{ expense.vendor.name|default:"-" }}</td>
                    <td>
                        <strong>KSh {{ expense.total_amount|floatformat:2 }}</strong>
                        {% if expense.tax_amount > 0 %}
                        <br><small class="text-muted">+KSh {{ expense.tax_amount|floatformat:2 }} tax</small>
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-badge status-{{ expense.status }}">
                            {{ expense.get_status_display }}
                        </span>
                    </td>
                    {% if user_role and user_role in 'owner,manager,supervisor' %}
                    <td>
                        {% if expense.created_by_user_id %}
                        <small class="text-muted">{{ expense.creator_name }}</small>
                        {% else %}
                        <small class="text-muted">System</small>
                        {% endif %}
                    </td>
                    {% endif %}
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="/business/{{ request.tenant.slug }}/expenses/{{ expense.pk }}/" 
                               class="btn btn-outline-primary" title="View Details">
                                <i class="fas fa-eye"></i>
                            </a>
                            
                            {% if user_role and user_role in 'owner,manager,supervisor' %}
                                {% if expense.status == 'pending' %}
                                <!-- Show approval buttons for all pending expenses -->
                                <form method="post" action="/business/{{ request.tenant.slug }}/expenses/{{ expense.pk }}/approve/" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success" title="Approve" 
                                            onclick="return confirm('Approve this expense?')">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </form>
                                <form method="post" action="/business/{{ request.tenant.slug }}/expenses/{{ expense.pk }}/reject/" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-danger" title="Reject"
                                            onclick="return confirm('Reject this expense?')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </form>
                                {% endif %}
                                <a href="/business/{{ request.tenant.slug }}/expenses/{{ expense.pk }}/edit/" 
                                   class="btn btn-outline-secondary" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                
                                <!-- Delete Button for Owners and Managers -->
                                {% if user_role == 'owner' and expense.status != 'paid' %}
                                <a href="/business/{{ request.tenant.slug }}/expenses/{{ expense.pk }}/delete/confirm/" 
                                   class="btn btn-outline-danger" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </a>
                                {% elif user_role in 'manager,supervisor' and expense.status in 'pending,rejected' %}
                                <a href="/business/{{ request.tenant.slug }}/expenses/{{ expense.pk }}/delete/confirm/" 
                                   class="btn btn-outline-danger" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </a>
                                {% endif %}
                            {% elif user_role == 'attendant' and expense.created_by_user_id == user.id %}
                                {% if expense.status == 'pending' %}
                                <a href="/business/{{ request.tenant.slug }}/expenses/{{ expense.pk }}/edit/" 
                                   class="btn btn-outline-secondary" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                
                                <a href="/business/{{ request.tenant.slug }}/expenses/{{ expense.pk }}/delete/confirm/" 
                                   class="btn btn-outline-danger" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </a>
                                {% endif %}
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="{% if user_role and user_role in 'owner,manager,supervisor' %}8{% else %}7{% endif %}" class="text-center py-5">
                        <i class="fas fa-receipt fa-4x text-muted mb-3 d-block"></i>
                        <h5 class="text-muted">No Expenses Found</h5>
                        <p class="text-muted">There are no expense records to display.</p>
                        <a href="/business/{{ request.tenant.slug }}/expenses/create/" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>
                            {% if user_role == 'attendant' %}Record First Expense{% else %}Add First Expense{% endif %}
                        </a>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if expenses.has_other_pages %}
    <nav aria-label="Expense pagination" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if expenses.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ expenses.previous_page_number }}">
                    <i class="fas fa-chevron-left"></i> Previous
                </a>
            </li>
            {% endif %}
            
            {% for num in expenses.paginator.page_range %}
            {% if expenses.number == num %}
            <li class="page-item active">
                <span class="page-link">{{ num }}</span>
            </li>
            {% elif num > expenses.number|add:'-3' and num < expenses.number|add:'3' %}
            <li class="page-item">
                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
            {% endif %}
            {% endfor %}
            
            {% if expenses.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ expenses.next_page_number }}">
                    Next <i class="fas fa-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}
