{% extends 'base/base.html' %}
{% load static %}

{% block title %}Expense Details - {{ expense.title }}{% endblock %}

{% block extra_css %}
<style>
    .expense-detail-card {
        background: white;
        border-radius: 12px;
        padding: 32px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        border: 1px solid #e3e6f0;
        margin-bottom: 1.5rem;
    }
    
    .status-badge {
        padding: 6px 16px;
        border-radius: 25px;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-pending { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    .status-approved { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status-rejected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .status-paid { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .info-item {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #007bff;
    }
    
    .info-label {
        font-size: 0.875rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }
    
    .info-value {
        font-size: 1.125rem;
        font-weight: 600;
        color: #212529;
    }
    
    .amount-highlight {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .amount-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 2rem;
    }
    
    .approval-section {
        background: #e7f3ff;
        border: 1px solid #b8daff;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 1.5rem;
    }
    
    .approval-pending {
        background: #fff3cd;
        border-color: #ffeaa7;
    }
    
    .approval-rejected {
        background: #f8d7da;
        border-color: #f5c6cb;
    }
    
    .breadcrumb-nav {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }
</style>
{% endblock %}

{% block page_title %}
    <div class="d-flex justify-content-between align-items-center">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-receipt me-2"></i>Expense Details
        </h1>
        <span class="status-badge status-{{ expense.status }}">
            {{ expense.get_status_display }}
        </span>
    </div>
{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<div class="breadcrumb-nav">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
                <a href="/business/{{ request.tenant.slug }}/expenses/">
                    <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="/business/{{ request.tenant.slug }}/expenses/list/">All Expenses</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">{{ expense.title|truncatechars:30 }}</li>
        </ol>
    </nav>
</div>

<!-- Main Expense Details -->
<div class="expense-detail-card">
    <!-- Amount Highlight -->
    <div class="amount-highlight">
        <div class="amount-value">KSh {{ expense.total_amount|floatformat:2 }}</div>
        <div>
            {% if expense.tax_amount > 0 %}
            Amount: KSh {{ expense.amount|floatformat:2 }} + Tax: KSh {{ expense.tax_amount|floatformat:2 }}
            {% else %}
            Total Expense Amount
            {% endif %}
        </div>
    </div>
    
    <!-- Basic Information -->
    <div class="info-grid">
        <div class="info-item">
            <div class="info-label">Expense Title</div>
            <div class="info-value">{{ expense.title }}</div>
        </div>
        
        <div class="info-item">
            <div class="info-label">Category</div>
            <div class="info-value">{{ expense.category.name }}</div>
        </div>
        
        <div class="info-item">
            <div class="info-label">Expense Date</div>
            <div class="info-value">{{ expense.expense_date|date:"F d, Y" }}</div>
        </div>
        
        <div class="info-item">
            <div class="info-label">Payment Method</div>
            <div class="info-value">{{ expense.get_payment_method_display }}</div>
        </div>
        
        {% if expense.vendor %}
        <div class="info-item">
            <div class="info-label">Vendor/Supplier</div>
            <div class="info-value">{{ expense.vendor.name }}</div>
        </div>
        {% endif %}
        
        {% if expense.reference_number %}
        <div class="info-item">
            <div class="info-label">Reference Number</div>
            <div class="info-value">{{ expense.reference_number }}</div>
        </div>
        {% endif %}
        
        {% if expense.receipt_number %}
        <div class="info-item">
            <div class="info-label">Receipt Number</div>
            <div class="info-value">{{ expense.receipt_number }}</div>
        </div>
        {% endif %}
        
        <div class="info-item">
            <div class="info-label">Expense Type</div>
            <div class="info-value">{{ expense.get_expense_type_display }}</div>
        </div>
        
        <div class="info-item">
            <div class="info-label">Created Date</div>
            <div class="info-value">{{ expense.created_at|date:"F d, Y H:i" }}</div>
        </div>
        
        {% if expense.created_by_user_id %}
        <div class="info-item">
            <div class="info-label">Submitted By</div>
            <div class="info-value">{{ expense.creator_name|default:"Unknown User" }}</div>
        </div>
        {% endif %}
    </div>
    
    <!-- Description -->
    {% if expense.description %}
    <div class="mb-4">
        <h6 class="text-muted text-uppercase mb-2">Description</h6>
        <p class="lead">{{ expense.description }}</p>
    </div>
    {% endif %}
    
    <!-- Notes -->
    {% if expense.notes %}
    <div class="mb-4">
        <h6 class="text-muted text-uppercase mb-2">Additional Notes</h6>
        <div class="bg-light p-3 rounded">
            {{ expense.notes|linebreaks }}
        </div>
    </div>
    {% endif %}
    
    <!-- Approval Status Section -->
    {% if expense.status == 'pending' %}
    <div class="approval-section approval-pending">
        <h6 class="mb-3">
            <i class="fas fa-clock me-2"></i>Pending Approval
        </h6>
        <p class="mb-0">This expense is waiting for management approval.</p>
    </div>
    {% elif expense.status == 'approved' and expense.approved_by_user_id %}
    <div class="approval-section">
        <h6 class="mb-3">
            <i class="fas fa-check-circle me-2"></i>Approved
        </h6>
        <p class="mb-0">
            {% if approver_name %}
                Approved by <strong>{{ approver_name }}</strong>
                {% if expense.approved_at %}
                    on {{ expense.approved_at|date:"F d, Y H:i" }}
                {% endif %}
            {% else %}
                Approved 
                {% if expense.approved_at %}
                    on {{ expense.approved_at|date:"F d, Y H:i" }}
                {% endif %}
            {% endif %}
        </p>
    </div>
    {% elif expense.status == 'rejected' %}
    <div class="approval-section approval-rejected">
        <h6 class="mb-3">
            <i class="fas fa-times-circle me-2"></i>Rejected
        </h6>
        <p class="mb-0">This expense has been rejected by management.</p>
    </div>
    {% endif %}
    
    <!-- Action Buttons -->
    <div class="action-buttons">
        <!-- Admin Actions -->
        {% if user_role and user_role in 'owner,manager,supervisor' %}
            {% if expense.status == 'pending' %}
            <!-- Show approval buttons for all pending expenses -->
            <form method="post" action="/business/{{ request.tenant.slug }}/expenses/{{ expense.pk }}/approve/" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-success" onclick="return confirm('Approve this expense?')">
                    <i class="fas fa-check me-2"></i>Approve Expense
                </button>
            </form>
            
            <form method="post" action="/business/{{ request.tenant.slug }}/expenses/{{ expense.pk }}/reject/" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger" onclick="return confirm('Reject this expense?')">
                    <i class="fas fa-times me-2"></i>Reject Expense
                </button>
            </form>
            {% endif %}
            
            <a href="/business/{{ request.tenant.slug }}/expenses/{{ expense.pk }}/edit/" class="btn btn-warning">
                <i class="fas fa-edit me-2"></i>Edit Expense
            </a>
            
            <!-- Delete Button for Owners and Managers -->
            {% if user_role == 'owner' and expense.status != 'paid' %}
            <a href="/business/{{ request.tenant.slug }}/expenses/{{ expense.pk }}/delete/confirm/" class="btn btn-danger">
                <i class="fas fa-trash me-2"></i>Delete Expense
            </a>
            {% elif user_role in 'manager,supervisor' and expense.status in 'pending,rejected' %}
            <a href="/business/{{ request.tenant.slug }}/expenses/{{ expense.pk }}/delete/confirm/" class="btn btn-danger">
                <i class="fas fa-trash me-2"></i>Delete Expense
            </a>
            {% endif %}
        {% endif %}
        
        <!-- Attendant Actions (only for their own expenses) -->
        {% if user_role == 'attendant' and expense.created_by_user_id == user.id %}
            {% if expense.status == 'pending' %}
            <a href="/business/{{ request.tenant.slug }}/expenses/{{ expense.pk }}/edit/" class="btn btn-warning">
                <i class="fas fa-edit me-2"></i>Edit Expense
            </a>
            
            <a href="/business/{{ request.tenant.slug }}/expenses/{{ expense.pk }}/delete/confirm/" class="btn btn-danger">
                <i class="fas fa-trash me-2"></i>Delete Expense
            </a>
            {% endif %}
        {% endif %}
        
        <!-- Common Actions -->
        <a href="/business/{{ request.tenant.slug }}/expenses/list/" class="btn btn-outline-secondary">
            <i class="fas fa-list me-2"></i>Back to List
        </a>
        
        <a href="/business/{{ request.tenant.slug }}/expenses/" class="btn btn-outline-primary">
            <i class="fas fa-tachometer-alt me-2"></i>Dashboard
        </a>
        
        {% if user_role == 'attendant' %}
        <a href="/business/{{ request.tenant.slug }}/expenses/my-expenses/" class="btn btn-outline-info">
            <i class="fas fa-user-check me-2"></i>My Expenses
        </a>
        {% endif %}
    </div>
</div>
{% endblock %}
