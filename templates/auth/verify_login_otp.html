{% extends 'base/base.html' %}
{% load static %}

{% block title %}Verify Login Code - Autowash{% endblock %}

{% block public_content %}
<section class="auth-section min-vh-100 d-flex align-items-center">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-5 col-md-7">
                <div class="auth-card" data-aos="fade-up">
                    <div class="auth-header text-center">
                        <div class="auth-brand mb-3">
                            <span class="brand-text">AUTOWASH</span>
                        </div>
                        <h2 class="auth-title">Verify Login Code</h2>
                        <p class="auth-subtitle">Enter the 6-digit code sent to your email</p>
                    </div>

                    <div class="auth-body">
                        <!-- Email Display -->
                        <div class="alert alert-info text-center mb-4">
                            <strong>Code sent to:</strong><br>
                            <code>{{ email }}</code>
                        </div>

                        {% if messages %}
                            {% for message in messages %}
                                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" title="Close alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}

                        <!-- OTP Verification Form -->
                        <form method="post" id="otpForm">
                            {% csrf_token %}
                            <input type="hidden" name="email" value="{{ email }}">
                            
                            <div class="form-group">
                                <label for="otp_code" class="form-label">Verification Code</label>
                                <div class="otp-inputs d-flex justify-content-center gap-2 mb-3">
                                    <input type="text" class="form-control otp-input text-center" maxlength="1" data-index="0" title="Enter first digit" style="width: 50px; height: 50px; font-size: 24px; font-weight: 600;">
                                    <input type="text" class="form-control otp-input text-center" maxlength="1" data-index="1" title="Enter second digit" style="width: 50px; height: 50px; font-size: 24px; font-weight: 600;">
                                    <input type="text" class="form-control otp-input text-center" maxlength="1" data-index="2" title="Enter third digit" style="width: 50px; height: 50px; font-size: 24px; font-weight: 600;">
                                    <input type="text" class="form-control otp-input text-center" maxlength="1" data-index="3" title="Enter fourth digit" style="width: 50px; height: 50px; font-size: 24px; font-weight: 600;">
                                    <input type="text" class="form-control otp-input text-center" maxlength="1" data-index="4" title="Enter fifth digit" style="width: 50px; height: 50px; font-size: 24px; font-weight: 600;">
                                    <input type="text" class="form-control otp-input text-center" maxlength="1" data-index="5" title="Enter sixth digit" style="width: 50px; height: 50px; font-size: 24px; font-weight: 600;">
                                </div>
                                <input type="hidden" name="otp_code" id="otpCode">
                            </div>

                            <div class="text-center mb-3">
                                <small class="text-muted" id="timer">Code expires in <span id="timeLeft">10:00</span></small>
                            </div>

                            <button type="submit" class="btn btn-auth btn-purple mb-3 w-100" id="verifyBtn" disabled>
                                <i class="fas fa-check me-2"></i>Verify & Sign In
                            </button>
                        </form>

                        <!-- Resend Code -->
                        <button type="button" class="btn btn-outline-secondary w-100 mb-3" id="resendBtn">
                            <i class="fas fa-sync me-2"></i>Resend Code
                        </button>

                        <!-- Alternative Options -->
                        <div class="position-relative text-center mb-3">
                            <hr class="my-0">
                            <span class="auth-divider-text">or</span>
                        </div>

                        <div class="text-center">
                            <a href="{% url 'accounts:email_login' %}" class="text-decoration-none me-3">‚Üê Change email</a>
                            <a href="{% url 'accounts:login' %}" class="text-decoration-none">Sign in with password</a>
                        </div>
                    </div>
                </div>

                <!-- Help Link -->
                <div class="text-center mt-4">
                    <p class="text-muted">
                        Need help? <a href="https://autowash.co.ke" target="_blank" rel="noopener" class="text-decoration-none">Contact Support</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // OTP Input handling
    const otpInputs = document.querySelectorAll('.otp-input');
    const otpCodeInput = document.getElementById('otpCode');
    const verifyBtn = document.getElementById('verifyBtn');
    const resendBtn = document.getElementById('resendBtn');
    const form = document.getElementById('otpForm');

    // Focus management and auto-advance
    otpInputs.forEach((input, index) => {
        input.addEventListener('input', function(e) {
            const value = e.target.value.replace(/[^0-9]/g, '');
            e.target.value = value;
            
            if (value && index < otpInputs.length - 1) {
                otpInputs[index + 1].focus();
            }
            
            updateOTPCode();
            updateInputStyles();
        });
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                otpInputs[index - 1].focus();
            }
            
            if (e.key === 'ArrowLeft' && index > 0) {
                otpInputs[index - 1].focus();
            }
            
            if (e.key === 'ArrowRight' && index < otpInputs.length - 1) {
                otpInputs[index + 1].focus();
            }
        });
        
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '').slice(0, 6);
            
            for (let i = 0; i < pastedData.length && i < otpInputs.length; i++) {
                otpInputs[i].value = pastedData[i];
            }
            
            updateOTPCode();
            updateInputStyles();
            
            if (pastedData.length === 6) {
                setTimeout(() => form.submit(), 300);
            }
        });
    });

    function updateOTPCode() {
        const code = Array.from(otpInputs).map(input => input.value).join('');
        otpCodeInput.value = code;
        verifyBtn.disabled = code.length !== 6;
    }

    function updateInputStyles() {
        otpInputs.forEach(input => {
            if (input.value) {
                input.classList.add('is-valid');
                input.classList.remove('is-invalid');
            } else {
                input.classList.remove('is-valid', 'is-invalid');
            }
        });
    }

    // Auto-submit when all digits are entered
    form.addEventListener('input', function() {
        const code = otpCodeInput.value;
        if (code.length === 6) {
            setTimeout(() => {
                form.submit();
            }, 300);
        }
    });

    // Form submission
    form.addEventListener('submit', function(e) {
        const originalText = verifyBtn.innerHTML;
        verifyBtn.disabled = true;
        verifyBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Verifying...';
        
        // Re-enable button after 5 seconds in case of issues
        setTimeout(() => {
            verifyBtn.disabled = false;
            verifyBtn.innerHTML = originalText;
        }, 5000);
    });

    // Resend functionality
    resendBtn.addEventListener('click', function() {
        const originalText = resendBtn.innerHTML;
        resendBtn.disabled = true;
        resendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
        
        fetch('{% url "accounts:resend_login_otp" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                email: '{{ email }}'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                const alert = document.createElement('div');
                alert.className = 'alert alert-success alert-dismissible fade show';
                alert.innerHTML = `
                    New verification code sent!
                    <button type="button" class="btn-close" data-bs-dismiss="alert" title="Close"></button>
                `;
                form.parentNode.insertBefore(alert, form);
                
                // Clear inputs
                otpInputs.forEach(input => {
                    input.value = '';
                    input.classList.remove('is-valid', 'is-invalid');
                });
                updateOTPCode();
                
                // Reset timer
                startTimer(600); // 10 minutes
                
                // Remove alert after 3 seconds
                setTimeout(() => alert.remove(), 3000);
            } else {
                // Show error message
                const alert = document.createElement('div');
                alert.className = 'alert alert-danger alert-dismissible fade show';
                alert.innerHTML = `
                    ${data.message || 'Failed to send code. Please try again.'}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" title="Close"></button>
                `;
                form.parentNode.insertBefore(alert, form);
                
                setTimeout(() => alert.remove(), 5000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show';
            alert.innerHTML = `
                Network error. Please try again.
                <button type="button" class="btn-close" data-bs-dismiss="alert" title="Close"></button>
            `;
            form.parentNode.insertBefore(alert, form);
            
            setTimeout(() => alert.remove(), 5000);
        })
        .finally(() => {
            resendBtn.disabled = false;
            resendBtn.innerHTML = originalText;
        });
    });

    // Timer functionality
    let timeLeft = 600; // 10 minutes in seconds

    function startTimer(duration) {
        timeLeft = duration;
        updateTimerDisplay();
        
        const timer = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                // Show expired message
                const alert = document.createElement('div');
                alert.className = 'alert alert-warning';
                alert.textContent = 'Verification code has expired. Please request a new one.';
                form.parentNode.insertBefore(alert, form);
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        const timeDisplay = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        document.getElementById('timeLeft').textContent = timeDisplay;
        
        const timerElement = document.getElementById('timer');
        if (timeLeft <= 60) {
            timerElement.classList.add('text-danger');
        } else {
            timerElement.classList.remove('text-danger');
        }
    }

    // Start the timer
    startTimer(600);

    // Focus first input on load
    otpInputs[0].focus();
});
</script>
{% endblock %}
