{% extends 'base/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
/* Quick Order Styles */
.quick-order-container {
    max-width: 1000px;
    margin: 0 auto;
}

.quick-order-header {
    background: linear-gradient(135deg, var(--success-600), var(--success-500));
    color: white;
    border-radius: var(--radius-lg);
    padding: 2rem;
    margin-bottom: 2rem;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.quick-order-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 100px;
    height: 100px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    animation: float 6s ease-in-out infinite;
}

.quick-order-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
}

.quick-order-subtitle {
    font-size: 1.125rem;
    opacity: 0.9;
    margin: 0;
}

.form-section {
    background: white;
    border-radius: var(--radius-lg);
    padding: 2rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-200);
}

.section-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--gray-100);
}

.section-icon {
    width: 32px;
    height: 32px;
    background: var(--primary-100);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-600);
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0;
}

.service-selection {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.service-option {
    border: 2px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    transition: all var(--transition-fast);
    cursor: pointer;
    position: relative;
    background: white;
}

.service-option:hover {
    border-color: var(--primary-300);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

.service-option.selected {
    border-color: var(--primary-500);
    background: var(--primary-50);
    box-shadow: var(--shadow-lg);
}

.service-checkbox {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 20px;
    height: 20px;
}

.service-info {
    margin-bottom: 1rem;
}

.service-name {
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 0.5rem;
}

.service-description {
    color: var(--gray-600);
    font-size: 0.875rem;
    line-height: 1.4;
    margin-bottom: 0.75rem;
}

.service-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.875rem;
}

.service-duration {
    color: var(--gray-500);
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.service-price {
    font-weight: 700;
    color: var(--primary-600);
    font-size: 1rem;
}

.order-summary {
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-top: 2rem;
    position: sticky;
    top: 2rem;
}

.summary-header {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.summary-items {
    margin-bottom: 1rem;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--gray-200);
}

.summary-item:last-child {
    border-bottom: none;
    font-weight: 600;
    font-size: 1.125rem;
    color: var(--gray-900);
    margin-top: 0.5rem;
    padding-top: 1rem;
    border-top: 2px solid var(--gray-300);
}

.item-name {
    color: var(--gray-700);
}

.item-price {
    color: var(--gray-900);
    font-weight: 500;
}

.form-actions {
    background: white;
    border-radius: var(--radius-lg);
    padding: 2rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-200);
    margin-top: 2rem;
    text-align: center;
}

.submit-btn {
    background: linear-gradient(135deg, var(--success-600), var(--success-500));
    border: none;
    color: white;
    font-size: 1.125rem;
    font-weight: 600;
    padding: 1rem 2rem;
    border-radius: var(--radius-lg);
    transition: all var(--transition-fast);
    box-shadow: var(--shadow-md);
}

.submit-btn:hover {
    background: linear-gradient(135deg, var(--success-700), var(--success-600));
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    color: white;
}

.submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* Responsive Design */
@media (max-width: 768px) {
    .quick-order-container {
        margin: 0;
    }
    
    .form-section {
        margin: 0 0 1rem 0;
        padding: 1.5rem;
        border-radius: var(--radius-md);
    }
    
    .service-selection {
        grid-template-columns: 1fr;
        gap: 0.75rem;
    }
    
    .order-summary {
        position: static;
        margin-top: 1rem;
    }
    
    .quick-order-title {
        font-size: 1.5rem;
    }
}

@keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(180deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="quick-order-container">
    <!-- Header -->
    <div class="quick-order-header">
        <h1 class="quick-order-title">
            <i class="fas fa-bolt"></i>
            Quick Order
        </h1>
        <p class="quick-order-subtitle">Fast service registration for walk-in customers</p>
    </div>

    <form method="post" id="quickOrderForm">
        {% csrf_token %}
        
        <!-- Customer Information -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-user"></i>
                </div>
                <h3 class="section-title">Customer Information</h3>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    {{ form.customer_name|as_crispy_field }}
                </div>
                <div class="col-md-6">
                    {{ form.customer_phone|as_crispy_field }}
                </div>
            </div>
        </div>

        <!-- Vehicle Information -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-car"></i>
                </div>
                <h3 class="section-title">Vehicle Information</h3>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    {{ form.vehicle_registration|as_crispy_field }}
                </div>
                <div class="col-md-4">
                    {{ form.vehicle_make|as_crispy_field }}
                </div>
                <div class="col-md-4">
                    {{ form.vehicle_model|as_crispy_field }}
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    {{ form.vehicle_color|as_crispy_field }}
                </div>
                <div class="col-md-4">
                    {{ form.vehicle_type|as_crispy_field }}
                </div>
                <div class="col-md-4">
                    {{ form.vehicle_year|as_crispy_field }}
                </div>
            </div>
        </div>

        <!-- Service Selection -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-car-wash"></i>
                </div>
                <h3 class="section-title">Select Services</h3>
            </div>
            
            <!-- Popular Services Quick Selection -->
            {% if popular_services %}
            <div class="mb-4">
                <h5 class="mb-3">
                    <i class="fas fa-star text-warning"></i>
                    Popular Services
                </h5>
                <div class="service-selection" id="popularServices">
                    {% for service in popular_services %}
                    <div class="service-option" onclick="toggleService(this, '{{ service.id }}')">
                        <input type="checkbox" 
                               class="service-checkbox" 
                               name="selected_services" 
                               value="{{ service.id }}" 
                               id="service_{{ service.id }}">
                        <div class="service-info">
                            <div class="service-name">{{ service.name }}</div>
                            <div class="service-description">{{ service.description|truncatewords:12 }}</div>
                            <div class="service-details">
                                <div class="service-duration">
                                    <i class="fas fa-clock"></i>
                                    {{ service.estimated_duration }} min
                                </div>
                                <div class="service-price">KES {{ service.base_price }}</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- All Services (Hidden by default) -->
            <div class="mb-3">
                <button type="button" 
                        class="btn btn-outline-primary" 
                        onclick="toggleAllServices()">
                    <i class="fas fa-list" id="allServicesIcon"></i>
                    <span id="allServicesText">Show All Services</span>
                </button>
            </div>
            
            <div id="allServicesSection" style="display: none;">
                {{ form.selected_services|as_crispy_field }}
            </div>
        </div>

        <!-- Order Summary -->
        <div class="row">
            <div class="col-md-8">
                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="submit" class="submit-btn" id="submitBtn" disabled>
                        <i class="fas fa-rocket"></i>
                        Create Quick Order
                        <span id="submitTotal"></span>
                    </button>
                    <div class="mt-3">
                        <a href="/business/{{ request.tenant.slug }}/services/orders/" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i>
                            Back to Orders
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="order-summary" id="orderSummary">
                    <div class="summary-header">
                        <i class="fas fa-receipt"></i>
                        Order Summary
                    </div>
                    <div class="summary-items" id="summaryItems">
                        <div class="text-muted text-center py-3">
                            No services selected
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
let selectedServices = new Map();
let allServicesVisible = false;

// Service data (would be passed from backend)
const serviceData = {
    {% for service in popular_services %}
    '{{ service.id }}': {
        name: '{{ service.name|escapejs }}',
        price: {{ service.base_price }},
        duration: {{ service.estimated_duration }}
    },
    {% endfor %}
};

function toggleService(element, serviceId) {
    const checkbox = element.querySelector('.service-checkbox');
    const isSelected = checkbox.checked;
    
    // Toggle selection
    checkbox.checked = !isSelected;
    element.classList.toggle('selected', !isSelected);
    
    // Update selected services
    if (!isSelected) {
        selectedServices.set(serviceId, serviceData[serviceId]);
    } else {
        selectedServices.delete(serviceId);
    }
    
    updateOrderSummary();
    updateSubmitButton();
}

function updateOrderSummary() {
    const summaryItems = document.getElementById('summaryItems');
    
    if (selectedServices.size === 0) {
        summaryItems.innerHTML = '<div class="text-muted text-center py-3">No services selected</div>';
        return;
    }
    
    let html = '';
    let total = 0;
    
    selectedServices.forEach((service, serviceId) => {
        html += `
            <div class="summary-item">
                <span class="item-name">${service.name}</span>
                <span class="item-price">KES ${service.price}</span>
            </div>
        `;
        total += service.price;
    });
    
    // Add total
    html += `
        <div class="summary-item">
            <span class="item-name">Total</span>
            <span class="item-price">KES ${total}</span>
        </div>
    `;
    
    summaryItems.innerHTML = html;
}

function updateSubmitButton() {
    const submitBtn = document.getElementById('submitBtn');
    const submitTotal = document.getElementById('submitTotal');
    
    if (selectedServices.size === 0) {
        submitBtn.disabled = true;
        submitTotal.textContent = '';
    } else {
        submitBtn.disabled = false;
        const total = Array.from(selectedServices.values()).reduce((sum, service) => sum + service.price, 0);
        submitTotal.textContent = `(KES ${total})`;
    }
}

function toggleAllServices() {
    const section = document.getElementById('allServicesSection');
    const icon = document.getElementById('allServicesIcon');
    const text = document.getElementById('allServicesText');
    
    allServicesVisible = !allServicesVisible;
    
    if (allServicesVisible) {
        section.style.display = 'block';
        icon.className = 'fas fa-eye-slash';
        text.textContent = 'Hide All Services';
    } else {
        section.style.display = 'none';
        icon.className = 'fas fa-list';
        text.textContent = 'Show All Services';
    }
}

// Form validation
document.getElementById('quickOrderForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    
    if (selectedServices.size === 0) {
        e.preventDefault();
        alert('Please select at least one service.');
        return;
    }
    
    // Disable submit button and show loading
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Order...';
});

// Auto-uppercase vehicle registration
document.getElementById('id_vehicle_registration').addEventListener('input', function(e) {
    e.target.value = e.target.value.toUpperCase();
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateOrderSummary();
    updateSubmitButton();
});
</script>
{% endblock %}