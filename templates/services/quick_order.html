<!-- templates/services/quick_order.html -->
{% extends 'base/base.html' %}
{% load static %}

{% block title %}Quick Order - {{ block.super }}{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block extra_css %}
<style>
:root {
    --primary-500: #3b82f6;
    --primary-50: #eff6ff;
    --primary-600: #2563eb;
    --primary-700: #1d4ed8;
    --success-500: #10b981;
    --success-50: #ecfdf5;
    --success-600: #059669;
    --warning-500: #f59e0b;
    --warning-50: #fffbeb;
    --info-500: #06b6d4;
    --info-50: #f0f9ff;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --radius-sm: 0.375rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --transition-fast: 0.15s ease-in-out;
}

.page-header {
    background: linear-gradient(135deg, var(--primary-50), var(--success-50));
    border: 1px solid var(--primary-200);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.page-title {
    margin: 0;
    font-size: 1.875rem;
    font-weight: 700;
    color: var(--gray-900);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.page-description {
    margin: 0.5rem 0 0;
    color: var(--gray-600);
    font-size: 1rem;
}

.page-actions {
    display: flex;
    gap: 0.75rem;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius-md);
    font-weight: 500;
    text-decoration: none;
    border: 1px solid transparent;
    transition: all var(--transition-fast);
    cursor: pointer;
    font-size: 0.875rem;
}

.btn-outline-secondary {
    background: transparent;
    color: var(--gray-600);
    border-color: var(--gray-300);
}

.btn-outline-secondary:hover {
    background: var(--gray-50);
    border-color: var(--gray-500);
    text-decoration: none;
    color: var(--gray-700);
}

.btn-success {
    background: var(--success-500);
    color: white;
    border-color: var(--success-500);
}

.btn-success:hover {
    background: var(--success-600);
    text-decoration: none;
    color: white;
    transform: translateY(-1px);
}

.btn-primary {
    background: var(--primary-500);
    color: white;
    border-color: var(--primary-500);
}

.btn-primary:hover {
    background: var(--primary-600);
    text-decoration: none;
    color: white;
    transform: translateY(-1px);
}

.btn-lg {
    padding: 1rem 2rem;
    font-size: 1rem;
}

.quick-order-container {
    max-width: 1200px;
    margin: 0 auto;
}

.order-progress {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2rem;
    position: relative;
}

.order-progress::before {
    content: '';
    position: absolute;
    top: 1rem;
    left: 2rem;
    right: 2rem;
    height: 2px;
    background: var(--gray-200);
    z-index: 1;
}

.progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: white;
    padding: 0.5rem;
    z-index: 2;
    position: relative;
}

.progress-number {
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    background: var(--gray-200);
    color: var(--gray-600);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    margin-bottom: 0.5rem;
    transition: all var(--transition-fast);
}

.progress-step.active .progress-number {
    background: var(--primary-500);
    color: white;
}

.progress-step.completed .progress-number {
    background: var(--success-500);
    color: white;
}

.progress-label {
    font-size: 0.75rem;
    color: var(--gray-600);
    text-align: center;
}

.step-content {
    display: none;
}

.step-content.active {
    display: block;
}

.form-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    margin-bottom: 2rem;
}

.card-header {
    background: var(--gray-50);
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--gray-200);
}

.card-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--gray-900);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.card-body {
    padding: 1.5rem;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
}

.form-label.required::after {
    content: " *";
    color: #ef4444;
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    transition: all var(--transition-fast);
    background: white;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-control.is-invalid {
    border-color: #ef4444;
}

.form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 16px 12px;
    padding-right: 2.5rem;
    appearance: none;
}

.customer-search-section {
    background: var(--info-50);
    border: 1px solid var(--info-200);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.service-search-section {
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
    padding: 1rem;
}

.global-search-section {
    background: var(--primary-50);
    border: 1px solid var(--primary-200);
    border-radius: var(--radius-md);
    padding: 1rem;
}

.search-input-group {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.search-btn {
    background: var(--primary-500);
    color: white;
    border: none;
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: 0.875rem;
    white-space: nowrap;
}

.search-results {
    margin-top: 1rem;
    max-height: 200px;
    overflow-y: auto;
}

.search-result-item {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.search-result-item:hover {
    background: var(--primary-50);
    border-color: var(--primary-300);
}

.selected-customer,
.selected-vehicle {
    background: var(--success-50);
    border: 1px solid var(--success-200);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-bottom: 1rem;
}

.selection-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.change-btn {
    background: none;
    border: none;
    color: var(--primary-600);
    cursor: pointer;
    font-size: 0.875rem;
    text-decoration: underline;
}

.services-grid,
.inventory-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.service-card,
.inventory-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    cursor: pointer;
    transition: all var(--transition-fast);
    position: relative;
}

.service-card:hover,
.inventory-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
    border-color: var(--primary-300);
}

.service-card.selected,
.inventory-card.selected {
    border-color: var(--primary-500);
    background: var(--primary-50);
}

.service-card.selected::before,
.inventory-card.selected::before {
    content: 'âœ“';
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: var(--primary-500);
    color: white;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
}

.service-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
}

.service-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0;
}

.service-price {
    font-size: 1rem;
    font-weight: 700;
    color: var(--primary-600);
}

.service-description {
    font-size: 0.875rem;
    color: var(--gray-600);
    margin-bottom: 0.75rem;
    line-height: 1.4;
}

.service-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: var(--gray-500);
}

.service-duration {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.service-category {
    background: var(--gray-100);
    color: var(--gray-700);
    padding: 0.125rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.625rem;
    font-weight: 500;
    text-transform: uppercase;
}

.service-type-selector .btn-group {
    border-radius: var(--radius-md);
    overflow: hidden;
}

.service-type-selector .btn {
    border-radius: 0;
    border-color: var(--primary-300);
}

.service-type-selector .btn.active {
    background: var(--primary-500);
    color: white;
    border-color: var(--primary-500);
}

.packages-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.package-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    cursor: pointer;
    transition: all var(--transition-fast);
    position: relative;
    overflow: hidden;
}

.package-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
    border-color: var(--primary-300);
}

.package-card.selected {
    border-color: var(--primary-500);
    background: var(--primary-50);
}

.package-card.selected::before {
    content: 'âœ“';
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: var(--primary-500);
    color: white;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
    z-index: 2;
}

.package-header {
    margin-bottom: 1rem;
}

.package-name {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0 0 0.5rem 0;
}

.package-pricing {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.original-price {
    font-size: 0.875rem;
    color: var(--gray-500);
    text-decoration: line-through;
}

.package-price {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary-600);
}

.savings {
    font-size: 0.75rem;
    color: var(--success-600);
    font-weight: 600;
    background: var(--success-50);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
}

.package-description {
    font-size: 0.875rem;
    color: var(--gray-600);
    margin-bottom: 1rem;
    line-height: 1.4;
}

.package-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: var(--gray-500);
}

.package-duration,
.package-services-count {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.package-badge {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
}

.discount-badge {
    background: var(--warning-500);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
}

.popular-badge {
    top: 0.5rem;
    left: 0.5rem;
}

.popular-label {
    background: var(--success-500);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
}

.order-summary {
    position: sticky;
    top: 2rem;
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    box-shadow: var(--shadow-sm);
}

.summary-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--gray-200);
}

.summary-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0;
}

.summary-content {
    margin-bottom: 1.5rem;
}

.selected-services-list {
    margin-bottom: 1rem;
}

.selected-service-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--gray-100);
}

.selected-service-item:last-child {
    border-bottom: none;
}

.service-item-name {
    font-size: 0.875rem;
    color: var(--gray-900);
}

.service-item-price {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--gray-700);
}

.summary-totals {
    border-top: 2px solid var(--gray-200);
    padding-top: 1rem;
}

.total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.total-row.main {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--gray-900);
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--gray-200);
}

.summary-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.step-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    background: var(--gray-50);
    border-top: 1px solid var(--gray-200);
    margin-top: 2rem;
}

.nav-buttons {
    display: flex;
    gap: 0.75rem;
}

.btn-outline-gray {
    background: transparent;
    color: var(--gray-600);
    border-color: var(--gray-300);
}

.btn-outline-gray:hover {
    background: var(--gray-100);
    border-color: var(--gray-400);
    text-decoration: none;
    color: var(--gray-700);
}

.step-indicator {
    font-size: 0.875rem;
    color: var(--gray-600);
}

.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--gray-500);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.category-filter {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.category-btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-md);
    background: white;
    color: var(--gray-700);
    cursor: pointer;
    font-size: 0.875rem;
    transition: all var(--transition-fast);
}

.category-btn:hover {
    background: var(--gray-50);
    border-color: var(--gray-400);
}

.category-btn.active {
    background: var(--primary-500);
    color: white;
    border-color: var(--primary-500);
}

@media (max-width: 1024px) {
    .quick-order-container {
        padding: 0 1rem;
    }
    
    .order-summary {
        position: static;
        margin-top: 2rem;
    }
}

@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .services-grid,
    .packages-grid {
        grid-template-columns: 1fr;
    }
    
    .search-input-group {
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .search-btn {
        width: 100%;
    }
    
    .order-progress {
        margin-bottom: 1.5rem;
        overflow-x: auto;
        padding-bottom: 0.5rem;
    }
    
    .order-progress::before {
        left: 1rem;
        right: 1rem;
    }
    
    .progress-step {
        padding: 0.25rem;
        min-width: 80px;
    }
    
    .progress-number {
        width: 1.5rem;
        height: 1.5rem;
        font-size: 0.75rem;
    }
    
    .progress-label {
        font-size: 0.625rem;
    }
    
    .service-type-selector .btn-group {
        flex-direction: column;
    }
    
    .service-type-selector .btn {
        border-radius: var(--radius-md) !important;
        margin-bottom: 0.5rem;
    }
    
    .service-type-selector .btn:last-child {
        margin-bottom: 0;
    }
    
    .category-filter {
        justify-content: center;
        overflow-x: auto;
        flex-wrap: nowrap;
        padding-bottom: 0.5rem;
    }
    
    .category-btn {
        font-size: 0.75rem;
        padding: 0.375rem 0.75rem;
        white-space: nowrap;
    }
    
    .step-navigation {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
        margin-bottom: 80px; /* Space for mobile summary */
    }
    
    .nav-buttons {
        justify-content: center;
    }
    
    /* Hide desktop order summary on mobile */
    .order-summary {
        display: none;
    }
    
    /* Show mobile order summary */
    .mobile-order-summary {
        display: block;
    }
    
    /* Show pagination on mobile */
    .pagination-container {
        display: block;
    }
    
    /* Limit items shown per page on mobile */
    .services-grid .service-card:nth-child(n+7),
    .packages-grid .package-card:nth-child(n+5),
    .inventory-grid .inventory-card:nth-child(n+7) {
        display: none;
    }
}

@media (max-width: 576px) {
    .quick-order-container {
        padding: 0 0.5rem;
    }
    
    .form-card {
        margin-bottom: 1rem;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    .page-title {
        font-size: 1.5rem;
    }
    
    .btn {
        padding: 0.625rem 1rem;
        font-size: 0.875rem;
        min-height: 44px; /* Improved tap target */
    }
    
    .service-card,
    .package-card,
    .inventory-card {
        padding: 1rem;
        margin-bottom: 0.75rem;
        min-height: 120px; /* Consistent height */
    }
    
    .category-btn {
        min-height: 40px; /* Better tap targets */
        padding: 0.5rem 1rem;
    }
    
    .pagination-btn {
        min-height: 40px;
        min-width: 40px;
    }
    
    .mobile-order-summary {
        padding: 0.75rem;
    }
    
    .mobile-summary-toggle {
        min-height: 60px; /* Easy to tap */
    }
    
    /* Performance optimizations */
    .service-card,
    .package-card,
    .inventory-card {
        will-change: transform;
        backface-visibility: hidden;
    }
    
    .pagination-container {
        overflow-x: auto;
        scroll-behavior: smooth;
    }
    
    /* Reduce animations on mobile for better performance */
    * {
        animation-duration: 0.1s !important;
        transition-duration: 0.1s !important;
    }
}

.text-muted { color: var(--gray-500); }
.text-success { color: var(--success-600); }
.text-primary { color: var(--primary-600); }
.d-flex { display: flex; }
.justify-content-between { justify-content: space-between; }
.align-items-center { align-items: center; }
.p-3 { padding: 1rem; }

/* Search empty state */
.search-empty-state {
    grid-column: 1 / -1;
}

/* Pagination */
.pagination-container {
    display: none; /* Hidden by default, shown on mobile */
    margin-top: 1rem;
    text-align: center;
}

.pagination-info {
    font-size: 0.875rem;
    color: var(--gray-600);
    margin-bottom: 0.5rem;
}

.pagination-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
}

.pagination-btn {
    padding: 0.375rem 0.75rem;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-md);
    background: white;
    color: var(--gray-700);
    font-size: 0.875rem;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.pagination-btn:hover:not(:disabled) {
    background: var(--primary-50);
    border-color: var(--primary-300);
    color: var(--primary-700);
}

.pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.pagination-btn.active {
    background: var(--primary-500);
    border-color: var(--primary-500);
    color: white;
}

/* Mobile order summary - sticky at bottom */
.mobile-order-summary {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-top: 1px solid var(--gray-200);
    box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    padding: 1rem;
}

/* Show mobile summary on tablets and mobile */
@media (max-width: 768px) {
    .mobile-order-summary {
        display: block !important;
    }
}

.mobile-summary-toggle {
    display: flex;
    justify-content: between;
    align-items: center;
    width: 100%;
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
}

.mobile-summary-content {
    display: none;
    padding-top: 1rem;
    border-top: 1px solid var(--gray-200);
    margin-top: 1rem;
}

.mobile-summary-content.show {
    display: block;
}

/* Inventory quantity controls */
.inventory-quantity-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.75rem;
    padding: 0.5rem;
    background: #f8fafc;
    border-radius: 0.375rem;
    border-top: 1px solid #e2e8f0;
}

.quantity-btn {
    width: 2rem;
    height: 2rem;
    border: 1px solid #d1d5db;
    background: white;
    border-radius: 0.375rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
    font-size: 0.75rem;
}

.quantity-btn:hover {
    background: #f9fafb;
    border-color: #9ca3af;
}

.inventory-quantity-input {
    width: 3rem;
    text-align: center;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    padding: 0.25rem;
    font-size: 0.875rem;
}

/* Category filter for inventory */
.inventory-category-btn {
    padding: 0.5rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    background: white;
    color: #374151;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.15s ease-in-out;
}

.inventory-category-btn:hover {
    background: #f9fafb;
    border-color: #9ca3af;
}

.inventory-category-btn.active {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

/* Inventory badges */
.out-of-stock-badge {
    background: #ef4444;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 600;
}

.low-stock-badge {
    background: #f59e0b;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 600;
}

/* Out of stock inventory cards */
.inventory-card:has(.out-of-stock-badge) {
    opacity: 0.6;
    cursor: not-allowed;
}

.inventory-card:has(.out-of-stock-badge):hover {
    border-color: var(--gray-200);
    background: white;
    transform: none;
    box-shadow: none;
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">
            <i class="fas fa-bolt text-primary"></i>
            Quick Order
        </h1>
        <p class="page-description">Create a service order quickly for walk-in customers</p>
    </div>
    
    <div class="page-actions">
        <a href="/business/{{ request.tenant.slug }}/services/dashboard/" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i>
            Back to Dashboard
        </a>
    </div>
</div>

<div class="quick-order-container">
    <!-- Progress Indicator -->
    <div class="order-progress">
        <div class="progress-step active" id="step1-indicator">
            <div class="progress-number">1</div>
            <div class="progress-label">Number Plate</div>
        </div>
        <div class="progress-step" id="step2-indicator">
            <div class="progress-number">2</div>
            <div class="progress-label">Customer</div>
        </div>
        <div class="progress-step" id="step3-indicator">
            <div class="progress-number">3</div>
            <div class="progress-label">Services</div>
        </div>
        <div class="progress-step" id="step4-indicator">
            <div class="progress-number">4</div>
            <div class="progress-label">Review</div>
        </div>
    </div>

    <form id="quickOrderForm" method="post">
        {% csrf_token %}
        
        <!-- Step 1: Vehicle Search/Selection -->
        <div class="step-content active" id="step1">
            <div class="form-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-car"></i>
                        Vehicle Search
                    </h5>
                </div>
                
                <div class="card-body">
                    <div id="vehicleRegistrationSection">
                        <!-- Vehicle Search - Primary Option -->
                        <div class="customer-search-section">
                            <h6><i class="fas fa-search"></i> Search by Number Plate</h6>
                            <div class="search-input-group">
                                <input type="text" class="form-control" id="vehicleSearchInput" placeholder="Enter number plate (e.g., KCA 123A)..." style="text-transform: uppercase;">
                                <button type="button" class="search-btn" onclick="searchVehiclesByRegistration()">
                                    <i class="fas fa-search"></i>
                                    Search
                                </button>
                            </div>
                            <div id="vehicleSearchResults" class="search-results" style="display: none;"></div>
                        </div>

                    <!-- Selected Vehicle Display -->
                    <div id="selectedVehicleDisplay" style="display: none;">
                        <div class="selected-vehicle">
                            <div class="selection-header">
                                <h6><i class="fas fa-check-circle text-success"></i> Selected Vehicle</h6>
                                <button type="button" class="change-btn" onclick="changeVehicle()">Change</button>
                            </div>
                            <div id="selectedVehicleInfo"></div>
                        </div>
                    </div>

                    <!-- New Vehicle Form -->
                    <div id="newVehicleForm">
                        <h6><i class="fas fa-plus"></i> Register New Vehicle</h6>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vehicleRegistration" class="form-label required">Number Plate</label>
                                <input type="text" class="form-control" id="vehicleRegistration" name="vehicle_registration" required style="text-transform: uppercase;">
                            </div>
                            <div class="form-group">
                                <label for="vehicleType" class="form-label">Vehicle Type (Optional)</label>
                                <select class="form-control form-select" id="vehicleType" name="vehicle_type">
                                    <option value="">Select Type</option>
                                    <option value="sedan">Sedan</option>
                                    <option value="suv">SUV</option>
                                    <option value="hatchback">Hatchback</option>
                                    <option value="pickup">Pickup Truck</option>
                                    <option value="van">Van</option>
                                    <option value="bus">Bus</option>
                                    <option value="motorcycle">Motorcycle</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vehicleMake" class="form-label">Make (Optional)</label>
                                <input type="text" class="form-control" id="vehicleMake" name="vehicle_make" placeholder="e.g., Toyota">
                            </div>
                            <div class="form-group">
                                <label for="vehicleModel" class="form-label">Model (Optional)</label>
                                <input type="text" class="form-control" id="vehicleModel" name="vehicle_model" placeholder="e.g., Camry">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vehicleColor" class="form-label">Color (Optional)</label>
                                <input type="text" class="form-control" id="vehicleColor" name="vehicle_color" placeholder="e.g., White">
                            </div>
                            <div class="form-group">
                                <label for="vehicleYear" class="form-label">Year</label>
                                <input type="number" class="form-control" id="vehicleYear" name="vehicle_year" min="1990" max="2025" value="2020">
                            </div>
                        </div>
                    </div>

                    <!-- Hidden fields for selected vehicle -->
                    <input type="hidden" id="selectedVehicleId" name="selected_vehicle_id">
                    <input type="hidden" id="skipVehicleInput" name="skip_vehicle" value="false">
                    </div> <!-- End vehicleRegistrationSection -->
                    
                    <!-- Skip Vehicle Option - Moved below, with better mobile layout -->
                    <div class="mt-4">
                        <div class="text-center">
                            <hr class="my-3">
                            <small class="text-muted d-block mb-3">Skip vehicle registration if selling inventory items only</small>
                            <div class="d-grid d-md-flex justify-content-md-center">
                                <button type="button" class="btn btn-warning" id="skipVehicleBtn" onclick="toggleVehicleSkip()">
                                    <i class="fas fa-forward me-2"></i>
                                    <span id="skipVehicleBtnText">Skip Vehicle Registration</span>
                                </button>
                            </div>
                            <input type="hidden" id="skipVehicleCheckbox" value="false">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Customer Selection -->
        <div class="step-content" id="step2">
            <div class="form-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-user"></i>
                        Select Customer
                    </h5>
                </div>
                
                <div class="card-body">
                    <!-- Walk-in Customer Option -->
                    <div class="walk-in-option">
                        <button type="button" class="btn btn-outline-primary btn-lg w-100 mb-3" onclick="selectWalkInCustomer()">
                            <i class="fas fa-walking"></i>
                            Walk-in Customer
                        </button>
                        <div class="text-center mb-3">
                            <small class="text-muted">OR</small>
                        </div>
                    </div>

                    <!-- Existing Customer from Vehicle -->
                    <div id="vehicleCustomerDisplay" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Vehicle Owner Found</strong>
                            <div id="vehicleCustomerInfo"></div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-success" onclick="useVehicleCustomer()">
                                    Use This Customer
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="showCustomerOptions()">
                                    Different Customer
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Search -->
                    <div class="customer-search-section" id="customerSearchSection">
                        <h6><i class="fas fa-search"></i> Search Existing Customer</h6>
                        <div class="search-input-group">
                            <input type="text" class="form-control" id="customerSearchInput" placeholder="Search by name, phone, or customer ID...">
                            <button type="button" class="search-btn" onclick="searchCustomers()">
                                <i class="fas fa-search"></i>
                                Search
                            </button>
                        </div>
                        <div id="customerSearchResults" class="search-results" style="display: none;"></div>
                    </div>

                    <!-- Selected Customer Display -->
                    <div id="selectedCustomerDisplay" style="display: none;">
                        <div class="selected-customer">
                            <div class="selection-header">
                                <h6><i class="fas fa-check-circle text-success"></i> Selected Customer</h6>
                                <button type="button" class="change-btn" onclick="changeCustomer()">Change</button>
                            </div>
                            <div id="selectedCustomerInfo"></div>
                        </div>
                    </div>

                    <!-- New Customer Form -->
                    <div id="newCustomerForm" style="display: none;">
                        <h6><i class="fas fa-user-plus"></i> Register New Customer</h6>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customerName" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="customerName" name="customer_name" placeholder="Optional for walk-in">
                            </div>
                            <div class="form-group">
                                <label for="customerPhone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="customerPhone" name="customer_phone" placeholder="Optional for walk-in">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="customerEmail" class="form-label">Email (Optional)</label>
                            <input type="email" class="form-control" id="customerEmail" name="customer_email">
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="addVehicleToCustomer" name="add_vehicle_to_customer">
                            <label class="form-check-label" for="addVehicleToCustomer">
                                Add vehicle to this customer's account
                            </label>
                        </div>
                    </div>

                    <!-- Walk-in Customer Display -->
                    <div id="walkInCustomerDisplay" style="display: none;">
                        <div class="alert alert-warning">
                            <i class="fas fa-walking"></i>
                            <strong>Walk-in Customer</strong>
                            <p class="mb-0">Customer details will be captured during payment if needed.</p>
                        </div>
                    </div>

                    <!-- Hidden fields for selected customer -->
                    <input type="hidden" id="selectedCustomerId" name="selected_customer_id">
                    <input type="hidden" id="isWalkInCustomer" name="is_walk_in_customer" value="false">
                </div>
            </div>
        </div>

        <!-- Step 3: Service Selection -->
        <div class="step-content" id="step3">
            <div class="row">
                <div class="col-lg-8">
                    <div class="form-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-list-check"></i>
                                Select Services
                            </h5>
                        </div>
                        
                        <div class="card-body">
                            <!-- Service Type Selector -->
                            <div class="service-type-selector mb-3">
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-outline-primary active" id="individualServicesBtn" onclick="showServiceType('individual')">
                                        <i class="fas fa-list"></i>
                                        Individual Services
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" id="packagesBtn" onclick="showServiceType('packages')">
                                        <i class="fas fa-box"></i>
                                        Service Packages
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" id="inventoryBtn" onclick="showServiceType('inventory')">
                                        <i class="fas fa-boxes"></i>
                                        Inventory Items
                                    </button>
                                </div>
                            </div>

                            <!-- Individual Services Section -->
                            <div id="individualServicesSection">
                                <!-- Service Search -->
                                <div class="service-search-section mb-3">
                                    <div class="search-input-group">
                                        <input type="text" class="form-control" id="serviceSearchInput" placeholder="Search services by name or description...">
                                        <button type="button" class="search-btn" onclick="clearServiceSearch()">
                                            <i class="fas fa-times"></i>
                                            Clear
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Category Filter -->
                                <div class="category-filter">
                                    <button type="button" class="category-btn active" onclick="filterServices('all')" data-category="all">
                                        All Services
                                    </button>
                                    {% for category in categories %}
                                    <button type="button" class="category-btn" onclick="filterServices('{{ category.id }}')" data-category="{{ category.id }}">
                                        <i class="{{ category.icon }}"></i>
                                        {{ category.name }}
                                    </button>
                                    {% endfor %}
                                </div>

                                <!-- Services Grid -->
                                <div class="services-grid" id="servicesGrid">
                                    {% for service in all_services %}
                                    <div class="service-card" onclick="toggleService('{{ service.id }}')" data-service-id="{{ service.id }}" data-category="{{ service.category.id }}">
                                        <div class="service-header">
                                            <h6 class="service-name">{{ service.name }}</h6>
                                            <div class="service-price">KES {{ service.base_price }}</div>
                                        </div>
                                        <p class="service-description">{{ service.description|truncatewords:15 }}</p>
                                        <div class="service-details">
                                            <div class="service-duration">
                                                <i class="fas fa-clock"></i>
                                                {{ service.estimated_duration }} min
                                            </div>
                                            <div class="service-category">{{ service.category.name }}</div>
                                        </div>
                                        {% if service.is_popular %}
                                        <div class="service-badge">
                                            <span class="popular-badge">POPULAR</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% empty %}
                                    <div class="empty-state">
                                        <i class="fas fa-car-wash"></i>
                                        <p>No services available</p>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <!-- Services Pagination -->
                                <div class="pagination-container" id="servicesPagination">
                                    <div class="pagination-info" id="servicesPaginationInfo"></div>
                                    <div class="pagination-controls">
                                        <button type="button" class="pagination-btn" id="servicesPrevBtn" onclick="changeServicesPage(-1)">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <span class="pagination-pages" id="servicesPaginationPages"></span>
                                        <button type="button" class="pagination-btn" id="servicesNextBtn" onclick="changeServicesPage(1)">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Service Packages Section -->
                            <div id="packagesSection" style="display: none;">
                                <!-- Package Search -->
                                <div class="service-search-section mb-3">
                                    <div class="search-input-group">
                                        <input type="text" class="form-control" id="packageSearchInput" placeholder="Search packages by name or description...">
                                        <button type="button" class="search-btn" onclick="clearPackageSearch()">
                                            <i class="fas fa-times"></i>
                                            Clear
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="packages-grid" id="packagesGrid">
                                    {% for package in service_packages %}
                                    <div class="package-card" onclick="togglePackage('{{ package.id }}')" data-package-id="{{ package.id }}">
                                        <div class="package-header">
                                            <h6 class="package-name">{{ package.name }}</h6>
                                            <div class="package-pricing">
                                                {% if package.discount_percentage > 0 %}
                                                <div class="original-price">KES {{ package.original_price|floatformat:2 }}</div>
                                                <div class="package-price">KES {{ package.total_price }}</div>
                                                <div class="savings">Save KES {{ package.savings_amount|floatformat:2 }}</div>
                                                {% else %}
                                                <div class="package-price">KES {{ package.total_price }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <p class="package-description">{{ package.description|truncatewords:20 }}</p>
                                        <div class="package-details">
                                            <div class="package-duration">
                                                <i class="fas fa-clock"></i>
                                                {{ package.estimated_duration }} min
                                            </div>
                                            <div class="package-services-count">
                                                <i class="fas fa-list"></i>
                                                {{ package.service_count }} services
                                            </div>
                                        </div>
                                        {% if package.discount_percentage > 0 %}
                                        <div class="package-badge">
                                            <span class="discount-badge">{{ package.discount_percentage|floatformat:0 }}% OFF</span>
                                        </div>
                                        {% endif %}
                                        {% if package.is_popular %}
                                        <div class="package-badge popular-badge">
                                            <span class="popular-label">POPULAR</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% empty %}
                                    <div class="empty-state">
                                        <i class="fas fa-box"></i>
                                        <p>No service packages available</p>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <!-- Packages Pagination -->
                                <div class="pagination-container" id="packagesPagination">
                                    <div class="pagination-info" id="packagesPaginationInfo"></div>
                                    <div class="pagination-controls">
                                        <button type="button" class="pagination-btn" id="packagesPrevBtn" onclick="changePackagesPage(-1)">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <span class="pagination-pages" id="packagesPaginationPages"></span>
                                        <button type="button" class="pagination-btn" id="packagesNextBtn" onclick="changePackagesPage(1)">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Inventory Items Section -->
                            <div id="inventorySection" style="display: none;">
                                <!-- Inventory Search -->
                                <div class="service-search-section mb-3">
                                    <div class="search-input-group">
                                        <input type="text" class="form-control" id="inventorySearchInput" placeholder="Search inventory items by name or description...">
                                        <button type="button" class="search-btn" onclick="clearInventorySearch()">
                                            <i class="fas fa-times"></i>
                                            Clear
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Category Filter for Inventory -->
                                <div class="category-filter">
                                    <button type="button" class="inventory-category-btn active" onclick="filterInventoryItems('all')" data-inventory-category="all">
                                        All Items
                                    </button>
                                    {% for category in inventory_categories %}
                                    <button type="button" class="inventory-category-btn" onclick="filterInventoryItems('{{ category.id }}')" data-inventory-category="{{ category.id }}">
                                        {{ category.name }}
                                    </button>
                                    {% endfor %}
                                </div>

                                <!-- Inventory Grid -->
                                <div class="inventory-grid" id="inventoryGrid">
                                    {% for item in inventory_items %}
                                    <div class="inventory-card" onclick="selectInventoryCard('{{ item.id }}')" data-item-id="{{ item.id }}" data-category="{{ item.category.id|default:'other' }}">
                                        <div class="service-header">
                                            <h6 class="service-name">{{ item.name }}</h6>
                                            <div class="service-price">KES {{ item.selling_price }}</div>
                                        </div>
                                        {% if item.description %}
                                        <p class="service-description">{{ item.description|truncatewords:15 }}</p>
                                        {% endif %}
                                        <div class="service-details">
                                            <div class="service-duration">
                                                <i class="fas fa-box"></i>
                                                Stock: {{ item.current_stock }}
                                            </div>
                                            {% if item.brand %}
                                            <div class="service-category">{{ item.brand }}</div>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Quantity controls -->
                                        <div class="inventory-quantity-controls">
                                            <button type="button" class="quantity-btn" onclick="event.stopPropagation(); updateInventoryQuantity('{{ item.id }}', -1)">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <input type="number" class="inventory-quantity-input" data-item-id="{{ item.id }}" data-max-stock="{{ item.current_stock }}" value="0" min="0" max="{{ item.current_stock }}" onchange="onInventoryQuantityChange(this, '{{ item.id }}')" onclick="event.stopPropagation()">
                                            <button type="button" class="quantity-btn" onclick="event.stopPropagation(); updateInventoryQuantity('{{ item.id }}', 1)">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                        
                                        {% if item.current_stock == 0 %}
                                        <div class="service-badge">
                                            <span class="out-of-stock-badge">OUT OF STOCK</span>
                                        </div>
                                        {% elif item.current_stock <= item.minimum_stock %}
                                        <div class="service-badge">
                                            <span class="low-stock-badge">LOW STOCK</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% empty %}
                                    <div class="empty-state">
                                        <i class="fas fa-boxes"></i>
                                        <p>No inventory items available</p>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <!-- Inventory Pagination -->
                                <div class="pagination-container" id="inventoryPagination">
                                    <div class="pagination-info" id="inventoryPaginationInfo"></div>
                                    <div class="pagination-controls">
                                        <button type="button" class="pagination-btn" id="inventoryPrevBtn" onclick="changeInventoryPage(-1)">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <span class="pagination-pages" id="inventoryPaginationPages"></span>
                                        <button type="button" class="pagination-btn" id="inventoryNextBtn" onclick="changeInventoryPage(1)">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <!-- Order Summary -->
                    <div class="order-summary">
                        <div class="summary-header">
                            <h6 class="summary-title">
                                <i class="fas fa-shopping-cart"></i>
                                Order Summary
                            </h6>
                        </div>
                        
                        <div class="summary-content">
                            <div id="selectedServicesDisplay">
                                <div class="empty-state">
                                    <i class="fas fa-list"></i>
                                    <p>No services selected</p>
                                </div>
                            </div>
                            
                            <div class="selected-services-list" id="selectedServicesList" style="display: none;">
                                <!-- Selected services will be populated here -->
                            </div>
                            
                            <div class="summary-totals" id="summaryTotals" style="display: none;">
                                <div class="total-row">
                                    <span>Subtotal (ex VAT):</span>
                                    <span id="subtotalAmount">KES 0</span>
                                </div>
                                <div class="total-row">
                                    <span>VAT (16%):</span>
                                    <span id="taxAmount">KES 0</span>
                                </div>
                                <div class="total-row main">
                                    <span>Total (incl VAT):</span>
                                    <span id="totalAmount">KES 0</span>
                                </div>
                                <div class="total-row">
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i>
                                        Est. Duration: <span id="estimatedDuration">0</span> min
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="summary-actions">
                            <button type="button" class="btn btn-outline-gray" onclick="clearAllServices()">
                                <i class="fas fa-trash"></i>
                                Clear All
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Review & Submit -->
        <div class="step-content" id="step4">
            <div class="form-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-check-circle"></i>
                        Review Order
                    </h5>
                </div>
                
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Customer Information</h6>
                            <div id="reviewCustomerInfo" class="mb-3">
                                <!-- Customer info will be populated here -->
                            </div>
                            
                            <h6>Vehicle Information</h6>
                            <div id="reviewVehicleInfo" class="mb-3">
                                <!-- Vehicle info will be populated here -->
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div id="reviewServicesSection" style="display: none;">
                                <h6><i class="fas fa-tools me-2"></i>Selected Services</h6>
                                <div id="reviewServicesInfo" class="mb-3">
                                    <!-- Services info will be populated here -->
                                </div>
                            </div>
                            
                            <div id="reviewInventorySection" style="display: none;">
                                <h6><i class="fas fa-box me-2"></i>Selected Items</h6>
                                <div id="reviewInventoryInfo" class="mb-3">
                                    <!-- Inventory info will be populated here -->
                                </div>
                            </div>
                            
                            <h6>Order Total</h6>
                            <div id="reviewTotalInfo">
                                <!-- Total info will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="specialInstructions" class="form-label">Special Instructions (Optional)</label>
                        <textarea class="form-control" id="specialInstructions" name="special_instructions" rows="3" placeholder="Any special requirements or notes..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="priority" class="form-label">Priority</label>
                        <select class="form-control form-select" id="priority" name="priority">
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden field for selected services -->
        <input type="hidden" id="selectedServicesData" name="selected_services">
    </form>

    <!-- Mobile Order Summary (Fixed at bottom on mobile) -->
    <div class="mobile-order-summary" id="mobileOrderSummary">
        <button type="button" class="mobile-summary-toggle" onclick="toggleMobileSummary()">
            <div class="d-flex justify-content-between align-items-center w-100">
                <div>
                    <strong id="mobileSummaryTitle">Order Summary</strong>
                    <div class="text-muted small" id="mobileSummaryPreview">No items selected</div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span id="mobileTotalAmount" class="fw-bold">KES 0</span>
                    <i class="fas fa-chevron-up" id="mobileSummaryIcon"></i>
                </div>
            </div>
        </button>
        
        <div class="mobile-summary-content" id="mobileSummaryContent">
            <div id="mobileSelectedServices"></div>
            <div class="mobile-summary-totals" id="mobileSummaryTotals" style="display: none;">
                <div class="d-flex justify-content-between">
                    <span>Subtotal (ex VAT):</span>
                    <span id="mobileSubtotalAmount">KES 0</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>VAT (16%):</span>
                    <span id="mobileTaxAmount">KES 0</span>
                </div>
                <div class="d-flex justify-content-between fw-bold border-top pt-2">
                    <span>Total (incl VAT):</span>
                    <span id="mobileTotalAmountDetail">KES 0</span>
                </div>
                <div class="text-center text-muted small mt-2">
                    <i class="fas fa-clock"></i>
                    Est. Duration: <span id="mobileEstimatedDuration">0</span> min
                </div>
            </div>
        </div>
    </div>

    <!-- Step Navigation -->
    <div class="step-navigation">
        <div class="step-indicator">
            Step <span id="currentStepNumber">1</span> of 4
        </div>
        
        <div class="nav-buttons">
            <button type="button" class="btn btn-outline-gray" id="prevBtn" onclick="previousStep()" style="display: none;">
                <i class="fas fa-arrow-left"></i>
                Previous
            </button>
            
            <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                Next
                <i class="fas fa-arrow-right"></i>
            </button>
            
            <button type="button" class="btn btn-success btn-lg" id="submitBtn" onclick="submitOrder()" style="display: none;">
                <i class="fas fa-check"></i>
                Create Order
            </button>
        </div>
    </div>
</div>

<!-- Customer Save Notification Modal -->
<div class="modal fade" id="customerSaveModal" tabindex="-1" aria-labelledby="customerSaveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="customerSaveModalLabel">
                    <i class="fas fa-user-plus me-2"></i>Save Walk-in Customer
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="fas fa-mobile-alt text-success mb-3" style="font-size: 3rem;"></i>
                    <h6>M-Pesa Payment Successful!</h6>
                </div>
                
                <div class="alert alert-info">
                    <strong>Customer Details from Transaction:</strong>
                    <div id="transactionCustomerDetails">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
                
                <p class="text-muted">
                    Would you like to save this walk-in customer's details for future visits? 
                    This will help you provide better service next time they visit.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Skip for Now
                </button>
                <button type="button" class="btn btn-success" id="saveCustomerBtn">
                    <i class="fas fa-save me-2"></i>Save Customer Details
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentStep = 1;
let selectedCustomer = null;
let selectedVehicle = null;
let vehicleCustomer = null; // Customer from selected vehicle
let selectedServices = [];
let selectedPackage = null;
let selectedInventoryItems = []; // Initialize inventory items array
let allServices = [];
let serviceType = 'individual'; // 'individual', 'package', or 'inventory'

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadAllServices();
    updateStepIndicator();
    initializeServiceSearch();
    initializePackageSearch();
    initializeInventorySearch();
    initializeGlobalSearch();
    initializePagination();
    initializeMobileSummary();
});

// Function to toggle vehicle registration section
function toggleVehicleSkip() {
    const skipBtn = document.getElementById('skipVehicleBtn');
    const skipCheckbox = document.getElementById('skipVehicleCheckbox');
    const vehicleSection = document.getElementById('vehicleRegistrationSection');
    const skipVehicleInput = document.getElementById('skipVehicleInput');
    const btnText = document.getElementById('skipVehicleBtnText');
    
    const isCurrentlySkipped = skipCheckbox.value === 'true';
    
    if (!isCurrentlySkipped) {
        // Enable skip mode
        skipCheckbox.value = 'true';
        skipVehicleInput.value = 'true';
        vehicleSection.style.display = 'none';
        skipBtn.className = 'btn btn-success btn-lg';
        btnText.innerHTML = 'Vehicle Registration Skipped<br><small>Click to enable vehicle registration</small>';
        skipBtn.querySelector('i').className = 'fas fa-check me-2';
        
        // Clear any selected vehicle data
        selectedVehicle = null;
        selectedCustomer = null;
        selectedCustomerType = null;
        document.getElementById('selectedVehicleId').value = '';
        // Clear customer type radio buttons
        const radios = document.querySelectorAll('input[name="customer_type"]');
        radios.forEach(radio => radio.checked = false);
        
        // Clear services and packages since they need vehicles
        selectedServices = [];
        selectedPackage = null;
        document.querySelectorAll('.service-card').forEach(card => {
            card.classList.remove('selected');
        });
        document.querySelectorAll('.package-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // Automatically set to walk-in customer
        document.getElementById('isWalkInCustomer').value = 'true';
        
        // Switch to inventory tab
        showServiceType('inventory');
        
        showToast('Vehicle registration skipped. You can now sell inventory items only.', 'info');
    } else {
        // Disable skip mode
        skipCheckbox.value = 'false';
        skipVehicleInput.value = 'false';
        vehicleSection.style.display = 'block';
        skipBtn.className = 'btn btn-warning btn-lg';
        btnText.innerHTML = 'Skip Vehicle Registration<br><small>For inventory items only</small>';
        skipBtn.querySelector('i').className = 'fas fa-forward me-2';
        
        // Reset walk-in customer setting
        document.getElementById('isWalkInCustomer').value = 'false';
        
        // Switch back to individual services tab
        showServiceType('individual');
        
        showToast('Vehicle registration enabled. You can now register vehicles for services.', 'info');
    }
    
    validateCurrentStep();
}

// Step Management
function nextStep() {
    if (validateCurrentStep()) {
        if (currentStep < 4) {
            currentStep++;
            showStep(currentStep);
            updateStepIndicator();
            updateNavigationButtons();
        }
    }
}

function previousStep() {
    if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
        updateStepIndicator();
        updateNavigationButtons();
    }
}

function showStep(step) {
    // Hide all steps
    document.querySelectorAll('.step-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Show current step
    document.getElementById(`step${step}`).classList.add('active');
    
    // Update step-specific content
    if (step === 2) {
        updateCustomerStep(); // Now step 2 is customer step
    } else if (step === 4) {
        updateReviewStep();
    }
}

function updateStepIndicator() {
    document.getElementById('currentStepNumber').textContent = currentStep;
    
    // Update progress indicators
    for (let i = 1; i <= 4; i++) {
        const indicator = document.getElementById(`step${i}-indicator`);
        if (i < currentStep) {
            indicator.classList.add('completed');
            indicator.classList.remove('active');
        } else if (i === currentStep) {
            indicator.classList.add('active');
            indicator.classList.remove('completed');
        } else {
            indicator.classList.remove('active', 'completed');
        }
    }
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    
    // Show/hide previous button
    prevBtn.style.display = currentStep > 1 ? 'inline-flex' : 'none';
    
    // Show next or submit button
    if (currentStep === 4) {
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'inline-flex';
    } else {
        nextBtn.style.display = 'inline-flex';
        submitBtn.style.display = 'none';
    }
}

function validateCurrentStep() {
    switch (currentStep) {
        case 1:
            return validateVehicleStep();
        case 2:
            return validateCustomerStep();
        case 3:
            return validateServicesStep();
        case 4:
            return true; // Review step doesn't need validation
        default:
            return true;
    }
}

// Customer Management
function searchCustomers() {
    const query = document.getElementById('customerSearchInput').value.trim();
    const resultsContainer = document.getElementById('customerSearchResults');
    
    if (query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
    }
    
    resultsContainer.innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
    resultsContainer.style.display = 'block';
    
    fetch(`/business/{{ request.tenant.slug }}/services/ajax/customer/search/?q=${encodeURIComponent(query)}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        displayCustomerResults(data.customers || []);
    })
    .catch(error => {
        console.error('Search error:', error);
        resultsContainer.innerHTML = '<div class="text-danger p-3">Error searching customers</div>';
    });
}

function displayCustomerResults(customers) {
    const resultsContainer = document.getElementById('customerSearchResults');
    
    if (customers.length === 0) {
        resultsContainer.innerHTML = '<div class="text-muted p-3">No customers found</div>';
        return;
    }
    
    let html = '';
    customers.forEach(customer => {
        html += `
            <div class="search-result-item" onclick="selectCustomer('${customer.id}', '${customer.full_name}', '${customer.phone}', '${customer.customer_id}')">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>${customer.full_name}</strong>
                        <br><small>${customer.phone || 'No phone'}</small>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">${customer.customer_id}</small>
                        <br><small>${customer.vehicle_count || 0} vehicle(s)</small>
                    </div>
                </div>
            </div>
        `;
    });
    
    resultsContainer.innerHTML = html;
}

function selectCustomer(id, name, phone, customerId) {
    selectedCustomer = { id, name, phone, customerId };
    
    // Update UI
    document.getElementById('selectedCustomerId').value = id;
    document.getElementById('selectedCustomerInfo').innerHTML = `
        <strong>${name}</strong><br>
        <small>Phone: ${phone}</small><br>
        <small>ID: ${customerId}</small>
    `;
    
    // Show selected customer, hide search and new customer form
    document.getElementById('selectedCustomerDisplay').style.display = 'block';
    document.getElementById('customerSearchResults').style.display = 'none';
    document.getElementById('newCustomerForm').style.display = 'none';
    
    // Clear search input
    document.getElementById('customerSearchInput').value = '';
}

function changeCustomer() {
    selectedCustomer = null;
    document.getElementById('selectedCustomerId').value = '';
    document.getElementById('selectedCustomerDisplay').style.display = 'none';
    document.getElementById('newCustomerForm').style.display = 'block';
    
    // Clear form fields
    document.getElementById('customerName').value = '';
    document.getElementById('customerPhone').value = '';
    document.getElementById('customerEmail').value = '';
}

// Vehicle Management (Step 1)
function searchVehiclesByRegistration() {
    const query = document.getElementById('vehicleSearchInput').value.trim();
    const resultsContainer = document.getElementById('vehicleSearchResults');
    
    if (query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
    }
    
    resultsContainer.innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
    resultsContainer.style.display = 'block';
    
    fetch(`/business/{{ request.tenant.slug }}/services/ajax/vehicle/search/?q=${encodeURIComponent(query)}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        displayVehicleResults(data.results || []);
    })
    .catch(error => {
        console.error('Vehicle search error:', error);
        resultsContainer.innerHTML = '<div class="text-danger p-3">Error searching vehicles</div>';
    });
}

function displayVehicleResults(vehicles) {
    const resultsContainer = document.getElementById('vehicleSearchResults');
    
    if (vehicles.length === 0) {
        resultsContainer.innerHTML = '<div class="text-muted p-3">No vehicles found with this registration</div>';
        return;
    }
    
    let html = '';
    vehicles.forEach(vehicle => {
        html += `
            <div class="search-result-item" onclick="selectExistingVehicle('${vehicle.id}', '${vehicle.registration}', '${vehicle.make}', '${vehicle.model}', '${vehicle.color}', '${vehicle.customer_name}')">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>${vehicle.registration}</strong>
                        <br><small>${vehicle.make} ${vehicle.model}</small>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">${vehicle.color}</small>
                        <br><small>Owner: ${vehicle.customer_name}</small>
                    </div>
                </div>
            </div>
        `;
    });
    
    resultsContainer.innerHTML = html;
}

function selectExistingVehicle(id, registration, make, model, color, customerName) {
    console.log('selectExistingVehicle called with:', { id, registration, make, model, color, customerName });
    
    selectedVehicle = { id, registration, make, model, color, customerName };
    
    // Update vehicle UI
    document.getElementById('selectedVehicleId').value = id;
    document.getElementById('selectedVehicleInfo').innerHTML = `
        <strong>${registration}</strong><br>
        <small>${make} ${model}</small><br>
        <small>Color: ${color}</small><br>
        <small>Owner: ${customerName}</small>
    `;
    
    // Show selected vehicle, hide search and new vehicle form
    document.getElementById('selectedVehicleDisplay').style.display = 'block';
    document.getElementById('vehicleSearchResults').style.display = 'none';
    document.getElementById('newVehicleForm').style.display = 'none';
    
    // Load vehicle's customer info for step 2
    console.log('Calling loadVehicleCustomer with auto-advance = true');
    loadVehicleCustomer(id, true); // Pass true to auto-advance
    
    // Clear search input
    document.getElementById('vehicleSearchInput').value = '';
}

function loadVehicleCustomer(vehicleId, autoAdvance = false) {
    console.log('loadVehicleCustomer called with vehicleId:', vehicleId, 'autoAdvance:', autoAdvance);
    
    // This will load the customer details when we move to step 2
    fetch(`/business/{{ request.tenant.slug }}/customers/ajax/vehicle-customer/?vehicle_id=${vehicleId}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Vehicle customer response:', data);
        
        if (data.success && data.customer) {
            // Set both variables to ensure validation works
            vehicleCustomer = data.customer;
            selectedCustomer = data.customer;
            
            console.log('Loaded vehicle customer:', data.customer);
            
            // Check if customer is walk-in
            const isWalkInCustomer = data.customer.is_walk_in;
            
            // Pre-fill customer information
            document.getElementById('selectedCustomerId').value = data.customer.id;
            document.getElementById('isWalkInCustomer').value = isWalkInCustomer ? 'true' : 'false';
            
            console.log('Set customer form values:', {
                selectedCustomerId: data.customer.id,
                isWalkInCustomer: isWalkInCustomer ? 'true' : 'false'
            });
            
            // Hide all other customer options and show vehicle customer display
            document.getElementById('walkInCustomerDisplay').style.display = 'none';
            document.getElementById('selectedCustomerDisplay').style.display = 'none';
            document.getElementById('newCustomerForm').style.display = 'none';
            document.getElementById('customerSearchSection').style.display = 'none';
            document.getElementById('vehicleCustomerDisplay').style.display = 'block';
            
            let customerInfoHtml = '';
            if (isWalkInCustomer) {
                customerInfoHtml = `
                    <div class="alert alert-warning">
                        <i class="fas fa-walking me-2"></i>
                        <strong>Walk-in Customer:</strong> ${data.customer.full_name || 'Unknown'}<br>
                        <small>Phone: ${data.customer.phone || 'Not provided'}</small><br>
                        <small>Customer ID: ${data.customer.customer_id}</small><br>
                        <small class="text-muted">Previous walk-in customer</small>
                    </div>
                `;
                
                // Check for transaction details and ask to save if needed
                checkWalkInCustomerTransactions(data.customer.id);
            } else {
                customerInfoHtml = `
                    <div class="alert alert-info">
                        <i class="fas fa-car me-2"></i>
                        <strong>Vehicle Owner:</strong> ${data.customer.full_name}<br>
                        <small>Phone: ${data.customer.phone}</small><br>
                        <small>Customer ID: ${data.customer.customer_id}</small>
                    </div>
                `;
            }
            
            const vehicleCustomerInfoElement = document.getElementById('vehicleCustomerInfo');
            if (vehicleCustomerInfoElement) {
                vehicleCustomerInfoElement.innerHTML = customerInfoHtml;
            } else {
                console.error('vehicleCustomerInfo element not found');
            }
            
            // If auto-advance is enabled, automatically go to next step
            if (autoAdvance) {
                console.log('Starting auto-advance for vehicle customer, is walk-in:', isWalkInCustomer);
                console.log('Current step before auto-advance:', currentStep);
                
                // For vehicle with customer (walk-in or regular), skip customer step and go directly to services
                setTimeout(() => {
                    console.log('Auto-advancing directly to services step, skipping customer selection');
                    console.log('Setting currentStep from', currentStep, 'to 3');
                    currentStep = 3; // Skip customer step, go directly to services
                    
                    // Mark step 2 as completed since we have a customer
                    const step2Indicator = document.getElementById('step2-indicator');
                    if (step2Indicator) {
                        step2Indicator.classList.add('completed');
                        step2Indicator.classList.remove('active');
                        console.log('Marked step 2 as completed');
                    }
                    
                    console.log('Calling showStep(3)');
                    showStep(currentStep);
                    console.log('Calling updateStepIndicator()');
                    updateStepIndicator();
                    console.log('Calling updateNavigationButtons()');
                    updateNavigationButtons();
                    console.log('Auto-advance complete, currentStep is now:', currentStep);
                }, 300);
            } else {
                console.log('Auto-advance is disabled or no customer found');
            }
        }
    })
    .catch(error => {
        console.error('Error loading vehicle customer:', error);
    });
}

function changeVehicle() {
    selectedVehicle = null;
    vehicleCustomer = null;
    document.getElementById('selectedVehicleId').value = '';
    document.getElementById('selectedVehicleDisplay').style.display = 'none';
    document.getElementById('newVehicleForm').style.display = 'block';
    
    // Clear form fields
    document.getElementById('vehicleRegistration').value = '';
    document.getElementById('vehicleMake').value = '';
    document.getElementById('vehicleModel').value = '';
    document.getElementById('vehicleColor').value = '';
    document.getElementById('vehicleYear').value = '2020';
    document.getElementById('vehicleType').value = '';
}

function validateVehicleStep() {
    // Check if vehicle skip is enabled
    const skipVehicleCheckbox = document.getElementById('skipVehicleCheckbox');
    const skipVehicle = skipVehicleCheckbox && skipVehicleCheckbox.value === 'true';
    
    if (skipVehicle) {
        // Vehicle skip is enabled - check if only inventory items are selected
        const hasServices = selectedServices.length > 0;
        const hasPackage = selectedPackage !== null;
        
        if (hasServices || hasPackage) {
            showToast('Cannot skip vehicle registration when services are selected. Please unselect services or enable vehicle registration.', 'error');
            return false;
        }
        return true; // Skip vehicle validation for inventory-only orders
    }
    
    if (selectedVehicle) {
        return true;
    }
    
    // Validate new vehicle form - only registration is required
    const registration = document.getElementById('vehicleRegistration').value.trim();
    
    if (!registration) {
        showToast('Please enter vehicle registration number', 'error');
        return false;
    }
    
    return true;
}

// Customer Management (Step 2)
function selectWalkInCustomer() {
    selectedCustomer = null;
    document.getElementById('isWalkInCustomer').value = 'true';
    document.getElementById('selectedCustomerId').value = '';
    
    // Show walk-in display, hide other options
    document.getElementById('walkInCustomerDisplay').style.display = 'block';
    document.getElementById('selectedCustomerDisplay').style.display = 'none';
    document.getElementById('newCustomerForm').style.display = 'none';
    document.getElementById('customerSearchSection').style.display = 'none';
    document.getElementById('vehicleCustomerDisplay').style.display = 'none';
}

function showCustomerOptions() {
    document.getElementById('walkInCustomerDisplay').style.display = 'none';
    document.getElementById('vehicleCustomerDisplay').style.display = 'none';
    document.getElementById('customerSearchSection').style.display = 'block';
    document.getElementById('newCustomerForm').style.display = 'block';
}

function useVehicleCustomer() {
    if (vehicleCustomer) {
        selectedCustomer = vehicleCustomer;
        document.getElementById('selectedCustomerId').value = vehicleCustomer.id;
        document.getElementById('isWalkInCustomer').value = 'false';
        
        document.getElementById('selectedCustomerInfo').innerHTML = `
            <strong>${vehicleCustomer.name}</strong><br>
            <small>Phone: ${vehicleCustomer.phone}</small><br>
            <small>ID: ${vehicleCustomer.customer_id}</small>
        `;
        
        document.getElementById('selectedCustomerDisplay').style.display = 'block';
        document.getElementById('vehicleCustomerDisplay').style.display = 'none';
        document.getElementById('customerSearchSection').style.display = 'none';
        document.getElementById('newCustomerForm').style.display = 'none';
        document.getElementById('walkInCustomerDisplay').style.display = 'none';
    }
}

function updateCustomerStep() {
    // Show vehicle customer option if we have one
    if (selectedVehicle && vehicleCustomer) {
        const vehicleCustomerInfoElement = document.getElementById('vehicleCustomerInfo');
        if (vehicleCustomerInfoElement) {
            vehicleCustomerInfoElement.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-car me-2"></i>
                    <strong>Vehicle Owner:</strong> ${vehicleCustomer.full_name || vehicleCustomer.name}<br>
                    <small>Phone: ${vehicleCustomer.phone}</small><br>
                    <small>Customer ID: ${vehicleCustomer.customer_id}</small>
                </div>
            `;
        } else {
            console.error('vehicleCustomerInfo element not found in updateCustomerStep');
        }
        
        // Hide other options and show vehicle customer
        document.getElementById('walkInCustomerDisplay').style.display = 'none';
        document.getElementById('selectedCustomerDisplay').style.display = 'none';
        document.getElementById('newCustomerForm').style.display = 'none';
        document.getElementById('customerSearchSection').style.display = 'none';
        document.getElementById('vehicleCustomerDisplay').style.display = 'block';
    } else {
        document.getElementById('vehicleCustomerDisplay').style.display = 'none';
        // Show customer search and walk-in options by default
        document.getElementById('customerSearchSection').style.display = 'block';
        document.getElementById('newCustomerForm').style.display = 'block';
    }
}

function searchCustomers() {
    const query = document.getElementById('customerSearchInput').value.trim();
    const resultsContainer = document.getElementById('customerSearchResults');
    
    if (query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
    }
    
    resultsContainer.innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
    resultsContainer.style.display = 'block';
    
    fetch(`/business/{{ request.tenant.slug }}/services/ajax/customer/search/?q=${encodeURIComponent(query)}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        displayCustomerResults(data.customers || []);
    })
    .catch(error => {
        console.error('Search error:', error);
        resultsContainer.innerHTML = '<div class="text-danger p-3">Error searching customers</div>';
    });
}

function displayCustomerResults(customers) {
    const resultsContainer = document.getElementById('customerSearchResults');
    
    if (customers.length === 0) {
        resultsContainer.innerHTML = '<div class="text-muted p-3">No customers found</div>';
        return;
    }
    
    let html = '';
    customers.forEach(customer => {
        html += `
            <div class="search-result-item" onclick="selectCustomer('${customer.id}', '${customer.full_name}', '${customer.phone}', '${customer.customer_id}')">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>${customer.full_name}</strong>
                        <br><small>${customer.phone || 'No phone'}</small>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">${customer.customer_id}</small>
                        <br><small>${customer.vehicle_count || 0} vehicle(s)</small>
                    </div>
                </div>
            </div>
        `;
    });
    
    resultsContainer.innerHTML = html;
}

function selectCustomer(id, name, phone, customerId) {
    selectedCustomer = { id, name, phone, customerId };
    document.getElementById('isWalkInCustomer').value = 'false';
    
    // Update UI
    document.getElementById('selectedCustomerId').value = id;
    document.getElementById('selectedCustomerInfo').innerHTML = `
        <strong>${name}</strong><br>
        <small>Phone: ${phone}</small><br>
        <small>ID: ${customerId}</small>
    `;
    
    // Show selected customer, hide other options
    document.getElementById('selectedCustomerDisplay').style.display = 'block';
    document.getElementById('customerSearchResults').style.display = 'none';
    document.getElementById('newCustomerForm').style.display = 'none';
    document.getElementById('walkInCustomerDisplay').style.display = 'none';
    document.getElementById('vehicleCustomerDisplay').style.display = 'none';
    
    // Clear search input
    document.getElementById('customerSearchInput').value = '';
}

function changeCustomer() {
    selectedCustomer = null;
    document.getElementById('selectedCustomerId').value = '';
    document.getElementById('isWalkInCustomer').value = 'false';
    document.getElementById('selectedCustomerDisplay').style.display = 'none';
    
    // Show customer options again
    showCustomerOptions();
    
    // Clear form fields
    document.getElementById('customerName').value = '';
    document.getElementById('customerPhone').value = '';
    document.getElementById('customerEmail').value = '';
}

function validateCustomerStep() {
    const isWalkIn = document.getElementById('isWalkInCustomer').value === 'true';
    
    // Check if vehicle skip is enabled
    const skipVehicleCheckbox = document.getElementById('skipVehicleCheckbox');
    const skipVehicle = skipVehicleCheckbox && skipVehicleCheckbox.value === 'true';
    
    // Debug logging
    console.log('Validating customer step:', {
        isWalkIn,
        skipVehicle,
        selectedCustomer: !!selectedCustomer,
        vehicleCustomer: !!vehicleCustomer,
        selectedCustomerId: selectedCustomer?.id,
        vehicleCustomerId: vehicleCustomer?.id
    });
    
    // If skipping vehicle, automatically use walk-in customer
    if (skipVehicle) {
        document.getElementById('isWalkInCustomer').value = 'true';
        console.log('Customer step validation passed - vehicle skipped, using walk-in');
        return true;
    }
    
    if (isWalkIn || selectedCustomer || vehicleCustomer) {
        console.log('Customer step validation passed');
        return true;
    }
    
    // Check if customer form has data for new customer
    const name = document.getElementById('customerName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    
    // For new vehicle registration, at least one of name or phone should be provided
    if (!name && !phone) {
        console.log('Customer step validation failed: no customer details');
        showToast('Please provide customer details, select an existing customer, or choose walk-in', 'error');
        return false;
    }
    
    console.log('Customer step validation passed with form data');
    return true;
}

// Service Management
function showServiceType(type) {
    serviceType = type;
    
    // Update button states
    document.getElementById('individualServicesBtn').classList.toggle('active', type === 'individual');
    document.getElementById('packagesBtn').classList.toggle('active', type === 'packages');
    document.getElementById('inventoryBtn').classList.toggle('active', type === 'inventory');
    
    // Show/hide sections
    document.getElementById('individualServicesSection').style.display = type === 'individual' ? 'block' : 'none';
    document.getElementById('packagesSection').style.display = type === 'packages' ? 'block' : 'none';
    document.getElementById('inventorySection').style.display = type === 'inventory' ? 'block' : 'none';
    
    // Clear section-specific searches when switching tabs
    if (type === 'individual') {
        clearPackageSearch();
        clearInventorySearch();
        selectedPackage = null;
        selectedInventoryItems = [];
        document.querySelectorAll('.package-card').forEach(card => {
            card.classList.remove('selected');
        });
        document.querySelectorAll('.inventory-card').forEach(card => {
            card.classList.remove('selected');
        });
    } else if (type === 'packages') {
        clearServiceSearch();
        clearInventorySearch();
        selectedServices = [];
        selectedInventoryItems = [];
        document.querySelectorAll('.service-card').forEach(card => {
            card.classList.remove('selected');
        });
        document.querySelectorAll('.inventory-card').forEach(card => {
            card.classList.remove('selected');
        });
    } else if (type === 'inventory') {
        clearServiceSearch();
        clearPackageSearch();
        selectedServices = [];
        selectedPackage = null;
        document.querySelectorAll('.service-card').forEach(card => {
            card.classList.remove('selected');
        });
        document.querySelectorAll('.package-card').forEach(card => {
            card.classList.remove('selected');
        });
    }
    
    updateOrderSummary();
}

function loadAllServices() {
    // Services are already loaded from the template
    // This function can be used to load additional services via AJAX if needed
}

function filterServices(categoryId) {
    // Update active category button
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-category="${categoryId}"]`).classList.add('active');
    
    // Filter service cards
    document.querySelectorAll('.service-card').forEach(card => {
        const cardCategory = card.dataset.category;
        if (categoryId === 'all' || cardCategory === categoryId) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
    
    // Clear search input when changing categories
    const searchInput = document.getElementById('serviceSearchInput');
    if (searchInput) {
        searchInput.value = '';
    }
}

// Service search functionality
function initializeServiceSearch() {
    const searchInput = document.getElementById('serviceSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            searchServices(searchTerm);
        });
    }
}

function searchServices(searchTerm) {
    const serviceCards = document.querySelectorAll('.service-card');
    let visibleCount = 0;
    
    serviceCards.forEach(card => {
        const serviceName = card.querySelector('.service-name').textContent.toLowerCase();
        const serviceDescription = card.querySelector('.service-description').textContent.toLowerCase();
        const serviceCategory = card.querySelector('.service-category').textContent.toLowerCase();
        
        const matches = searchTerm === '' || 
                       serviceName.includes(searchTerm) || 
                       serviceDescription.includes(searchTerm) ||
                       serviceCategory.includes(searchTerm);
        
        if (matches) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // Show/hide empty state
    const servicesGrid = document.getElementById('servicesGrid');
    const existingEmptyState = servicesGrid.querySelector('.search-empty-state');
    
    if (visibleCount === 0 && searchTerm !== '') {
        if (!existingEmptyState) {
            const emptyState = document.createElement('div');
            emptyState.className = 'search-empty-state col-12 text-center py-4';
            emptyState.innerHTML = `
                <i class="fas fa-search text-muted mb-3" style="font-size: 2rem;"></i>
                <h6 class="text-muted">No services found</h6>
                <p class="text-muted small">Try different keywords or clear the search</p>
            `;
            servicesGrid.appendChild(emptyState);
        }
    } else if (existingEmptyState) {
        existingEmptyState.remove();
    }
    
    // Reset category filter to "All" when searching
    if (searchTerm !== '') {
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector('[data-category="all"]').classList.add('active');
    }
}

function clearServiceSearch() {
    const searchInput = document.getElementById('serviceSearchInput');
    if (searchInput) {
        searchInput.value = '';
        searchServices('');
    }
    
    // Remove empty state if it exists
    const existingEmptyState = document.querySelector('.search-empty-state');
    if (existingEmptyState) {
        existingEmptyState.remove();
    }
}

// Package search functionality
function initializePackageSearch() {
    const searchInput = document.getElementById('packageSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            searchPackages(searchTerm);
        });
    }
}

function searchPackages(searchTerm) {
    const packageCards = document.querySelectorAll('.package-card');
    let visibleCount = 0;
    
    packageCards.forEach(card => {
        const packageName = card.querySelector('.package-name').textContent.toLowerCase();
        const packageDescription = card.querySelector('.package-description').textContent.toLowerCase();
        
        const matches = searchTerm === '' || 
                       packageName.includes(searchTerm) || 
                       packageDescription.includes(searchTerm);
        
        if (matches) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // Show/hide empty state
    const packagesGrid = document.getElementById('packagesGrid');
    const existingEmptyState = packagesGrid.querySelector('.search-empty-state');
    
    if (visibleCount === 0 && searchTerm !== '') {
        if (!existingEmptyState) {
            const emptyState = document.createElement('div');
            emptyState.className = 'search-empty-state col-12 text-center py-4';
            emptyState.innerHTML = `
                <i class="fas fa-search text-muted mb-3" style="font-size: 2rem;"></i>
                <h6 class="text-muted">No packages found</h6>
                <p class="text-muted small">Try different keywords or clear the search</p>
            `;
            packagesGrid.appendChild(emptyState);
        }
    } else if (existingEmptyState) {
        existingEmptyState.remove();
    }
}

function clearPackageSearch() {
    const searchInput = document.getElementById('packageSearchInput');
    if (searchInput) {
        searchInput.value = '';
        searchPackages('');
    }
    
    // Remove empty state if it exists
    const existingEmptyState = document.querySelector('#packagesGrid .search-empty-state');
    if (existingEmptyState) {
        existingEmptyState.remove();
    }
}

// Inventory search functionality
function initializeInventorySearch() {
    const searchInput = document.getElementById('inventorySearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            searchInventory(searchTerm);
        });
    }
}

function searchInventory(searchTerm) {
    const inventoryCards = document.querySelectorAll('.inventory-card');
    let visibleCount = 0;
    
    inventoryCards.forEach(card => {
        const itemName = card.querySelector('.service-name').textContent.toLowerCase();
        const itemDescription = card.querySelector('.service-description');
        const descriptionText = itemDescription ? itemDescription.textContent.toLowerCase() : '';
        
        const matches = searchTerm === '' || 
                       itemName.includes(searchTerm) || 
                       descriptionText.includes(searchTerm);
        
        if (matches) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // Show/hide empty state
    const inventoryGrid = document.getElementById('inventoryGrid');
    const existingEmptyState = inventoryGrid.querySelector('.search-empty-state');
    
    if (visibleCount === 0 && searchTerm !== '') {
        if (!existingEmptyState) {
            const emptyState = document.createElement('div');
            emptyState.className = 'search-empty-state col-12 text-center py-4';
            emptyState.innerHTML = `
                <i class="fas fa-search text-muted mb-3" style="font-size: 2rem;"></i>
                <h6 class="text-muted">No inventory items found</h6>
                <p class="text-muted small">Try different keywords or clear the search</p>
            `;
            inventoryGrid.appendChild(emptyState);
        }
    } else if (existingEmptyState) {
        existingEmptyState.remove();
    }
    
    // Reset category filter to "All" when searching
    if (searchTerm !== '') {
        document.querySelectorAll('.inventory-category-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector('[data-inventory-category="all"]').classList.add('active');
    }
}

function clearInventorySearch() {
    const searchInput = document.getElementById('inventorySearchInput');
    if (searchInput) {
        searchInput.value = '';
        searchInventory('');
    }
    
    // Remove empty state if it exists
    const existingEmptyState = document.querySelector('#inventoryGrid .search-empty-state');
    if (existingEmptyState) {
        existingEmptyState.remove();
    }
}

// Global search functionality
function initializeGlobalSearch() {
    const searchInput = document.getElementById('globalSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            globalSearch(searchTerm);
        });
    }
}

function globalSearch(searchTerm) {
    // Search across all sections
    searchServices(searchTerm);
    searchPackages(searchTerm);
    searchInventory(searchTerm);
    
    // Clear section-specific search inputs
    const serviceSearchInput = document.getElementById('serviceSearchInput');
    const packageSearchInput = document.getElementById('packageSearchInput');
    const inventorySearchInput = document.getElementById('inventorySearchInput');
    
    if (serviceSearchInput) serviceSearchInput.value = '';
    if (packageSearchInput) packageSearchInput.value = '';
    if (inventorySearchInput) inventorySearchInput.value = '';
    
    // If searching, show results count in each tab
    if (searchTerm !== '') {
        updateTabResultCounts(searchTerm);
    } else {
        clearTabResultCounts();
    }
}

function updateTabResultCounts(searchTerm) {
    // Count visible items in each section
    const visibleServices = document.querySelectorAll('#servicesGrid .service-card[style*="block"], #servicesGrid .service-card:not([style*="none"])').length;
    const visiblePackages = document.querySelectorAll('#packagesGrid .package-card[style*="block"], #packagesGrid .package-card:not([style*="none"])').length;
    const visibleInventory = document.querySelectorAll('#inventoryGrid .inventory-card[style*="block"], #inventoryGrid .inventory-card:not([style*="none"])').length;
    
    // Update button text with counts
    const serviceBtn = document.getElementById('individualServicesBtn');
    const packageBtn = document.getElementById('packagesBtn');
    const inventoryBtn = document.getElementById('inventoryBtn');
    
    if (serviceBtn) {
        serviceBtn.innerHTML = `<i class="fas fa-list"></i> Individual Services (${visibleServices})`;
    }
    if (packageBtn) {
        packageBtn.innerHTML = `<i class="fas fa-box"></i> Service Packages (${visiblePackages})`;
    }
    if (inventoryBtn) {
        inventoryBtn.innerHTML = `<i class="fas fa-boxes"></i> Inventory Items (${visibleInventory})`;
    }
}

function clearTabResultCounts() {
    // Reset button text to original
    const serviceBtn = document.getElementById('individualServicesBtn');
    const packageBtn = document.getElementById('packagesBtn');
    const inventoryBtn = document.getElementById('inventoryBtn');
    
    if (serviceBtn) {
        serviceBtn.innerHTML = `<i class="fas fa-list"></i> Individual Services`;
    }
    if (packageBtn) {
        packageBtn.innerHTML = `<i class="fas fa-box"></i> Service Packages`;
    }
    if (inventoryBtn) {
        inventoryBtn.innerHTML = `<i class="fas fa-boxes"></i> Inventory Items`;
    }
}

function clearGlobalSearch() {
    const searchInput = document.getElementById('globalSearchInput');
    if (searchInput) {
        searchInput.value = '';
        globalSearch('');
    }
    
    // Clear all section searches too
    clearServiceSearch();
    clearPackageSearch();
    clearInventorySearch();
}

// Pagination functionality
let currentPages = {
    services: 1,
    packages: 1,
    inventory: 1
};

const itemsPerPage = {
    services: 6,
    packages: 4,
    inventory: 6
};

function initializePagination() {
    // Only show pagination on mobile
    if (window.innerWidth <= 768) {
        initializeServicesPagination();
        initializePackagesPagination();
        initializeInventoryPagination();
    }
    
    // Listen for window resize
    window.addEventListener('resize', function() {
        if (window.innerWidth <= 768) {
            document.querySelectorAll('.pagination-container').forEach(container => {
                container.style.display = 'block';
            });
            updateAllPagination();
        } else {
            document.querySelectorAll('.pagination-container').forEach(container => {
                container.style.display = 'none';
            });
            showAllItems();
        }
    });
}

function initializeServicesPagination() {
    const serviceCards = document.querySelectorAll('#servicesGrid .service-card');
    const totalPages = Math.ceil(serviceCards.length / itemsPerPage.services);
    updatePaginationDisplay('services', serviceCards.length, totalPages);
    showServicesPage(1);
}

function initializePackagesPagination() {
    const packageCards = document.querySelectorAll('#packagesGrid .package-card');
    const totalPages = Math.ceil(packageCards.length / itemsPerPage.packages);
    updatePaginationDisplay('packages', packageCards.length, totalPages);
    showPackagesPage(1);
}

function initializeInventoryPagination() {
    const inventoryCards = document.querySelectorAll('#inventoryGrid .inventory-card');
    const totalPages = Math.ceil(inventoryCards.length / itemsPerPage.inventory);
    updatePaginationDisplay('inventory', inventoryCards.length, totalPages);
    showInventoryPage(1);
}

function showServicesPage(page) {
    const serviceCards = document.querySelectorAll('#servicesGrid .service-card');
    const totalPages = Math.ceil(serviceCards.length / itemsPerPage.services);
    
    if (page < 1) page = 1;
    if (page > totalPages) page = totalPages;
    
    currentPages.services = page;
    
    const startIndex = (page - 1) * itemsPerPage.services;
    const endIndex = startIndex + itemsPerPage.services;
    
    serviceCards.forEach((card, index) => {
        if (index >= startIndex && index < endIndex) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
    
    updatePaginationDisplay('services', serviceCards.length, totalPages);
}

function showPackagesPage(page) {
    const packageCards = document.querySelectorAll('#packagesGrid .package-card');
    const totalPages = Math.ceil(packageCards.length / itemsPerPage.packages);
    
    if (page < 1) page = 1;
    if (page > totalPages) page = totalPages;
    
    currentPages.packages = page;
    
    const startIndex = (page - 1) * itemsPerPage.packages;
    const endIndex = startIndex + itemsPerPage.packages;
    
    packageCards.forEach((card, index) => {
        if (index >= startIndex && index < endIndex) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
    
    updatePaginationDisplay('packages', packageCards.length, totalPages);
}

function showInventoryPage(page) {
    const inventoryCards = document.querySelectorAll('#inventoryGrid .inventory-card');
    const totalPages = Math.ceil(inventoryCards.length / itemsPerPage.inventory);
    
    if (page < 1) page = 1;
    if (page > totalPages) page = totalPages;
    
    currentPages.inventory = page;
    
    const startIndex = (page - 1) * itemsPerPage.inventory;
    const endIndex = startIndex + itemsPerPage.inventory;
    
    inventoryCards.forEach((card, index) => {
        if (index >= startIndex && index < endIndex) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
    
    updatePaginationDisplay('inventory', inventoryCards.length, totalPages);
}

function updatePaginationDisplay(section, totalItems, totalPages) {
    const infoElement = document.getElementById(`${section}PaginationInfo`);
    const pagesElement = document.getElementById(`${section}PaginationPages`);
    const prevBtn = document.getElementById(`${section}PrevBtn`);
    const nextBtn = document.getElementById(`${section}NextBtn`);
    
    if (infoElement && totalItems > 0) {
        const currentPage = currentPages[section];
        const startItem = (currentPage - 1) * itemsPerPage[section] + 1;
        const endItem = Math.min(currentPage * itemsPerPage[section], totalItems);
        
        infoElement.textContent = `Showing ${startItem}-${endItem} of ${totalItems} items`;
        
        if (pagesElement) {
            pagesElement.textContent = `Page ${currentPage} of ${totalPages}`;
        }
        
        if (prevBtn) {
            prevBtn.disabled = currentPage <= 1;
        }
        
        if (nextBtn) {
            nextBtn.disabled = currentPage >= totalPages;
        }
    }
}

function changeServicesPage(direction) {
    const newPage = currentPages.services + direction;
    showServicesPage(newPage);
}

function changePackagesPage(direction) {
    const newPage = currentPages.packages + direction;
    showPackagesPage(newPage);
}

function changeInventoryPage(direction) {
    const newPage = currentPages.inventory + direction;
    showInventoryPage(newPage);
}

function showAllItems() {
    // Show all items when not on mobile
    document.querySelectorAll('.service-card, .package-card, .inventory-card').forEach(card => {
        card.style.display = 'block';
    });
}

function updateAllPagination() {
    if (window.innerWidth <= 768) {
        initializeServicesPagination();
        initializePackagesPagination();
        initializeInventoryPagination();
    }
}

// Mobile summary functionality
function initializeMobileSummary() {
    // Update mobile summary when order changes
    updateMobileSummary();
    
    // Ensure mobile summary is visible on mobile devices
    const mobileOrderSummary = document.getElementById('mobileOrderSummary');
    if (mobileOrderSummary && window.innerWidth <= 768) {
        mobileOrderSummary.style.display = 'block';
    }
}

function toggleMobileSummary() {
    const content = document.getElementById('mobileSummaryContent');
    const icon = document.getElementById('mobileSummaryIcon');
    
    if (content.classList.contains('show')) {
        content.classList.remove('show');
        icon.className = 'fas fa-chevron-up';
    } else {
        content.classList.add('show');
        icon.className = 'fas fa-chevron-down';
    }
}

function updateMobileSummary() {
    // Update mobile summary with current selections
    const mobileTitle = document.getElementById('mobileSummaryTitle');
    const mobilePreview = document.getElementById('mobileSummaryPreview');
    const mobileTotalAmount = document.getElementById('mobileTotalAmount');
    const mobileSelectedServices = document.getElementById('mobileSelectedServices');
    const mobileSummaryTotals = document.getElementById('mobileSummaryTotals');
    
    const totalItems = selectedServices.length + (selectedPackage ? 1 : 0) + selectedInventoryItems.length;
    const totalAmount = calculateTotalAmount();
    
    if (totalItems > 0) {
        mobileTitle.textContent = `Order Summary (${totalItems} items)`;
        mobilePreview.textContent = `${totalItems} item${totalItems > 1 ? 's' : ''} selected`;
        mobileTotalAmount.textContent = `KES ${totalAmount.toFixed(2)}`;
        
        // Update detailed mobile summary
        updateMobileDetailedSummary();
        mobileSummaryTotals.style.display = 'block';
    } else {
        mobileTitle.textContent = 'Order Summary';
        mobilePreview.textContent = 'No items selected';
        mobileTotalAmount.textContent = 'KES 0';
        mobileSelectedServices.innerHTML = '<div class="text-muted text-center py-3">No items selected</div>';
        mobileSummaryTotals.style.display = 'none';
    }
}

function updateMobileDetailedSummary() {
    const container = document.getElementById('mobileSelectedServices');
    const subtotalElement = document.getElementById('mobileSubtotalAmount');
    const taxElement = document.getElementById('mobileTaxAmount');
    const totalElement = document.getElementById('mobileTotalAmountDetail');
    const durationElement = document.getElementById('mobileEstimatedDuration');
    
    let html = '';
    let subtotal = 0;
    let totalDuration = 0;
    
    // Add selected services
    selectedServices.forEach(service => {
        html += `
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                <div>
                    <div class="fw-medium">${service.name}</div>
                    <small class="text-muted">${service.duration} min</small>
                </div>
                <div>KES ${service.price.toFixed(2)}</div>
            </div>
        `;
        subtotal += service.price;
        totalDuration += service.duration;
    });
    
    // Add selected package
    if (selectedPackage) {
        html += `
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                <div>
                    <div class="fw-medium">${selectedPackage.name}</div>
                    <small class="text-muted">Package - ${selectedPackage.duration} min</small>
                </div>
                <div>KES ${selectedPackage.price.toFixed(2)}</div>
            </div>
        `;
        subtotal += selectedPackage.price;
        totalDuration += selectedPackage.duration;
    }
    
    // Add selected inventory items
    selectedInventoryItems.forEach(item => {
        html += `
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                <div>
                    <div class="fw-medium">${item.name}</div>
                    <small class="text-muted">Qty: ${item.quantity}</small>
                </div>
                <div>KES ${(item.price * item.quantity).toFixed(2)}</div>
            </div>
        `;
        subtotal += item.price * item.quantity;
    });
    
    container.innerHTML = html;
    
    // Update totals
    const tax = subtotal * 0.16;
    const total = subtotal + tax;
    
    if (subtotalElement) subtotalElement.textContent = `KES ${subtotal.toFixed(2)}`;
    if (taxElement) taxElement.textContent = `KES ${tax.toFixed(2)}`;
    if (totalElement) totalElement.textContent = `KES ${total.toFixed(2)}`;
    if (durationElement) durationElement.textContent = totalDuration;
}

function calculateTotalAmount() {
    let total = 0;
    
    selectedServices.forEach(service => {
        total += service.price;
    });
    
    if (selectedPackage) {
        total += selectedPackage.price;
    }
    
    selectedInventoryItems.forEach(item => {
        total += item.price * item.quantity;
    });
    
    return total * 1.16; // Including 16% VAT
}

function toggleService(serviceId) {
    // Check if vehicle skip is enabled
    const skipVehicleCheckbox = document.getElementById('skipVehicleCheckbox');
    const skipVehicle = skipVehicleCheckbox && skipVehicleCheckbox.value === 'true';
    
    const serviceCard = document.querySelector(`[data-service-id="${serviceId}"]`);
    const isSelected = serviceCard.classList.contains('selected');
    
    if (!isSelected && skipVehicle) {
        // Prevent selecting services when vehicle is skipped
        showToast('Cannot select services when vehicle registration is skipped. Enable vehicle registration or select inventory items only.', 'warning');
        return;
    }
    
    if (isSelected) {
        // Remove service
        serviceCard.classList.remove('selected');
        selectedServices = selectedServices.filter(s => s.id !== serviceId);
    } else {
        // Add service
        serviceCard.classList.add('selected');
        
        // Get service data from the card
        const serviceName = serviceCard.querySelector('.service-name').textContent;
        const servicePriceText = serviceCard.querySelector('.service-price').textContent;
        const servicePrice = parseFloat(servicePriceText.replace(/[^0-9.]/g, ''));
        const serviceDuration = parseInt(serviceCard.querySelector('.service-duration').textContent);
        
        selectedServices.push({
            id: serviceId,
            name: serviceName,
            price: servicePrice,
            duration: serviceDuration
        });
    }
    
    updateOrderSummary();
}

function togglePackage(packageId) {
    // Check if vehicle skip is enabled
    const skipVehicleCheckbox = document.getElementById('skipVehicleCheckbox');
    const skipVehicle = skipVehicleCheckbox && skipVehicleCheckbox.value === 'true';
    
    const packageCard = document.querySelector(`[data-package-id="${packageId}"]`);
    const isSelected = packageCard.classList.contains('selected');
    
    if (!isSelected && skipVehicle) {
        // Prevent selecting packages when vehicle is skipped
        showToast('Cannot select service packages when vehicle registration is skipped. Enable vehicle registration or select inventory items only.', 'warning');
        return;
    }
    
    // Clear all other package selections (only one package can be selected)
    document.querySelectorAll('.package-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    if (isSelected) {
        // Deselect package
        selectedPackage = null;
    } else {
        // Select package
        packageCard.classList.add('selected');
        
        // Get package data from the card
        const packageName = packageCard.querySelector('.package-name').textContent;
        const packagePriceText = packageCard.querySelector('.package-price').textContent;
        const packagePrice = parseFloat(packagePriceText.replace(/[^0-9.]/g, ''));
        const packageDuration = parseInt(packageCard.querySelector('.package-duration').textContent);
        const servicesCount = parseInt(packageCard.querySelector('.package-services-count').textContent);
        
        selectedPackage = {
            id: packageId,
            name: packageName,
            price: packagePrice,
            duration: packageDuration,
            servicesCount: servicesCount
        };
    }
    
    updateOrderSummary();
}

function clearAllServices() {
    selectedServices = [];
    selectedPackage = null;
    selectedInventoryItems = [];
    
    // Clear service selections
    document.querySelectorAll('.service-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Clear package selections
    document.querySelectorAll('.package-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Clear inventory selections and reset quantities
    document.querySelectorAll('.inventory-card').forEach(card => {
        card.classList.remove('selected');
        const quantityInput = card.querySelector('.inventory-quantity-input');
        if (quantityInput) {
            quantityInput.value = 0;
        }
    });
    
    updateOrderSummary();
}

// Review Step
function updateReviewStep() {
    // Update customer info - handle walk-in, selected, and vehicle customers
    let customerInfo = '';
    const isWalkIn = document.getElementById('isWalkInCustomer').value === 'true';
    
    if (isWalkIn) {
        customerInfo = `<div class="alert alert-warning"><i class="fas fa-walking me-2"></i><strong>Walk-in Customer</strong><br><small>No registration required</small></div>`;
    } else if (vehicleCustomer) {
        customerInfo = `<div class="alert alert-info"><i class="fas fa-car me-2"></i><strong>${vehicleCustomer.full_name || vehicleCustomer.name}</strong><br><small>Phone: ${vehicleCustomer.phone}</small><br><small>ID: ${vehicleCustomer.customer_id}</small><br><small class="text-muted">Vehicle Owner</small></div>`;
    } else if (selectedCustomer) {
        customerInfo = `<strong>${selectedCustomer.name}</strong><br><small>Phone: ${selectedCustomer.phone}</small><br><small>ID: ${selectedCustomer.customerId}</small>`;
    } else {
        const customerName = document.getElementById('customerName').value.trim();
        const customerPhone = document.getElementById('customerPhone').value.trim();
        if (customerName || customerPhone) {
            customerInfo = `<strong>${customerName || 'New Customer'}</strong><br><small>Phone: ${customerPhone || 'Not provided'}</small><br><small class="text-muted">New Registration</small>`;
        } else {
            customerInfo = `<div class="text-muted">No customer information</div>`;
        }
    }
    document.getElementById('reviewCustomerInfo').innerHTML = customerInfo;
    
    // Update vehicle info
    let vehicleInfo = '';
    if (selectedVehicle) {
        vehicleInfo = `<strong>${selectedVehicle.registration}</strong><br><small>${selectedVehicle.make} ${selectedVehicle.model}</small><br><small>Color: ${selectedVehicle.color}</small>`;
        if (selectedVehicle.customerName) {
            vehicleInfo += `<br><small class="text-muted">Owner: ${selectedVehicle.customerName}</small>`;
        }
    } else {
        const registration = document.getElementById('vehicleRegistration').value.trim();
        const make = document.getElementById('vehicleMake').value.trim();
        const model = document.getElementById('vehicleModel').value.trim();
        const color = document.getElementById('vehicleColor').value.trim();
        if (registration || make || model) {
            vehicleInfo = `<strong>${registration || 'New Vehicle'}</strong><br><small>${make} ${model}</small><br><small>Color: ${color}</small><br><small class="text-muted">New Registration</small>`;
        } else {
            vehicleInfo = `<div class="text-muted">No vehicle information</div>`;
        }
    }
    document.getElementById('reviewVehicleInfo').innerHTML = vehicleInfo;
    
    // Update services and inventory info
    let servicesHtml = '';
    let inventoryHtml = '';
    let totalInclusiveVAT = 0;
    let totalDuration = 0;
    
    // Show package if selected
    if (selectedPackage) {
        servicesHtml += `<div class="d-flex justify-content-between"><span><strong>${selectedPackage.name}</strong> (Package)</span><span>KES ${selectedPackage.price.toFixed(2)}</span></div>`;
        totalInclusiveVAT += selectedPackage.price;
        totalDuration += selectedPackage.duration;
    }
    
    // Show individual services if selected
    if (selectedServices && selectedServices.length > 0) {
        selectedServices.forEach(service => {
            servicesHtml += `<div class="d-flex justify-content-between"><span><i class="fas fa-tools me-2"></i>${service.name}</span><span>KES ${service.price.toFixed(2)}</span></div>`;
            totalInclusiveVAT += service.price;
            totalDuration += service.duration;
        });
    }
    
    // Show inventory items if selected
    if (selectedInventoryItems && selectedInventoryItems.length > 0) {
        selectedInventoryItems.forEach(item => {
            const itemTotal = item.price * item.quantity;
            inventoryHtml += `<div class="d-flex justify-content-between"><span><i class="fas fa-box me-2"></i>${item.name} (Qty: ${item.quantity})</span><span>KES ${itemTotal.toFixed(2)}</span></div>`;
            totalInclusiveVAT += itemTotal;
        });
    }
    
    // Update services section visibility and content
    const servicesSection = document.getElementById('reviewServicesSection');
    const servicesInfo = document.getElementById('reviewServicesInfo');
    if (servicesHtml) {
        servicesSection.style.display = 'block';
        servicesInfo.innerHTML = servicesHtml;
    } else {
        servicesSection.style.display = 'none';
    }
    
    // Update inventory section visibility and content
    const inventorySection = document.getElementById('reviewInventorySection');
    const inventoryInfo = document.getElementById('reviewInventoryInfo');
    if (inventoryHtml) {
        inventorySection.style.display = 'block';
        inventoryInfo.innerHTML = inventoryHtml;
    } else {
        inventorySection.style.display = 'none';
    }
    
    // Update total info with inclusive VAT
    if (totalInclusiveVAT > 0) {
        const taxAmount = totalInclusiveVAT * 0.16 / 1.16; // Extract VAT from inclusive price
        const subtotalExVAT = totalInclusiveVAT - taxAmount; // Subtotal without VAT
        
        document.getElementById('reviewTotalInfo').innerHTML = `
            <div class="d-flex justify-content-between"><span>Subtotal (ex VAT):</span><span>KES ${subtotalExVAT.toFixed(2)}</span></div>
            <div class="d-flex justify-content-between"><span>VAT (16%):</span><span>KES ${taxAmount.toFixed(2)}</span></div>
            <hr>
            <div class="d-flex justify-content-between"><strong><span>Total (incl VAT):</span><span>KES ${totalInclusiveVAT.toFixed(2)}</span></strong></div>
            <div class="d-flex justify-content-between text-muted"><small><span>Estimated Duration:</span><span>${totalDuration} minutes</span></small></div>
        `;
    } else {
        document.getElementById('reviewTotalInfo').innerHTML = '<div class="text-muted">No items selected</div>';
    }
}

// Form Submission
function submitOrder() {
    // Validate that we have all required data
    if (!validateAllSteps()) {
        showToast('Please complete all required fields', 'error');
        return;
    }
    
    const form = document.getElementById('quickOrderForm');
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Order...';
    submitBtn.disabled = true;
    
    try {
        // Prepare form data
        const formData = new FormData();
        
        // Add CSRF token with multiple fallbacks
        const csrfToken = getCSRFToken();
        if (!csrfToken) {
            throw new Error('CSRF token not found. Please refresh the page.');
        }
        
        console.log('Using CSRF token:', csrfToken.substring(0, 10) + '...');
        
        // Check if vehicle skip is enabled
        const skipVehicleCheckbox = document.getElementById('skipVehicleCheckbox');
        const skipVehicle = skipVehicleCheckbox && skipVehicleCheckbox.value === 'true';
        
        // Add skip vehicle flag
        formData.set('skip_vehicle', skipVehicle ? 'true' : 'false');
        
        // Vehicle data (only if not skipping vehicle)
        if (!skipVehicle) {
            if (selectedVehicle) {
                formData.set('selected_vehicle_id', selectedVehicle.id);
            } else {
                const vehicleRegistration = document.getElementById('vehicleRegistration').value.trim().toUpperCase();
                const vehicleMake = document.getElementById('vehicleMake').value.trim();
                const vehicleModel = document.getElementById('vehicleModel').value.trim();
                const vehicleColor = document.getElementById('vehicleColor').value.trim();
                const vehicleType = document.getElementById('vehicleType').value;
                const vehicleYear = document.getElementById('vehicleYear').value;
                
                if (!vehicleRegistration) {
                    throw new Error('Vehicle registration number is required');
                }
                
                formData.set('vehicle_registration', vehicleRegistration);
                formData.set('vehicle_make', vehicleMake || 'Unknown');
                formData.set('vehicle_model', vehicleModel || 'Unknown');
                formData.set('vehicle_color', vehicleColor || 'Unknown');
                formData.set('vehicle_type', vehicleType || 'car');
                formData.set('vehicle_year', vehicleYear || '2020');
            }
        }

        // Customer data (automatically set to walk-in if vehicle is skipped)
        const isWalkIn = skipVehicle ? true : (document.getElementById('isWalkInCustomer').value === 'true');
        formData.set('is_walk_in_customer', isWalkIn);
        
        if (!skipVehicle && selectedCustomer) {
            formData.set('selected_customer_id', selectedCustomer.id);
        } else if (!skipVehicle && !isWalkIn) {
            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const customerEmail = document.getElementById('customerEmail').value.trim();
            
            if (customerName || customerPhone) {
                formData.set('customer_name', customerName);
                formData.set('customer_phone', customerPhone);
                formData.set('customer_email', customerEmail);
                
                // Check if vehicle should be added to customer
                if (document.getElementById('addVehicleToCustomer').checked) {
                    formData.set('add_vehicle_to_customer', 'on');
                }
            }
        }
        
        // Service selection data
        const selectedServicesDataElement = document.getElementById('selectedServicesData');
        const selectedServicesDataValue = selectedServicesDataElement ? selectedServicesDataElement.value : '';
        console.log('Raw selectedServicesData value:', selectedServicesDataValue);
        
        const selectionData = JSON.parse(selectedServicesDataValue || '{}');
        console.log('Parsed selection data:', selectionData);
        
        if (selectionData.type === 'package' && selectionData.package_id) {
            formData.set('service_type', 'package');
            formData.set('selected_package', selectionData.package_id);
        } else if (selectionData.type === 'individual' && selectionData.service_ids && selectionData.service_ids.length > 0) {
            formData.set('service_type', 'individual');
            selectionData.service_ids.forEach(serviceId => {
                formData.append('selected_services', serviceId);
            });
        } else if (selectionData.type === 'inventory' && selectionData.inventory_items && selectionData.inventory_items.length > 0) {
            formData.set('service_type', 'inventory');
            selectionData.inventory_items.forEach(item => {
                formData.append('selected_inventory_items', item.id);
                formData.append(`inventory_quantity_${item.id}`, item.quantity);
            });
        } else if (selectionData.type === 'mixed') {
            formData.set('service_type', 'mixed');
            if (selectionData.service_ids && selectionData.service_ids.length > 0) {
                selectionData.service_ids.forEach(serviceId => {
                    formData.append('selected_services', serviceId);
                });
            }
            if (selectionData.inventory_items && selectionData.inventory_items.length > 0) {
                selectionData.inventory_items.forEach(item => {
                    formData.append('selected_inventory_items', item.id);
                    formData.append(`inventory_quantity_${item.id}`, item.quantity);
                });
            }
        } else {
            throw new Error('Please select at least one service, package, or inventory item');
        }
        
        // Additional order details
        formData.set('special_instructions', document.getElementById('specialInstructions').value.trim());
        formData.set('priority', document.getElementById('priority').value);
        
        // Log the data being sent (for debugging)
        console.log('Submitting order with data:', Object.fromEntries(formData.entries()));
        
        // Function to make the actual request
        const makeRequest = (token) => {
            return fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': token,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'  // Important for CSRF
            });
        };
        
        // Make the request with CSRF retry logic
        makeRequest(csrfToken)
        .then(async (response) => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            // If CSRF failure, try to refresh token and retry once
            if (response.status === 403) {
                const responseText = await response.text();
                if (responseText.includes('CSRF') || responseText.includes('csrf')) {
                    console.log('CSRF error detected, attempting to refresh token...');
                    try {
                        const newToken = await refreshCSRFToken();
                        if (newToken) {
                            // Update formData with new token
                            formData.set('csrfmiddlewaretoken', newToken);
                            console.log('Retrying request with new CSRF token...');
                            return makeRequest(newToken);
                        }
                    } catch (refreshError) {
                        console.error('Failed to refresh CSRF token:', refreshError);
                        throw new Error('CSRF token expired. Please refresh the page and try again.');
                    }
                }
            }
            
            return response;
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            // Check if response is ok
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Server did not return JSON response');
            }
            
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            
            if (data.success) {
                showToast('Order created successfully!', 'success');
                
                // Start checking payment status for walk-in customers with M-Pesa
                if (data.order_id) {
                    checkPaymentStatus(data.order_id);
                }
                
                // Redirect after a short delay
                setTimeout(() => {
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    } else {
                        // Fallback redirect
                        window.location.href = `/business/{{ request.tenant.slug }}/services/orders/${data.order_id}/`;
                    }
                }, 1500);
            } else {
                // Handle server-side validation errors
                showToast(data.message || 'Error creating order', 'error');
                
                // Show field-specific errors if available
                if (data.errors) {
                    console.log('Form errors:', data.errors);
                    displayFormErrors(data.errors);
                }
            }
        })
        .catch(error => {
            console.error('Order creation error:', error);
            
            let errorMessage = 'Error creating order. Please try again.';
            
            if (error.message.includes('CSRF') || error.message.includes('csrf')) {
                errorMessage = 'Security token expired. Please refresh the page and try again.';
                // Add a refresh button to the error message
                showToast(`${errorMessage} <button onclick="window.location.reload()" class="btn btn-sm btn-outline-light ms-2">Refresh Page</button>`, 'error');
                return; // Don't show the generic toast
            } else if (error.message.includes('HTTP 500')) {
                errorMessage = 'Server error. Please contact support if this persists.';
            } else if (error.message.includes('HTTP 403')) {
                errorMessage = 'Access denied. Please check your permissions and try again.';
            } else if (error.message.includes('HTTP 404')) {
                errorMessage = 'Service not found. Please refresh the page.';
            } else if (error.message.includes('Network')) {
                errorMessage = 'Network error. Please check your connection.';
            }
            
            showToast(errorMessage, 'error');
        })
        .finally(() => {
            // Restore button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
        
    } catch (error) {
        console.error('Form preparation error:', error);
        showToast(error.message || 'Error preparing order data', 'error');
        
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

function validateAllSteps() {
    // Check if vehicle skip is enabled
    const skipVehicleCheckbox = document.getElementById('skipVehicleCheckbox');
    const skipVehicle = skipVehicleCheckbox && skipVehicleCheckbox.value === 'true';
    
    console.log('validateAllSteps debug:', {
        skipVehicle,
        selectedPackage: !!selectedPackage,
        selectedServices: selectedServices.length,
        selectedInventoryItems: selectedInventoryItems.length,
        selectedServicesData: document.getElementById('selectedServicesData').value
    });
    
    // If skipping vehicle, validate that only inventory items are selected
    if (skipVehicle) {
        const hasServices = selectedServices.length > 0;
        const hasPackage = selectedPackage !== null;
        const hasInventoryItems = selectedInventoryItems.length > 0;
        
        if (hasServices || hasPackage) {
            console.log('Validation failed: services selected but vehicle skipped');
            return false;
        }
        
        if (!hasInventoryItems) {
            console.log('Validation failed: no inventory items selected');
            return false;
        }
        
        console.log('Vehicle skipped - inventory-only validation passed');
        return true;
    }
    
    // Vehicle not skipped - normal validation
    
    // Validate customer - check if walk-in is selected or vehicle customer is loaded
    const isWalkIn = document.getElementById('isWalkInCustomer').value === 'true';
    
    if (!isWalkIn && !selectedCustomer && !vehicleCustomer) {
        const name = document.getElementById('customerName').value.trim();
        const phone = document.getElementById('customerPhone').value.trim();
        if (!name || !phone) {
            console.log('Validation failed: customer info missing');
            return false;
        }
    }
    
    // Validate vehicle - only registration is required
    if (!selectedVehicle) {
        const registration = document.getElementById('vehicleRegistration').value.trim();
        
        if (!registration) {
            console.log('Validation failed: vehicle registration missing');
            return false;
        }
    }
    
    // Validate services/items
    const hasPackage = selectedPackage !== null;
    const hasServices = selectedServices.length > 0;
    const hasInventoryItems = selectedInventoryItems.length > 0;
    
    if (!hasPackage && !hasServices && !hasInventoryItems) {
        console.log('Validation failed: no selections made');
        return false;
    }
    
    console.log('All validations passed');
    return true;
}

function displayFormErrors(errors) {
    // Clear previous errors
    document.querySelectorAll('.form-control').forEach(field => {
        field.classList.remove('is-invalid');
    });
    document.querySelectorAll('.invalid-feedback').forEach(el => el.remove());
    
    // Display new errors
    Object.keys(errors).forEach(fieldName => {
        const fieldErrors = errors[fieldName];
        if (fieldErrors && fieldErrors.length > 0) {
            // Try to find the form field
            let field = document.querySelector(`[name="${fieldName}"]`);
            if (!field) {
                // Try alternative field names
                const fieldMappings = {
                    'customer_name': 'customerName',
                    'customer_phone': 'customerPhone',
                    'vehicle_registration': 'vehicleRegistration',
                    'vehicle_make': 'vehicleMake',
                    'vehicle_model': 'vehicleModel',
                    'vehicle_color': 'vehicleColor',
                    'vehicle_type': 'vehicleType'
                };
                field = document.getElementById(fieldMappings[fieldName]);
            }
            
            if (field) {
                field.classList.add('is-invalid');
                
                // Add error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'invalid-feedback';
                errorDiv.textContent = fieldErrors[0];
                field.parentNode.appendChild(errorDiv);
            }
        }
    });
}

// Enhanced CSRF token getter with multiple fallbacks
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Robust CSRF token getter with multiple fallbacks and refresh capability
function getCSRFToken() {
    // First, try to get from form
    const formToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (formToken && formToken.value) {
        console.log('CSRF token from form:', formToken.value.substring(0, 10) + '...');
        return formToken.value;
    }
    
    // Second, try to get from cookie
    const cookieToken = getCookie('csrftoken') || getCookie('autowash_csrftoken');
    if (cookieToken) {
        console.log('CSRF token from cookie:', cookieToken.substring(0, 10) + '...');
        return cookieToken;
    }
    
    // Third, try meta tag
    const metaToken = document.querySelector('meta[name="csrf-token"]');
    if (metaToken) {
        console.log('CSRF token from meta:', metaToken.getAttribute('content').substring(0, 10) + '...');
        return metaToken.getAttribute('content');
    }
    
    console.error('No CSRF token found in form, cookie, or meta tag');
    return null;
}

// Function to refresh CSRF token
function refreshCSRFToken() {
    return fetch(window.location.href, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(html => {
        // Extract new CSRF token from response
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newToken = doc.querySelector('[name=csrfmiddlewaretoken]');
        
        if (newToken) {
            // Update form token
            const currentFormToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (currentFormToken) {
                currentFormToken.value = newToken.value;
                console.log('CSRF token refreshed');
                return newToken.value;
            }
        }
        throw new Error('Could not refresh CSRF token');
    });
}

// Initialize page and token refresh
document.addEventListener('DOMContentLoaded', function() {
    console.log('Quick Order form initialized');
    
    // Check CSRF token on page load
    const initialToken = getCSRFToken();
    if (!initialToken) {
        console.warn('No CSRF token found on page load');
        showToast('Security token missing. Please refresh the page.', 'warning');
    } else {
        console.log('Initial CSRF token verified');
    }
    
    // Refresh CSRF token every 10 minutes to prevent expiry
    setInterval(() => {
        refreshCSRFToken().then(() => {
            console.log('CSRF token auto-refreshed');
        }).catch(error => {
            console.warn('Auto CSRF refresh failed:', error);
        });
    }, 600000); // 10 minutes
    
    // Also refresh token when page becomes visible again (user returns to tab)
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            refreshCSRFToken().then(() => {
                console.log('CSRF token refreshed on page focus');
            }).catch(error => {
                console.warn('CSRF refresh on focus failed:', error);
            });
        }
    });
});

// Enhanced toast with better positioning and styling
function showToast(message, type) {
    // Remove existing toasts
    document.querySelectorAll('.toast-notification').forEach(toast => toast.remove());
    
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    
    const iconMap = {
        'success': 'check-circle',
        'error': 'exclamation-triangle',
        'warning': 'exclamation-circle',
        'info': 'info-circle'
    };
    
    const colorMap = {
        'success': '#10b981',
        'error': '#ef4444',
        'warning': '#f59e0b',
        'info': '#06b6d4'
    };
    
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas fa-${iconMap[type] || 'info-circle'}"></i>
            <span>${message}</span>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Apply styles
    toast.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        z-index: 9999;
        min-width: 300px;
        max-width: 500px;
        animation: slideInRight 0.3s ease-out;
        border-left: 4px solid ${colorMap[type] || colorMap.info};
    `;
    
    const content = toast.querySelector('.toast-content');
    content.style.cssText = `
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: #374151;
    `;
    
    const icon = content.querySelector('i');
    icon.style.color = colorMap[type] || colorMap.info;
    
    const closeBtn = toast.querySelector('.toast-close');
    closeBtn.style.cssText = `
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 0.375rem;
        transition: color 0.15s ease-in-out;
    `;
    
    closeBtn.addEventListener('mouseenter', () => {
        closeBtn.style.color = '#374151';
    });
    
    closeBtn.addEventListener('mouseleave', () => {
        closeBtn.style.color = '#9ca3af';
    });
    
    document.body.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
}

// Add CSS animations
if (!document.getElementById('toast-animations')) {
    const style = document.createElement('style');
    style.id = 'toast-animations';
    style.textContent = `
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideOutRight {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        .invalid-feedback {
            display: block;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875rem;
            color: #ef4444;
        }
        .form-control.is-invalid {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }
    `;
    document.head.appendChild(style);
}
// Auto-search as user types
document.getElementById('customerSearchInput').addEventListener('input', function() {
    clearTimeout(this.searchTimeout);
    this.searchTimeout = setTimeout(() => {
        if (this.value.length >= 2) {
            searchCustomers();
        }
    }, 300);
});

document.getElementById('vehicleSearchInput').addEventListener('input', function() {
    clearTimeout(this.searchTimeout);
    this.searchTimeout = setTimeout(() => {
        if (this.value.length >= 2) {
            searchVehiclesByRegistration();
        } else {
            document.getElementById('vehicleSearchResults').style.display = 'none';
        }
    }, 300);
});

// Phone number formatting
document.getElementById('customerPhone').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    
    if (value.startsWith('0')) {
        value = '254' + value.substring(1);
    }
    if (value.startsWith('254') && !value.startsWith('+254')) {
        value = '+' + value;
    }
    
    e.target.value = value;
});

// Registration number formatting
document.getElementById('vehicleRegistration').addEventListener('input', function(e) {
    e.target.value = e.target.value.toUpperCase();
});

// Utility functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showToast(message, type) {
    // Remove existing toasts
    document.querySelectorAll('.toast-notification').forEach(toast => toast.remove());
    
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
            <span>${message}</span>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Toast styles
    toast.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: 1rem;
        box-shadow: var(--shadow-lg);
        z-index: 9999;
        min-width: 300px;
        animation: slideInRight 0.3s ease-out;
        border-left: 4px solid ${type === 'success' ? 'var(--success-500)' : type === 'error' ? '#ef4444' : 'var(--info-500)'};
    `;
    
    const content = toast.querySelector('.toast-content');
    content.style.cssText = `
        display: flex;
        align-items: center;
        gap: 0.75rem;
    `;
    
    const closeBtn = toast.querySelector('.toast-close');
    closeBtn.style.cssText = `
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: none;
        border: none;
        color: var(--gray-400);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: var(--radius-sm);
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}

// Check for walk-in customer transaction details
function checkWalkInCustomerTransactions(customerId) {
    // Check if this walk-in customer has recent M-Pesa transactions that could be saved
    fetch(`/business/{{ request.tenant.slug }}/customers/ajax/check-walk-in-transactions/?customer_id=${customerId}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.has_transactions) {
            // Show notification that customer has transaction details available
            showToast(`This walk-in customer has transaction details available. Consider saving their information.`, 'info');
            
            // Optional: Show save suggestion modal if there are recent payments
            if (data.recent_payment) {
                setTimeout(() => {
                    showCustomerSaveModal({
                        payment_id: data.recent_payment.id,
                        customer_phone: data.recent_payment.customer_phone,
                        amount: data.recent_payment.amount
                    });
                }, 2000);
            }
        }
    })
    .catch(error => {
        console.error('Error checking walk-in customer transactions:', error);
    });
}

// Customer Save Notification Functions
function showCustomerSaveModal(paymentData) {
    // Populate transaction details
    const detailsDiv = document.getElementById('transactionCustomerDetails');
    detailsDiv.innerHTML = `
        <div><strong>Phone:</strong> ${paymentData.customer_phone || 'N/A'}</div>
        <div><strong>Amount:</strong> KSh ${paymentData.amount || 'N/A'}</div>
        <div><strong>Transaction:</strong> ${paymentData.payment_id || 'N/A'}</div>
    `;
    
    // Store payment ID for save action
    document.getElementById('saveCustomerBtn').setAttribute('data-payment-id', paymentData.payment_id);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('customerSaveModal'));
    modal.show();
}

// Handle save customer button click
document.getElementById('saveCustomerBtn').addEventListener('click', function() {
    const paymentId = this.getAttribute('data-payment-id');
    if (paymentId) {
        // Redirect to save customer page
        window.location.href = `/customers/save-walk-in/${paymentId}/`;
    }
});

// Function to check for payment completion and show notification
function checkPaymentStatus(orderId) {
    if (!orderId) return;
    
    // Poll for payment completion every 3 seconds
    const checkInterval = setInterval(() => {
        fetch(`/business/{{ request.tenant.slug }}/payments/ajax/status/?order_id=${orderId}`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.payment) {
                if (data.payment.status === 'completed' && data.payment.method === 'mpesa') {
                    // Check if customer is walk-in
                    if (data.payment.customer_is_walk_in && data.payment.customer_phone) {
                        clearInterval(checkInterval);
                        showCustomerSaveModal({
                            payment_id: data.payment.id,
                            customer_phone: data.payment.customer_phone,
                            amount: data.payment.amount
                        });
                    }
                } else if (data.payment.status === 'failed') {
                    clearInterval(checkInterval);
                    showToast('Payment failed. Please try again.', 'error');
                }
            }
        })
        .catch(error => {
            console.error('Error checking payment status:', error);
        });
    }, 3000);
    
    // Stop checking after 5 minutes
    setTimeout(() => {
        clearInterval(checkInterval);
    }, 300000);
}

// Inventory Functions
function showServiceType(type) {
    serviceType = type;
    
    // Update button states
    document.getElementById('individualServicesBtn').classList.toggle('active', type === 'individual');
    document.getElementById('packagesBtn').classList.toggle('active', type === 'packages');
    document.getElementById('inventoryBtn').classList.toggle('active', type === 'inventory');
    
    // Show/hide sections
    document.getElementById('individualServicesSection').style.display = type === 'individual' ? 'block' : 'none';
    document.getElementById('packagesSection').style.display = type === 'packages' ? 'block' : 'none';
    document.getElementById('inventorySection').style.display = type === 'inventory' ? 'block' : 'none';
    
    // Don't clear selections - just maintain current state
    // Users should be able to switch between tabs and keep their selections
    
    updateOrderSummary();
}

function filterInventoryItems(categoryId) {
    // Update active category button
    document.querySelectorAll('.inventory-category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-inventory-category="${categoryId}"]`).classList.add('active');
    
    // Filter inventory cards
    document.querySelectorAll('.inventory-card').forEach(card => {
        const cardCategory = card.dataset.category;
        if (categoryId === 'all' || cardCategory === categoryId) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
    
    // Clear search input when changing categories
    const searchInput = document.getElementById('inventorySearchInput');
    if (searchInput) {
        searchInput.value = '';
    }
}

function selectInventoryCard(itemId) {
    const itemCard = document.querySelector(`[data-item-id="${itemId}"]`);
    const quantityInput = itemCard.querySelector('.inventory-quantity-input');
    const maxStock = parseInt(quantityInput.dataset.maxStock) || 0;
    
    // Don't allow selection if out of stock
    if (maxStock === 0) {
        showToast('This item is out of stock', 'warning');
        return;
    }
    
    const currentQuantity = parseInt(quantityInput.value) || 0;
    
    if (currentQuantity === 0) {
        // Set quantity to 1 when card is clicked and quantity is 0
        quantityInput.value = 1;
        updateInventoryItemSelection(itemId, 1);
    }
}

function updateInventoryQuantity(itemId, change) {
    const quantityInput = document.querySelector(`[data-item-id="${itemId}"] .inventory-quantity-input`);
    const currentQuantity = parseInt(quantityInput.value) || 0;
    const maxStock = parseInt(quantityInput.dataset.maxStock) || 0;
    
    let newQuantity = currentQuantity + change;
    
    // Ensure quantity is within bounds
    newQuantity = Math.max(0, Math.min(newQuantity, maxStock));
    
    quantityInput.value = newQuantity;
    
    // Update inventory item selection
    updateInventoryItemSelection(itemId, newQuantity);
}

function updateInventoryItemSelection(itemId, quantity) {
    const itemCard = document.querySelector(`[data-item-id="${itemId}"]`);
    const itemName = itemCard.querySelector('.service-name').textContent;
    const itemPriceText = itemCard.querySelector('.service-price').textContent;
    const itemPrice = parseFloat(itemPriceText.replace(/[^0-9.]/g, ''));
    
    // Remove existing entry if any
    selectedInventoryItems = selectedInventoryItems.filter(item => item.id !== itemId);
    
    if (quantity > 0) {
        // Add or update inventory item
        itemCard.classList.add('selected');
        selectedInventoryItems.push({
            id: itemId,
            name: itemName,
            price: itemPrice,
            quantity: quantity
        });
    } else {
        // Remove inventory item
        itemCard.classList.remove('selected');
    }
    
    updateOrderSummary();
}

function onInventoryQuantityChange(input, itemId) {
    const quantity = parseInt(input.value) || 0;
    const maxStock = parseInt(input.dataset.maxStock) || 0;
    
    // Ensure quantity is within bounds
    if (quantity > maxStock) {
        input.value = maxStock;
        showToast(`Maximum available quantity is ${maxStock}`, 'warning');
    } else if (quantity < 0) {
        input.value = 0;
    }
    
    updateInventoryItemSelection(itemId, parseInt(input.value));
}

// Update the existing updateOrderSummary function to handle inventory items
function updateOrderSummary() {
    const selectedServicesDisplay = document.getElementById('selectedServicesDisplay');
    const selectedServicesList = document.getElementById('selectedServicesList');
    const summaryTotals = document.getElementById('summaryTotals');
    
    let hasSelection = false;
    let subtotal = 0;
    let totalDuration = 0;
    let servicesHtml = '';
    
    // Determine active type based on what's selected
    let activeType = null;
    if (selectedPackage) {
        activeType = 'package';
    } else if (selectedServices.length > 0 && selectedInventoryItems.length > 0) {
        activeType = 'mixed'; // Both services and inventory
    } else if (selectedServices.length > 0) {
        activeType = 'individual';
    } else if (selectedInventoryItems.length > 0) {
        activeType = 'inventory';
    }
    
    if (activeType === 'package' && selectedPackage) {
        // Package selected
        hasSelection = true;
        subtotal = selectedPackage.price;
        totalDuration = selectedPackage.duration;
        
        servicesHtml = `
            <div class="selected-service-item">
                <div class="service-item-name">${selectedPackage.name} (Package)</div>
                <div class="service-item-price">KES ${selectedPackage.price.toFixed(2)}</div>
            </div>
        `;
    } else if (activeType === 'individual' || activeType === 'mixed') {
        // Individual services selected
        if (selectedServices.length > 0) {
            hasSelection = true;
            selectedServices.forEach(service => {
                subtotal += service.price;
                totalDuration += service.duration;
                servicesHtml += `
                    <div class="selected-service-item">
                        <div class="service-item-name">${service.name}</div>
                        <div class="service-item-price">KES ${service.price.toFixed(2)}</div>
                    </div>
                `;
            });
        }
        
        // Add inventory items if mixed
        if (activeType === 'mixed' || activeType === 'inventory') {
            selectedInventoryItems.forEach(item => {
                hasSelection = true;
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                servicesHtml += `
                    <div class="selected-service-item">
                        <div class="service-item-name">${item.name} (x${item.quantity})</div>
                        <div class="service-item-price">KES ${itemTotal.toFixed(2)}</div>
                    </div>
                `;
            });
        }
    } else if (activeType === 'inventory') {
        // Only inventory items selected
        selectedInventoryItems.forEach(item => {
            hasSelection = true;
            const itemTotal = item.price * item.quantity;
            subtotal += itemTotal;
            servicesHtml += `
                <div class="selected-service-item">
                    <div class="service-item-name">${item.name} (x${item.quantity})</div>
                    <div class="service-item-price">KES ${itemTotal.toFixed(2)}</div>
                </div>
            `;
        });
    }
    
    if (hasSelection) {
        selectedServicesDisplay.style.display = 'none';
        selectedServicesList.style.display = 'block';
        selectedServicesList.innerHTML = servicesHtml;
        
        summaryTotals.style.display = 'block';
        
        const tax = subtotal * 0.16;
        const total = subtotal + tax;
        
        document.getElementById('subtotalAmount').textContent = `KES ${subtotal.toFixed(2)}`;
        document.getElementById('taxAmount').textContent = `KES ${tax.toFixed(2)}`;
        document.getElementById('totalAmount').textContent = `KES ${total.toFixed(2)}`;
        document.getElementById('estimatedDuration').textContent = totalDuration;
    } else {
        selectedServicesDisplay.style.display = 'block';
        selectedServicesList.style.display = 'none';
        summaryTotals.style.display = 'none';
    }
    
    // Update mobile summary
    updateMobileSummary();
    
    // Update selected services data for form submission
    const selectedServicesData = document.getElementById('selectedServicesData');
    if (selectedServicesData) {
        let dataToSubmit = {};
        
        // Determine the correct type and structure
        if (selectedPackage) {
            dataToSubmit = {
                type: 'package',
                package_id: selectedPackage.id
            };
        } else if (selectedServices.length > 0 && selectedInventoryItems.length > 0) {
            dataToSubmit = {
                type: 'mixed',
                service_ids: selectedServices.map(s => s.id),
                inventory_items: selectedInventoryItems.map(item => ({
                    id: item.id,
                    quantity: item.quantity
                }))
            };
        } else if (selectedServices.length > 0) {
            dataToSubmit = {
                type: 'individual',
                service_ids: selectedServices.map(s => s.id)
            };
        } else if (selectedInventoryItems.length > 0) {
            dataToSubmit = {
                type: 'inventory',
                inventory_items: selectedInventoryItems.map(item => ({
                    id: item.id,
                    quantity: item.quantity
                }))
            };
        } else {
            dataToSubmit = { type: null };
        }
        
        selectedServicesData.value = JSON.stringify(dataToSubmit);
        console.log('Updated selectedServicesData in updateOrderSummary:', dataToSubmit);
        console.log('selectedServices:', selectedServices);
        console.log('selectedPackage:', selectedPackage);  
        console.log('selectedInventoryItems:', selectedInventoryItems);
    }
}

// Package selected function
function updateOrderSummaryDisplay() {
    let hasSelection = false;
    let subtotal = 0;
    let totalDuration = 0;
    let servicesHtml = '';
    let activeType = 'individual';
    
    // Determine active type
    if (selectedPackage) {
        activeType = 'package';
    } else if (selectedServices.length > 0 && selectedInventoryItems.length > 0) {
        activeType = 'mixed';
    } else if (selectedServices.length > 0) {
        activeType = 'services';
    } else if (selectedInventoryItems.length > 0) {
        activeType = 'inventory';
    }
    
    // Package selected
    if (selectedPackage) {
        hasSelection = true;
        subtotal = selectedPackage.price;
        totalDuration = selectedPackage.duration;
        
        servicesHtml = `
            <div class="selected-service-item">
                <div class="service-item-name">
                    <strong>${selectedPackage.name}</strong>
                    <br><small>${selectedPackage.servicesCount} services included</small>
                </div>
                <div class="service-item-price">KES ${selectedPackage.price.toFixed(2)}</div>
            </div>
        `;
    }
    
    // Individual services selected
    if (selectedServices.length > 0) {
        hasSelection = true;
        
        selectedServices.forEach(service => {
            servicesHtml += `
                <div class="selected-service-item">
                    <div class="service-item-name">${service.name}</div>
                    <div class="service-item-price">KES ${service.price.toFixed(2)}</div>
                </div>
            `;
            subtotal += service.price;
            totalDuration += service.duration;
        });
    }
    
    // Inventory items selected
    if (selectedInventoryItems.length > 0) {
        hasSelection = true;
        
        selectedInventoryItems.forEach(item => {
            const itemTotal = item.price * item.quantity;
            servicesHtml += `
                <div class="selected-service-item">
                    <div class="service-item-name">
                        ${item.name}
                        <br><small>Qty: ${item.quantity} Ã— KES ${item.price.toFixed(2)}</small>
                    </div>
                    <div class="service-item-price">KES ${itemTotal.toFixed(2)}</div>
                </div>
            `;
            subtotal += itemTotal;
        });
    }
    
    if (!hasSelection) {
        selectedServicesDisplay.style.display = 'block';
        selectedServicesList.style.display = 'none';
        summaryTotals.style.display = 'none';
        return;
    }
    
    selectedServicesDisplay.style.display = 'none';
    selectedServicesList.style.display = 'block';
    summaryTotals.style.display = 'block';
    
    selectedServicesList.innerHTML = servicesHtml;
    
    // Update totals with inclusive VAT
    const totalInclusiveVAT = subtotal;
    const taxAmount = totalInclusiveVAT * 0.16 / 1.16;
    const subtotalExVAT = totalInclusiveVAT - taxAmount;
    
    document.getElementById('subtotalAmount').textContent = `KES ${subtotalExVAT.toFixed(2)}`;
    document.getElementById('taxAmount').textContent = `KES ${taxAmount.toFixed(2)}`;
    document.getElementById('totalAmount').textContent = `KES ${totalInclusiveVAT.toFixed(2)}`;
    document.getElementById('estimatedDuration').textContent = totalDuration;
    
    // Update hidden field based on what's selected
    if (selectedPackage) {
        document.getElementById('selectedServicesData').value = JSON.stringify({
            type: 'package',
            package_id: selectedPackage.id
        });
    } else if (selectedServices.length > 0 && selectedInventoryItems.length > 0) {
        // Mixed selection
        document.getElementById('selectedServicesData').value = JSON.stringify({
            type: 'mixed',
            service_ids: selectedServices.map(s => s.id),
            inventory_items: selectedInventoryItems.map(item => ({
                id: item.id,
                quantity: item.quantity
            }))
        });
    } else if (selectedInventoryItems.length > 0) {
        document.getElementById('selectedServicesData').value = JSON.stringify({
            type: 'inventory',
            inventory_items: selectedInventoryItems.map(item => ({
                id: item.id,
                quantity: item.quantity
            }))
        });
    } else {
        document.getElementById('selectedServicesData').value = JSON.stringify({
            type: 'individual',
            service_ids: selectedServices.map(s => s.id)
        });
    }
}

// Update the existing validateServicesStep function to handle inventory
function validateServicesStep() {
    // Check if any selection exists
    const hasPackage = selectedPackage !== null;
    const hasServices = selectedServices.length > 0;
    const hasInventoryItems = selectedInventoryItems.length > 0;
    
    if (!hasPackage && !hasServices && !hasInventoryItems) {
        showToast('Please select at least one service, package, or inventory item', 'error');
        return false;
    }
    
    return true;
}
</script>

<style>
@keyframes slideInRight {
    from { opacity: 0; transform: translateX(100%); }
    to { opacity: 1; transform: translateX(0); }
}

.row {
    display: flex;
    gap: 2rem;
    margin: 0 -1rem;
}

.col-lg-8 {
    flex: 0 0 66.666667%;
    padding: 0 1rem;
}

.col-lg-4 {
    flex: 0 0 33.333333%;
    padding: 0 1rem;
}

.col-md-6 {
    flex: 0 0 50%;
    padding: 0 1rem;
}

@media (max-width: 768px) {
    .row {
        flex-direction: column;
    }
    
    .col-lg-8,
    .col-lg-4,
    .col-md-6 {
        flex: 1;
    }
}
</style>
{% endblock %}