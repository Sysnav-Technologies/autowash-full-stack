<!-- templates/services/quick_order.html -->
{% extends 'base/base.html' %}
{% load static %}

{% block title %}Quick Order - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
:root {
    --primary-500: #3b82f6;
    --primary-50: #eff6ff;
    --primary-600: #2563eb;
    --primary-700: #1d4ed8;
    --success-500: #10b981;
    --success-50: #ecfdf5;
    --success-600: #059669;
    --warning-500: #f59e0b;
    --warning-50: #fffbeb;
    --info-500: #06b6d4;
    --info-50: #f0f9ff;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --radius-sm: 0.375rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --transition-fast: 0.15s ease-in-out;
}

.page-header {
    background: linear-gradient(135deg, var(--primary-50), var(--success-50));
    border: 1px solid var(--primary-200);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.page-title {
    margin: 0;
    font-size: 1.875rem;
    font-weight: 700;
    color: var(--gray-900);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.page-description {
    margin: 0.5rem 0 0;
    color: var(--gray-600);
    font-size: 1rem;
}

.page-actions {
    display: flex;
    gap: 0.75rem;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius-md);
    font-weight: 500;
    text-decoration: none;
    border: 1px solid transparent;
    transition: all var(--transition-fast);
    cursor: pointer;
    font-size: 0.875rem;
}

.btn-outline-secondary {
    background: transparent;
    color: var(--gray-600);
    border-color: var(--gray-300);
}

.btn-outline-secondary:hover {
    background: var(--gray-50);
    border-color: var(--gray-500);
    text-decoration: none;
    color: var(--gray-700);
}

.btn-success {
    background: var(--success-500);
    color: white;
    border-color: var(--success-500);
}

.btn-success:hover {
    background: var(--success-600);
    text-decoration: none;
    color: white;
    transform: translateY(-1px);
}

.btn-primary {
    background: var(--primary-500);
    color: white;
    border-color: var(--primary-500);
}

.btn-primary:hover {
    background: var(--primary-600);
    text-decoration: none;
    color: white;
    transform: translateY(-1px);
}

.btn-lg {
    padding: 1rem 2rem;
    font-size: 1rem;
}

.quick-order-container {
    max-width: 1200px;
    margin: 0 auto;
}

.order-progress {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2rem;
    position: relative;
}

.order-progress::before {
    content: '';
    position: absolute;
    top: 1rem;
    left: 2rem;
    right: 2rem;
    height: 2px;
    background: var(--gray-200);
    z-index: 1;
}

.progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: white;
    padding: 0.5rem;
    z-index: 2;
    position: relative;
}

.progress-number {
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    background: var(--gray-200);
    color: var(--gray-600);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    margin-bottom: 0.5rem;
    transition: all var(--transition-fast);
}

.progress-step.active .progress-number {
    background: var(--primary-500);
    color: white;
}

.progress-step.completed .progress-number {
    background: var(--success-500);
    color: white;
}

.progress-label {
    font-size: 0.75rem;
    color: var(--gray-600);
    text-align: center;
}

.step-content {
    display: none;
}

.step-content.active {
    display: block;
}

.form-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    margin-bottom: 2rem;
}

.card-header {
    background: var(--gray-50);
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--gray-200);
}

.card-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--gray-900);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.card-body {
    padding: 1.5rem;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
}

.form-label.required::after {
    content: " *";
    color: #ef4444;
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    transition: all var(--transition-fast);
    background: white;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-control.is-invalid {
    border-color: #ef4444;
}

.form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 16px 12px;
    padding-right: 2.5rem;
    appearance: none;
}

.customer-search-section {
    background: var(--info-50);
    border: 1px solid var(--info-200);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.search-input-group {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.search-btn {
    background: var(--primary-500);
    color: white;
    border: none;
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: 0.875rem;
    white-space: nowrap;
}

.search-results {
    margin-top: 1rem;
    max-height: 200px;
    overflow-y: auto;
}

.search-result-item {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.search-result-item:hover {
    background: var(--primary-50);
    border-color: var(--primary-300);
}

.selected-customer,
.selected-vehicle {
    background: var(--success-50);
    border: 1px solid var(--success-200);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-bottom: 1rem;
}

.selection-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.change-btn {
    background: none;
    border: none;
    color: var(--primary-600);
    cursor: pointer;
    font-size: 0.875rem;
    text-decoration: underline;
}

.services-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.service-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    cursor: pointer;
    transition: all var(--transition-fast);
    position: relative;
}

.service-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
    border-color: var(--primary-300);
}

.service-card.selected {
    border-color: var(--primary-500);
    background: var(--primary-50);
}

.service-card.selected::before {
    content: '✓';
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: var(--primary-500);
    color: white;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
}

.service-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
}

.service-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0;
}

.service-price {
    font-size: 1rem;
    font-weight: 700;
    color: var(--primary-600);
}

.service-description {
    font-size: 0.875rem;
    color: var(--gray-600);
    margin-bottom: 0.75rem;
    line-height: 1.4;
}

.service-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: var(--gray-500);
}

.service-duration {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.service-category {
    background: var(--gray-100);
    color: var(--gray-700);
    padding: 0.125rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.625rem;
    font-weight: 500;
    text-transform: uppercase;
}

.service-type-selector .btn-group {
    border-radius: var(--radius-md);
    overflow: hidden;
}

.service-type-selector .btn {
    border-radius: 0;
    border-color: var(--primary-300);
}

.service-type-selector .btn.active {
    background: var(--primary-500);
    color: white;
    border-color: var(--primary-500);
}

.packages-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.package-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    cursor: pointer;
    transition: all var(--transition-fast);
    position: relative;
    overflow: hidden;
}

.package-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
    border-color: var(--primary-300);
}

.package-card.selected {
    border-color: var(--primary-500);
    background: var(--primary-50);
}

.package-card.selected::before {
    content: '✓';
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: var(--primary-500);
    color: white;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
    z-index: 2;
}

.package-header {
    margin-bottom: 1rem;
}

.package-name {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0 0 0.5rem 0;
}

.package-pricing {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.original-price {
    font-size: 0.875rem;
    color: var(--gray-500);
    text-decoration: line-through;
}

.package-price {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary-600);
}

.savings {
    font-size: 0.75rem;
    color: var(--success-600);
    font-weight: 600;
    background: var(--success-50);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
}

.package-description {
    font-size: 0.875rem;
    color: var(--gray-600);
    margin-bottom: 1rem;
    line-height: 1.4;
}

.package-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: var(--gray-500);
}

.package-duration,
.package-services-count {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.package-badge {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
}

.discount-badge {
    background: var(--warning-500);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
}

.popular-badge {
    top: 0.5rem;
    left: 0.5rem;
}

.popular-label {
    background: var(--success-500);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
}

.order-summary {
    position: sticky;
    top: 2rem;
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    box-shadow: var(--shadow-sm);
}

.summary-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--gray-200);
}

.summary-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0;
}

.summary-content {
    margin-bottom: 1.5rem;
}

.selected-services-list {
    margin-bottom: 1rem;
}

.selected-service-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--gray-100);
}

.selected-service-item:last-child {
    border-bottom: none;
}

.service-item-name {
    font-size: 0.875rem;
    color: var(--gray-900);
}

.service-item-price {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--gray-700);
}

.summary-totals {
    border-top: 2px solid var(--gray-200);
    padding-top: 1rem;
}

.total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.total-row.main {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--gray-900);
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--gray-200);
}

.summary-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.step-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    background: var(--gray-50);
    border-top: 1px solid var(--gray-200);
    margin-top: 2rem;
}

.nav-buttons {
    display: flex;
    gap: 0.75rem;
}

.btn-outline-gray {
    background: transparent;
    color: var(--gray-600);
    border-color: var(--gray-300);
}

.btn-outline-gray:hover {
    background: var(--gray-100);
    border-color: var(--gray-400);
    text-decoration: none;
    color: var(--gray-700);
}

.step-indicator {
    font-size: 0.875rem;
    color: var(--gray-600);
}

.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--gray-500);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.category-filter {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.category-btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-md);
    background: white;
    color: var(--gray-700);
    cursor: pointer;
    font-size: 0.875rem;
    transition: all var(--transition-fast);
}

.category-btn:hover {
    background: var(--gray-50);
    border-color: var(--gray-400);
}

.category-btn.active {
    background: var(--primary-500);
    color: white;
    border-color: var(--primary-500);
}

@media (max-width: 1024px) {
    .quick-order-container {
        padding: 0 1rem;
    }
    
    .order-summary {
        position: static;
        margin-top: 2rem;
    }
}

@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .services-grid {
        grid-template-columns: 1fr;
    }
    
    .search-input-group {
        flex-direction: column;
    }
    
    .order-progress {
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .step-navigation {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
}

.text-muted { color: var(--gray-500); }
.text-success { color: var(--success-600); }
.text-primary { color: var(--primary-600); }
.d-flex { display: flex; }
.justify-content-between { justify-content: space-between; }
.align-items-center { align-items: center; }
.p-3 { padding: 1rem; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">
            <i class="fas fa-bolt text-primary"></i>
            Quick Order
        </h1>
        <p class="page-description">Create a service order quickly for walk-in customers</p>
    </div>
    
    <div class="page-actions">
        <a href="/business/{{ request.tenant.slug }}/services/dashboard/" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i>
            Back to Dashboard
        </a>
    </div>
</div>

<div class="quick-order-container">
    <!-- Progress Indicator -->
    <div class="order-progress">
        <div class="progress-step active" id="step1-indicator">
            <div class="progress-number">1</div>
            <div class="progress-label">Customer</div>
        </div>
        <div class="progress-step" id="step2-indicator">
            <div class="progress-number">2</div>
            <div class="progress-label">Vehicle</div>
        </div>
        <div class="progress-step" id="step3-indicator">
            <div class="progress-number">3</div>
            <div class="progress-label">Services</div>
        </div>
        <div class="progress-step" id="step4-indicator">
            <div class="progress-number">4</div>
            <div class="progress-label">Review</div>
        </div>
    </div>

    <form id="quickOrderForm" method="post">
        {% csrf_token %}
        
        <!-- Step 1: Customer Selection -->
        <div class="step-content active" id="step1">
            <div class="form-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-user"></i>
                        Select Customer
                    </h5>
                </div>
                
                <div class="card-body">
                    <!-- Customer Search -->
                    <div class="customer-search-section">
                        <h6><i class="fas fa-search"></i> Search Existing Customer</h6>
                        <div class="search-input-group">
                            <input type="text" class="form-control" id="customerSearchInput" placeholder="Search by name, phone, or customer ID...">
                            <button type="button" class="search-btn" onclick="searchCustomers()">
                                <i class="fas fa-search"></i>
                                Search
                            </button>
                        </div>
                        <div id="customerSearchResults" class="search-results" style="display: none;"></div>
                    </div>

                    <!-- Selected Customer Display -->
                    <div id="selectedCustomerDisplay" style="display: none;">
                        <div class="selected-customer">
                            <div class="selection-header">
                                <h6><i class="fas fa-check-circle text-success"></i> Selected Customer</h6>
                                <button type="button" class="change-btn" onclick="changeCustomer()">Change</button>
                            </div>
                            <div id="selectedCustomerInfo"></div>
                        </div>
                    </div>

                    <!-- New Customer Form -->
                    <div id="newCustomerForm">
                        <h6><i class="fas fa-user-plus"></i> New Customer</h6>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customerName" class="form-label required">Full Name</label>
                                <input type="text" class="form-control" id="customerName" name="customer_name" required>
                            </div>
                            <div class="form-group">
                                <label for="customerPhone" class="form-label required">Phone Number</label>
                                <input type="tel" class="form-control" id="customerPhone" name="customer_phone" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="customerEmail" class="form-label">Email (Optional)</label>
                            <input type="email" class="form-control" id="customerEmail" name="customer_email">
                        </div>
                    </div>

                    <!-- Hidden fields for selected customer -->
                    <input type="hidden" id="selectedCustomerId" name="selected_customer_id">
                </div>
            </div>
        </div>

        <!-- Step 2: Vehicle Selection -->
        <div class="step-content" id="step2">
            <div class="form-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-car"></i>
                        Select Vehicle
                    </h5>
                </div>
                
                <div class="card-body">
                    <!-- Vehicle Search (for existing customers) -->
                    <div id="vehicleSearchSection" style="display: none;">
                        <div class="customer-search-section">
                            <h6><i class="fas fa-search"></i> Search Customer's Vehicles</h6>
                            <div class="search-input-group">
                                <input type="text" class="form-control" id="vehicleSearchInput" placeholder="Search by registration number...">
                                <button type="button" class="search-btn" onclick="searchVehicles()">
                                    <i class="fas fa-search"></i>
                                    Search
                                </button>
                            </div>
                            <div id="vehicleSearchResults" class="search-results" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Selected Vehicle Display -->
                    <div id="selectedVehicleDisplay" style="display: none;">
                        <div class="selected-vehicle">
                            <div class="selection-header">
                                <h6><i class="fas fa-check-circle text-success"></i> Selected Vehicle</h6>
                                <button type="button" class="change-btn" onclick="changeVehicle()">Change</button>
                            </div>
                            <div id="selectedVehicleInfo"></div>
                        </div>
                    </div>

                    <!-- New Vehicle Form -->
                    <div id="newVehicleForm">
                        <h6><i class="fas fa-plus"></i> Vehicle Information</h6>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vehicleRegistration" class="form-label required">Registration Number</label>
                                <input type="text" class="form-control" id="vehicleRegistration" name="vehicle_registration" required style="text-transform: uppercase;">
                            </div>
                            <div class="form-group">
                                <label for="vehicleType" class="form-label required">Vehicle Type</label>
                                <select class="form-control form-select" id="vehicleType" name="vehicle_type" required>
                                    <option value="">Select Type</option>
                                    <option value="sedan">Sedan</option>
                                    <option value="suv">SUV</option>
                                    <option value="hatchback">Hatchback</option>
                                    <option value="pickup">Pickup Truck</option>
                                    <option value="van">Van</option>
                                    <option value="bus">Bus</option>
                                    <option value="motorcycle">Motorcycle</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vehicleMake" class="form-label required">Make</label>
                                <input type="text" class="form-control" id="vehicleMake" name="vehicle_make" required>
                            </div>
                            <div class="form-group">
                                <label for="vehicleModel" class="form-label required">Model</label>
                                <input type="text" class="form-control" id="vehicleModel" name="vehicle_model" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vehicleColor" class="form-label required">Color</label>
                                <input type="text" class="form-control" id="vehicleColor" name="vehicle_color" required>
                            </div>
                            <div class="form-group">
                                <label for="vehicleYear" class="form-label">Year</label>
                                <input type="number" class="form-control" id="vehicleYear" name="vehicle_year" min="1990" max="2025" value="2020">
                            </div>
                        </div>
                    </div>

                    <!-- Hidden fields for selected vehicle -->
                    <input type="hidden" id="selectedVehicleId" name="selected_vehicle_id">
                </div>
            </div>
        </div>

        <!-- Step 3: Service Selection -->
        <div class="step-content" id="step3">
            <div class="row">
                <div class="col-lg-8">
                    <div class="form-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-list-check"></i>
                                Select Services
                            </h5>
                        </div>
                        
                        <div class="card-body">
                            <!-- Service Type Selector -->
                            <div class="service-type-selector mb-3">
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-outline-primary active" id="individualServicesBtn" onclick="showServiceType('individual')">
                                        <i class="fas fa-list"></i>
                                        Individual Services
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" id="packagesBtn" onclick="showServiceType('packages')">
                                        <i class="fas fa-box"></i>
                                        Service Packages
                                    </button>
                                </div>
                            </div>

                            <!-- Individual Services Section -->
                            <div id="individualServicesSection">
                                <!-- Category Filter -->
                                <div class="category-filter">
                                    <button type="button" class="category-btn active" onclick="filterServices('all')" data-category="all">
                                        All Services
                                    </button>
                                    {% for category in categories %}
                                    <button type="button" class="category-btn" onclick="filterServices('{{ category.id }}')" data-category="{{ category.id }}">
                                        <i class="{{ category.icon }}"></i>
                                        {{ category.name }}
                                    </button>
                                    {% endfor %}
                                </div>

                                <!-- Services Grid -->
                                <div class="services-grid" id="servicesGrid">
                                    {% for service in all_services %}
                                    <div class="service-card" onclick="toggleService('{{ service.id }}')" data-service-id="{{ service.id }}" data-category="{{ service.category.id }}">
                                        <div class="service-header">
                                            <h6 class="service-name">{{ service.name }}</h6>
                                            <div class="service-price">KES {{ service.base_price }}</div>
                                        </div>
                                        <p class="service-description">{{ service.description|truncatewords:15 }}</p>
                                        <div class="service-details">
                                            <div class="service-duration">
                                                <i class="fas fa-clock"></i>
                                                {{ service.estimated_duration }} min
                                            </div>
                                            <div class="service-category">{{ service.category.name }}</div>
                                        </div>
                                        {% if service.is_popular %}
                                        <div class="service-badge">
                                            <span class="popular-badge">POPULAR</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% empty %}
                                    <div class="empty-state">
                                        <i class="fas fa-car-wash"></i>
                                        <p>No services available</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Service Packages Section -->
                            <div id="packagesSection" style="display: none;">
                                <div class="packages-grid">
                                    {% for package in service_packages %}
                                    <div class="package-card" onclick="togglePackage('{{ package.id }}')" data-package-id="{{ package.id }}">
                                        <div class="package-header">
                                            <h6 class="package-name">{{ package.name }}</h6>
                                            <div class="package-pricing">
                                                {% if package.discount_percentage > 0 %}
                                                <div class="original-price">KES {{ package.original_price|floatformat:2 }}</div>
                                                <div class="package-price">KES {{ package.total_price }}</div>
                                                <div class="savings">Save KES {{ package.savings_amount|floatformat:2 }}</div>
                                                {% else %}
                                                <div class="package-price">KES {{ package.total_price }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <p class="package-description">{{ package.description|truncatewords:20 }}</p>
                                        <div class="package-details">
                                            <div class="package-duration">
                                                <i class="fas fa-clock"></i>
                                                {{ package.estimated_duration }} min
                                            </div>
                                            <div class="package-services-count">
                                                <i class="fas fa-list"></i>
                                                {{ package.service_count }} services
                                            </div>
                                        </div>
                                        {% if package.discount_percentage > 0 %}
                                        <div class="package-badge">
                                            <span class="discount-badge">{{ package.discount_percentage|floatformat:0 }}% OFF</span>
                                        </div>
                                        {% endif %}
                                        {% if package.is_popular %}
                                        <div class="package-badge popular-badge">
                                            <span class="popular-label">POPULAR</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% empty %}
                                    <div class="empty-state">
                                        <i class="fas fa-box"></i>
                                        <p>No service packages available</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <!-- Order Summary -->
                    <div class="order-summary">
                        <div class="summary-header">
                            <h6 class="summary-title">
                                <i class="fas fa-shopping-cart"></i>
                                Order Summary
                            </h6>
                        </div>
                        
                        <div class="summary-content">
                            <div id="selectedServicesDisplay">
                                <div class="empty-state">
                                    <i class="fas fa-list"></i>
                                    <p>No services selected</p>
                                </div>
                            </div>
                            
                            <div class="selected-services-list" id="selectedServicesList" style="display: none;">
                                <!-- Selected services will be populated here -->
                            </div>
                            
                            <div class="summary-totals" id="summaryTotals" style="display: none;">
                                <div class="total-row">
                                    <span>Subtotal:</span>
                                    <span id="subtotalAmount">KES 0</span>
                                </div>
                                <div class="total-row">
                                    <span>Tax (16%):</span>
                                    <span id="taxAmount">KES 0</span>
                                </div>
                                <div class="total-row main">
                                    <span>Total:</span>
                                    <span id="totalAmount">KES 0</span>
                                </div>
                                <div class="total-row">
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i>
                                        Est. Duration: <span id="estimatedDuration">0</span> min
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="summary-actions">
                            <button type="button" class="btn btn-outline-gray" onclick="clearAllServices()">
                                <i class="fas fa-trash"></i>
                                Clear All
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Review & Submit -->
        <div class="step-content" id="step4">
            <div class="form-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-check-circle"></i>
                        Review Order
                    </h5>
                </div>
                
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Customer Information</h6>
                            <div id="reviewCustomerInfo" class="mb-3">
                                <!-- Customer info will be populated here -->
                            </div>
                            
                            <h6>Vehicle Information</h6>
                            <div id="reviewVehicleInfo" class="mb-3">
                                <!-- Vehicle info will be populated here -->
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6>Selected Services</h6>
                            <div id="reviewServicesInfo" class="mb-3">
                                <!-- Services info will be populated here -->
                            </div>
                            
                            <h6>Order Total</h6>
                            <div id="reviewTotalInfo">
                                <!-- Total info will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="specialInstructions" class="form-label">Special Instructions (Optional)</label>
                        <textarea class="form-control" id="specialInstructions" name="special_instructions" rows="3" placeholder="Any special requirements or notes..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="priority" class="form-label">Priority</label>
                        <select class="form-control form-select" id="priority" name="priority">
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden field for selected services -->
        <input type="hidden" id="selectedServicesData" name="selected_services">
    </form>

    <!-- Step Navigation -->
    <div class="step-navigation">
        <div class="step-indicator">
            Step <span id="currentStepNumber">1</span> of 4
        </div>
        
        <div class="nav-buttons">
            <button type="button" class="btn btn-outline-gray" id="prevBtn" onclick="previousStep()" style="display: none;">
                <i class="fas fa-arrow-left"></i>
                Previous
            </button>
            
            <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                Next
                <i class="fas fa-arrow-right"></i>
            </button>
            
            <button type="button" class="btn btn-success btn-lg" id="submitBtn" onclick="submitOrder()" style="display: none;">
                <i class="fas fa-check"></i>
                Create Order
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentStep = 1;
let selectedCustomer = null;
let selectedVehicle = null;
let selectedServices = [];
let selectedPackage = null;
let allServices = [];
let serviceType = 'individual'; // 'individual' or 'package'

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadAllServices();
    updateStepIndicator();
});

// Step Management
function nextStep() {
    if (validateCurrentStep()) {
        if (currentStep < 4) {
            currentStep++;
            showStep(currentStep);
            updateStepIndicator();
            updateNavigationButtons();
        }
    }
}

function previousStep() {
    if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
        updateStepIndicator();
        updateNavigationButtons();
    }
}

function showStep(step) {
    // Hide all steps
    document.querySelectorAll('.step-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Show current step
    document.getElementById(`step${step}`).classList.add('active');
    
    // Update step-specific content
    if (step === 2) {
        updateVehicleStep();
    } else if (step === 4) {
        updateReviewStep();
    }
}

function updateStepIndicator() {
    document.getElementById('currentStepNumber').textContent = currentStep;
    
    // Update progress indicators
    for (let i = 1; i <= 4; i++) {
        const indicator = document.getElementById(`step${i}-indicator`);
        if (i < currentStep) {
            indicator.classList.add('completed');
            indicator.classList.remove('active');
        } else if (i === currentStep) {
            indicator.classList.add('active');
            indicator.classList.remove('completed');
        } else {
            indicator.classList.remove('active', 'completed');
        }
    }
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    
    // Show/hide previous button
    prevBtn.style.display = currentStep > 1 ? 'inline-flex' : 'none';
    
    // Show next or submit button
    if (currentStep === 4) {
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'inline-flex';
    } else {
        nextBtn.style.display = 'inline-flex';
        submitBtn.style.display = 'none';
    }
}

function validateCurrentStep() {
    switch (currentStep) {
        case 1:
            return validateCustomerStep();
        case 2:
            return validateVehicleStep();
        case 3:
            return validateServicesStep();
        case 4:
            return true; // Review step doesn't need validation
        default:
            return true;
    }
}

// Customer Management
function searchCustomers() {
    const query = document.getElementById('customerSearchInput').value.trim();
    const resultsContainer = document.getElementById('customerSearchResults');
    
    if (query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
    }
    
    resultsContainer.innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
    resultsContainer.style.display = 'block';
    
    fetch(`/business/{{ request.tenant.slug }}/services/ajax/customer/search/?q=${encodeURIComponent(query)}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        displayCustomerResults(data.customers || []);
    })
    .catch(error => {
        console.error('Search error:', error);
        resultsContainer.innerHTML = '<div class="text-danger p-3">Error searching customers</div>';
    });
}

function displayCustomerResults(customers) {
    const resultsContainer = document.getElementById('customerSearchResults');
    
    if (customers.length === 0) {
        resultsContainer.innerHTML = '<div class="text-muted p-3">No customers found</div>';
        return;
    }
    
    let html = '';
    customers.forEach(customer => {
        html += `
            <div class="search-result-item" onclick="selectCustomer('${customer.id}', '${customer.full_name}', '${customer.phone}', '${customer.customer_id}')">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>${customer.full_name}</strong>
                        <br><small>${customer.phone || 'No phone'}</small>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">${customer.customer_id}</small>
                        <br><small>${customer.vehicle_count || 0} vehicle(s)</small>
                    </div>
                </div>
            </div>
        `;
    });
    
    resultsContainer.innerHTML = html;
}

function selectCustomer(id, name, phone, customerId) {
    selectedCustomer = { id, name, phone, customerId };
    
    // Update UI
    document.getElementById('selectedCustomerId').value = id;
    document.getElementById('selectedCustomerInfo').innerHTML = `
        <strong>${name}</strong><br>
        <small>Phone: ${phone}</small><br>
        <small>ID: ${customerId}</small>
    `;
    
    // Show selected customer, hide search and new customer form
    document.getElementById('selectedCustomerDisplay').style.display = 'block';
    document.getElementById('customerSearchResults').style.display = 'none';
    document.getElementById('newCustomerForm').style.display = 'none';
    
    // Clear search input
    document.getElementById('customerSearchInput').value = '';
}

function changeCustomer() {
    selectedCustomer = null;
    document.getElementById('selectedCustomerId').value = '';
    document.getElementById('selectedCustomerDisplay').style.display = 'none';
    document.getElementById('newCustomerForm').style.display = 'block';
    
    // Clear form fields
    document.getElementById('customerName').value = '';
    document.getElementById('customerPhone').value = '';
    document.getElementById('customerEmail').value = '';
}

function validateCustomerStep() {
    if (selectedCustomer) {
        return true;
    }
    
    // Validate new customer form
    const name = document.getElementById('customerName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    
    if (!name || !phone) {
        showToast('Please enter customer name and phone number', 'error');
        return false;
    }
    
    return true;
}

// Vehicle Management
function updateVehicleStep() {
    if (selectedCustomer) {
        document.getElementById('vehicleSearchSection').style.display = 'block';
        loadCustomerVehicles();
    } else {
        document.getElementById('vehicleSearchSection').style.display = 'none';
    }
}

function loadCustomerVehicles() {
    if (!selectedCustomer) return;
    
    fetch(`/business/{{ request.tenant.slug }}/services/ajax/vehicle/search/?customer_id=${selectedCustomer.id}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.results && data.results.length > 0) {
            displayVehicleOptions(data.results);
        }
    })
    .catch(error => {
        console.error('Error loading vehicles:', error);
    });
}

function displayVehicleOptions(vehicles) {
    const resultsContainer = document.getElementById('vehicleSearchResults');
    
    let html = '<h6>Customer\'s Vehicles:</h6>';
    vehicles.forEach(vehicle => {
        html += `
            <div class="search-result-item" onclick="selectVehicle('${vehicle.id}', '${vehicle.registration}', '${vehicle.make}', '${vehicle.model}', '${vehicle.color}')">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>${vehicle.registration}</strong>
                        <br><small>${vehicle.make} ${vehicle.model}</small>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">${vehicle.color}</small>
                    </div>
                </div>
            </div>
        `;
    });
    
    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';
}

function searchVehicles() {
    const query = document.getElementById('vehicleSearchInput').value.trim();
    const customerId = selectedCustomer ? selectedCustomer.id : '';
    
    if (query.length < 2) return;
    
    fetch(`/business/{{ request.tenant.slug }}/services/ajax/vehicle/search/?q=${encodeURIComponent(query)}&customer_id=${customerId}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        displayVehicleResults(data.results || []);
    })
    .catch(error => {
        console.error('Vehicle search error:', error);
    });
}

function displayVehicleResults(vehicles) {
    const resultsContainer = document.getElementById('vehicleSearchResults');
    
    if (vehicles.length === 0) {
        resultsContainer.innerHTML = '<div class="text-muted p-3">No vehicles found</div>';
        return;
    }
    
    let html = '';
    vehicles.forEach(vehicle => {
        html += `
            <div class="search-result-item" onclick="selectVehicle('${vehicle.id}', '${vehicle.registration}', '${vehicle.make}', '${vehicle.model}', '${vehicle.color}')">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>${vehicle.registration}</strong>
                        <br><small>${vehicle.make} ${vehicle.model}</small>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">${vehicle.color}</small>
                        <br><small>${vehicle.customer_name}</small>
                    </div>
                </div>
            </div>
        `;
    });
    
    resultsContainer.innerHTML = html;
}

function selectVehicle(id, registration, make, model, color) {
    selectedVehicle = { id, registration, make, model, color };
    
    // Update UI
    document.getElementById('selectedVehicleId').value = id;
    document.getElementById('selectedVehicleInfo').innerHTML = `
        <strong>${registration}</strong><br>
        <small>${make} ${model}</small><br>
        <small>Color: ${color}</small>
    `;
    
    // Show selected vehicle, hide search and new vehicle form
    document.getElementById('selectedVehicleDisplay').style.display = 'block';
    document.getElementById('vehicleSearchResults').style.display = 'none';
    document.getElementById('newVehicleForm').style.display = 'none';
}

function changeVehicle() {
    selectedVehicle = null;
    document.getElementById('selectedVehicleId').value = '';
    document.getElementById('selectedVehicleDisplay').style.display = 'none';
    document.getElementById('newVehicleForm').style.display = 'block';
    
    // Clear form fields
    document.getElementById('vehicleRegistration').value = '';
    document.getElementById('vehicleMake').value = '';
    document.getElementById('vehicleModel').value = '';
    document.getElementById('vehicleColor').value = '';
    document.getElementById('vehicleYear').value = '2020';
    document.getElementById('vehicleType').value = '';
}

function validateVehicleStep() {
    if (selectedVehicle) {
        return true;
    }
    
    // Validate new vehicle form
    const registration = document.getElementById('vehicleRegistration').value.trim();
    const make = document.getElementById('vehicleMake').value.trim();
    const model = document.getElementById('vehicleModel').value.trim();
    const color = document.getElementById('vehicleColor').value.trim();
    const type = document.getElementById('vehicleType').value;
    
    if (!registration || !make || !model || !color || !type) {
        showToast('Please fill in all required vehicle information', 'error');
        return false;
    }
    
    return true;
}

// Service Management
function showServiceType(type) {
    serviceType = type;
    
    // Update button states
    document.getElementById('individualServicesBtn').classList.toggle('active', type === 'individual');
    document.getElementById('packagesBtn').classList.toggle('active', type === 'packages');
    
    // Show/hide sections
    document.getElementById('individualServicesSection').style.display = type === 'individual' ? 'block' : 'none';
    document.getElementById('packagesSection').style.display = type === 'packages' ? 'block' : 'none';
    
    // Clear selections when switching types
    if (type === 'individual') {
        selectedPackage = null;
        document.querySelectorAll('.package-card').forEach(card => {
            card.classList.remove('selected');
        });
    } else {
        selectedServices = [];
        document.querySelectorAll('.service-card').forEach(card => {
            card.classList.remove('selected');
        });
    }
    
    updateOrderSummary();
}

function loadAllServices() {
    // Services are already loaded from the template
    // This function can be used to load additional services via AJAX if needed
}

function filterServices(categoryId) {
    // Update active category button
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-category="${categoryId}"]`).classList.add('active');
    
    // Filter service cards
    document.querySelectorAll('.service-card').forEach(card => {
        const cardCategory = card.dataset.category;
        if (categoryId === 'all' || cardCategory === categoryId) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function toggleService(serviceId) {
    const serviceCard = document.querySelector(`[data-service-id="${serviceId}"]`);
    const isSelected = serviceCard.classList.contains('selected');
    
    if (isSelected) {
        // Remove service
        serviceCard.classList.remove('selected');
        selectedServices = selectedServices.filter(s => s.id !== serviceId);
    } else {
        // Add service
        serviceCard.classList.add('selected');
        
        // Get service data from the card
        const serviceName = serviceCard.querySelector('.service-name').textContent;
        const servicePriceText = serviceCard.querySelector('.service-price').textContent;
        const servicePrice = parseFloat(servicePriceText.replace(/[^0-9.]/g, ''));
        const serviceDuration = parseInt(serviceCard.querySelector('.service-duration').textContent);
        
        selectedServices.push({
            id: serviceId,
            name: serviceName,
            price: servicePrice,
            duration: serviceDuration
        });
    }
    
    updateOrderSummary();
}

function togglePackage(packageId) {
    const packageCard = document.querySelector(`[data-package-id="${packageId}"]`);
    const isSelected = packageCard.classList.contains('selected');
    
    // Clear all other package selections (only one package can be selected)
    document.querySelectorAll('.package-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    if (isSelected) {
        // Deselect package
        selectedPackage = null;
    } else {
        // Select package
        packageCard.classList.add('selected');
        
        // Get package data from the card
        const packageName = packageCard.querySelector('.package-name').textContent;
        const packagePriceText = packageCard.querySelector('.package-price').textContent;
        const packagePrice = parseFloat(packagePriceText.replace(/[^0-9.]/g, ''));
        const packageDuration = parseInt(packageCard.querySelector('.package-duration').textContent);
        const servicesCount = parseInt(packageCard.querySelector('.package-services-count').textContent);
        
        selectedPackage = {
            id: packageId,
            name: packageName,
            price: packagePrice,
            duration: packageDuration,
            servicesCount: servicesCount
        };
    }
    
    updateOrderSummary();
}

function updateOrderSummary() {
    const selectedServicesDisplay = document.getElementById('selectedServicesDisplay');
    const selectedServicesList = document.getElementById('selectedServicesList');
    const summaryTotals = document.getElementById('summaryTotals');
    
    let hasSelection = false;
    let subtotal = 0;
    let totalDuration = 0;
    let servicesHtml = '';
    
    if (serviceType === 'package' && selectedPackage) {
        // Package selected
        hasSelection = true;
        subtotal = selectedPackage.price;
        totalDuration = selectedPackage.duration;
        
        servicesHtml = `
            <div class="selected-service-item">
                <div class="service-item-name">
                    <strong>${selectedPackage.name}</strong>
                    <br><small>${selectedPackage.servicesCount} services included</small>
                </div>
                <div class="service-item-price">KES ${selectedPackage.price.toFixed(2)}</div>
            </div>
        `;
    } else if (serviceType === 'individual' && selectedServices.length > 0) {
        // Individual services selected
        hasSelection = true;
        
        selectedServices.forEach(service => {
            servicesHtml += `
                <div class="selected-service-item">
                    <div class="service-item-name">${service.name}</div>
                    <div class="service-item-price">KES ${service.price.toFixed(2)}</div>
                </div>
            `;
            subtotal += service.price;
            totalDuration += service.duration;
        });
    }
    
    if (!hasSelection) {
        selectedServicesDisplay.style.display = 'block';
        selectedServicesList.style.display = 'none';
        summaryTotals.style.display = 'none';
        return;
    }
    
    selectedServicesDisplay.style.display = 'none';
    selectedServicesList.style.display = 'block';
    summaryTotals.style.display = 'block';
    
    selectedServicesList.innerHTML = servicesHtml;
    
    // Update totals
    const tax = subtotal * 0.16;
    const total = subtotal + tax;
    
    document.getElementById('subtotalAmount').textContent = `KES ${subtotal.toFixed(2)}`;
    document.getElementById('taxAmount').textContent = `KES ${tax.toFixed(2)}`;
    document.getElementById('totalAmount').textContent = `KES ${total.toFixed(2)}`;
    document.getElementById('estimatedDuration').textContent = totalDuration;
    
    // Update hidden field based on service type
    if (serviceType === 'package' && selectedPackage) {
        document.getElementById('selectedServicesData').value = JSON.stringify({
            type: 'package',
            package_id: selectedPackage.id
        });
    } else {
        document.getElementById('selectedServicesData').value = JSON.stringify({
            type: 'individual',
            service_ids: selectedServices.map(s => s.id)
        });
    }
}

function clearAllServices() {
    selectedServices = [];
    selectedPackage = null;
    
    document.querySelectorAll('.service-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelectorAll('.package-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    updateOrderSummary();
}

function validateServicesStep() {
    if (serviceType === 'package' && !selectedPackage) {
        showToast('Please select a service package', 'error');
        return false;
    } else if (serviceType === 'individual' && selectedServices.length === 0) {
        showToast('Please select at least one service', 'error');
        return false;
    }
    return true;
}

// Review Step
function updateReviewStep() {
    // Update customer info
    const customerInfo = selectedCustomer ? 
        `<strong>${selectedCustomer.name}</strong><br><small>Phone: ${selectedCustomer.phone}</small>` :
        `<strong>${document.getElementById('customerName').value}</strong><br><small>Phone: ${document.getElementById('customerPhone').value}</small>`;
    document.getElementById('reviewCustomerInfo').innerHTML = customerInfo;
    
    // Update vehicle info
    const vehicleInfo = selectedVehicle ?
        `<strong>${selectedVehicle.registration}</strong><br><small>${selectedVehicle.make} ${selectedVehicle.model}</small><br><small>Color: ${selectedVehicle.color}</small>` :
        `<strong>${document.getElementById('vehicleRegistration').value}</strong><br><small>${document.getElementById('vehicleMake').value} ${document.getElementById('vehicleModel').value}</small><br><small>Color: ${document.getElementById('vehicleColor').value}</small>`;
    document.getElementById('reviewVehicleInfo').innerHTML = vehicleInfo;
    
    // Update services info
    let servicesHtml = '';
    selectedServices.forEach(service => {
        servicesHtml += `<div>${service.name} - KES ${service.price.toFixed(2)}</div>`;
    });
    document.getElementById('reviewServicesInfo').innerHTML = servicesHtml;
    
    // Update total info
    const subtotal = selectedServices.reduce((sum, service) => sum + service.price, 0);
    const tax = subtotal * 0.16;
    const total = subtotal + tax;
    const duration = selectedServices.reduce((sum, service) => sum + service.duration, 0);
    
    document.getElementById('reviewTotalInfo').innerHTML = `
        <div>Subtotal: KES ${subtotal.toFixed(2)}</div>
        <div>Tax: KES ${tax.toFixed(2)}</div>
        <div><strong>Total: KES ${total.toFixed(2)}</strong></div>
        <div><small>Duration: ${duration} minutes</small></div>
    `;
}

// Form Submission
function submitOrder() {
    // Validate that we have all required data
    if (!validateAllSteps()) {
        showToast('Please complete all required fields', 'error');
        return;
    }
    
    const form = document.getElementById('quickOrderForm');
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Order...';
    submitBtn.disabled = true;
    
    try {
        // Prepare form data
        const formData = new FormData();
        
        // Add CSRF token
        const csrfToken = getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (!csrfToken) {
            throw new Error('CSRF token not found');
        }
        
        // Customer data
        if (selectedCustomer) {
            formData.set('existing_customer_id', selectedCustomer.id);
        } else {
            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const customerEmail = document.getElementById('customerEmail').value.trim();
            
            if (!customerName || !customerPhone) {
                throw new Error('Customer name and phone are required');
            }
            
            formData.set('customer_name', customerName);
            formData.set('customer_phone', customerPhone);
            formData.set('customer_email', customerEmail);
        }
        
        // Vehicle data
        if (selectedVehicle) {
            formData.set('existing_vehicle_id', selectedVehicle.id);
        } else {
            const vehicleRegistration = document.getElementById('vehicleRegistration').value.trim().toUpperCase();
            const vehicleMake = document.getElementById('vehicleMake').value.trim();
            const vehicleModel = document.getElementById('vehicleModel').value.trim();
            const vehicleColor = document.getElementById('vehicleColor').value.trim();
            const vehicleType = document.getElementById('vehicleType').value;
            const vehicleYear = document.getElementById('vehicleYear').value;
            
            if (!vehicleRegistration || !vehicleMake || !vehicleModel || !vehicleColor || !vehicleType) {
                throw new Error('All vehicle information is required');
            }
            
            formData.set('vehicle_registration', vehicleRegistration);
            formData.set('vehicle_make', vehicleMake);
            formData.set('vehicle_model', vehicleModel);
            formData.set('vehicle_color', vehicleColor);
            formData.set('vehicle_type', vehicleType);
            formData.set('vehicle_year', vehicleYear);
        }
        
        // Service selection data
        const selectionData = JSON.parse(document.getElementById('selectedServicesData').value || '{}');
        
        if (selectionData.type === 'package' && selectionData.package_id) {
            formData.set('service_type', 'package');
            formData.set('selected_package', selectionData.package_id);
        } else if (selectionData.type === 'individual' && selectionData.service_ids && selectionData.service_ids.length > 0) {
            formData.set('service_type', 'individual');
            selectionData.service_ids.forEach(serviceId => {
                formData.append('selected_services', serviceId);
            });
        } else {
            throw new Error('Please select at least one service or package');
        }
        
        // Additional order details
        formData.set('special_instructions', document.getElementById('specialInstructions').value.trim());
        formData.set('priority', document.getElementById('priority').value);
        
        // Log the data being sent (for debugging)
        console.log('Submitting order with data:', Object.fromEntries(formData.entries()));
        
        // Make the request with proper error handling
        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'  // Important for CSRF
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            // Check if response is ok
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Server did not return JSON response');
            }
            
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            
            if (data.success) {
                showToast('Order created successfully!', 'success');
                
                // Redirect after a short delay
                setTimeout(() => {
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    } else {
                        // Fallback redirect
                        window.location.href = `/business/{{ request.tenant.slug }}/services/orders/${data.order_id}/`;
                    }
                }, 1500);
            } else {
                // Handle server-side validation errors
                showToast(data.message || 'Error creating order', 'error');
                
                // Show field-specific errors if available
                if (data.errors) {
                    console.log('Form errors:', data.errors);
                    displayFormErrors(data.errors);
                }
            }
        })
        .catch(error => {
            console.error('Order creation error:', error);
            
            let errorMessage = 'Error creating order. Please try again.';
            
            if (error.message.includes('CSRF')) {
                errorMessage = 'Security token expired. Please refresh the page and try again.';
            } else if (error.message.includes('HTTP 500')) {
                errorMessage = 'Server error. Please contact support if this persists.';
            } else if (error.message.includes('HTTP 403')) {
                errorMessage = 'Access denied. Please refresh the page and try again.';
            } else if (error.message.includes('HTTP 404')) {
                errorMessage = 'Service not found. Please refresh the page.';
            } else if (error.message.includes('Network')) {
                errorMessage = 'Network error. Please check your connection.';
            }
            
            showToast(errorMessage, 'error');
        })
        .finally(() => {
            // Restore button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
        
    } catch (error) {
        console.error('Form preparation error:', error);
        showToast(error.message || 'Error preparing order data', 'error');
        
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

function validateAllSteps() {
    // Validate customer
    if (!selectedCustomer) {
        const name = document.getElementById('customerName').value.trim();
        const phone = document.getElementById('customerPhone').value.trim();
        if (!name || !phone) {
            return false;
        }
    }
    
    // Validate vehicle
    if (!selectedVehicle) {
        const registration = document.getElementById('vehicleRegistration').value.trim();
        const make = document.getElementById('vehicleMake').value.trim();
        const model = document.getElementById('vehicleModel').value.trim();
        const color = document.getElementById('vehicleColor').value.trim();
        const type = document.getElementById('vehicleType').value;
        
        if (!registration || !make || !model || !color || !type) {
            return false;
        }
    }
    
    // Validate services
    const selectionData = JSON.parse(document.getElementById('selectedServicesData').value || '{}');
    if (serviceType === 'package' && !selectedPackage) {
        return false;
    } else if (serviceType === 'individual' && selectedServices.length === 0) {
        return false;
    }
    
    return true;
}

function displayFormErrors(errors) {
    // Clear previous errors
    document.querySelectorAll('.form-control').forEach(field => {
        field.classList.remove('is-invalid');
    });
    document.querySelectorAll('.invalid-feedback').forEach(el => el.remove());
    
    // Display new errors
    Object.keys(errors).forEach(fieldName => {
        const fieldErrors = errors[fieldName];
        if (fieldErrors && fieldErrors.length > 0) {
            // Try to find the form field
            let field = document.querySelector(`[name="${fieldName}"]`);
            if (!field) {
                // Try alternative field names
                const fieldMappings = {
                    'customer_name': 'customerName',
                    'customer_phone': 'customerPhone',
                    'vehicle_registration': 'vehicleRegistration',
                    'vehicle_make': 'vehicleMake',
                    'vehicle_model': 'vehicleModel',
                    'vehicle_color': 'vehicleColor',
                    'vehicle_type': 'vehicleType'
                };
                field = document.getElementById(fieldMappings[fieldName]);
            }
            
            if (field) {
                field.classList.add('is-invalid');
                
                // Add error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'invalid-feedback';
                errorDiv.textContent = fieldErrors[0];
                field.parentNode.appendChild(errorDiv);
            }
        }
    });
}

// Enhanced CSRF token getter
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Enhanced toast with better positioning and styling
function showToast(message, type) {
    // Remove existing toasts
    document.querySelectorAll('.toast-notification').forEach(toast => toast.remove());
    
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    
    const iconMap = {
        'success': 'check-circle',
        'error': 'exclamation-triangle',
        'warning': 'exclamation-circle',
        'info': 'info-circle'
    };
    
    const colorMap = {
        'success': '#10b981',
        'error': '#ef4444',
        'warning': '#f59e0b',
        'info': '#06b6d4'
    };
    
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas fa-${iconMap[type] || 'info-circle'}"></i>
            <span>${message}</span>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Apply styles
    toast.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        z-index: 9999;
        min-width: 300px;
        max-width: 500px;
        animation: slideInRight 0.3s ease-out;
        border-left: 4px solid ${colorMap[type] || colorMap.info};
    `;
    
    const content = toast.querySelector('.toast-content');
    content.style.cssText = `
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: #374151;
    `;
    
    const icon = content.querySelector('i');
    icon.style.color = colorMap[type] || colorMap.info;
    
    const closeBtn = toast.querySelector('.toast-close');
    closeBtn.style.cssText = `
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 0.375rem;
        transition: color 0.15s ease-in-out;
    `;
    
    closeBtn.addEventListener('mouseenter', () => {
        closeBtn.style.color = '#374151';
    });
    
    closeBtn.addEventListener('mouseleave', () => {
        closeBtn.style.color = '#9ca3af';
    });
    
    document.body.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
}

// Add CSS animations
if (!document.getElementById('toast-animations')) {
    const style = document.createElement('style');
    style.id = 'toast-animations';
    style.textContent = `
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideOutRight {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        .invalid-feedback {
            display: block;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875rem;
            color: #ef4444;
        }
        .form-control.is-invalid {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }
    `;
    document.head.appendChild(style);
}
// Auto-search as user types
document.getElementById('customerSearchInput').addEventListener('input', function() {
    clearTimeout(this.searchTimeout);
    this.searchTimeout = setTimeout(() => {
        if (this.value.length >= 2) {
            searchCustomers();
        }
    }, 300);
});

document.getElementById('vehicleSearchInput').addEventListener('input', function() {
    clearTimeout(this.searchTimeout);
    this.searchTimeout = setTimeout(() => {
        if (this.value.length >= 2) {
            searchVehicles();
        }
    }, 300);
});

// Phone number formatting
document.getElementById('customerPhone').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    
    if (value.startsWith('0')) {
        value = '254' + value.substring(1);
    }
    if (value.startsWith('254') && !value.startsWith('+254')) {
        value = '+' + value;
    }
    
    e.target.value = value;
});

// Registration number formatting
document.getElementById('vehicleRegistration').addEventListener('input', function(e) {
    e.target.value = e.target.value.toUpperCase();
});

// Utility functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showToast(message, type) {
    // Remove existing toasts
    document.querySelectorAll('.toast-notification').forEach(toast => toast.remove());
    
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
            <span>${message}</span>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Toast styles
    toast.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: 1rem;
        box-shadow: var(--shadow-lg);
        z-index: 9999;
        min-width: 300px;
        animation: slideInRight 0.3s ease-out;
        border-left: 4px solid ${type === 'success' ? 'var(--success-500)' : type === 'error' ? '#ef4444' : 'var(--info-500)'};
    `;
    
    const content = toast.querySelector('.toast-content');
    content.style.cssText = `
        display: flex;
        align-items: center;
        gap: 0.75rem;
    `;
    
    const closeBtn = toast.querySelector('.toast-close');
    closeBtn.style.cssText = `
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: none;
        border: none;
        color: var(--gray-400);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: var(--radius-sm);
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}
</script>

<style>
@keyframes slideInRight {
    from { opacity: 0; transform: translateX(100%); }
    to { opacity: 1; transform: translateX(0); }
}

.row {
    display: flex;
    gap: 2rem;
    margin: 0 -1rem;
}

.col-lg-8 {
    flex: 0 0 66.666667%;
    padding: 0 1rem;
}

.col-lg-4 {
    flex: 0 0 33.333333%;
    padding: 0 1rem;
}

.col-md-6 {
    flex: 0 0 50%;
    padding: 0 1rem;
}

@media (max-width: 768px) {
    .row {
        flex-direction: column;
    }
    
    .col-lg-8,
    .col-lg-4,
    .col-md-6 {
        flex: 1;
    }
}
</style>
{% endblock %}