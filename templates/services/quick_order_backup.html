<!-- templates/services/quick_order.html -->
{% extends 'base/base.html' %}
{% load static %}

{% block title %}Quick Order - {{ block.super }}{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token }}">
<meta name="tenant-slug" content="{{ request.tenant.slug }}">
{% endblock %}

{% block extra_css %}
<style>
:root {
    --primary-500: #3b82f6;
    --primary-50: #eff6ff;
    --primary-600: #2563eb;
    --primary-700: #1d4ed8;
    --success-500: #10b981;
    --success-50: #ecfdf5;
    --success-600: #059669;
    --warning-500: #f59e0b;
    --warning-50: #fffbeb;
    --info-500: #06b6d4;
    --info-50: #f0f9ff;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --radius-sm: 0.375rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --transition-fast: 0.15s ease-in-out;
}

.page-header {
    background: linear-gradient(135deg, var(--primary-50), var(--success-50));
    border: 1px solid var(--primary-200);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.page-title {
    margin: 0;
    font-size: 1.875rem;
    font-weight: 700;
    color: var(--gray-900);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.page-description {
    margin: 0.5rem 0 0;
    color: var(--gray-600);
    font-size: 1rem;
}

.page-actions {
    display: flex;
    gap: 0.75rem;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius-md);
    font-weight: 500;
    text-decoration: none;
    border: 1px solid transparent;
    transition: all var(--transition-fast);
    cursor: pointer;
    font-size: 0.875rem;
}

.btn-outline-secondary {
    background: transparent;
    color: var(--gray-600);
    border-color: var(--gray-300);
}

.btn-outline-secondary:hover {
    background: var(--gray-50);
    border-color: var(--gray-500);
    text-decoration: none;
    color: var(--gray-700);
}

.btn-success {
    background: var(--success-500);
    color: white;
    border-color: var(--success-500);
}

.btn-success:hover {
    background: var(--success-600);
    text-decoration: none;
    color: white;
    transform: translateY(-1px);
}

.btn-primary {
    background: var(--primary-500);
    color: white;
    border-color: var(--primary-500);
}

.btn-primary:hover {
    background: var(--primary-600);
    text-decoration: none;
    color: white;
    transform: translateY(-1px);
}

.btn-lg {
    padding: 1rem 2rem;
    font-size: 1rem;
}

.quick-order-container {
    max-width: 1200px;
    margin: 0 auto;
}

.order-progress {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2rem;
    position: relative;
}

.order-progress::before {
    content: '';
    position: absolute;
    top: 1rem;
    left: 2rem;
    right: 2rem;
    height: 2px;
    background: var(--gray-200);
    z-index: 1;
}

.progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: white;
    padding: 0.5rem;
    z-index: 2;
    position: relative;
}

.progress-number {
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    background: var(--gray-200);
    color: var(--gray-600);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    margin-bottom: 0.5rem;
    transition: all var(--transition-fast);
}

.progress-step.active .progress-number {
    background: var(--primary-500);
    color: white;
}

.progress-step.completed .progress-number {
    background: var(--success-500);
    color: white;
}

.progress-label {
    font-size: 0.75rem;
    color: var(--gray-600);
    text-align: center;
}

.step-content {
    display: none;
}

.step-content.active {
    display: block;
}

.form-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    margin-bottom: 2rem;
}

.card-header {
    background: var(--gray-50);
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--gray-200);
}

.card-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--gray-900);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.card-body {
    padding: 1.5rem;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
}

.form-label.required::after {
    content: " *";
    color: #ef4444;
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    transition: all var(--transition-fast);
    background: white;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-control.is-invalid {
    border-color: #ef4444;
}

.form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 16px 12px;
    padding-right: 2.5rem;
    appearance: none;
}

.customer-search-section {
    background: var(--info-50);
    border: 1px solid var(--info-200);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.service-search-section {
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
    padding: 1rem;
}

.global-search-section {
    background: var(--primary-50);
    border: 1px solid var(--primary-200);
    border-radius: var(--radius-md);
    padding: 1rem;
}

.search-input-group {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.search-btn {
    background: var(--primary-500);
    color: white;
    border: none;
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: 0.875rem;
    white-space: nowrap;
}

.search-results {
    margin-top: 1rem;
    max-height: 200px;
    overflow-y: auto;
}

.search-result-item {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.search-result-item:hover {
    background: var(--primary-50);
    border-color: var(--primary-300);
}

.selected-customer,
.selected-vehicle {
    background: var(--success-50);
    border: 1px solid var(--success-200);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-bottom: 1rem;
}

.selection-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.change-btn {
    background: none;
    border: none;
    color: var(--primary-600);
    cursor: pointer;
    font-size: 0.875rem;
    text-decoration: underline;
}

.services-grid,
.inventory-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.service-card,
.inventory-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    cursor: pointer;
    transition: all var(--transition-fast);
    position: relative;
}

.service-card:hover,
.inventory-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
    border-color: var(--primary-300);
}

.service-card.selected,
.inventory-card.selected {
    border-color: var(--primary-500);
    background: var(--primary-50);
}

.service-card.selected::before,
.inventory-card.selected::before {
    content: '✓';
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: var(--primary-500);
    color: white;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
}

.service-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
}

.service-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0;
}

.service-price {
    font-size: 1rem;
    font-weight: 700;
    color: var(--primary-600);
}

.service-description {
    font-size: 0.875rem;
    color: var(--gray-600);
    margin-bottom: 0.75rem;
    line-height: 1.4;
}

.service-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: var(--gray-500);
}

.service-duration {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.service-category {
    background: var(--gray-100);
    color: var(--gray-700);
    padding: 0.125rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.625rem;
    font-weight: 500;
    text-transform: uppercase;
}

.service-type-selector .btn-group {
    border-radius: var(--radius-md);
    overflow: hidden;
}

.service-type-selector .btn {
    border-radius: 0;
    border-color: var(--primary-300);
}

.service-type-selector .btn.active {
    background: var(--primary-500);
    color: white;
    border-color: var(--primary-500);
}

.packages-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.package-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    cursor: pointer;
    transition: all var(--transition-fast);
    position: relative;
    overflow: hidden;
}

.package-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
    border-color: var(--primary-300);
}

.package-card.selected {
    border-color: var(--primary-500);
    background: var(--primary-50);
}

.package-card.selected::before {
    content: '✓';
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: var(--primary-500);
    color: white;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
    z-index: 2;
}

.package-header {
    margin-bottom: 1rem;
}

.package-name {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0 0 0.5rem 0;
}

.package-pricing {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.original-price {
    font-size: 0.875rem;
    color: var(--gray-500);
    text-decoration: line-through;
}

.package-price {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary-600);
}

.savings {
    font-size: 0.75rem;
    color: var(--success-600);
    font-weight: 600;
    background: var(--success-50);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
}

.package-description {
    font-size: 0.875rem;
    color: var(--gray-600);
    margin-bottom: 1rem;
    line-height: 1.4;
}

.package-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: var(--gray-500);
}

.package-duration,
.package-services-count {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.package-badge {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
}

.discount-badge {
    background: var(--warning-500);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
}

.popular-badge {
    top: 0.5rem;
    left: 0.5rem;
}

.popular-label {
    background: var(--success-500);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
}

.order-summary {
    position: sticky;
    top: 2rem;
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    box-shadow: var(--shadow-sm);
}

.summary-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--gray-200);
}

.summary-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0;
}

.summary-content {
    margin-bottom: 1.5rem;
}

.selected-services-list {
    margin-bottom: 1rem;
}

.selected-service-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--gray-100);
}

.selected-service-item:last-child {
    border-bottom: none;
}

.service-item-name {
    font-size: 0.875rem;
    color: var(--gray-900);
}

.service-item-price {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--gray-700);
}

.summary-totals {
    border-top: 2px solid var(--gray-200);
    padding-top: 1rem;
}

.total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.total-row.main {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--gray-900);
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--gray-200);
}

.summary-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.step-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    background: var(--gray-50);
    border-top: 1px solid var(--gray-200);
    margin-top: 2rem;
}

.nav-buttons {
    display: flex;
    gap: 0.75rem;
}

.btn-outline-gray {
    background: transparent;
    color: var(--gray-600);
    border-color: var(--gray-300);
}

.btn-outline-gray:hover {
    background: var(--gray-100);
    border-color: var(--gray-400);
    text-decoration: none;
    color: var(--gray-700);
}

.step-indicator {
    font-size: 0.875rem;
    color: var(--gray-600);
}

.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--gray-500);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.category-filter {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.category-btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-md);
    background: white;
    color: var(--gray-700);
    cursor: pointer;
    font-size: 0.875rem;
    transition: all var(--transition-fast);
}

.category-btn:hover {
    background: var(--gray-50);
    border-color: var(--gray-400);
}

.category-btn.active {
    background: var(--primary-500);
    color: white;
    border-color: var(--primary-500);
}

@media (max-width: 1024px) {
    .quick-order-container {
        padding: 0 1rem;
    }
    
    .order-summary {
        position: static;
        margin-top: 2rem;
    }
}

@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .services-grid,
    .packages-grid {
        grid-template-columns: 1fr;
    }
    
    .search-input-group {
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .search-btn {
        width: 100%;
    }
    
    .order-progress {
        margin-bottom: 1.5rem;
        overflow-x: auto;
        padding-bottom: 0.5rem;
    }
    
    .order-progress::before {
        left: 1rem;
        right: 1rem;
    }
    
    .progress-step {
        padding: 0.25rem;
        min-width: 80px;
    }
    
    .progress-number {
        width: 1.5rem;
        height: 1.5rem;
        font-size: 0.75rem;
    }
    
    .progress-label {
        font-size: 0.625rem;
    }
    
    .service-type-selector .btn-group {
        flex-direction: column;
    }
    
    .service-type-selector .btn {
        border-radius: var(--radius-md) !important;
        margin-bottom: 0.5rem;
    }
    
    .service-type-selector .btn:last-child {
        margin-bottom: 0;
    }
    
    .category-filter {
        justify-content: center;
        overflow-x: auto;
        flex-wrap: nowrap;
        padding-bottom: 0.5rem;
    }
    
    .category-btn {
        font-size: 0.75rem;
        padding: 0.375rem 0.75rem;
        white-space: nowrap;
    }
    
    .step-navigation {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
        margin-bottom: 80px; /* Space for mobile summary */
    }
    
    .nav-buttons {
        justify-content: center;
    }
    
    /* Hide desktop order summary on mobile */
    .order-summary {
        display: none;
    }
    
    /* Show mobile order summary */
    .mobile-order-summary {
        display: block;
    }
    
    /* Show pagination on mobile */
    .pagination-container {
        display: block;
    }
    
    /* Limit items shown per page on mobile */
    .services-grid .service-card:nth-child(n+7),
    .packages-grid .package-card:nth-child(n+5),
    .inventory-grid .inventory-card:nth-child(n+7) {
        display: none;
    }
}

@media (max-width: 576px) {
    .quick-order-container {
        padding: 0 0.5rem;
    }
    
    .form-card {
        margin-bottom: 1rem;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    .page-title {
        font-size: 1.5rem;
    }
    
    .btn {
        padding: 0.625rem 1rem;
        font-size: 0.875rem;
        min-height: 44px; /* Improved tap target */
    }
    
    .service-card,
    .package-card,
    .inventory-card {
        padding: 1rem;
        margin-bottom: 0.75rem;
        min-height: 120px; /* Consistent height */
    }
    
    .category-btn {
        min-height: 40px; /* Better tap targets */
        padding: 0.5rem 1rem;
    }
    
    .pagination-btn {
        min-height: 40px;
        min-width: 40px;
    }
    
    .mobile-order-summary {
        padding: 0.75rem;
    }
    
    .mobile-summary-toggle {
        min-height: 60px; /* Easy to tap */
    }
    
    /* Performance optimizations */
    .service-card,
    .package-card,
    .inventory-card {
        will-change: transform;
        backface-visibility: hidden;
    }
    
    .pagination-container {
        overflow-x: auto;
        scroll-behavior: smooth;
    }
    
    /* Reduce animations on mobile for better performance */
    * {
        animation-duration: 0.1s !important;
        transition-duration: 0.1s !important;
    }
}

.text-muted { color: var(--gray-500); }
.text-success { color: var(--success-600); }
.text-primary { color: var(--primary-600); }
.d-flex { display: flex; }
.justify-content-between { justify-content: space-between; }
.align-items-center { align-items: center; }
.p-3 { padding: 1rem; }

/* Search empty state */
.search-empty-state {
    grid-column: 1 / -1;
}

/* Pagination */
.pagination-container {
    display: none; /* Hidden by default, shown on mobile */
    margin-top: 1rem;
    text-align: center;
}

.pagination-info {
    font-size: 0.875rem;
    color: var(--gray-600);
    margin-bottom: 0.5rem;
}

.pagination-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
}

.pagination-btn {
    padding: 0.375rem 0.75rem;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-md);
    background: white;
    color: var(--gray-700);
    font-size: 0.875rem;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.pagination-btn:hover:not(:disabled) {
    background: var(--primary-50);
    border-color: var(--primary-300);
    color: var(--primary-700);
}

.pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.pagination-btn.active {
    background: var(--primary-500);
    border-color: var(--primary-500);
    color: white;
}

/* Mobile order summary - sticky at bottom */
.mobile-order-summary {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-top: 1px solid var(--gray-200);
    box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    padding: 1rem;
}

/* Show mobile summary on tablets and mobile */
@media (max-width: 768px) {
    .mobile-order-summary {
        display: block !important;
    }
}

.mobile-summary-toggle {
    display: flex;
    justify-content: between;
    align-items: center;
    width: 100%;
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
}

.mobile-summary-content {
    display: none;
    padding-top: 1rem;
    border-top: 1px solid var(--gray-200);
    margin-top: 1rem;
}

.mobile-summary-content.show {
    display: block;
}

/* Inventory quantity controls */
.inventory-quantity-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.75rem;
    padding: 0.5rem;
    background: #f8fafc;
    border-radius: 0.375rem;
    border-top: 1px solid #e2e8f0;
}

.quantity-btn {
    width: 2rem;
    height: 2rem;
    border: 1px solid #d1d5db;
    background: white;
    border-radius: 0.375rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
    font-size: 0.75rem;
}

.quantity-btn:hover {
    background: #f9fafb;
    border-color: #9ca3af;
}

.inventory-quantity-input {
    width: 3rem;
    text-align: center;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    padding: 0.25rem;
    font-size: 0.875rem;
}

/* Category filter for inventory */
.inventory-category-btn {
    padding: 0.5rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    background: white;
    color: #374151;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.15s ease-in-out;
}

.inventory-category-btn:hover {
    background: #f9fafb;
    border-color: #9ca3af;
}

/* Customer Parts Styles */
.add-customer-part-form {
    background: var(--success-50);
    border: 1px solid var(--success-200);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.customer-parts-list {
    min-height: 200px;
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1rem;
}

.customer-part-item {
    display: flex;
    justify-content: between;
    align-items: center;
    padding: 1rem;
    background: var(--success-50);
    border: 1px solid var(--success-200);
    border-radius: var(--radius-md);
    margin-bottom: 0.75rem;
    transition: all var(--transition-fast);
}

.customer-part-item:hover {
    background: var(--success-100);
    border-color: var(--success-300);
}

.customer-part-info {
    flex: 1;
}

.customer-part-name {
    font-weight: 600;
    color: var(--success-700);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.customer-part-quantity {
    color: var(--success-600);
    font-size: 0.875rem;
    margin: 0;
}

.customer-part-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-edit-part {
    background: var(--warning-500);
    color: white;
    border: none;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.btn-edit-part:hover {
    background: var(--warning-600);
}

.btn-remove-part {
    background: var(--gray-500);
    color: white;
    border: none;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.btn-remove-part:hover {
    background: var(--gray-600);
}

/* Price Editing Styles */
.price-edit-container {
    position: relative;
    display: inline-block;
}

.price-display {
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    transition: all var(--transition-fast);
}

.price-display:hover {
    background: var(--primary-50);
    color: var(--primary-600);
}

.price-edit-input {
    width: 80px;
    padding: 0.25rem;
    border: 1px solid var(--primary-300);
    border-radius: var(--radius-sm);
    text-align: right;
    font-size: 0.875rem;
}

.price-edit-controls {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-sm);
    box-shadow: var(--shadow-md);
    padding: 0.5rem;
    display: none;
    z-index: 10;
    gap: 0.25rem;
}

.price-edit-controls.active {
    display: flex;
}

.btn-save-price, .btn-cancel-price {
    padding: 0.25rem 0.5rem;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    cursor: pointer;
}

.btn-save-price {
    background: var(--success-500);
    color: white;
}

.btn-cancel-price {
    background: var(--gray-500);
    color: white;
}

.inventory-category-btn.active {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

/* Inventory badges */
.out-of-stock-badge {
    background: #ef4444;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 600;
}

.low-stock-badge {
    background: #f59e0b;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 600;
}

/* Out of stock inventory cards */
.inventory-card:has(.out-of-stock-badge) {
    opacity: 0.6;
    cursor: not-allowed;
}

.inventory-card:has(.out-of-stock-badge):hover {
    border-color: var(--gray-200);
    background: white;
    transform: none;
    box-shadow: none;
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">
            <i class="fas fa-bolt text-primary"></i>
            Quick Order
        </h1>
        <p class="page-description">Create a service order quickly for walk-in customers</p>
    </div>
    
    <div class="page-actions">
        <a href="/business/{{ request.tenant.slug }}/services/dashboard/" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i>
            Back to Dashboard
        </a>
    </div>
</div>

<div class="quick-order-container">
    <!-- Progress Indicator -->
    <div class="order-progress">
        <div class="progress-step active" id="step1-indicator">
            <div class="progress-number">1</div>
            <div class="progress-label">Number Plate</div>
        </div>
        <div class="progress-step" id="step2-indicator">
            <div class="progress-number">2</div>
            <div class="progress-label">Customer</div>
        </div>
        <div class="progress-step" id="step3-indicator">
            <div class="progress-number">3</div>
            <div class="progress-label">Services</div>
        </div>
        <div class="progress-step" id="step4-indicator">
            <div class="progress-number">4</div>
            <div class="progress-label">Review</div>
        </div>
    </div>

    <form id="quickOrderForm" method="post">
        {% csrf_token %}
        
        <!-- Step 1: Vehicle Search/Selection -->
        <div class="step-content active" id="step1">
            <div class="form-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-car"></i>
                        Vehicle Search
                    </h5>
                </div>
                
                <div class="card-body">
                    <div id="vehicleRegistrationSection">
                        <!-- Vehicle Search - Primary Option -->
                        <div class="customer-search-section">
                            <h6><i class="fas fa-search"></i> Search by Number Plate</h6>
                            <div class="search-input-group">
                                <input type="text" class="form-control" id="vehicleSearchInput" placeholder="Enter number plate (e.g., KCA 123A)..." style="text-transform: uppercase;">
                                <button type="button" class="search-btn" onclick="searchVehiclesByRegistration()">
                                    <i class="fas fa-search"></i>
                                    Search
                                </button>
                            </div>
                            <div id="vehicleSearchResults" class="search-results" style="display: none;"></div>
                        </div>

                    <!-- Selected Vehicle Display -->
                    <div id="selectedVehicleDisplay" style="display: none;">
                        <div class="selected-vehicle">
                            <div class="selection-header">
                                <h6><i class="fas fa-check-circle text-success"></i> Selected Vehicle</h6>
                                <button type="button" class="change-btn" onclick="changeVehicle()">Change</button>
                            </div>
                            <div id="selectedVehicleInfo"></div>
                        </div>
                    </div>

                    <!-- New Vehicle Form -->
                    <div id="newVehicleForm">
                        <h6><i class="fas fa-plus"></i> Register New Vehicle</h6>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vehicleRegistration" class="form-label required">Number Plate</label>
                                <input type="text" class="form-control" id="vehicleRegistration" name="vehicle_registration" required style="text-transform: uppercase;">
                            </div>
                            <div class="form-group">
                                <label for="vehicleType" class="form-label">Vehicle Type (Optional)</label>
                                <select class="form-control form-select" id="vehicleType" name="vehicle_type">
                                    <option value="">Select Type</option>
                                    <option value="sedan">Sedan</option>
                                    <option value="suv">SUV</option>
                                    <option value="hatchback">Hatchback</option>
                                    <option value="pickup">Pickup Truck</option>
                                    <option value="van">Van</option>
                                    <option value="bus">Bus</option>
                                    <option value="motorcycle">Motorcycle</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vehicleMake" class="form-label">Make (Optional)</label>
                                <input type="text" class="form-control" id="vehicleMake" name="vehicle_make" placeholder="e.g., Toyota">
                            </div>
                            <div class="form-group">
                                <label for="vehicleModel" class="form-label">Model (Optional)</label>
                                <input type="text" class="form-control" id="vehicleModel" name="vehicle_model" placeholder="e.g., Camry">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vehicleColor" class="form-label">Color (Optional)</label>
                                <input type="text" class="form-control" id="vehicleColor" name="vehicle_color" placeholder="e.g., White">
                            </div>
                            <div class="form-group">
                                <label for="vehicleYear" class="form-label">Year</label>
                                <input type="number" class="form-control" id="vehicleYear" name="vehicle_year" min="1990" max="2025" value="2020">
                            </div>
                        </div>
                    </div>

                    <!-- Hidden fields for selected vehicle -->
                    <input type="hidden" id="selectedVehicleId" name="selected_vehicle_id">
                    <input type="hidden" id="skipVehicleInput" name="skip_vehicle" value="false">
                    </div> <!-- End vehicleRegistrationSection -->
                    
                    <!-- Skip Vehicle Option - Moved below, with better mobile layout -->
                    <div class="mt-4">
                        <div class="text-center">
                            <hr class="my-3">
                            <small class="text-muted d-block mb-3">Skip vehicle registration if selling inventory items only</small>
                            <div class="d-grid d-md-flex justify-content-md-center">
                                <button type="button" class="btn btn-warning" id="skipVehicleBtn" onclick="toggleVehicleSkip()">
                                    <i class="fas fa-forward me-2"></i>
                                    <span id="skipVehicleBtnText">Skip Vehicle Registration</span>
                                </button>
                            </div>
                            <input type="hidden" id="skipVehicleCheckbox" value="false">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Customer Selection -->
        <div class="step-content" id="step2">
            <div class="form-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-user"></i>
                        Select Customer
                    </h5>
                </div>
                
                <div class="card-body">
                    <!-- Walk-in Customer Option -->
                    <div class="walk-in-option">
                        <button type="button" class="btn btn-outline-primary btn-lg w-100 mb-3" onclick="selectWalkInCustomer()">
                            <i class="fas fa-walking"></i>
                            Walk-in Customer
                        </button>
                        <div class="text-center mb-3">
                            <small class="text-muted">OR</small>
                        </div>
                    </div>

                    <!-- Existing Customer from Vehicle -->
                    <div id="vehicleCustomerDisplay" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Vehicle Owner Found</strong>
                            <div id="vehicleCustomerInfo"></div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-success" onclick="useVehicleCustomer()">
                                    Use This Customer
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="showCustomerOptions()">
                                    Different Customer
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Search -->
                    <div class="customer-search-section" id="customerSearchSection">
                        <h6><i class="fas fa-search"></i> Search Existing Customer</h6>
                        <div class="search-input-group">
                            <input type="text" class="form-control" id="customerSearchInput" placeholder="Search by name, phone, or customer ID...">
                            <button type="button" class="search-btn" onclick="searchCustomers()">
                                <i class="fas fa-search"></i>
                                Search
                            </button>
                        </div>
                        <div id="customerSearchResults" class="search-results" style="display: none;"></div>
                    </div>

                    <!-- Selected Customer Display -->
                    <div id="selectedCustomerDisplay" style="display: none;">
                        <div class="selected-customer">
                            <div class="selection-header">
                                <h6><i class="fas fa-check-circle text-success"></i> Selected Customer</h6>
                                <button type="button" class="change-btn" onclick="changeCustomer()">Change</button>
                            </div>
                            <div id="selectedCustomerInfo"></div>
                        </div>
                    </div>

                    <!-- New Customer Form -->
                    <div id="newCustomerForm" style="display: none;">
                        <h6><i class="fas fa-user-plus"></i> Register New Customer</h6>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customerName" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="customerName" name="customer_name" placeholder="Optional for walk-in">
                            </div>
                            <div class="form-group">
                                <label for="customerPhone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="customerPhone" name="customer_phone" placeholder="Optional for walk-in">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="customerEmail" class="form-label">Email (Optional)</label>
                            <input type="email" class="form-control" id="customerEmail" name="customer_email">
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="addVehicleToCustomer" name="add_vehicle_to_customer">
                            <label class="form-check-label" for="addVehicleToCustomer">
                                Add vehicle to this customer's account
                            </label>
                        </div>
                    </div>

                    <!-- Walk-in Customer Display -->
                    <div id="walkInCustomerDisplay" style="display: none;">
                        <div class="alert alert-warning">
                            <i class="fas fa-walking"></i>
                            <strong>Walk-in Customer</strong>
                            <p class="mb-0">Customer details will be captured during payment if needed.</p>
                        </div>
                    </div>

                    <!-- Hidden fields for selected customer -->
                    <input type="hidden" id="selectedCustomerId" name="selected_customer_id">
                    <input type="hidden" id="isWalkInCustomer" name="is_walk_in_customer" value="false">
                </div>
            </div>
        </div>

        <!-- Step 3: Service Selection -->
        <div class="step-content" id="step3">
            <div class="row">
                <div class="col-lg-8">
                    <div class="form-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-list-check"></i>
                                Select Services
                            </h5>
                        </div>
                        
                        <div class="card-body">
                            <!-- Service Type Selector -->
                            <div class="service-type-selector mb-3">
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-outline-primary active" id="individualServicesBtn" onclick="showServiceType('individual')">
                                        <i class="fas fa-list"></i>
                                        Individual Services
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" id="packagesBtn" onclick="showServiceType('packages')">
                                        <i class="fas fa-box"></i>
                                        Service Packages
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" id="inventoryBtn" onclick="showServiceType('inventory')">
                                        <i class="fas fa-boxes"></i>
                                        Inventory Items
                                    </button>
                                    <button type="button" class="btn btn-outline-success" id="customerPartsBtn" onclick="showServiceType('customerParts')">
                                        <i class="fas fa-gift"></i>
                                        Customer Parts
                                    </button>
                                </div>
                            </div>

                            <!-- Individual Services Section -->
                            <div id="individualServicesSection">
                                <!-- Service Search -->
                                <div class="service-search-section mb-3">
                                    <div class="search-input-group">
                                        <input type="text" class="form-control" id="serviceSearchInput" placeholder="Search services by name or description...">
                                        <button type="button" class="search-btn" onclick="clearServiceSearch()">
                                            <i class="fas fa-times"></i>
                                            Clear
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Category Filter -->
                                <div class="category-filter">
                                    <button type="button" class="category-btn active" onclick="filterServices('all')" data-category="all">
                                        All Services
                                    </button>
                                    {% for category in categories %}
                                    <button type="button" class="category-btn" onclick="filterServices('{{ category.id }}')" data-category="{{ category.id }}">
                                        <i class="{{ category.icon }}"></i>
                                        {{ category.name }}
                                    </button>
                                    {% endfor %}
                                </div>

                                <!-- Services Grid -->
                                <div class="services-grid" id="servicesGrid">
                                    {% for service in all_services %}
                                    <div class="service-card" onclick="toggleService('{{ service.id }}')" data-service-id="{{ service.id }}" data-category="{{ service.category.id }}">
                                        <div class="service-header">
                                            <h6 class="service-name">{{ service.name }}</h6>
                                            <div class="price-edit-container">
                                                <div class="service-price price-display" onclick="event.stopPropagation(); editPrice('service', '{{ service.id }}', {{ service.base_price }}, {{ service.minimum_price|default:service.base_price }})">
                                                    KES {{ service.base_price }}
                                                </div>
                                                <div class="price-edit-controls">
                                                    <input type="number" class="price-edit-input" step="0.01" min="{{ service.minimum_price|default:service.base_price }}" onclick="event.stopPropagation();">
                                                    <button class="btn-save-price" onclick="event.stopPropagation(); savePrice('service', '{{ service.id }}')">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button class="btn-cancel-price" onclick="event.stopPropagation(); cancelPriceEdit()">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <p class="service-description">{{ service.description|truncatewords:15 }}</p>
                                        <div class="service-details">
                                            <div class="service-duration">
                                                <i class="fas fa-clock"></i>
                                                {{ service.estimated_duration }} min
                                            </div>
                                            <div class="service-category">{{ service.category.name }}</div>
                                        </div>
                                        {% if service.is_popular %}
                                        <div class="service-badge">
                                            <span class="popular-badge">POPULAR</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% empty %}
                                    <div class="empty-state">
                                        <i class="fas fa-car-wash"></i>
                                        <p>No services available</p>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <!-- Services Pagination -->
                                <div class="pagination-container" id="servicesPagination">
                                    <div class="pagination-info" id="servicesPaginationInfo"></div>
                                    <div class="pagination-controls">
                                        <button type="button" class="pagination-btn" id="servicesPrevBtn" onclick="changeServicesPage(-1)">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <span class="pagination-pages" id="servicesPaginationPages"></span>
                                        <button type="button" class="pagination-btn" id="servicesNextBtn" onclick="changeServicesPage(1)">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Service Packages Section -->
                            <div id="packagesSection" style="display: none;">
                                <!-- Package Search -->
                                <div class="service-search-section mb-3">
                                    <div class="search-input-group">
                                        <input type="text" class="form-control" id="packageSearchInput" placeholder="Search packages by name or description...">
                                        <button type="button" class="search-btn" onclick="clearPackageSearch()">
                                            <i class="fas fa-times"></i>
                                            Clear
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="packages-grid" id="packagesGrid">
                                    {% for package in service_packages %}
                                    <div class="package-card" onclick="togglePackage('{{ package.id }}')" data-package-id="{{ package.id }}">
                                        <div class="package-header">
                                            <h6 class="package-name">{{ package.name }}</h6>
                                            <div class="package-pricing">
                                                {% if package.discount_percentage > 0 %}
                                                <div class="original-price">KES {{ package.original_price|floatformat:2 }}</div>
                                                <div class="price-edit-container">
                                                    <div class="package-price price-display" onclick="event.stopPropagation(); editPrice('package', '{{ package.id }}', {{ package.total_price }}, {{ package.minimum_price|default:package.total_price }})">
                                                        KES {{ package.total_price }}
                                                    </div>
                                                    <div class="price-edit-controls">
                                                        <input type="number" class="price-edit-input" step="0.01" min="{{ package.minimum_price|default:package.total_price }}" onclick="event.stopPropagation();">
                                                        <button type="button" class="btn-save-price" onclick="event.stopPropagation(); savePrice('package', '{{ package.id }}')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button type="button" class="btn-cancel-price" onclick="event.stopPropagation(); cancelPriceEdit()">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="savings">Save KES {{ package.savings_amount|floatformat:2 }}</div>
                                                {% else %}
                                                <div class="price-edit-container">
                                                    <div class="package-price price-display" onclick="event.stopPropagation(); editPrice('package', '{{ package.id }}', {{ package.total_price }}, {{ package.minimum_price|default:package.total_price }})">
                                                        KES {{ package.total_price }}
                                                    </div>
                                                    <div class="price-edit-controls">
                                                        <input type="number" class="price-edit-input" step="0.01" min="{{ package.minimum_price|default:package.total_price }}" onclick="event.stopPropagation();">
                                                        <button type="button" class="btn-save-price" onclick="event.stopPropagation(); savePrice('package', '{{ package.id }}')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                        <button type="button" class="btn-cancel-price" onclick="event.stopPropagation(); cancelPriceEdit()">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <p class="package-description">{{ package.description|truncatewords:20 }}</p>
                                        <div class="package-details">
                                            <div class="package-duration">
                                                <i class="fas fa-clock"></i>
                                                {{ package.estimated_duration }} min
                                            </div>
                                            <div class="package-services-count">
                                                <i class="fas fa-list"></i>
                                                {{ package.service_count }} services
                                            </div>
                                        </div>
                                        {% if package.discount_percentage > 0 %}
                                        <div class="package-badge">
                                            <span class="discount-badge">{{ package.discount_percentage|floatformat:0 }}% OFF</span>
                                        </div>
                                        {% endif %}
                                        {% if package.is_popular %}
                                        <div class="package-badge popular-badge">
                                            <span class="popular-label">POPULAR</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% empty %}
                                    <div class="empty-state">
                                        <i class="fas fa-box"></i>
                                        <p>No service packages available</p>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <!-- Packages Pagination -->
                                <div class="pagination-container" id="packagesPagination">
                                    <div class="pagination-info" id="packagesPaginationInfo"></div>
                                    <div class="pagination-controls">
                                        <button type="button" class="pagination-btn" id="packagesPrevBtn" onclick="changePackagesPage(-1)">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <span class="pagination-pages" id="packagesPaginationPages"></span>
                                        <button type="button" class="pagination-btn" id="packagesNextBtn" onclick="changePackagesPage(1)">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Inventory Items Section -->
                            <div id="inventorySection" style="display: none;">
                                <!-- Inventory Search -->
                                <div class="service-search-section mb-3">
                                    <div class="search-input-group">
                                        <input type="text" class="form-control" id="inventorySearchInput" placeholder="Search inventory items by name or description...">
                                        <button type="button" class="search-btn" onclick="clearInventorySearch()">
                                            <i class="fas fa-times"></i>
                                            Clear
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Category Filter for Inventory -->
                                <div class="category-filter">
                                    <button type="button" class="inventory-category-btn active" onclick="filterInventoryItems('all')" data-inventory-category="all">
                                        All Items
                                    </button>
                                    {% for category in inventory_categories %}
                                    <button type="button" class="inventory-category-btn" onclick="filterInventoryItems('{{ category.id }}')" data-inventory-category="{{ category.id }}">
                                        {{ category.name }}
                                    </button>
                                    {% endfor %}
                                </div>

                                <!-- Inventory Grid -->
                                <div class="inventory-grid" id="inventoryGrid">
                                    {% for item in inventory_items %}
                                    <div class="inventory-card" onclick="selectInventoryCard('{{ item.id }}')" data-item-id="{{ item.id }}" data-category="{{ item.category.id|default:'other' }}">
                                        <div class="service-header">
                                            <h6 class="service-name">{{ item.name }}</h6>
                                            <div class="price-edit-container">
                                                <div class="service-price price-display" onclick="event.stopPropagation(); editPrice('inventory', '{{ item.id }}', {{ item.selling_price }}, {{ item.minimum_price|default:item.selling_price }})">
                                                    KES {{ item.selling_price }}
                                                </div>
                                                <div class="price-edit-controls">
                                                    <input type="number" class="price-edit-input" step="0.01" min="{{ item.minimum_price|default:item.selling_price }}" onclick="event.stopPropagation();">
                                                    <button type="button" class="btn-save-price" onclick="event.stopPropagation(); savePrice('inventory', '{{ item.id }}')">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button type="button" class="btn-cancel-price" onclick="event.stopPropagation(); cancelPriceEdit()">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        {% if item.description %}
                                        <p class="service-description">{{ item.description|truncatewords:15 }}</p>
                                        {% endif %}
                                        <div class="service-details">
                                            <div class="service-duration">
                                                <i class="fas fa-box"></i>
                                                Stock: {{ item.current_stock }}
                                            </div>
                                            {% if item.brand %}
                                            <div class="service-category">{{ item.brand }}</div>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Quantity controls -->
                                        <div class="inventory-quantity-controls">
                                            <button type="button" class="quantity-btn" onclick="event.stopPropagation(); updateInventoryQuantity('{{ item.id }}', -1)">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <input type="number" class="inventory-quantity-input" data-item-id="{{ item.id }}" data-max-stock="{{ item.current_stock }}" value="0" min="0" max="{{ item.current_stock }}" step="0.01" onchange="onInventoryQuantityChange(this, '{{ item.id }}')" onclick="event.stopPropagation()">
                                            <button type="button" class="quantity-btn" onclick="event.stopPropagation(); updateInventoryQuantity('{{ item.id }}', 1)">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                        
                                        {% if item.current_stock == 0 %}
                                        <div class="service-badge">
                                            <span class="out-of-stock-badge">OUT OF STOCK</span>
                                        </div>
                                        {% elif item.current_stock <= item.minimum_stock %}
                                        <div class="service-badge">
                                            <span class="low-stock-badge">LOW STOCK</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% empty %}
                                    <div class="empty-state">
                                        <i class="fas fa-boxes"></i>
                                        <p>No inventory items available</p>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <!-- Inventory Pagination -->
                                <div class="pagination-container" id="inventoryPagination">
                                    <div class="pagination-info" id="inventoryPaginationInfo"></div>
                                    <div class="pagination-controls">
                                        <button type="button" class="pagination-btn" id="inventoryPrevBtn" onclick="changeInventoryPage(-1)">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <span class="pagination-pages" id="inventoryPaginationPages"></span>
                                        <button type="button" class="pagination-btn" id="inventoryNextBtn" onclick="changeInventoryPage(1)">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                            <!-- Customer Parts Section -->
                            <div id="customerPartsSection" style="display: none;">
                                <!-- Add Custom Part Form -->
                                <div class="add-customer-part-form">
                                    <h6 class="section-subtitle">
                                        <i class="fas fa-gift text-success"></i>
                                        Add Customer-Provided Parts
                                    </h6>
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label for="customerPartName" class="form-label">Part Name</label>
                                            <input type="text" class="form-control" id="customerPartName" 
                                                   placeholder="Enter part name (e.g., Oil Filter, Brake Pads)">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="customerPartQuantity" class="form-label">Quantity</label>
                                            <input type="number" class="form-control" id="customerPartQuantity" 
                                                   min="0.01" step="0.01" value="1" placeholder="1">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="button" class="btn btn-success w-100" onclick="addCustomerPart()">
                                                <i class="fas fa-plus"></i> Add Part
                                            </button>
                                        </div>
                                    </div>
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>Note:</strong> Customer-provided parts appear on the receipt but are not charged and don't affect inventory.
                                    </div>
                                </div>

                                <!-- Added Customer Parts List -->
                                <div class="added-customer-parts">
                                    <h6 class="section-subtitle">Added Customer Parts</h6>
                                    <div id="customerPartsListDisplay" class="customer-parts-list">
                                        <div class="empty-state">
                                            <i class="fas fa-gift"></i>
                                            <p>No customer parts added yet</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                
                <div class="col-lg-4">
                    <!-- Order Summary -->
                    <div class="order-summary">
                        <div class="summary-header">
                            <h6 class="summary-title">
                                <i class="fas fa-shopping-cart"></i>
                                Order Summary
                            </h6>
                        </div>
                        
                        <div class="summary-content">
                            <div id="selectedServicesDisplay">
                                <div class="empty-state">
                                    <i class="fas fa-list"></i>
                                    <p>No services selected</p>
                                </div>
                            </div>
                            
                            <div class="selected-services-list" id="selectedServicesList" style="display: none;">
                                <!-- Selected services will be populated here -->
                            </div>
                            
                            <div class="summary-totals" id="summaryTotals" style="display: none;">
                                <div class="total-row">
                                    <span>Subtotal (ex VAT):</span>
                                    <span id="subtotalAmount">KES 0</span>
                                </div>
                                <div class="total-row">
                                    <span>VAT (16%):</span>
                                    <span id="taxAmount">KES 0</span>
                                </div>
                                <div class="total-row main">
                                    <span>Total (incl VAT):</span>
                                    <span id="totalAmount">KES 0</span>
                                </div>
                                <div class="total-row">
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i>
                                        Est. Duration: <span id="estimatedDuration">0</span> min
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="summary-actions">
                            <button type="button" class="btn btn-outline-gray" onclick="clearAllServices()">
                                <i class="fas fa-trash"></i>
                                Clear All
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Review & Submit -->
        <div class="step-content" id="step4">
            <div class="form-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-check-circle"></i>
                        Review Order
                    </h5>
                </div>
                
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Customer Information</h6>
                            <div id="reviewCustomerInfo" class="mb-3">
                                <!-- Customer info will be populated here -->
                            </div>
                            
                            <h6>Vehicle Information</h6>
                            <div id="reviewVehicleInfo" class="mb-3">
                                <!-- Vehicle info will be populated here -->
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div id="reviewServicesSection" style="display: none;">
                                <h6><i class="fas fa-tools me-2"></i>Selected Services</h6>
                                <div id="reviewServicesInfo" class="mb-3">
                                    <!-- Services info will be populated here -->
                                </div>
                            </div>
                            
                            <div id="reviewInventorySection" style="display: none;">
                                <h6><i class="fas fa-box me-2"></i>Selected Items</h6>
                                <div id="reviewInventoryInfo" class="mb-3">
                                    <!-- Inventory info will be populated here -->
                                </div>
                            </div>
                            
                            <h6>Order Total</h6>
                            <div id="reviewTotalInfo">
                                <!-- Total info will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="specialInstructions" class="form-label">Special Instructions (Optional)</label>
                        <textarea class="form-control" id="specialInstructions" name="special_instructions" rows="3" placeholder="Any special requirements or notes..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="priority" class="form-label">Priority</label>
                        <select class="form-control form-select" id="priority" name="priority">
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden field for selected services -->
        <input type="hidden" id="selectedServicesData" name="selected_services">
    </form>

    <!-- Mobile Order Summary (Fixed at bottom on mobile) -->
    <div class="mobile-order-summary" id="mobileOrderSummary">
        <button type="button" class="mobile-summary-toggle" onclick="toggleMobileSummary()">
            <div class="d-flex justify-content-between align-items-center w-100">
                <div>
                    <strong id="mobileSummaryTitle">Order Summary</strong>
                    <div class="text-muted small" id="mobileSummaryPreview">No items selected</div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span id="mobileTotalAmount" class="fw-bold">KES 0</span>
                    <i class="fas fa-chevron-up" id="mobileSummaryIcon"></i>
                </div>
            </div>
        </button>
        
        <div class="mobile-summary-content" id="mobileSummaryContent">
            <div id="mobileSelectedServices"></div>
            <div class="mobile-summary-totals" id="mobileSummaryTotals" style="display: none;">
                <div class="d-flex justify-content-between">
                    <span>Subtotal (ex VAT):</span>
                    <span id="mobileSubtotalAmount">KES 0</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>VAT (16%):</span>
                    <span id="mobileTaxAmount">KES 0</span>
                </div>
                <div class="d-flex justify-content-between fw-bold border-top pt-2">
                    <span>Total (incl VAT):</span>
                    <span id="mobileTotalAmountDetail">KES 0</span>
                </div>
                <div class="text-center text-muted small mt-2">
                    <i class="fas fa-clock"></i>
                    Est. Duration: <span id="mobileEstimatedDuration">0</span> min
                </div>
            </div>
        </div>
    </div>

    <!-- Step Navigation -->
    <div class="step-navigation">
        <div class="step-indicator">
            Step <span id="currentStepNumber">1</span> of 4
        </div>
        
        <div class="nav-buttons">
            <button type="button" class="btn btn-outline-gray" id="prevBtn" onclick="previousStep()" style="display: none;">
                <i class="fas fa-arrow-left"></i>
                Previous
            </button>
            
            <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                Next
                <i class="fas fa-arrow-right"></i>
            </button>
            
            <button type="button" class="btn btn-success btn-lg" id="submitBtn" onclick="submitOrder()" style="display: none;">
                <i class="fas fa-check"></i>
                Create Order
            </button>
        </div>
    </div>
</div>

<!-- Customer Save Notification Modal -->
<div class="modal fade" id="customerSaveModal" tabindex="-1" aria-labelledby="customerSaveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="customerSaveModalLabel">
                    <i class="fas fa-user-plus me-2"></i>Save Walk-in Customer
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="fas fa-mobile-alt text-success mb-3" style="font-size: 3rem;"></i>
                    <h6>M-Pesa Payment Successful!</h6>
                </div>
                
                <div class="alert alert-info">
                    <strong>Customer Details from Transaction:</strong>
                    <div id="transactionCustomerDetails">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
                
                <p class="text-muted">
                    Would you like to save this walk-in customer's details for future visits? 
                    This will help you provide better service next time they visit.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Skip for Now
                </button>
                <button type="button" class="btn btn-success" id="saveCustomerBtn">
                    <i class="fas fa-save me-2"></i>Save Customer Details
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/quick_order.js' %}"></script>

<style>
@keyframes slideInRight {
    from { opacity: 0; transform: translateX(100%); }
    to { opacity: 1; transform: translateX(0); }
}

.row {
    display: flex;
    gap: 2rem;
    margin: 0 -1rem;
}

.col-lg-8 {
    flex: 0 0 66.666667%;
    padding: 0 1rem;
}

.col-lg-4 {
    flex: 0 0 33.333333%;
    padding: 0 1rem;
}

.col-md-6 {
    flex: 0 0 50%;
    padding: 0 1rem;
}

@media (max-width: 768px) {
    .row {
        flex-direction: column;
    }
    
    .col-lg-8,
    .col-lg-4,
    .col-md-6 {
        flex: 1;
    }
}
</style>
{% endblock %}