<!-- templates/services/quick_order.html -->
{% extends 'base/base.html' %}
{% load static %}

{% block title %}Quick Order - {{ block.super }}{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block extra_css %}
<style>
:root {
    --primary-500: #3b82f6;
    --primary-50: #eff6ff;
    --primary-600: #2563eb;
    --primary-700: #1d4ed8;
    --success-500: #10b981;
    --success-50: #ecfdf5;
    --success-600: #059669;
    --warning-500: #f59e0b;
    --warning-50: #fffbeb;
    --info-500: #06b6d4;
    --info-50: #f0f9ff;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --radius-sm: 0.375rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --transition-fast: 0.15s ease-in-out;
}

.page-header {
    background: linear-gradient(135deg, var(--primary-50), var(--success-50));
    border: 1px solid var(--primary-200);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.page-title {
    margin: 0;
    font-size: 1.875rem;
    font-weight: 700;
    color: var(--gray-900);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.page-description {
    margin: 0.5rem 0 0;
    color: var(--gray-600);
    font-size: 1rem;
}

.page-actions {
    display: flex;
    gap: 0.75rem;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius-md);
    font-weight: 500;
    text-decoration: none;
    border: 1px solid transparent;
    transition: all var(--transition-fast);
    cursor: pointer;
    font-size: 0.875rem;
}

.btn-outline-secondary {
    background: transparent;
    color: var(--gray-600);
    border-color: var(--gray-300);
}

.btn-outline-secondary:hover {
    background: var(--gray-50);
    border-color: var(--gray-500);
    text-decoration: none;
    color: var(--gray-700);
}

.btn-success {
    background: var(--success-500);
    color: white;
    border-color: var(--success-500);
}

.btn-success:hover {
    background: var(--success-600);
    text-decoration: none;
    color: white;
    transform: translateY(-1px);
}

.btn-primary {
    background: var(--primary-500);
    color: white;
    border-color: var(--primary-500);
}

.btn-primary:hover {
    background: var(--primary-600);
    text-decoration: none;
    color: white;
    transform: translateY(-1px);
}

.btn-lg {
    padding: 1rem 2rem;
    font-size: 1rem;
}

.quick-order-container {
    max-width: 1200px;
    margin: 0 auto;
}

.order-progress {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2rem;
    position: relative;
}

.order-progress::before {
    content: '';
    position: absolute;
    top: 1rem;
    left: 2rem;
    right: 2rem;
    height: 2px;
    background: var(--gray-200);
    z-index: 1;
}

.progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    background: white;
    padding: 0.5rem;
    z-index: 2;
    position: relative;
}

.progress-number {
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    background: var(--gray-200);
    color: var(--gray-600);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    margin-bottom: 0.5rem;
    transition: all var(--transition-fast);
}

.progress-step.active .progress-number {
    background: var(--primary-500);
    color: white;
}

.progress-step.completed .progress-number {
    background: var(--success-500);
    color: white;
}

.progress-label {
    font-size: 0.75rem;
    color: var(--gray-600);
    text-align: center;
}

.step-content {
    display: none;
}

.step-content.active {
    display: block;
}

.form-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    margin-bottom: 2rem;
}

.card-header {
    background: var(--gray-50);
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--gray-200);
}

.card-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--gray-900);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.card-body {
    padding: 1.5rem;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
}

.form-label.required::after {
    content: " *";
    color: #ef4444;
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    transition: all var(--transition-fast);
    background: white;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-control.is-invalid {
    border-color: #ef4444;
}

.form-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 16px 12px;
    padding-right: 2.5rem;
    appearance: none;
}

.customer-search-section {
    background: var(--info-50);
    border: 1px solid var(--info-200);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.search-input-group {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.search-btn {
    background: var(--primary-500);
    color: white;
    border: none;
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: 0.875rem;
    white-space: nowrap;
}

.search-results {
    margin-top: 1rem;
    max-height: 200px;
    overflow-y: auto;
}

.search-result-item {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.search-result-item:hover {
    background: var(--primary-50);
    border-color: var(--primary-300);
}

.selected-customer,
.selected-vehicle {
    background: var(--success-50);
    border: 1px solid var(--success-200);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-bottom: 1rem;
}

.selection-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.change-btn {
    background: none;
    border: none;
    color: var(--primary-600);
    cursor: pointer;
    font-size: 0.875rem;
    text-decoration: underline;
}

.services-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.service-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    cursor: pointer;
    transition: all var(--transition-fast);
    position: relative;
}

.service-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
    border-color: var(--primary-300);
}

.service-card.selected {
    border-color: var(--primary-500);
    background: var(--primary-50);
}

.service-card.selected::before {
    content: 'âœ“';
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: var(--primary-500);
    color: white;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
}

.service-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.75rem;
}

.service-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0;
}

.service-price {
    font-size: 1rem;
    font-weight: 700;
    color: var(--primary-600);
}

.service-description {
    font-size: 0.875rem;
    color: var(--gray-600);
    margin-bottom: 0.75rem;
    line-height: 1.4;
}

.service-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: var(--gray-500);
}

.service-duration {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.service-category {
    background: var(--gray-100);
    color: var(--gray-700);
    padding: 0.125rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.625rem;
    font-weight: 500;
    text-transform: uppercase;
}

.service-type-selector .btn-group {
    border-radius: var(--radius-md);
    overflow: hidden;
}

.service-type-selector .btn {
    border-radius: 0;
    border-color: var(--primary-300);
}

.service-type-selector .btn.active {
    background: var(--primary-500);
    color: white;
    border-color: var(--primary-500);
}

.packages-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.package-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    cursor: pointer;
    transition: all var(--transition-fast);
    position: relative;
    overflow: hidden;
}

.package-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
    border-color: var(--primary-300);
}

.package-card.selected {
    border-color: var(--primary-500);
    background: var(--primary-50);
}

.package-card.selected::before {
    content: 'âœ“';
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: var(--primary-500);
    color: white;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
    z-index: 2;
}

.package-header {
    margin-bottom: 1rem;
}

.package-name {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0 0 0.5rem 0;
}

.package-pricing {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.original-price {
    font-size: 0.875rem;
    color: var(--gray-500);
    text-decoration: line-through;
}

.package-price {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary-600);
}

.savings {
    font-size: 0.75rem;
    color: var(--success-600);
    font-weight: 600;
    background: var(--success-50);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
}

.package-description {
    font-size: 0.875rem;
    color: var(--gray-600);
    margin-bottom: 1rem;
    line-height: 1.4;
}

.package-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: var(--gray-500);
}

.package-duration,
.package-services-count {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.package-badge {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
}

.discount-badge {
    background: var(--warning-500);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
}

.popular-badge {
    top: 0.5rem;
    left: 0.5rem;
}

.popular-label {
    background: var(--success-500);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
}

/* Inventory Items Styles */
.inventory-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.inventory-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1rem;
    cursor: pointer;
    transition: var(--transition-fast);
    position: relative;
}

.inventory-card:hover {
    border-color: var(--primary-500);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

.inventory-card.selected {
    border-color: var(--primary-500);
    background: var(--primary-50);
}

.inventory-card.selected::before {
    content: 'âœ“';
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--primary-500);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
}

.inventory-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.inventory-name {
    font-size: 1rem;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0;
    flex: 1;
    margin-right: 0.5rem;
}

.inventory-pricing {
    text-align: right;
}

.inventory-price {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--primary-600);
    margin-bottom: 0.25rem;
}

.inventory-unit {
    font-size: 0.75rem;
    color: var(--gray-500);
    text-transform: uppercase;
}

.inventory-description {
    font-size: 0.875rem;
    color: var(--gray-600);
    margin: 0.5rem 0;
    line-height: 1.4;
}

.inventory-details {
    display: flex;
    gap: 1rem;
    margin: 0.75rem 0;
}

.inventory-stock,
.inventory-category {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    color: var(--gray-500);
}

.inventory-quantity-controls {
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--gray-200);
}

.quantity-input-group {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.quantity-btn {
    background: var(--gray-100);
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-sm);
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    cursor: pointer;
    transition: var(--transition-fast);
}

.quantity-btn:hover {
    background: var(--gray-200);
}

.quantity-input {
    width: 80px;
    text-align: center;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-sm);
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.inventory-badge {
    position: absolute;
    top: 10px;
    left: 10px;
}

.low-stock-label {
    background: var(--warning-500);
    color: white;
    font-size: 0.625rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.order-summary {
    position: sticky;
    top: 2rem;
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    box-shadow: var(--shadow-sm);
}

.summary-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--gray-200);
}

.summary-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0;
}

.summary-content {
    margin-bottom: 1.5rem;
}

.selected-services-list {
    margin-bottom: 1rem;
}

.selected-service-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--gray-100);
}

.selected-service-item:last-child {
    border-bottom: none;
}

.service-item-name {
    font-size: 0.875rem;
    color: var(--gray-900);
}

.service-item-price {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--gray-700);
}

.summary-totals {
    border-top: 2px solid var(--gray-200);
    padding-top: 1rem;
}

.total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.total-row.main {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--gray-900);
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--gray-200);
}

.summary-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.step-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    background: var(--gray-50);
    border-top: 1px solid var(--gray-200);
    margin-top: 2rem;
}

.nav-buttons {
    display: flex;
    gap: 0.75rem;
}

.btn-outline-gray {
    background: transparent;
    color: var(--gray-600);
    border-color: var(--gray-300);
}

.btn-outline-gray:hover {
    background: var(--gray-100);
    border-color: var(--gray-400);
    text-decoration: none;
    color: var(--gray-700);
}

.step-indicator {
    font-size: 0.875rem;
    color: var(--gray-600);
}

.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--gray-500);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.category-filter {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.category-btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-md);
    background: white;
    color: var(--gray-700);
    cursor: pointer;
    font-size: 0.875rem;
    transition: all var(--transition-fast);
}

.category-btn:hover {
    background: var(--gray-50);
    border-color: var(--gray-400);
}

.category-btn.active {
    background: var(--primary-500);
    color: white;
    border-color: var(--primary-500);
}

/* Order Type Selection Cards */
.order-type-selection h6 {
    margin-bottom: 1rem;
    color: var(--gray-700);
    font-weight: 600;
}

.order-type-options {
    margin-bottom: 1.5rem;
}

.order-type-card {
    padding: 1.5rem;
    border: 2px solid var(--gray-200);
    border-radius: var(--radius-lg);
    background: white;
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-fast);
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
}

.order-type-card:hover {
    border-color: var(--primary-400);
    background: var(--primary-50);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.order-type-card.selected {
    border-color: var(--primary-500);
    background: var(--primary-100);
}

.order-type-card i {
    font-size: 2rem;
    color: var(--primary-500);
    margin-bottom: 0.5rem;
}

.order-type-card h6 {
    margin: 0;
    font-weight: 600;
    color: var(--gray-800);
}

.order-type-card p {
    margin: 0;
    font-size: 0.875rem;
    color: var(--gray-600);
}

.items-only-customer-options .btn {
    height: 80px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

@media (max-width: 1024px) {
    .quick-order-container {
        padding: 0 1rem;
    }
    
    .order-summary {
        position: static;
        margin-top: 2rem;
    }
}

@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .services-grid {
        grid-template-columns: 1fr;
    }
    
    .search-input-group {
        flex-direction: column;
    }
    
    .order-progress {
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .step-navigation {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
}

.text-muted { color: var(--gray-500); }
.text-success { color: var(--success-600); }
.text-primary { color: var(--primary-600); }
.d-flex { display: flex; }
.justify-content-between { justify-content: space-between; }
.align-items-center { align-items: center; }
.p-3 { padding: 1rem; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">
            <i class="fas fa-bolt text-primary"></i>
            Quick Order
        </h1>
        <p class="page-description">Create a service order quickly for walk-in customers</p>
    </div>
    
    <div class="page-actions">
        <a href="/business/{{ request.tenant.slug }}/services/dashboard/" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i>
            Back to Dashboard
        </a>
    </div>
</div>

<div class="quick-order-container">
    <!-- Progress Indicator -->
    <div class="order-progress">
        <div class="progress-step active" id="step1-indicator">
            <div class="progress-number">1</div>
            <div class="progress-label">Vehicle</div>
        </div>
        <div class="progress-step" id="step2-indicator">
            <div class="progress-number">2</div>
            <div class="progress-label">Customer</div>
        </div>
        <div class="progress-step" id="step3-indicator">
            <div class="progress-number">3</div>
            <div class="progress-label">Services</div>
        </div>
        <div class="progress-step" id="step4-indicator">
            <div class="progress-number">4</div>
            <div class="progress-label">Review</div>
        </div>
    </div>

    <form id="quickOrderForm" method="post">
        {% csrf_token %}
        
        <!-- Step 1: Vehicle Search/Selection -->
        <div class="step-content active" id="step1">
            <div class="form-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-car"></i>
                        Vehicle Information
                    </h5>
                </div>
                
                <div class="card-body">
                    <!-- Order Type Selection -->
                    <div class="order-type-selection mb-4">
                        <h6><i class="fas fa-route"></i> How would you like to proceed?</h6>
                        <div class="order-type-options">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="order-type-card" onclick="selectOrderType('search-vehicle', this)">
                                        <i class="fas fa-search"></i>
                                        <h6>Search Vehicle</h6>
                                        <p>Find existing vehicle by registration number</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="order-type-card" onclick="selectOrderType('register-vehicle', this)">
                                        <i class="fas fa-plus-circle"></i>
                                        <h6>Register Vehicle</h6>
                                        <p>Add new vehicle to the system</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="order-type-card" onclick="selectOrderType('items-only', this)">
                                        <i class="fas fa-shopping-cart"></i>
                                        <h6>Sell Items Only</h6>
                                        <p>Skip vehicle info and sell products directly</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vehicle Search -->
                    <div class="customer-search-section" id="vehicleSearchSection" style="display: none;">
                        <h6><i class="fas fa-search"></i> Search by Registration Number</h6>
                        <div class="search-input-group">
                            <input type="text" class="form-control" id="vehicleSearchInput" placeholder="Enter registration number (e.g., KCA 123A)..." style="text-transform: uppercase;">
                            <button type="button" class="search-btn" onclick="searchVehiclesByRegistration()">
                                <i class="fas fa-search"></i>
                                Search
                            </button>
                        </div>
                        <div id="vehicleSearchResults" class="search-results" style="display: none;"></div>
                    </div>

                    <!-- Selected Vehicle Display -->
                    <div id="selectedVehicleDisplay" style="display: none;">
                        <div class="selected-vehicle">
                            <div class="selection-header">
                                <h6><i class="fas fa-check-circle text-success"></i> Selected Vehicle</h6>
                                <button type="button" class="change-btn" onclick="changeVehicle()">Change</button>
                            </div>
                            <div id="selectedVehicleInfo"></div>
                        </div>
                    </div>

                    <!-- New Vehicle Form -->
                    <div id="newVehicleForm" style="display: none;">
                        <h6><i class="fas fa-plus"></i> Register New Vehicle</h6>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vehicleRegistration" class="form-label required">Registration Number</label>
                                <input type="text" class="form-control" id="vehicleRegistration" name="vehicle_registration" required style="text-transform: uppercase;">
                            </div>
                            <div class="form-group">
                                <label for="vehicleType" class="form-label">Vehicle Type (Optional)</label>
                                <select class="form-control form-select" id="vehicleType" name="vehicle_type">
                                    <option value="">Select Type</option>
                                    <option value="sedan">Sedan</option>
                                    <option value="suv">SUV</option>
                                    <option value="hatchback">Hatchback</option>
                                    <option value="pickup">Pickup Truck</option>
                                    <option value="van">Van</option>
                                    <option value="bus">Bus</option>
                                    <option value="motorcycle">Motorcycle</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vehicleMake" class="form-label">Make (Optional)</label>
                                <input type="text" class="form-control" id="vehicleMake" name="vehicle_make" placeholder="e.g., Toyota">
                            </div>
                            <div class="form-group">
                                <label for="vehicleModel" class="form-label">Model (Optional)</label>
                                <input type="text" class="form-control" id="vehicleModel" name="vehicle_model" placeholder="e.g., Camry">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vehicleColor" class="form-label">Color (Optional)</label>
                                <input type="text" class="form-control" id="vehicleColor" name="vehicle_color" placeholder="e.g., White">
                            </div>
                            <div class="form-group">
                                <label for="vehicleYear" class="form-label">Year</label>
                                <input type="number" class="form-control" id="vehicleYear" name="vehicle_year" min="1990" max="2025" value="2020">
                            </div>
                        </div>
                    </div>

                    <!-- Items Only Customer Selection -->
                    <div id="itemsOnlyCustomerSection" style="display: none;">
                        <h6><i class="fas fa-user"></i> Customer Information</h6>
                        <div class="items-only-customer-options">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <button type="button" class="btn btn-outline-primary btn-lg w-100" onclick="selectItemsOnlyCustomerType('search')">
                                        <i class="fas fa-search"></i>
                                        <br>Search Customer
                                    </button>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <button type="button" class="btn btn-outline-primary btn-lg w-100" onclick="selectItemsOnlyCustomerType('register')">
                                        <i class="fas fa-user-plus"></i>
                                        <br>Register Customer
                                    </button>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <button type="button" class="btn btn-outline-primary btn-lg w-100" onclick="selectItemsOnlyCustomerType('walkin')">
                                        <i class="fas fa-walking"></i>
                                        <br>Walk-in Customer
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Items Only Customer Search -->
                        <div id="itemsOnlyCustomerSearch" style="display: none;">
                            <div class="search-input-group">
                                <input type="text" class="form-control" id="itemsOnlyCustomerSearchInput" placeholder="Search by name, phone, or customer ID...">
                                <button type="button" class="search-btn" onclick="searchItemsOnlyCustomers()">
                                    <i class="fas fa-search"></i>
                                    Search
                                </button>
                            </div>
                            <div id="itemsOnlyCustomerSearchResults" class="search-results" style="display: none;"></div>
                        </div>

                        <!-- Items Only Customer Registration -->
                        <div id="itemsOnlyCustomerRegister" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="itemsOnlyCustomerName" class="form-label required">Full Name</label>
                                    <input type="text" class="form-control" id="itemsOnlyCustomerName" name="items_only_customer_name" required>
                                </div>
                                <div class="form-group">
                                    <label for="itemsOnlyCustomerPhone" class="form-label required">Phone Number</label>
                                    <input type="tel" class="form-control" id="itemsOnlyCustomerPhone" name="items_only_customer_phone" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="itemsOnlyCustomerEmail" class="form-label">Email (Optional)</label>
                                <input type="email" class="form-control" id="itemsOnlyCustomerEmail" name="items_only_customer_email">
                            </div>
                        </div>

                        <!-- Items Only Walk-in Selected -->
                        <div id="itemsOnlyWalkinSelected" style="display: none;">
                            <div class="alert alert-success">
                                <i class="fas fa-walking"></i>
                                <strong>Walk-in Customer Selected</strong>
                                <p class="mb-0">You can proceed directly to select items to sell.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden fields for selected vehicle -->
                    <input type="hidden" id="selectedVehicleId" name="selected_vehicle_id">
                    <input type="hidden" id="orderType" name="order_type" value="">
                </div>
            </div>
        </div>

        <!-- Step 2: Customer Selection -->
        <div class="step-content" id="step2">
            <div class="form-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-user"></i>
                        Select Customer
                    </h5>
                </div>
                
                <div class="card-body">
                    <!-- Walk-in Customer Option -->
                    <div class="walk-in-option">
                        <button type="button" class="btn btn-outline-primary btn-lg w-100 mb-3" onclick="selectWalkInCustomer()">
                            <i class="fas fa-walking"></i>
                            Walk-in Customer
                        </button>
                        <div class="text-center mb-3">
                            <small class="text-muted">OR</small>
                        </div>
                    </div>

                    <!-- Existing Customer from Vehicle -->
                    <div id="vehicleCustomerDisplay" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Vehicle Owner Found</strong>
                            <div id="vehicleCustomerInfo"></div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-success" onclick="useVehicleCustomer()">
                                    Use This Customer
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="showCustomerOptions()">
                                    Different Customer
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Search -->
                    <div class="customer-search-section" id="customerSearchSection">
                        <h6><i class="fas fa-search"></i> Search Existing Customer</h6>
                        <div class="search-input-group">
                            <input type="text" class="form-control" id="customerSearchInput" placeholder="Search by name, phone, or customer ID...">
                            <button type="button" class="search-btn" onclick="searchCustomers()">
                                <i class="fas fa-search"></i>
                                Search
                            </button>
                        </div>
                        <div id="customerSearchResults" class="search-results" style="display: none;"></div>
                    </div>

                    <!-- Selected Customer Display -->
                    <div id="selectedCustomerDisplay" style="display: none;">
                        <div class="selected-customer">
                            <div class="selection-header">
                                <h6><i class="fas fa-check-circle text-success"></i> Selected Customer</h6>
                                <button type="button" class="change-btn" onclick="changeCustomer()">Change</button>
                            </div>
                            <div id="selectedCustomerInfo"></div>
                        </div>
                    </div>

                    <!-- New Customer Form -->
                    <div id="newCustomerForm" style="display: none;">
                        <h6><i class="fas fa-user-plus"></i> Register New Customer</h6>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="customerName" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="customerName" name="customer_name" placeholder="Optional for walk-in">
                            </div>
                            <div class="form-group">
                                <label for="customerPhone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="customerPhone" name="customer_phone" placeholder="Optional for walk-in">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="customerEmail" class="form-label">Email (Optional)</label>
                            <input type="email" class="form-control" id="customerEmail" name="customer_email">
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="addVehicleToCustomer" name="add_vehicle_to_customer">
                            <label class="form-check-label" for="addVehicleToCustomer">
                                Add vehicle to this customer's account
                            </label>
                        </div>
                    </div>

                    <!-- Walk-in Customer Display -->
                    <div id="walkInCustomerDisplay" style="display: none;">
                        <div class="alert alert-warning">
                            <i class="fas fa-walking"></i>
                            <strong>Walk-in Customer</strong>
                            <p class="mb-0">Customer details will be captured during payment if needed.</p>
                        </div>
                    </div>

                    <!-- Hidden fields for selected customer -->
                    <input type="hidden" id="selectedCustomerId" name="selected_customer_id">
                    <input type="hidden" id="isWalkInCustomer" name="is_walk_in_customer" value="false">
                </div>
            </div>
        </div>

        <!-- Step 3: Service Selection -->
        <div class="step-content" id="step3">
            <div class="row">
                <div class="col-lg-8">
                    <div class="form-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-list-check"></i>
                                Select Services
                            </h5>
                        </div>
                        
                        <div class="card-body">
                            <!-- Service Type Selector -->
                            <div class="service-type-selector mb-3">
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-outline-primary active" id="individualServicesBtn" onclick="showServiceType('individual')">
                                        <i class="fas fa-list"></i>
                                        Services
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" id="inventoryBtn" onclick="showServiceType('inventory')">
                                        <i class="fas fa-boxes"></i>
                                        Inventory Items
                                    </button>
                                </div>
                            </div>

                            <!-- Individual Services Section -->
                            <div id="individualServicesSection">
                                <!-- Category Filter -->
                                <div class="category-filter">
                                    <button type="button" class="category-btn active" onclick="filterServices('all')" data-category="all">
                                        All Services
                                    </button>
                                    {% for category in categories %}
                                    <button type="button" class="category-btn" onclick="filterServices('{{ category.id }}')" data-category="{{ category.id }}">
                                        <i class="{{ category.icon }}"></i>
                                        {{ category.name }}
                                    </button>
                                    {% endfor %}
                                </div>

                                <!-- Services Grid -->
                                <div class="services-grid" id="servicesGrid">
                                    {% for service in all_services %}
                                    <div class="service-card" onclick="toggleService('{{ service.id }}')" data-service-id="{{ service.id }}" data-category="{{ service.category.id }}">
                                        <div class="service-header">
                                            <h6 class="service-name">{{ service.name }}</h6>
                                            <div class="service-price">KES {{ service.base_price }}</div>
                                        </div>
                                        <p class="service-description">{{ service.description|truncatewords:15 }}</p>
                                        <div class="service-details">
                                            <div class="service-duration">
                                                <i class="fas fa-clock"></i>
                                                {{ service.estimated_duration }} min
                                            </div>
                                            <div class="service-category">{{ service.category.name }}</div>
                                        </div>
                                        {% if service.is_popular %}
                                        <div class="service-badge">
                                            <span class="popular-badge">POPULAR</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% empty %}
                                    <div class="empty-state">
                                        <i class="fas fa-car-wash"></i>
                                        <p>No services available</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Inventory Items Section -->
                            <div id="inventorySection" style="display: none;">
                                <div class="inventory-grid">
                                    {% for item in inventory_items %}
                                    <div class="inventory-card" onclick="toggleInventoryItem('{{ item.id }}')" data-item-id="{{ item.id }}">
                                        <div class="inventory-header">
                                            <h6 class="inventory-name">{{ item.name }}</h6>
                                            <div class="inventory-pricing">
                                                <div class="inventory-price">KSH {{ item.selling_price|default:item.unit_cost|floatformat:2 }}</div>
                                                <div class="inventory-unit">per {{ item.unit.abbreviation }}</div>
                                            </div>
                                        </div>
                                        <p class="inventory-description">{{ item.description|truncatewords:15|default:"No description" }}</p>
                                        <div class="inventory-details">
                                            <div class="inventory-stock">
                                                <i class="fas fa-warehouse"></i>
                                                {{ item.current_stock|floatformat:0 }} {{ item.unit.abbreviation }}
                                            </div>
                                            {% if item.category %}
                                            <div class="inventory-category">
                                                <i class="fas fa-tag"></i>
                                                {{ item.category.name }}
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="inventory-quantity-controls" style="display: none;">
                                            <div class="quantity-input-group">
                                                <button type="button" class="quantity-btn minus" onclick="changeInventoryQuantity('{{ item.id }}', -1)">-</button>
                                                <input type="number" class="quantity-input" id="inventory_quantity_{{ item.id }}" 
                                                       name="inventory_quantity_{{ item.id }}" value="1" min="1" 
                                                       max="{{ item.current_stock|floatformat:0 }}" step="0.01">
                                                <button type="button" class="quantity-btn plus" onclick="changeInventoryQuantity('{{ item.id }}', 1)">+</button>
                                            </div>
                                        </div>
                                        {% if item.current_stock <= item.minimum_stock_level %}
                                        <div class="inventory-badge low-stock-badge">
                                            <span class="low-stock-label">LOW STOCK</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% empty %}
                                    <div class="empty-state">
                                        <i class="fas fa-boxes"></i>
                                        <p>No inventory items available</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <!-- Order Summary -->
                    <div class="order-summary">
                        <div class="summary-header">
                            <h6 class="summary-title">
                                <i class="fas fa-shopping-cart"></i>
                                Order Summary
                            </h6>
                        </div>
                        
                        <div class="summary-content">
                            <div id="selectedServicesDisplay">
                                <div class="empty-state">
                                    <i class="fas fa-list"></i>
                                    <p>No services selected</p>
                                </div>
                            </div>
                            
                            <div class="selected-services-list" id="selectedServicesList" style="display: none;">
                                <!-- Selected services will be populated here -->
                            </div>
                            
                            <div class="summary-totals" id="summaryTotals" style="display: none;">
                                <div class="total-row">
                                    <span>Subtotal (ex VAT):</span>
                                    <span id="subtotalAmount">KES 0</span>
                                </div>
                                <div class="total-row">
                                    <span>VAT (16%):</span>
                                    <span id="taxAmount">KES 0</span>
                                </div>
                                <div class="total-row main">
                                    <span>Total (incl VAT):</span>
                                    <span id="totalAmount">KES 0</span>
                                </div>
                                <div class="total-row">
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i>
                                        Est. Duration: <span id="estimatedDuration">0</span> min
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="summary-actions">
                            <button type="button" class="btn btn-outline-gray" onclick="clearAllServices()">
                                <i class="fas fa-trash"></i>
                                Clear All
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Review & Submit -->
        <div class="step-content" id="step4">
            <div class="form-card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-check-circle"></i>
                        Review Order
                    </h5>
                </div>
                
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Customer Information</h6>
                            <div id="reviewCustomerInfo" class="mb-3">
                                <!-- Customer info will be populated here -->
                            </div>
                            
                            <h6>Vehicle Information</h6>
                            <div id="reviewVehicleInfo" class="mb-3">
                                <!-- Vehicle info will be populated here -->
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6>Selected Services</h6>
                            <div id="reviewServicesInfo" class="mb-3">
                                <!-- Services info will be populated here -->
                            </div>
                            
                            <h6>Order Total</h6>
                            <div id="reviewTotalInfo">
                                <!-- Total info will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="specialInstructions" class="form-label">Special Instructions (Optional)</label>
                        <textarea class="form-control" id="specialInstructions" name="special_instructions" rows="3" placeholder="Any special requirements or notes..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="priority" class="form-label">Priority</label>
                        <select class="form-control form-select" id="priority" name="priority">
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden field for selected services -->
        <input type="hidden" id="selectedServicesData" name="selected_services">
    </form>

    <!-- Step Navigation -->
    <div class="step-navigation">
        <div class="step-indicator">
            Step <span id="currentStepNumber">1</span> of 4
        </div>
        
        <div class="nav-buttons">
            <button type="button" class="btn btn-outline-gray" id="prevBtn" onclick="previousStep()" style="display: none;">
                <i class="fas fa-arrow-left"></i>
                Previous
            </button>
            
            <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                Next
                <i class="fas fa-arrow-right"></i>
            </button>
            
            <button type="button" class="btn btn-success btn-lg" id="submitBtn" onclick="submitOrder()" style="display: none;">
                <i class="fas fa-check"></i>
                Create Order
            </button>
        </div>
    </div>
</div>

<!-- Customer Save Notification Modal -->
<div class="modal fade" id="customerSaveModal" tabindex="-1" aria-labelledby="customerSaveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="customerSaveModalLabel">
                    <i class="fas fa-user-plus me-2"></i>Save Walk-in Customer
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="fas fa-mobile-alt text-success mb-3" style="font-size: 3rem;"></i>
                    <h6>M-Pesa Payment Successful!</h6>
                </div>
                
                <div class="alert alert-info">
                    <strong>Customer Details from Transaction:</strong>
                    <div id="transactionCustomerDetails">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
                
                <p class="text-muted">
                    Would you like t    o save this walk-in customer's details for future visits? 
                    This will help you provide better service next time they visit.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Skip for Now
                </button>
                <button type="button" class="btn btn-success" id="saveCustomerBtn">
                    <i class="fas fa-save me-2"></i>Save Customer Details
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Define functions globally first to ensure they're available for onclick handlers
window.selectOrderType = function(type, element) {
    alert('Function called with type: ' + type); // Debug alert
    try {
        console.log('selectOrderType called with type:', type, 'element:', element);
        window.orderType = type;
        
        // Update hidden field for form submission
        const orderTypeField = document.getElementById('orderType');
        if (orderTypeField) {
            orderTypeField.value = type;
            console.log('Set order type field to:', type);
        } else {
            console.error('orderType field not found');
        }
        
        // Update card selection visually
        document.querySelectorAll('.order-type-card').forEach(card => {
            card.classList.remove('selected');
        });
        if (element) {
            element.classList.add('selected');
            console.log('Added selected class to element');
        }
        
        // Hide all sections first
        const sections = {
            vehicleSearchSection: document.getElementById('vehicleSearchSection'),
            selectedVehicleDisplay: document.getElementById('selectedVehicleDisplay'),
            newVehicleForm: document.getElementById('newVehicleForm'),
            itemsOnlyCustomerSection: document.getElementById('itemsOnlyCustomerSection')
        };
        
        Object.values(sections).forEach(section => {
            if (section) section.style.display = 'none';
        });
        
        // Show relevant sections based on selection
        if (type === 'search-vehicle') {
            if (sections.vehicleSearchSection) {
                sections.vehicleSearchSection.style.display = 'block';
                console.log('Showing vehicle search section');
            }
        } else if (type === 'register-vehicle') {
            if (sections.newVehicleForm) {
                sections.newVehicleForm.style.display = 'block';
                console.log('Showing new vehicle form');
            }
        } else if (type === 'items-only') {
            if (sections.itemsOnlyCustomerSection) {
                sections.itemsOnlyCustomerSection.style.display = 'block';
                console.log('Showing items only customer section');
            }
            // Update progress indicator to skip vehicle step
            window.updateProgressForItemsOnly();
        }
        
        console.log('selectOrderType completed successfully');
    } catch (error) {
        console.error('Error in selectOrderType:', error);
    }
};

let currentStep = 1;
let selectedCustomer = null;
let selectedVehicle = null;
let vehicleCustomer = null; // Customer from selected vehicle
let selectedServices = [];
let selectedInventoryItems = [];
let selectedPackage = null;
let allServices = [];
let serviceType = 'individual'; // 'individual' or 'package'

// Order Type Management - Define early to be available for onclick handlers
let orderType = null; // 'search-vehicle', 'register-vehicle', 'items-only'

window.updateProgressForItemsOnly = function() {
    // Update step labels for items-only flow
    if (window.orderType === 'items-only') {
        const step1Label = document.querySelector('#step1-indicator .progress-label');
        const step2Label = document.querySelector('#step2-indicator .progress-label');
        const step3Label = document.querySelector('#step3-indicator .progress-label');
        const step4Indicator = document.querySelector('#step4-indicator');
        
        if (step1Label) step1Label.textContent = 'Customer';
        if (step2Label) step2Label.textContent = 'Items';
        if (step3Label) step3Label.textContent = 'Review';
        if (step4Indicator) step4Indicator.style.display = 'none';
    } else {
        // Restore original labels
        const step1Label = document.querySelector('#step1-indicator .progress-label');
        const step2Label = document.querySelector('#step2-indicator .progress-label');
        const step3Label = document.querySelector('#step3-indicator .progress-label');
        const step4Indicator = document.querySelector('#step4-indicator');
        
        if (step1Label) step1Label.textContent = 'Vehicle';
        if (step2Label) step2Label.textContent = 'Customer';
        if (step3Label) step3Label.textContent = 'Services';
        if (step4Indicator) {
            step4Indicator.style.display = 'block';
            const step4Label = step4Indicator.querySelector('.progress-label');
            if (step4Label) step4Label.textContent = 'Review';
        }
    }
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadAllServices();
    updateStepIndicator();
});

// Step Management
function nextStep() {
    if (validateCurrentStep()) {
        if (orderType === 'items-only') {
            // Items-only flow: Step 1 (Customer) -> Step 2 (Items) -> Step 3 (Review)
            if (currentStep === 1) {
                currentStep = 3; // Skip to services/items step
            } else if (currentStep === 3) {
                currentStep = 4; // Go to review
            }
        } else {
            // Normal flow: Step 1 (Vehicle) -> Step 2 (Customer) -> Step 3 (Services) -> Step 4 (Review)
            if (currentStep < 4) {
                currentStep++;
            }
        }
        
        showStep(currentStep);
        updateStepIndicator();
        updateNavigationButtons();
    }
}

function previousStep() {
    if (orderType === 'items-only') {
        // Items-only flow backwards
        if (currentStep === 4) {
            currentStep = 3; // Review to Items
        } else if (currentStep === 3) {
            currentStep = 1; // Items to Customer
        }
    } else {
        // Normal flow backwards
        if (currentStep > 1) {
            currentStep--;
        }
    }
    
    showStep(currentStep);
    updateStepIndicator();
    updateNavigationButtons();
}

function showStep(step) {
    // Hide all steps
    document.querySelectorAll('.step-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Show current step
    document.getElementById(`step${step}`).classList.add('active');
    
    // Update step-specific content
    if (step === 2) {
        updateCustomerStep(); // Now step 2 is customer step
    } else if (step === 4) {
        updateReviewStep();
    }
}

function updateStepIndicator() {
    // Handle items-only flow differently
    if (orderType === 'items-only') {
        // Step mapping for items-only: 1=Customer, 3=Items, 4=Review
        const stepMap = { 1: 1, 3: 2, 4: 3 };
        const currentMappedStep = stepMap[currentStep] || 1;
        
        document.getElementById('currentStepNumber').textContent = currentMappedStep;
        
        // Update indicators for 3-step flow
        for (let i = 1; i <= 3; i++) {
            const indicator = document.getElementById(`step${i}-indicator`);
            if (i < currentMappedStep) {
                indicator.classList.add('completed');
                indicator.classList.remove('active');
            } else if (i === currentMappedStep) {
                indicator.classList.add('active');
                indicator.classList.remove('completed');
            } else {
                indicator.classList.remove('active', 'completed');
            }
        }
        // Hide step 4 indicator for items-only
        document.getElementById('step4-indicator').style.display = 'none';
    } else {
        // Normal 4-step flow
        document.getElementById('currentStepNumber').textContent = currentStep;
        document.getElementById('step4-indicator').style.display = 'flex';
        
        for (let i = 1; i <= 4; i++) {
            const indicator = document.getElementById(`step${i}-indicator`);
            if (i < currentStep) {
                indicator.classList.add('completed');
                indicator.classList.remove('active');
            } else if (i === currentStep) {
                indicator.classList.add('active');
                indicator.classList.remove('completed');
            } else {
                indicator.classList.remove('active', 'completed');
            }
        }
    }
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    
    if (orderType === 'items-only') {
        // Show/hide previous button (hide on first step)
        prevBtn.style.display = currentStep === 1 ? 'none' : 'inline-flex';
        
        // Show next or submit button (submit on step 4/review)
        if (currentStep === 4) {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'inline-flex';
        } else {
            nextBtn.style.display = 'inline-flex';
            submitBtn.style.display = 'none';
        }
    } else {
        // Normal flow
        // Show/hide previous button
        prevBtn.style.display = currentStep > 1 ? 'inline-flex' : 'none';
        
        // Show next or submit button
        if (currentStep === 4) {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'inline-flex';
        } else {
            nextBtn.style.display = 'inline-flex';
            submitBtn.style.display = 'none';
        }
    }
}

function validateCurrentStep() {
    switch (currentStep) {
        case 1:
            return validateVehicleStep();
        case 2:
            return validateCustomerStep();
        case 3:
            return validateServicesStep();
        case 4:
            return true; // Review step doesn't need validation
        default:
            return true;
    }
}

function selectItemsOnlyCustomerType(type) {
    // Hide all customer sections first
    document.getElementById('itemsOnlyCustomerSearch').style.display = 'none';
    document.getElementById('itemsOnlyCustomerRegister').style.display = 'none';
    document.getElementById('itemsOnlyWalkinSelected').style.display = 'none';
    
    if (type === 'search') {
        document.getElementById('itemsOnlyCustomerSearch').style.display = 'block';
    } else if (type === 'register') {
        document.getElementById('itemsOnlyCustomerRegister').style.display = 'block';
    } else if (type === 'walkin') {
        document.getElementById('itemsOnlyWalkinSelected').style.display = 'block';
        // Set walk-in customer automatically
        selectedCustomer = { id: null, name: 'Walk-in Customer', phone: '', customerId: 'WALKIN' };
        document.getElementById('isWalkInCustomer').value = 'true';
    }
}

function searchItemsOnlyCustomers() {
    const query = document.getElementById('itemsOnlyCustomerSearchInput').value.trim();
    const resultsContainer = document.getElementById('itemsOnlyCustomerSearchResults');
    
    if (query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
    }
    
    resultsContainer.innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
    resultsContainer.style.display = 'block';
    
    fetch(`/business/{{ request.tenant.slug }}/services/ajax/customer/search/?q=${encodeURIComponent(query)}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        displayItemsOnlyCustomerResults(data.customers || []);
    })
    .catch(error => {
        console.error('Search error:', error);
        resultsContainer.innerHTML = '<div class="text-danger p-3">Error searching customers</div>';
    });
}

function displayItemsOnlyCustomerResults(customers) {
    const resultsContainer = document.getElementById('itemsOnlyCustomerSearchResults');
    
    if (customers.length === 0) {
        resultsContainer.innerHTML = '<div class="text-muted p-3">No customers found</div>';
        return;
    }
    
    let html = '';
    customers.forEach(customer => {
        html += `
            <div class="search-result-item" onclick="selectItemsOnlyCustomer('${customer.id}', '${customer.full_name}', '${customer.phone}', '${customer.customer_id}')">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>${customer.full_name}</strong>
                        <br><small>${customer.phone || 'No phone'}</small>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">${customer.customer_id}</small>
                    </div>
                </div>
            </div>
        `;
    });
    
    resultsContainer.innerHTML = html;
}

function selectItemsOnlyCustomer(id, name, phone, customerId) {
    selectedCustomer = { id, name, phone, customerId };
    document.getElementById('selectedCustomerId').value = id;
    document.getElementById('itemsOnlyCustomerSearchResults').style.display = 'none';
    document.getElementById('itemsOnlyCustomerSearchInput').value = '';
    
    // Show success message or proceed to next step
    alert('Customer selected: ' + name);
}

// Customer Management
function searchCustomers() {
    const query = document.getElementById('customerSearchInput').value.trim();
    const resultsContainer = document.getElementById('customerSearchResults');
    
    if (query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
    }
    
    resultsContainer.innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
    resultsContainer.style.display = 'block';
    
    fetch(`/business/{{ request.tenant.slug }}/services/ajax/customer/search/?q=${encodeURIComponent(query)}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        displayCustomerResults(data.customers || []);
    })
    .catch(error => {
        console.error('Search error:', error);
        resultsContainer.innerHTML = '<div class="text-danger p-3">Error searching customers</div>';
    });
}

function displayCustomerResults(customers) {
    const resultsContainer = document.getElementById('customerSearchResults');
    
    if (customers.length === 0) {
        resultsContainer.innerHTML = '<div class="text-muted p-3">No customers found</div>';
        return;
    }
    
    let html = '';
    customers.forEach(customer => {
        html += `
            <div class="search-result-item" onclick="selectCustomer('${customer.id}', '${customer.full_name}', '${customer.phone}', '${customer.customer_id}')">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>${customer.full_name}</strong>
                        <br><small>${customer.phone || 'No phone'}</small>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">${customer.customer_id}</small>
                        <br><small>${customer.vehicle_count || 0} vehicle(s)</small>
                    </div>
                </div>
            </div>
        `;
    });
    
    resultsContainer.innerHTML = html;
}

function selectCustomer(id, name, phone, customerId) {
    selectedCustomer = { id, name, phone, customerId };
    
    // Update UI
    document.getElementById('selectedCustomerId').value = id;
    document.getElementById('selectedCustomerInfo').innerHTML = `
        <strong>${name}</strong><br>
        <small>Phone: ${phone}</small><br>
        <small>ID: ${customerId}</small>
    `;
    
    // Show selected customer, hide search and new customer form
    document.getElementById('selectedCustomerDisplay').style.display = 'block';
    document.getElementById('customerSearchResults').style.display = 'none';
    document.getElementById('newCustomerForm').style.display = 'none';
    
    // Clear search input
    document.getElementById('customerSearchInput').value = '';
}

function changeCustomer() {
    selectedCustomer = null;
    document.getElementById('selectedCustomerId').value = '';
    document.getElementById('selectedCustomerDisplay').style.display = 'none';
    document.getElementById('newCustomerForm').style.display = 'block';
    
    // Clear form fields
    document.getElementById('customerName').value = '';
    document.getElementById('customerPhone').value = '';
    document.getElementById('customerEmail').value = '';
}

// Vehicle Management (Step 1)
function searchVehiclesByRegistration() {
    const query = document.getElementById('vehicleSearchInput').value.trim();
    const resultsContainer = document.getElementById('vehicleSearchResults');
    
    if (query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
    }
    
    resultsContainer.innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
    resultsContainer.style.display = 'block';
    
    fetch(`/business/{{ request.tenant.slug }}/services/ajax/vehicle/search/?q=${encodeURIComponent(query)}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        displayVehicleResults(data.results || []);
    })
    .catch(error => {
        console.error('Vehicle search error:', error);
        resultsContainer.innerHTML = '<div class="text-danger p-3">Error searching vehicles</div>';
    });
}

function displayVehicleResults(vehicles) {
    const resultsContainer = document.getElementById('vehicleSearchResults');
    
    if (vehicles.length === 0) {
        resultsContainer.innerHTML = '<div class="text-muted p-3">No vehicles found with this registration</div>';
        return;
    }
    
    let html = '';
    vehicles.forEach(vehicle => {
        html += `
            <div class="search-result-item" onclick="selectExistingVehicle('${vehicle.id}', '${vehicle.registration}', '${vehicle.make}', '${vehicle.model}', '${vehicle.color}', '${vehicle.customer_name}')">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>${vehicle.registration}</strong>
                        <br><small>${vehicle.make} ${vehicle.model}</small>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">${vehicle.color}</small>
                        <br><small>Owner: ${vehicle.customer_name}</small>
                    </div>
                </div>
            </div>
        `;
    });
    
    resultsContainer.innerHTML = html;
}

function selectExistingVehicle(id, registration, make, model, color, customerName) {
    console.log('selectExistingVehicle called with:', { id, registration, make, model, color, customerName });
    
    selectedVehicle = { id, registration, make, model, color, customerName };
    
    // Update vehicle UI
    document.getElementById('selectedVehicleId').value = id;
    document.getElementById('selectedVehicleInfo').innerHTML = `
        <strong>${registration}</strong><br>
        <small>${make} ${model}</small><br>
        <small>Color: ${color}</small><br>
        <small>Owner: ${customerName}</small>
    `;
    
    // Show selected vehicle, hide search and new vehicle form
    document.getElementById('selectedVehicleDisplay').style.display = 'block';
    document.getElementById('vehicleSearchResults').style.display = 'none';
    document.getElementById('newVehicleForm').style.display = 'none';
    
    // Load vehicle's customer info for step 2
    console.log('Calling loadVehicleCustomer with auto-advance = true');
    loadVehicleCustomer(id, true); // Pass true to auto-advance
    
    // Clear search input
    document.getElementById('vehicleSearchInput').value = '';
}

function loadVehicleCustomer(vehicleId, autoAdvance = false) {
    console.log('loadVehicleCustomer called with vehicleId:', vehicleId, 'autoAdvance:', autoAdvance);
    
    // This will load the customer details when we move to step 2
    fetch(`/business/{{ request.tenant.slug }}/customers/ajax/vehicle-customer/?vehicle_id=${vehicleId}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Vehicle customer response:', data);
        
        if (data.success && data.customer) {
            // Set both variables to ensure validation works
            vehicleCustomer = data.customer;
            selectedCustomer = data.customer;
            
            console.log('Loaded vehicle customer:', data.customer);
            
            // Check if customer is walk-in
            const isWalkInCustomer = data.customer.is_walk_in;
            
            // Pre-fill customer information
            document.getElementById('selectedCustomerId').value = data.customer.id;
            document.getElementById('isWalkInCustomer').value = isWalkInCustomer ? 'true' : 'false';
            
            console.log('Set customer form values:', {
                selectedCustomerId: data.customer.id,
                isWalkInCustomer: isWalkInCustomer ? 'true' : 'false'
            });
            
            // Hide all other customer options and show vehicle customer display
            document.getElementById('walkInCustomerDisplay').style.display = 'none';
            document.getElementById('selectedCustomerDisplay').style.display = 'none';
            document.getElementById('newCustomerForm').style.display = 'none';
            document.getElementById('customerSearchSection').style.display = 'none';
            document.getElementById('vehicleCustomerDisplay').style.display = 'block';
            
            let customerInfoHtml = '';
            if (isWalkInCustomer) {
                customerInfoHtml = `
                    <div class="alert alert-warning">
                        <i class="fas fa-walking me-2"></i>
                        <strong>Walk-in Customer:</strong> ${data.customer.full_name || 'Unknown'}<br>
                        <small>Phone: ${data.customer.phone || 'Not provided'}</small><br>
                        <small>Customer ID: ${data.customer.customer_id}</small><br>
                        <small class="text-muted">Previous walk-in customer</small>
                    </div>
                `;
                
                // Check for transaction details and ask to save if needed
                checkWalkInCustomerTransactions(data.customer.id);
            } else {
                customerInfoHtml = `
                    <div class="alert alert-info">
                        <i class="fas fa-car me-2"></i>
                        <strong>Vehicle Owner:</strong> ${data.customer.full_name}<br>
                        <small>Phone: ${data.customer.phone}</small><br>
                        <small>Customer ID: ${data.customer.customer_id}</small>
                    </div>
                `;
            }
            
            const vehicleCustomerInfoElement = document.getElementById('vehicleCustomerInfo');
            if (vehicleCustomerInfoElement) {
                vehicleCustomerInfoElement.innerHTML = customerInfoHtml;
            } else {
                console.error('vehicleCustomerInfo element not found');
            }
            
            // If auto-advance is enabled, automatically go to next step
            if (autoAdvance) {
                console.log('Starting auto-advance for vehicle customer, is walk-in:', isWalkInCustomer);
                console.log('Current step before auto-advance:', currentStep);
                
                // For vehicle with customer (walk-in or regular), skip customer step and go directly to services
                setTimeout(() => {
                    console.log('Auto-advancing directly to services step, skipping customer selection');
                    console.log('Setting currentStep from', currentStep, 'to 3');
                    currentStep = 3; // Skip customer step, go directly to services
                    
                    // Mark step 2 as completed since we have a customer
                    const step2Indicator = document.getElementById('step2-indicator');
                    if (step2Indicator) {
                        step2Indicator.classList.add('completed');
                        step2Indicator.classList.remove('active');
                        console.log('Marked step 2 as completed');
                    }
                    
                    console.log('Calling showStep(3)');
                    showStep(currentStep);
                    console.log('Calling updateStepIndicator()');
                    updateStepIndicator();
                    console.log('Calling updateNavigationButtons()');
                    updateNavigationButtons();
                    console.log('Auto-advance complete, currentStep is now:', currentStep);
                }, 300);
            } else {
                console.log('Auto-advance is disabled or no customer found');
            }
        }
    })
    .catch(error => {
        console.error('Error loading vehicle customer:', error);
    });
}

function changeVehicle() {
    selectedVehicle = null;
    vehicleCustomer = null;
    document.getElementById('selectedVehicleId').value = '';
    document.getElementById('selectedVehicleDisplay').style.display = 'none';
    document.getElementById('newVehicleForm').style.display = 'block';
    
    // Clear form fields
    document.getElementById('vehicleRegistration').value = '';
    document.getElementById('vehicleMake').value = '';
    document.getElementById('vehicleModel').value = '';
    document.getElementById('vehicleColor').value = '';
    document.getElementById('vehicleYear').value = '2020';
    document.getElementById('vehicleType').value = '';
}

function validateVehicleStep() {
    // For items-only orders, check if customer is selected
    if (orderType === 'items-only') {
        if (!selectedCustomer) {
            showToast('Please select a customer option for items-only sale', 'error');
            return false;
        }
        
        // If registering a new customer, validate the form
        if (document.getElementById('itemsOnlyCustomerRegister').style.display === 'block') {
            const name = document.getElementById('itemsOnlyCustomerName').value.trim();
            const phone = document.getElementById('itemsOnlyCustomerPhone').value.trim();
            
            if (!name || !phone) {
                showToast('Please enter customer name and phone number', 'error');
                return false;
            }
            
            // Create customer object for items-only registration
            selectedCustomer = {
                id: null,
                name: name,
                phone: phone,
                customerId: 'NEW',
                email: document.getElementById('itemsOnlyCustomerEmail').value.trim()
            };
        }
        return true;
    }
    
    // For vehicle orders, validate vehicle selection or registration
    if (selectedVehicle) {
        return true;
    }
    
    // Validate new vehicle form - only registration is required
    const registration = document.getElementById('vehicleRegistration').value.trim();
    
    if (!registration) {
        showToast('Please enter vehicle registration number', 'error');
        return false;
    }
    
    return true;
}

// Customer Management (Step 2)
function selectWalkInCustomer() {
    selectedCustomer = null;
    document.getElementById('isWalkInCustomer').value = 'true';
    document.getElementById('selectedCustomerId').value = '';
    
    // Show walk-in display, hide other options
    document.getElementById('walkInCustomerDisplay').style.display = 'block';
    document.getElementById('selectedCustomerDisplay').style.display = 'none';
    document.getElementById('newCustomerForm').style.display = 'none';
    document.getElementById('customerSearchSection').style.display = 'none';
    document.getElementById('vehicleCustomerDisplay').style.display = 'none';
}

function showCustomerOptions() {
    document.getElementById('walkInCustomerDisplay').style.display = 'none';
    document.getElementById('vehicleCustomerDisplay').style.display = 'none';
    document.getElementById('customerSearchSection').style.display = 'block';
    document.getElementById('newCustomerForm').style.display = 'block';
}

function useVehicleCustomer() {
    if (vehicleCustomer) {
        selectedCustomer = vehicleCustomer;
        document.getElementById('selectedCustomerId').value = vehicleCustomer.id;
        document.getElementById('isWalkInCustomer').value = 'false';
        
        document.getElementById('selectedCustomerInfo').innerHTML = `
            <strong>${vehicleCustomer.name}</strong><br>
            <small>Phone: ${vehicleCustomer.phone}</small><br>
            <small>ID: ${vehicleCustomer.customer_id}</small>
        `;
        
        document.getElementById('selectedCustomerDisplay').style.display = 'block';
        document.getElementById('vehicleCustomerDisplay').style.display = 'none';
        document.getElementById('customerSearchSection').style.display = 'none';
        document.getElementById('newCustomerForm').style.display = 'none';
        document.getElementById('walkInCustomerDisplay').style.display = 'none';
    }
}

function updateCustomerStep() {
    // Show vehicle customer option if we have one
    if (selectedVehicle && vehicleCustomer) {
        const vehicleCustomerInfoElement = document.getElementById('vehicleCustomerInfo');
        if (vehicleCustomerInfoElement) {
            vehicleCustomerInfoElement.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-car me-2"></i>
                    <strong>Vehicle Owner:</strong> ${vehicleCustomer.full_name || vehicleCustomer.name}<br>
                    <small>Phone: ${vehicleCustomer.phone}</small><br>
                    <small>Customer ID: ${vehicleCustomer.customer_id}</small>
                </div>
            `;
        } else {
            console.error('vehicleCustomerInfo element not found in updateCustomerStep');
        }
        
        // Hide other options and show vehicle customer
        document.getElementById('walkInCustomerDisplay').style.display = 'none';
        document.getElementById('selectedCustomerDisplay').style.display = 'none';
        document.getElementById('newCustomerForm').style.display = 'none';
        document.getElementById('customerSearchSection').style.display = 'none';
        document.getElementById('vehicleCustomerDisplay').style.display = 'block';
    } else {
        document.getElementById('vehicleCustomerDisplay').style.display = 'none';
        // Show customer search and walk-in options by default
        document.getElementById('customerSearchSection').style.display = 'block';
        document.getElementById('newCustomerForm').style.display = 'block';
    }
}

function searchCustomers() {
    const query = document.getElementById('customerSearchInput').value.trim();
    const resultsContainer = document.getElementById('customerSearchResults');
    
    if (query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
    }
    
    resultsContainer.innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
    resultsContainer.style.display = 'block';
    
    fetch(`/business/{{ request.tenant.slug }}/services/ajax/customer/search/?q=${encodeURIComponent(query)}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        displayCustomerResults(data.customers || []);
    })
    .catch(error => {
        console.error('Search error:', error);
        resultsContainer.innerHTML = '<div class="text-danger p-3">Error searching customers</div>';
    });
}

function displayCustomerResults(customers) {
    const resultsContainer = document.getElementById('customerSearchResults');
    
    if (customers.length === 0) {
        resultsContainer.innerHTML = '<div class="text-muted p-3">No customers found</div>';
        return;
    }
    
    let html = '';
    customers.forEach(customer => {
        html += `
            <div class="search-result-item" onclick="selectCustomer('${customer.id}', '${customer.full_name}', '${customer.phone}', '${customer.customer_id}')">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>${customer.full_name}</strong>
                        <br><small>${customer.phone || 'No phone'}</small>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">${customer.customer_id}</small>
                        <br><small>${customer.vehicle_count || 0} vehicle(s)</small>
                    </div>
                </div>
            </div>
        `;
    });
    
    resultsContainer.innerHTML = html;
}

function selectCustomer(id, name, phone, customerId) {
    selectedCustomer = { id, name, phone, customerId };
    document.getElementById('isWalkInCustomer').value = 'false';
    
    // Update UI
    document.getElementById('selectedCustomerId').value = id;
    document.getElementById('selectedCustomerInfo').innerHTML = `
        <strong>${name}</strong><br>
        <small>Phone: ${phone}</small><br>
        <small>ID: ${customerId}</small>
    `;
    
    // Show selected customer, hide other options
    document.getElementById('selectedCustomerDisplay').style.display = 'block';
    document.getElementById('customerSearchResults').style.display = 'none';
    document.getElementById('newCustomerForm').style.display = 'none';
    document.getElementById('walkInCustomerDisplay').style.display = 'none';
    document.getElementById('vehicleCustomerDisplay').style.display = 'none';
    
    // Clear search input
    document.getElementById('customerSearchInput').value = '';
}

function changeCustomer() {
    selectedCustomer = null;
    document.getElementById('selectedCustomerId').value = '';
    document.getElementById('isWalkInCustomer').value = 'false';
    document.getElementById('selectedCustomerDisplay').style.display = 'none';
    
    // Show customer options again
    showCustomerOptions();
    
    // Clear form fields
    document.getElementById('customerName').value = '';
    document.getElementById('customerPhone').value = '';
    document.getElementById('customerEmail').value = '';
}

function validateCustomerStep() {
    const isWalkIn = document.getElementById('isWalkInCustomer').value === 'true';
    
    // Debug logging
    console.log('Validating customer step:', {
        isWalkIn,
        selectedCustomer: !!selectedCustomer,
        vehicleCustomer: !!vehicleCustomer,
        selectedCustomerId: selectedCustomer?.id,
        vehicleCustomerId: vehicleCustomer?.id
    });
    
    if (isWalkIn || selectedCustomer || vehicleCustomer) {
        console.log('Customer step validation passed');
        return true;
    }
    
    // Check if customer form has data for new customer
    const name = document.getElementById('customerName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    
    // For new vehicle registration, at least one of name or phone should be provided
    if (!name && !phone) {
        console.log('Customer step validation failed: no customer details');
        showToast('Please provide customer details, select an existing customer, or choose walk-in', 'error');
        return false;
    }
    
    console.log('Customer step validation passed with form data');
    return true;
}

// Service Management
function showServiceType(type) {
    serviceType = type;
    
    // Update button states
    document.getElementById('individualServicesBtn').classList.toggle('active', type === 'individual');
    document.getElementById('inventoryBtn').classList.toggle('active', type === 'inventory');
    
    // Show/hide sections
    document.getElementById('individualServicesSection').style.display = type === 'individual' ? 'block' : 'none';
    document.getElementById('inventorySection').style.display = type === 'inventory' ? 'block' : 'none';
    
    // Clear selections when switching types
    if (type === 'individual') {
        selectedInventoryItems = [];
        document.querySelectorAll('.inventory-card').forEach(card => {
            card.classList.remove('selected');
            const quantityControls = card.querySelector('.inventory-quantity-controls');
            if (quantityControls) {
                quantityControls.style.display = 'none';
            }
        });
    } else if (type === 'inventory') {
        selectedServices = [];
        document.querySelectorAll('.service-card').forEach(card => {
            card.classList.remove('selected');
        });
    }
    
    updateOrderSummary();
}

function loadAllServices() {
    // Services are already loaded from the template
    // This function can be used to load additional services via AJAX if needed
}

function filterServices(categoryId) {
    // Update active category button
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-category="${categoryId}"]`).classList.add('active');
    
    // Filter service cards
    document.querySelectorAll('.service-card').forEach(card => {
        const cardCategory = card.dataset.category;
        if (categoryId === 'all' || cardCategory === categoryId) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function toggleService(serviceId) {
    const serviceCard = document.querySelector(`[data-service-id="${serviceId}"]`);
    const isSelected = serviceCard.classList.contains('selected');
    
    if (isSelected) {
        // Remove service
        serviceCard.classList.remove('selected');
        selectedServices = selectedServices.filter(s => s.id !== serviceId);
    } else {
        // Add service
        serviceCard.classList.add('selected');
        
        // Get service data from the card
        const serviceName = serviceCard.querySelector('.service-name').textContent;
        const servicePriceText = serviceCard.querySelector('.service-price').textContent;
        const servicePrice = parseFloat(servicePriceText.replace(/[^0-9.]/g, ''));
        const serviceDuration = parseInt(serviceCard.querySelector('.service-duration').textContent);
        
        selectedServices.push({
            id: serviceId,
            name: serviceName,
            price: servicePrice,
            duration: serviceDuration
        });
    }
    
    updateOrderSummary();
}

function toggleInventoryItem(itemId) {
    const itemCard = document.querySelector(`[data-item-id="${itemId}"]`);
    const isSelected = itemCard.classList.contains('selected');
    
    if (isSelected) {
        // Remove item
        itemCard.classList.remove('selected');
        selectedInventoryItems = selectedInventoryItems.filter(item => item.id !== itemId);
        
        // Hide quantity controls
        const quantityControls = itemCard.querySelector('.inventory-quantity-controls');
        if (quantityControls) {
            quantityControls.style.display = 'none';
        }
    } else {
        // Add item
        itemCard.classList.add('selected');
        
        // Show quantity controls
        const quantityControls = itemCard.querySelector('.inventory-quantity-controls');
        if (quantityControls) {
            quantityControls.style.display = 'block';
        }
        
        // Get item data from the card
        const itemName = itemCard.querySelector('.inventory-name').textContent;
        const itemPriceText = itemCard.querySelector('.inventory-price').textContent;
        const itemPrice = parseFloat(itemPriceText.replace(/[^0-9.]/g, ''));
        const itemUnit = itemCard.querySelector('.inventory-unit').textContent;
        const quantityInput = itemCard.querySelector('.quantity-input');
        const quantity = parseFloat(quantityInput.value) || 1;
        
        selectedInventoryItems.push({
            id: itemId,
            name: itemName,
            price: itemPrice,
            unit: itemUnit,
            quantity: quantity
        });
    }
    
    updateOrderSummary();
}

function changeInventoryQuantity(itemId, delta) {
    const quantityInput = document.getElementById(`inventory_quantity_${itemId}`);
    const currentValue = parseFloat(quantityInput.value) || 1;
    const maxStock = parseFloat(quantityInput.getAttribute('max')) || 999;
    const minValue = 1;
    
    let newValue = currentValue + delta;
    newValue = Math.max(minValue, Math.min(maxStock, newValue));
    
    quantityInput.value = newValue;
    
    // Update the selectedInventoryItems array
    const itemIndex = selectedInventoryItems.findIndex(item => item.id === itemId);
    if (itemIndex !== -1) {
        selectedInventoryItems[itemIndex].quantity = newValue;
        updateOrderSummary();
    }
}
}

function togglePackage(packageId) {
    const packageCard = document.querySelector(`[data-package-id="${packageId}"]`);
    const isSelected = packageCard.classList.contains('selected');
    
    // Clear all other package selections (only one package can be selected)
    document.querySelectorAll('.package-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    if (isSelected) {
        // Deselect package
        selectedPackage = null;
    } else {
        // Select package
        packageCard.classList.add('selected');
        
        // Get package data from the card
        const packageName = packageCard.querySelector('.package-name').textContent;
        const packagePriceText = packageCard.querySelector('.package-price').textContent;
        const packagePrice = parseFloat(packagePriceText.replace(/[^0-9.]/g, ''));
        const packageDuration = parseInt(packageCard.querySelector('.package-duration').textContent);
        const servicesCount = parseInt(packageCard.querySelector('.package-services-count').textContent);
        
        selectedPackage = {
            id: packageId,
            name: packageName,
            price: packagePrice,
            duration: packageDuration,
            servicesCount: servicesCount
        };
    }
    
    updateOrderSummary();
}

function updateOrderSummary() {
    const selectedServicesDisplay = document.getElementById('selectedServicesDisplay');
    const selectedServicesList = document.getElementById('selectedServicesList');
    const summaryTotals = document.getElementById('summaryTotals');
    
    let hasSelection = false;
    let subtotal = 0;
    let totalDuration = 0;
    let itemsHtml = '';
    
    // Handle individual services
    if (serviceType === 'individual' && selectedServices.length > 0) {
        hasSelection = true;
        
        selectedServices.forEach(service => {
            itemsHtml += `
                <div class="selected-service-item">
                    <div class="service-item-name">${service.name}</div>
                    <div class="service-item-price">KSH ${service.price.toFixed(2)}</div>
                </div>
            `;
            subtotal += service.price;
            totalDuration += service.duration;
        });
    }
    
    // Handle inventory items
    if (serviceType === 'inventory' && selectedInventoryItems.length > 0) {
        hasSelection = true;
        
        selectedInventoryItems.forEach(item => {
            const itemTotal = item.price * item.quantity;
            itemsHtml += `
                <div class="selected-service-item">
                    <div class="service-item-name">
                        ${item.name}
                        <br><small>${item.quantity} ${item.unit}</small>
                    </div>
                    <div class="service-item-price">KSH ${itemTotal.toFixed(2)}</div>
                </div>
            `;
            subtotal += itemTotal;
        });
    }
    
    if (!hasSelection) {
        selectedServicesDisplay.style.display = 'block';
        selectedServicesList.style.display = 'none';
        summaryTotals.style.display = 'none';
        return;
    }
    
    selectedServicesDisplay.style.display = 'none';
    selectedServicesList.style.display = 'block';
    summaryTotals.style.display = 'block';
    
    selectedServicesList.innerHTML = itemsHtml;
    
    // Update totals with inclusive VAT
    const totalInclusiveVAT = subtotal;
    const taxAmount = totalInclusiveVAT * 0.16 / 1.16;
    const subtotalExVAT = totalInclusiveVAT - taxAmount;
    
    document.getElementById('subtotalAmount').textContent = `KSH ${subtotalExVAT.toFixed(2)}`;
    document.getElementById('taxAmount').textContent = `KSH ${taxAmount.toFixed(2)}`;
    document.getElementById('totalAmount').textContent = `KSH ${totalInclusiveVAT.toFixed(2)}`;
    document.getElementById('estimatedDuration').textContent = totalDuration;
    
    // Update hidden fields for form submission
    if (serviceType === 'individual') {
        document.getElementById('selectedServicesData').value = JSON.stringify({
            type: 'individual',
            service_ids: selectedServices.map(s => s.id)
        });
    } else if (serviceType === 'inventory') {
        // Add hidden inputs for inventory items
        let inventoryInputsHtml = '';
        selectedInventoryItems.forEach(item => {
            inventoryInputsHtml += `<input type="hidden" name="selected_inventory_items" value="${item.id}">`;
            inventoryInputsHtml += `<input type="hidden" name="inventory_quantity_${item.id}" value="${item.quantity}">`;
        });
        
        // Remove existing inventory inputs
        document.querySelectorAll('input[name="selected_inventory_items"], input[name^="inventory_quantity_"]').forEach(input => {
            if (input.type === 'hidden') input.remove();
        });
        
        // Add new inventory inputs to the form
        const form = document.querySelector('#quickOrderForm');
        if (form) {
            form.insertAdjacentHTML('beforeend', inventoryInputsHtml);
        }
    }
}

function clearAllServices() {
    selectedServices = [];
    selectedInventoryItems = [];
    selectedPackage = null;
    
    document.querySelectorAll('.service-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelectorAll('.inventory-card').forEach(card => {
        card.classList.remove('selected');
        const quantityControls = card.querySelector('.inventory-quantity-controls');
        if (quantityControls) {
            quantityControls.style.display = 'none';
        }
    });
    document.querySelectorAll('.package-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    updateOrderSummary();
}

function validateServicesStep() {
    if (serviceType === 'package' && !selectedPackage) {
        showToast('Please select a service package', 'error');
        return false;
    } else if (serviceType === 'individual' && selectedServices.length === 0) {
        showToast('Please select at least one service', 'error');
        return false;
    }
    return true;
}

// Review Step
function updateReviewStep() {
    // Update customer info - handle walk-in, selected, and vehicle customers
    let customerInfo = '';
    const isWalkIn = document.getElementById('isWalkInCustomer').value === 'true';
    
    if (isWalkIn) {
        customerInfo = `<div class="alert alert-warning"><i class="fas fa-walking me-2"></i><strong>Walk-in Customer</strong><br><small>No registration required</small></div>`;
    } else if (vehicleCustomer) {
        customerInfo = `<div class="alert alert-info"><i class="fas fa-car me-2"></i><strong>${vehicleCustomer.full_name || vehicleCustomer.name}</strong><br><small>Phone: ${vehicleCustomer.phone}</small><br><small>ID: ${vehicleCustomer.customer_id}</small><br><small class="text-muted">Vehicle Owner</small></div>`;
    } else if (selectedCustomer) {
        customerInfo = `<strong>${selectedCustomer.name}</strong><br><small>Phone: ${selectedCustomer.phone}</small><br><small>ID: ${selectedCustomer.customerId}</small>`;
    } else {
        const customerName = document.getElementById('customerName').value.trim();
        const customerPhone = document.getElementById('customerPhone').value.trim();
        if (customerName || customerPhone) {
            customerInfo = `<strong>${customerName || 'New Customer'}</strong><br><small>Phone: ${customerPhone || 'Not provided'}</small><br><small class="text-muted">New Registration</small>`;
        } else {
            customerInfo = `<div class="text-muted">No customer information</div>`;
        }
    }
    document.getElementById('reviewCustomerInfo').innerHTML = customerInfo;
    
    // Update vehicle info
    let vehicleInfo = '';
    if (selectedVehicle) {
        vehicleInfo = `<strong>${selectedVehicle.registration}</strong><br><small>${selectedVehicle.make} ${selectedVehicle.model}</small><br><small>Color: ${selectedVehicle.color}</small>`;
        if (selectedVehicle.customerName) {
            vehicleInfo += `<br><small class="text-muted">Owner: ${selectedVehicle.customerName}</small>`;
        }
    } else {
        const registration = document.getElementById('vehicleRegistration').value.trim();
        const make = document.getElementById('vehicleMake').value.trim();
        const model = document.getElementById('vehicleModel').value.trim();
        const color = document.getElementById('vehicleColor').value.trim();
        if (registration || make || model) {
            vehicleInfo = `<strong>${registration || 'New Vehicle'}</strong><br><small>${make} ${model}</small><br><small>Color: ${color}</small><br><small class="text-muted">New Registration</small>`;
        } else {
            vehicleInfo = `<div class="text-muted">No vehicle information</div>`;
        }
    }
    document.getElementById('reviewVehicleInfo').innerHTML = vehicleInfo;
    
    // Update services info
    let servicesHtml = '';
    if (selectedServices && selectedServices.length > 0) {
        selectedServices.forEach(service => {
            servicesHtml += `<div class="d-flex justify-content-between"><span>${service.name}</span><span>KES ${service.price.toFixed(2)}</span></div>`;
        });
    } else {
        servicesHtml = '<div class="text-muted">No services selected</div>';
    }
    document.getElementById('reviewServicesInfo').innerHTML = servicesHtml;
    
    // Update total info with inclusive VAT
    if (selectedServices && selectedServices.length > 0) {
        const totalInclusiveVAT = selectedServices.reduce((sum, service) => sum + service.price, 0); // Prices already include VAT
        const taxAmount = totalInclusiveVAT * 0.16 / 1.16; // Extract VAT from inclusive price
        const subtotalExVAT = totalInclusiveVAT - taxAmount; // Subtotal without VAT
        const duration = selectedServices.reduce((sum, service) => sum + service.duration, 0);
        
        document.getElementById('reviewTotalInfo').innerHTML = `
            <div class="d-flex justify-content-between"><span>Subtotal (ex VAT):</span><span>KES ${subtotalExVAT.toFixed(2)}</span></div>
            <div class="d-flex justify-content-between"><span>VAT (16%):</span><span>KES ${taxAmount.toFixed(2)}</span></div>
            <hr>
            <div class="d-flex justify-content-between"><strong><span>Total (incl VAT):</span><span>KES ${totalInclusiveVAT.toFixed(2)}</span></strong></div>
            <div class="d-flex justify-content-between text-muted"><small><span>Estimated Duration:</span><span>${duration} minutes</span></small></div>
        `;
    } else {
        document.getElementById('reviewTotalInfo').innerHTML = '<div class="text-muted">No services selected</div>';
    }
}

// Form Submission
function submitOrder() {
    // Validate that we have all required data
    if (!validateAllSteps()) {
        showToast('Please complete all required fields', 'error');
        return;
    }
    
    const form = document.getElementById('quickOrderForm');
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Order...';
    submitBtn.disabled = true;
    
    try {
        // Prepare form data
        const formData = new FormData();
        
        // Add CSRF token with multiple fallbacks
        const csrfToken = getCSRFToken();
        if (!csrfToken) {
            throw new Error('CSRF token not found. Please refresh the page.');
        }
        
        console.log('Using CSRF token:', csrfToken.substring(0, 10) + '...');
        
        // Vehicle data (now step 1)
        if (selectedVehicle) {
            formData.set('selected_vehicle_id', selectedVehicle.id);
        } else {
            const vehicleRegistration = document.getElementById('vehicleRegistration').value.trim().toUpperCase();
            const vehicleMake = document.getElementById('vehicleMake').value.trim();
            const vehicleModel = document.getElementById('vehicleModel').value.trim();
            const vehicleColor = document.getElementById('vehicleColor').value.trim();
            const vehicleType = document.getElementById('vehicleType').value;
            const vehicleYear = document.getElementById('vehicleYear').value;
            
            if (!vehicleRegistration) {
                throw new Error('Vehicle registration number is required');
            }
            
            formData.set('vehicle_registration', vehicleRegistration);
            formData.set('vehicle_make', vehicleMake || 'Unknown');
            formData.set('vehicle_model', vehicleModel || 'Unknown');
            formData.set('vehicle_color', vehicleColor || 'Unknown');
            formData.set('vehicle_type', vehicleType || 'car');
            formData.set('vehicle_year', vehicleYear || '2020');
        }

        // Customer data (now step 2)
        const isWalkIn = document.getElementById('isWalkInCustomer').value === 'true';
        formData.set('is_walk_in_customer', isWalkIn);
        
        if (selectedCustomer) {
            formData.set('selected_customer_id', selectedCustomer.id);
        } else if (!isWalkIn) {
            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const customerEmail = document.getElementById('customerEmail').value.trim();
            
            if (customerName || customerPhone) {
                formData.set('customer_name', customerName);
                formData.set('customer_phone', customerPhone);
                formData.set('customer_email', customerEmail);
                
                // Check if vehicle should be added to customer
                if (document.getElementById('addVehicleToCustomer').checked) {
                    formData.set('add_vehicle_to_customer', 'on');
                }
            }
        }
        
        // Service selection data
        const selectionData = JSON.parse(document.getElementById('selectedServicesData').value || '{}');
        
        if (selectionData.type === 'package' && selectionData.package_id) {
            formData.set('service_type', 'package');
            formData.set('selected_package', selectionData.package_id);
        } else if (selectionData.type === 'individual' && selectionData.service_ids && selectionData.service_ids.length > 0) {
            formData.set('service_type', 'individual');
            selectionData.service_ids.forEach(serviceId => {
                formData.append('selected_services', serviceId);
            });
        } else {
            throw new Error('Please select at least one service or package');
        }
        
        // Additional order details
        formData.set('special_instructions', document.getElementById('specialInstructions').value.trim());
        formData.set('priority', document.getElementById('priority').value);
        
        // Log the data being sent (for debugging)
        console.log('Submitting order with data:', Object.fromEntries(formData.entries()));
        
        // Function to make the actual request
        const makeRequest = (token) => {
            return fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': token,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'  // Important for CSRF
            });
        };
        
        // Make the request with CSRF retry logic
        makeRequest(csrfToken)
        .then(async (response) => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            // If CSRF failure, try to refresh token and retry once
            if (response.status === 403) {
                const responseText = await response.text();
                if (responseText.includes('CSRF') || responseText.includes('csrf')) {
                    console.log('CSRF error detected, attempting to refresh token...');
                    try {
                        const newToken = await refreshCSRFToken();
                        if (newToken) {
                            // Update formData with new token
                            formData.set('csrfmiddlewaretoken', newToken);
                            console.log('Retrying request with new CSRF token...');
                            return makeRequest(newToken);
                        }
                    } catch (refreshError) {
                        console.error('Failed to refresh CSRF token:', refreshError);
                        throw new Error('CSRF token expired. Please refresh the page and try again.');
                    }
                }
            }
            
            return response;
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            // Check if response is ok
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Server did not return JSON response');
            }
            
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            
            if (data.success) {
                showToast('Order created successfully!', 'success');
                
                // Start checking payment status for walk-in customers with M-Pesa
                if (data.order_id) {
                    checkPaymentStatus(data.order_id);
                }
                
                // Redirect after a short delay
                setTimeout(() => {
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    } else {
                        // Fallback redirect
                        window.location.href = `/business/{{ request.tenant.slug }}/services/orders/${data.order_id}/`;
                    }
                }, 1500);
            } else {
                // Handle server-side validation errors
                showToast(data.message || 'Error creating order', 'error');
                
                // Show field-specific errors if available
                if (data.errors) {
                    console.log('Form errors:', data.errors);
                    displayFormErrors(data.errors);
                }
            }
        })
        .catch(error => {
            console.error('Order creation error:', error);
            
            let errorMessage = 'Error creating order. Please try again.';
            
            if (error.message.includes('CSRF') || error.message.includes('csrf')) {
                errorMessage = 'Security token expired. Please refresh the page and try again.';
                // Add a refresh button to the error message
                showToast(`${errorMessage} <button onclick="window.location.reload()" class="btn btn-sm btn-outline-light ms-2">Refresh Page</button>`, 'error');
                return; // Don't show the generic toast
            } else if (error.message.includes('HTTP 500')) {
                errorMessage = 'Server error. Please contact support if this persists.';
            } else if (error.message.includes('HTTP 403')) {
                errorMessage = 'Access denied. Please check your permissions and try again.';
            } else if (error.message.includes('HTTP 404')) {
                errorMessage = 'Service not found. Please refresh the page.';
            } else if (error.message.includes('Network')) {
                errorMessage = 'Network error. Please check your connection.';
            }
            
            showToast(errorMessage, 'error');
        })
        .finally(() => {
            // Restore button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
        
    } catch (error) {
        console.error('Form preparation error:', error);
        showToast(error.message || 'Error preparing order data', 'error');
        
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

function validateAllSteps() {
    // Validate customer - check if walk-in is selected or vehicle customer is loaded
    const isWalkIn = document.getElementById('isWalkInCustomer').value === 'true';
    
    if (!isWalkIn && !selectedCustomer && !vehicleCustomer) {
        const name = document.getElementById('customerName').value.trim();
        const phone = document.getElementById('customerPhone').value.trim();
        if (!name || !phone) {
            return false;
        }
    }
    
    // Validate vehicle - only registration is required
    if (!selectedVehicle) {
        const registration = document.getElementById('vehicleRegistration').value.trim();
        
        if (!registration) {
            return false;
        }
    }
    
    // Validate services
    const selectionData = JSON.parse(document.getElementById('selectedServicesData').value || '{}');
    if (serviceType === 'package' && !selectedPackage) {
        return false;
    } else if (serviceType === 'individual' && selectedServices.length === 0) {
        return false;
    }
    
    return true;
}

function displayFormErrors(errors) {
    // Clear previous errors
    document.querySelectorAll('.form-control').forEach(field => {
        field.classList.remove('is-invalid');
    });
    document.querySelectorAll('.invalid-feedback').forEach(el => el.remove());
    
    // Display new errors
    Object.keys(errors).forEach(fieldName => {
        const fieldErrors = errors[fieldName];
        if (fieldErrors && fieldErrors.length > 0) {
            // Try to find the form field
            let field = document.querySelector(`[name="${fieldName}"]`);
            if (!field) {
                // Try alternative field names
                const fieldMappings = {
                    'customer_name': 'customerName',
                    'customer_phone': 'customerPhone',
                    'vehicle_registration': 'vehicleRegistration',
                    'vehicle_make': 'vehicleMake',
                    'vehicle_model': 'vehicleModel',
                    'vehicle_color': 'vehicleColor',
                    'vehicle_type': 'vehicleType'
                };
                field = document.getElementById(fieldMappings[fieldName]);
            }
            
            if (field) {
                field.classList.add('is-invalid');
                
                // Add error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'invalid-feedback';
                errorDiv.textContent = fieldErrors[0];
                field.parentNode.appendChild(errorDiv);
            }
        }
    });
}

// Enhanced CSRF token getter with multiple fallbacks
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Robust CSRF token getter with multiple fallbacks and refresh capability
function getCSRFToken() {
    // First, try to get from form
    const formToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (formToken && formToken.value) {
        console.log('CSRF token from form:', formToken.value.substring(0, 10) + '...');
        return formToken.value;
    }
    
    // Second, try to get from cookie
    const cookieToken = getCookie('csrftoken') || getCookie('autowash_csrftoken');
    if (cookieToken) {
        console.log('CSRF token from cookie:', cookieToken.substring(0, 10) + '...');
        return cookieToken;
    }
    
    // Third, try meta tag
    const metaToken = document.querySelector('meta[name="csrf-token"]');
    if (metaToken) {
        console.log('CSRF token from meta:', metaToken.getAttribute('content').substring(0, 10) + '...');
        return metaToken.getAttribute('content');
    }
    
    console.error('No CSRF token found in form, cookie, or meta tag');
    return null;
}

// Function to refresh CSRF token
function refreshCSRFToken() {
    return fetch(window.location.href, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(html => {
        // Extract new CSRF token from response
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newToken = doc.querySelector('[name=csrfmiddlewaretoken]');
        
        if (newToken) {
            // Update form token
            const currentFormToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (currentFormToken) {
                currentFormToken.value = newToken.value;
                console.log('CSRF token refreshed');
                return newToken.value;
            }
        }
        throw new Error('Could not refresh CSRF token');
    });
}

// Initialize page and token refresh
document.addEventListener('DOMContentLoaded', function() {
    console.log('Quick Order form initialized');
    
    // Check CSRF token on page load
    const initialToken = getCSRFToken();
    if (!initialToken) {
        console.warn('No CSRF token found on page load');
        showToast('Security token missing. Please refresh the page.', 'warning');
    } else {
        console.log('Initial CSRF token verified');
    }
    
    // Refresh CSRF token every 10 minutes to prevent expiry
    setInterval(() => {
        refreshCSRFToken().then(() => {
            console.log('CSRF token auto-refreshed');
        }).catch(error => {
            console.warn('Auto CSRF refresh failed:', error);
        });
    }, 600000); // 10 minutes
    
    // Also refresh token when page becomes visible again (user returns to tab)
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            refreshCSRFToken().then(() => {
                console.log('CSRF token refreshed on page focus');
            }).catch(error => {
                console.warn('CSRF refresh on focus failed:', error);
            });
        }
    });
});

// Enhanced toast with better positioning and styling
function showToast(message, type) {
    // Remove existing toasts
    document.querySelectorAll('.toast-notification').forEach(toast => toast.remove());
    
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    
    const iconMap = {
        'success': 'check-circle',
        'error': 'exclamation-triangle',
        'warning': 'exclamation-circle',
        'info': 'info-circle'
    };
    
    const colorMap = {
        'success': '#10b981',
        'error': '#ef4444',
        'warning': '#f59e0b',
        'info': '#06b6d4'
    };
    
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas fa-${iconMap[type] || 'info-circle'}"></i>
            <span>${message}</span>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Apply styles
    toast.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        z-index: 9999;
        min-width: 300px;
        max-width: 500px;
        animation: slideInRight 0.3s ease-out;
        border-left: 4px solid ${colorMap[type] || colorMap.info};
    `;
    
    const content = toast.querySelector('.toast-content');
    content.style.cssText = `
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: #374151;
    `;
    
    const icon = content.querySelector('i');
    icon.style.color = colorMap[type] || colorMap.info;
    
    const closeBtn = toast.querySelector('.toast-close');
    closeBtn.style.cssText = `
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 0.375rem;
        transition: color 0.15s ease-in-out;
    `;
    
    closeBtn.addEventListener('mouseenter', () => {
        closeBtn.style.color = '#374151';
    });
    
    closeBtn.addEventListener('mouseleave', () => {
        closeBtn.style.color = '#9ca3af';
    });
    
    document.body.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(() => toast.remove(), 300);
        }
    }, 5000);
}

// Add CSS animations
if (!document.getElementById('toast-animations')) {
    const style = document.createElement('style');
    style.id = 'toast-animations';
    style.textContent = `
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideOutRight {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        .invalid-feedback {
            display: block;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875rem;
            color: #ef4444;
        }
        .form-control.is-invalid {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }
    `;
    document.head.appendChild(style);
}
// Auto-search as user types
document.getElementById('customerSearchInput').addEventListener('input', function() {
    clearTimeout(this.searchTimeout);
    this.searchTimeout = setTimeout(() => {
        if (this.value.length >= 2) {
            searchCustomers();
        }
    }, 300);
});

document.getElementById('vehicleSearchInput').addEventListener('input', function() {
    clearTimeout(this.searchTimeout);
    this.searchTimeout = setTimeout(() => {
        if (this.value.length >= 2) {
            searchVehiclesByRegistration();
        } else {
            document.getElementById('vehicleSearchResults').style.display = 'none';
        }
    }, 300);
});

// Phone number formatting
document.getElementById('customerPhone').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    
    if (value.startsWith('0')) {
        value = '254' + value.substring(1);
    }
    if (value.startsWith('254') && !value.startsWith('+254')) {
        value = '+' + value;
    }
    
    e.target.value = value;
});

// Registration number formatting
document.getElementById('vehicleRegistration').addEventListener('input', function(e) {
    e.target.value = e.target.value.toUpperCase();
});

// Utility functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showToast(message, type) {
    // Remove existing toasts
    document.querySelectorAll('.toast-notification').forEach(toast => toast.remove());
    
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
            <span>${message}</span>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Toast styles
    toast.style.cssText = `
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: 1rem;
        box-shadow: var(--shadow-lg);
        z-index: 9999;
        min-width: 300px;
        animation: slideInRight 0.3s ease-out;
        border-left: 4px solid ${type === 'success' ? 'var(--success-500)' : type === 'error' ? '#ef4444' : 'var(--info-500)'};
    `;
    
    const content = toast.querySelector('.toast-content');
    content.style.cssText = `
        display: flex;
        align-items: center;
        gap: 0.75rem;
    `;
    
    const closeBtn = toast.querySelector('.toast-close');
    closeBtn.style.cssText = `
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: none;
        border: none;
        color: var(--gray-400);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: var(--radius-sm);
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}

// Check for walk-in customer transaction details
function checkWalkInCustomerTransactions(customerId) {
    // Check if this walk-in customer has recent M-Pesa transactions that could be saved
    fetch(`/business/{{ request.tenant.slug }}/customers/ajax/check-walk-in-transactions/?customer_id=${customerId}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.has_transactions) {
            // Show notification that customer has transaction details available
            showToast(`This walk-in customer has transaction details available. Consider saving their information.`, 'info');
            
            // Optional: Show save suggestion modal if there are recent payments
            if (data.recent_payment) {
                setTimeout(() => {
                    showCustomerSaveModal({
                        payment_id: data.recent_payment.id,
                        customer_phone: data.recent_payment.customer_phone,
                        amount: data.recent_payment.amount
                    });
                }, 2000);
            }
        }
    })
    .catch(error => {
        console.error('Error checking walk-in customer transactions:', error);
    });
}

// Customer Save Notification Functions
function showCustomerSaveModal(paymentData) {
    // Populate transaction details
    const detailsDiv = document.getElementById('transactionCustomerDetails');
    detailsDiv.innerHTML = `
        <div><strong>Phone:</strong> ${paymentData.customer_phone || 'N/A'}</div>
        <div><strong>Amount:</strong> KSh ${paymentData.amount || 'N/A'}</div>
        <div><strong>Transaction:</strong> ${paymentData.payment_id || 'N/A'}</div>
    `;
    
    // Store payment ID for save action
    document.getElementById('saveCustomerBtn').setAttribute('data-payment-id', paymentData.payment_id);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('customerSaveModal'));
    modal.show();
}

// Handle save customer button click
document.getElementById('saveCustomerBtn').addEventListener('click', function() {
    const paymentId = this.getAttribute('data-payment-id');
    if (paymentId) {
        // Redirect to save customer page
        window.location.href = `/customers/save-walk-in/${paymentId}/`;
    }
});

// Function to check for payment completion and show notification
function checkPaymentStatus(orderId) {
    if (!orderId) return;
    
    // Poll for payment completion every 3 seconds
    const checkInterval = setInterval(() => {
        fetch(`/business/{{ request.tenant.slug }}/payments/ajax/status/?order_id=${orderId}`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.payment) {
                if (data.payment.status === 'completed' && data.payment.method === 'mpesa') {
                    // Check if customer is walk-in
                    if (data.payment.customer_is_walk_in && data.payment.customer_phone) {
                        clearInterval(checkInterval);
                        showCustomerSaveModal({
                            payment_id: data.payment.id,
                            customer_phone: data.payment.customer_phone,
                            amount: data.payment.amount
                        });
                    }
                } else if (data.payment.status === 'failed') {
                    clearInterval(checkInterval);
                    showToast('Payment failed. Please try again.', 'error');
                }
            }
        })
        .catch(error => {
            console.error('Error checking payment status:', error);
        });
    }, 3000);
    
    // Stop checking after 5 minutes
    setTimeout(() => {
        clearInterval(checkInterval);
    }, 300000);
}
</script>
{% endblock %}

<style>
@keyframes slideInRight {
    from { opacity: 0; transform: translateX(100%); }
    to { opacity: 1; transform: translateX(0); }
}

.row {
    display: flex;
    gap: 2rem;
    margin: 0 -1rem;
}

.col-lg-8 {
    flex: 0 0 66.666667%;
    padding: 0 1rem;
}

.col-lg-4 {
    flex: 0 0 33.333333%;
    padding: 0 1rem;
}

.col-md-6 {
    flex: 0 0 50%;
    padding: 0 1rem;
}

@media (max-width: 768px) {
    .row {
        flex-direction: column;
    }
    
    .col-lg-8,
    .col-lg-4,
    .col-md-6 {
        flex: 1;
    }
}
</style>