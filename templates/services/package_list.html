{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/data-table.css' %}">
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <div class="breadcrumb-nav">
            <a href="/business/{{ request.tenant.slug }}/services/" class="breadcrumb-link">
                <i class="fas fa-car-wash"></i>
                Services
            </a>
            <i class="fas fa-chevron-right breadcrumb-separator"></i>
            <span class="breadcrumb-current">Service Packages</span>
        </div>
        <h1 class="page-title">
            <i class="fas fa-box"></i>
            Service Packages
        </h1>
        <p class="page-subtitle">Manage bundled service offerings for better value</p>
    </div>
    <div class="page-actions">
        {% if user_role in 'owner,manager' %}
        <a href="/business/{{ request.tenant.slug }}/services/packages/create/" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            Create Package
        </a>
        {% endif %}
    </div>
</div>

<!-- Packages Table -->
<div class="data-table-container">
    <div class="data-table-header">
        <h5 class="data-table-title">
            Service Packages
            <span class="table-badge table-badge-secondary">{{ packages.count }}</span>
        </h5>
    </div>
    
    <div class="data-table-scroll">
        {% if packages %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Package</th>
                    <th>Services</th>
                    <th>Duration</th>
                    <th>Price</th>
                    <th>Discount</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for package in packages %}
                <tr>
                    <td>
                        <div class="package-info">
                            <div class="package-image-thumb">
                                {% if package.image %}
                                    <img src="{{ package.image.url }}" alt="{{ package.name }}">
                                {% else %}
                                    <div class="package-placeholder-thumb">
                                        <i class="fas fa-box"></i>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="package-details">
                                <h6 class="package-name">
                                    {{ package.name }}
                                    {% if package.is_popular %}
                                        <span class="badge badge-warning badge-sm">
                                            <i class="fas fa-star"></i>
                                            Popular
                                        </span>
                                    {% endif %}
                                </h6>
                                <p class="package-description">{{ package.description|truncatewords:15 }}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="service-count">
                            <i class="fas fa-cogs text-primary"></i>
                            {{ package.service_count }} Service{{ package.service_count|pluralize }}
                        </div>
                    </td>
                    <td>
                        <div class="duration-info">
                            <i class="fas fa-clock text-secondary"></i>
                            {{ package.estimated_duration }} min
                        </div>
                    </td>
                    <td>
                        <div class="price-info">
                            {% if package.discount_percentage > 0 %}
                                <div class="original-price">KES {{ package.original_price|floatformat:0 }}</div>
                            {% endif %}
                            <div class="current-price">KES {{ package.total_price|floatformat:0 }}</div>
                            {% if package.discount_percentage > 0 %}
                                <div class="savings-text">Save KES {{ package.savings_amount|floatformat:0 }}</div>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {% if package.discount_percentage > 0 %}
                            <span class="badge badge-success">
                                {{ package.discount_percentage|floatformat:0 }}% OFF
                            </span>
                        {% else %}
                            <span class="text-muted">â€”</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if package.is_active %}
                            <span class="badge badge-success">Active</span>
                        {% else %}
                            <span class="badge badge-secondary">Inactive</span>
                        {% endif %}
                        
                        {% if package.valid_from or package.valid_until %}
                            <div class="validity-info">
                                <small class="text-muted">
                                    <i class="fas fa-calendar-alt"></i>
                                    {% if package.valid_from and package.valid_until %}
                                        {{ package.valid_from|date:"M d" }} - {{ package.valid_until|date:"M d, Y" }}
                                    {% elif package.valid_from %}
                                        From {{ package.valid_from|date:"M d, Y" }}
                                    {% elif package.valid_until %}
                                        Until {{ package.valid_until|date:"M d, Y" }}
                                    {% endif %}
                                </small>
                            </div>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="/business/{{ request.tenant.slug }}/services/packages/{{ package.id }}/" 
                               class="btn btn-outline-primary btn-sm" title="View Details">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% if user_role in 'owner,manager' %}
                            <a href="/business/{{ request.tenant.slug }}/services/packages/{{ package.id }}/edit/" 
                               class="btn btn-outline-secondary btn-sm" title="Edit Package">
                                <i class="fas fa-edit"></i>
                            </a>
                            {% endif %}
                            <button class="btn btn-success btn-sm" 
                                    onclick="addPackageToOrder('{{ package.id }}')" 
                                    title="Add to Order">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-box"></i>
            </div>
            <h3>No Service Packages</h3>
            <p>Create your first service package to offer bundled services at discounted rates.</p>
            {% if user_role in 'owner,manager' %}
            <a href="/business/{{ request.tenant.slug }}/services/packages/create/" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                Create Package
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function addPackageToOrder(packageId) {
    // Navigate to quick order with package pre-selected
    window.location.href = `/business/{{ request.tenant.slug }}/services/orders/quick/?package=${packageId}`;
}
</script>
{% endblock %}