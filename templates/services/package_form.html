{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <h2>{% if package %}Edit Service Package{% else %}Create Service Package{% endif %}</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/business/{{ request.tenant.slug }}/services/">Services</a></li>
                    <li class="breadcrumb-item"><a href="/business/{{ request.tenant.slug }}/services/packages/">Packages</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{% if package %}Edit {{ package.name }}{% else %}Create Package{% endif %}</li>
                </ol>
            </nav>
        </div>
    </div>
    <form method="post" enctype="multipart/form-data" id="packageForm">
        {% csrf_token %}
        <div class="row">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header"><strong>Basic Information</strong></div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="name" class="form-label">Package Name</label>
                            <input type="text" class="form-control" id="name" name="name" value="{{ package.name|default:'' }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3" required>{{ package.description|default:'' }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label for="image" class="form-label">Package Image</label>
                            <input type="file" class="form-control" id="image" name="image" accept="image/*">
                            {% if package.image %}
                                <img src="{{ package.image.url }}" alt="Current image" class="img-thumbnail mt-2" style="max-width: 200px;">
                            {% endif %}
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="is_popular" name="is_popular" {% if package.is_popular %}checked{% endif %}>
                            <label class="form-check-label" for="is_popular">Mark as Popular</label>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="is_active" name="is_active" {% if package.is_active or not package %}checked{% endif %}>
                            <label class="form-check-label" for="is_active">Package Active</label>
                        </div>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Included Services</strong>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="showServiceSelector()">
                            <i class="fas fa-plus"></i> Add Service
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="selectedServices" class="mb-3"></div>
                        <div id="emptyServicesMessage" class="text-muted">No services added yet. Click "Add Service" to include services in this package.</div>
                        <input type="hidden" id="servicesData" name="services_data" value="">
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header"><strong>Pricing & Duration</strong></div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="total_price" class="form-label">Package Price (KES)</label>
                                <input type="number" class="form-control" id="total_price" name="total_price" value="{{ package.total_price|default:'0' }}" min="0" step="0.01" required>
                            </div>
                            <div class="col-md-4">
                                <label for="discount_percentage" class="form-label">Discount (%)</label>
                                <input type="number" class="form-control" id="discount_percentage" name="discount_percentage" value="{{ package.discount_percentage|default:'0' }}" min="0" max="100" step="0.1">
                            </div>
                            <div class="col-md-4">
                                <label for="estimated_duration" class="form-label">Estimated Duration (min)</label>
                                <input type="number" class="form-control" id="estimated_duration" name="estimated_duration" value="{{ package.estimated_duration|default:'0' }}" min="1" required>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="calculateFromServices()">
                                <i class="fas fa-magic"></i> Auto-Calculate Price
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="calculateDuration()">
                                <i class="fas fa-clock"></i> Auto-Calculate Duration
                            </button>
                        </div>
                        <div class="mt-3 border rounded p-2 bg-light">
                            <div><strong>Individual Services Total:</strong> <span id="servicesTotal">KES 0</span></div>
                            <div><strong>Package Price:</strong> <span id="packagePrice">KES 0</span></div>
                            <div><strong>Customer Savings:</strong> <span id="customerSavings">KES 0</span></div>
                        </div>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header"><strong>Validity Period (Optional)</strong></div>
                    <div class="card-body row g-3">
                        <div class="col-md-6">
                            <label for="valid_from" class="form-label">Valid From</label>
                            <input type="date" class="form-control" id="valid_from" name="valid_from" value="{{ package.valid_from|date:'Y-m-d'|default:'' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="valid_until" class="form-label">Valid Until</label>
                            <input type="date" class="form-control" id="valid_until" name="valid_until" value="{{ package.valid_until|date:'Y-m-d'|default:'' }}">
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-end gap-2">
                    <a href="/business/{{ request.tenant.slug }}/services/packages/" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> {% if package %}Update Package{% else %}Create Package{% endif %}
                    </button>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card mb-4">
                    <div class="card-header"><strong>Package Preview</strong></div>
                    <div class="card-body">
                        <div class="mb-3 text-center">
                            <div id="previewImage" class="mb-2" style="min-height:120px;">
                                <i class="fas fa-box fa-3x text-muted"></i>
                            </div>
                        </div>
                        <h5 id="previewName">New Package</h5>
                        <p id="previewDescription" class="text-muted">Package description...</p>
                        <div class="mb-2"><i class="fas fa-cogs"></i> <span id="previewServiceCount">0 Services</span></div>
                        <div class="mb-2"><i class="fas fa-clock"></i> <span id="previewDuration">0 min</span></div>
                        <div class="mb-2"><strong id="previewPrice">KES 0</strong></div>
                        <div class="mb-2 text-success" id="previewSavings">Save KES 0</div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Service Selector Modal -->
<div class="modal fade" id="serviceSelectorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Services to Package</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control mb-3" id="serviceSearch" placeholder="Search services...">
                <div id="serviceCategories"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="addSelectedServices()">Add Selected Services</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/fontawesome.min.js' %}"></script>
<script>
let selectedServices = [];

document.addEventListener('DOMContentLoaded', function() {
    // Form elements
    const nameInput = document.getElementById('name');
    const descriptionInput = document.getElementById('description');
    const totalPriceInput = document.getElementById('total_price');
    const estimatedDurationInput = document.getElementById('estimated_duration');
    const imageInput = document.getElementById('image');
    // Preview elements
    const previewName = document.getElementById('previewName');
    const previewDescription = document.getElementById('previewDescription');
    const previewServiceCount = document.getElementById('previewServiceCount');
    const previewDuration = document.getElementById('previewDuration');
    const previewPrice = document.getElementById('previewPrice');
    const previewSavings = document.getElementById('previewSavings');
    const previewImage = document.getElementById('previewImage');
    // Price breakdown elements
    const servicesTotal = document.getElementById('servicesTotal');
    const packagePrice = document.getElementById('packagePrice');
    const customerSavings = document.getElementById('customerSavings');

    function updatePreview() {
        previewName.textContent = nameInput.value.trim() || 'New Package';
        const desc = descriptionInput.value.trim() || 'Package description...';
        previewDescription.textContent = desc.length > 80 ? desc.substring(0, 80) + '...' : desc;
        previewServiceCount.textContent = `${selectedServices.length} Service${selectedServices.length !== 1 ? 's' : ''}`;
        previewDuration.textContent = `${estimatedDurationInput.value || '0'} min`;
        previewPrice.textContent = `KES ${parseFloat(totalPriceInput.value || 0).toLocaleString()}`;
        updatePriceBreakdown();
    }
    function updatePriceBreakdown() {
        const packagePriceValue = parseFloat(totalPriceInput.value) || 0;
        const servicesValue = calculateServicesTotal();
        const savings = Math.max(0, servicesValue - packagePriceValue);
        servicesTotal.textContent = `KES ${servicesValue.toLocaleString()}`;
        packagePrice.textContent = `KES ${packagePriceValue.toLocaleString()}`;
        customerSavings.textContent = `KES ${savings.toLocaleString()}`;
        previewSavings.textContent = savings > 0 ? `Save KES ${savings.toLocaleString()}` : 'No savings';
    }
    function calculateServicesTotal() {
        return selectedServices.reduce((total, service) => total + (parseFloat(service.price) * parseInt(service.quantity)), 0);
    }
    function calculateServicesDuration() {
        return selectedServices.reduce((total, service) => total + (parseInt(service.duration) * parseInt(service.quantity)), 0);
    }
    if (nameInput) nameInput.addEventListener('input', updatePreview);
    if (descriptionInput) descriptionInput.addEventListener('input', updatePreview);
    if (totalPriceInput) totalPriceInput.addEventListener('input', updatePreview);
    if (estimatedDurationInput) estimatedDurationInput.addEventListener('input', updatePreview);
    if (imageInput) {
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.innerHTML = `<img src="${e.target.result}" alt="Preview" class="img-fluid rounded">`;
                };
                reader.readAsDataURL(file);
            }
        });
    }
    updatePreview();
});

function showServiceSelector() {
    fetch(`/business/{{ request.tenant.slug }}/services/ajax/services-list/`)
        .then(response => response.json())
        .then(data => {
            populateServiceSelector(data.services);
            const modal = new bootstrap.Modal(document.getElementById('serviceSelectorModal'));
            modal.show();
        })
        .catch(error => {
            alert('Error loading services. Please try again.');
        });
}
function populateServiceSelector(services) {
    const container = document.getElementById('serviceCategories');
    container.innerHTML = '';
    const categorizedServices = {};
    services.forEach(service => {
        const categoryName = service.category || 'Uncategorized';
        if (!categorizedServices[categoryName]) categorizedServices[categoryName] = [];
        categorizedServices[categoryName].push(service);
    });
    Object.keys(categorizedServices).forEach(categoryName => {
        const categorySection = document.createElement('div');
        categorySection.className = 'mb-2';
        const categoryHeader = document.createElement('div');
        categoryHeader.className = 'fw-bold mb-1';
        categoryHeader.textContent = categoryName;
        categorySection.appendChild(categoryHeader);
        categorizedServices[categoryName].forEach(service => {
            const serviceOption = document.createElement('div');
            serviceOption.className = 'form-check form-check-inline mb-1';
            serviceOption.innerHTML = `
                <input type="checkbox" class="form-check-input service-checkbox" value="${service.id}">
                <label class="form-check-label ms-1">${service.name} <span class="text-muted small">(${service.estimated_duration} min, KES ${parseFloat(service.base_price).toLocaleString()})</span></label>
            `;
            categorySection.appendChild(serviceOption);
        });
        container.appendChild(categorySection);
    });
    document.getElementById('serviceSearch').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const serviceOptions = container.querySelectorAll('.form-check-label');
        serviceOptions.forEach(option => {
            const isVisible = option.textContent.toLowerCase().includes(searchTerm);
            option.parentElement.style.display = isVisible ? '' : 'none';
        });
    });
}
function addSelectedServices() {
    const selectedCheckboxes = document.querySelectorAll('.service-checkbox:checked');
    const selectedServicesContainer = document.getElementById('selectedServices');
    const emptyMessage = document.getElementById('emptyServicesMessage');
    selectedCheckboxes.forEach(checkbox => {
        const serviceId = checkbox.value;
        if (document.querySelector(`[data-service-id="${serviceId}"]`)) return;
        const label = checkbox.nextElementSibling;
        const name = label.childNodes[0].textContent.trim();
        const details = label.querySelector('span').textContent;
        const duration = parseInt(details.match(/(\d+) min/)[1]);
        const price = parseFloat(details.match(/KES ([\d,]+)/)[1].replace(/,/g, ''));
        addServiceToPackage({ id: serviceId, name, price, duration, quantity: 1, is_optional: false });
    });
    const modal = bootstrap.Modal.getInstance(document.getElementById('serviceSelectorModal'));
    modal.hide();
    if (selectedServicesContainer.children.length > 0) emptyMessage.classList.add('d-none');
    updatePreview();
}
function addServiceToPackage(service) {
    const container = document.getElementById('selectedServices');
    const serviceElement = document.createElement('div');
    serviceElement.className = 'border rounded p-2 mb-2 d-flex align-items-center justify-content-between service-item';
    serviceElement.dataset.serviceId = service.id;
    serviceElement.innerHTML = `
        <div>
            <strong>${service.name}</strong> <span class="text-muted small">(${service.duration} min, KES ${service.price.toLocaleString()})</span>
        </div>
        <div class="d-flex align-items-center gap-2">
            <input type="number" class="form-control form-control-sm quantity-input" value="${service.quantity}" min="1" max="10" style="width:60px;">
            <input type="number" class="form-control form-control-sm price-input" value="${service.price}" min="0" step="0.01" style="width:90px;">
            <div class="form-check ms-2">
                <input class="form-check-input optional-checkbox" type="checkbox" ${service.is_optional ? 'checked' : ''}>
                <label class="form-check-label small">Optional</label>
            </div>
            <button type="button" class="btn btn-outline-danger btn-sm remove-service"><i class="fas fa-trash"></i></button>
        </div>
    `;
    const quantityInput = serviceElement.querySelector('.quantity-input');
    const priceInput = serviceElement.querySelector('.price-input');
    const optionalCheckbox = serviceElement.querySelector('.optional-checkbox');
    const removeButton = serviceElement.querySelector('.remove-service');
    quantityInput.addEventListener('change', updateSelectedServices);
    priceInput.addEventListener('input', updateSelectedServices);
    optionalCheckbox.addEventListener('change', updateSelectedServices);
    removeButton.addEventListener('click', function() {
        serviceElement.remove();
        updateSelectedServices();
        if (container.children.length === 0) document.getElementById('emptyServicesMessage').classList.remove('d-none');
    });
    container.appendChild(serviceElement);
    updateSelectedServices();
}
function updateSelectedServices() {
    const serviceItems = document.querySelectorAll('.service-item');
    selectedServices = [];
    serviceItems.forEach(item => {
        const serviceId = item.dataset.serviceId;
        const quantity = parseInt(item.querySelector('.quantity-input').value);
        const price = parseFloat(item.querySelector('.price-input').value);
        const isOptional = item.querySelector('.optional-checkbox').checked;
        const name = item.querySelector('strong').textContent;
        const details = item.querySelector('span').textContent;
        const duration = parseInt(details.match(/(\d+) min/)[1]);
        selectedServices.push({ id: serviceId, name, quantity, price, duration, is_optional: isOptional });
    });
    document.getElementById('servicesData').value = JSON.stringify(selectedServices);
    updatePreview();
}
function calculateFromServices() {
    const total = selectedServices.reduce((sum, s) => sum + (s.price * s.quantity), 0);
    document.getElementById('total_price').value = total.toFixed(2);
    updatePreview();
}
function calculateDuration() {
    const total = selectedServices.reduce((sum, s) => sum + (s.duration * s.quantity), 0);
    document.getElementById('estimated_duration').value = total;
    updatePreview();
}
</script>
{% endblock %}
