{% extends 'base/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
/* Service Form Styles */
.service-form-container {
    max-width: 900px;
    margin: 0 auto;
}

.form-section {
    background: white;
    border-radius: var(--radius-lg);
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-200);
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--primary-100);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.section-icon {
    width: 32px;
    height: 32px;
    background: var(--primary-100);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-600);
}

.image-preview {
    max-width: 200px;
    max-height: 200px;
    border-radius: var(--radius-lg);
    margin-top: 1rem;
    box-shadow: var(--shadow-sm);
}

.form-help-text {
    background: var(--info-50);
    border: 1px solid var(--info-200);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.help-icon {
    color: var(--info-600);
    margin-right: 0.5rem;
}

.price-input-group {
    position: relative;
}

.price-input-group::before {
    content: 'KES';
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-500);
    font-weight: 500;
    z-index: 10;
}

.price-input-group input {
    padding-left: 3rem;
}

.duration-input-group {
    position: relative;
}

.duration-input-group::after {
    content: 'min';
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-500);
    font-weight: 500;
}

.duration-input-group input {
    padding-right: 3rem;
}

.checkbox-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.checkbox-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
}

.checkbox-item:hover {
    background: var(--gray-50);
    border-color: var(--primary-300);
}

.checkbox-item input:checked + label {
    color: var(--primary-600);
    font-weight: 500;
}

.form-actions {
    background: white;
    border-radius: var(--radius-lg);
    padding: 2rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    bottom: 2rem;
    z-index: 100;
}

.btn-group {
    display: flex;
    gap: 1rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .service-form-container {
        margin: 0;
    }
    
    .form-section {
        margin: 0 0 1rem 0;
        padding: 1.5rem;
        border-radius: var(--radius-md);
    }
    
    .form-actions {
        flex-direction: column;
        gap: 1rem;
        position: static;
        margin-top: 2rem;
    }
    
    .btn-group {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="service-form-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-content">
            <h1 class="page-title">
                <i class="fas fa-plus-circle text-primary"></i>
                {{ title }}
            </h1>
            <p class="page-description">Configure service details, pricing, and requirements</p>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" id="serviceForm">
        {% csrf_token %}
        
        <!-- Basic Information -->
        <div class="form-section">
            <h3 class="section-title">
                <div class="section-icon">
                    <i class="fas fa-info-circle"></i>
                </div>
                Basic Information
            </h3>
            
            <div class="form-help-text">
                <i class="fas fa-lightbulb help-icon"></i>
                <strong>Tip:</strong> Use clear, descriptive names and detailed descriptions to help customers understand your services.
            </div>
            
            <div class="row">
                <div class="col-md-8">
                    {{ form.name|as_crispy_field }}
                </div>
                <div class="col-md-4">
                    {{ form.category|as_crispy_field }}
                </div>
            </div>
            
            {{ form.description|as_crispy_field }}
            
            <div class="row">
                <div class="col-md-6">
                    {{ form.image|as_crispy_field }}
                    <div id="imagePreview" style="display: none;">
                        <img id="previewImg" class="image-preview" src="" alt="Service Image Preview">
                    </div>
                </div>
                <div class="col-md-6">
                    {{ form.display_order|as_crispy_field }}
                </div>
            </div>
        </div>

        <!-- Pricing Configuration -->
        <div class="form-section">
            <h3 class="section-title">
                <div class="section-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                Pricing Configuration
            </h3>
            
            <div class="form-help-text">
                <i class="fas fa-calculator help-icon"></i>
                <strong>Pricing Guide:</strong> Set a base price and optional min/max ranges for flexible pricing based on vehicle size or condition.
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="{{ form.base_price.id_for_label }}" class="form-label">{{ form.base_price.label }}</label>
                        <div class="price-input-group">
                            {{ form.base_price }}
                        </div>
                        {% if form.base_price.help_text %}
                            <div class="form-text">{{ form.base_price.help_text }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="{{ form.min_price.id_for_label }}" class="form-label">{{ form.min_price.label }}</label>
                        <div class="price-input-group">
                            {{ form.min_price }}
                        </div>
                        {% if form.min_price.help_text %}
                            <div class="form-text">{{ form.min_price.help_text }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="{{ form.max_price.id_for_label }}" class="form-label">{{ form.max_price.label }}</label>
                        <div class="price-input-group">
                            {{ form.max_price }}
                        </div>
                        {% if form.max_price.help_text %}
                            <div class="form-text">{{ form.max_price.help_text }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Duration Settings -->
        <div class="form-section">
            <h3 class="section-title">
                <div class="section-icon">
                    <i class="fas fa-clock"></i>
                </div>
                Duration Settings
            </h3>
            
            <div class="form-help-text">
                <i class="fas fa-stopwatch help-icon"></i>
                <strong>Time Management:</strong> Accurate duration estimates help with scheduling and customer expectations.
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="{{ form.estimated_duration.id_for_label }}" class="form-label">{{ form.estimated_duration.label }}</label>
                        <div class="duration-input-group">
                            {{ form.estimated_duration }}
                        </div>
                        {% if form.estimated_duration.help_text %}
                            <div class="form-text">{{ form.estimated_duration.help_text }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="{{ form.min_duration.id_for_label }}" class="form-label">{{ form.min_duration.label }}</label>
                        <div class="duration-input-group">
                            {{ form.min_duration }}
                        </div>
                        {% if form.min_duration.help_text %}
                            <div class="form-text">{{ form.min_duration.help_text }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="{{ form.max_duration.id_for_label }}" class="form-label">{{ form.max_duration.label }}</label>
                        <div class="duration-input-group">
                            {{ form.max_duration }}
                        </div>
                        {% if form.max_duration.help_text %}
                            <div class="form-text">{{ form.max_duration.help_text }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Requirements & Compatibility -->
        <div class="form-section">
            <h3 class="section-title">
                <div class="section-icon">
                    <i class="fas fa-cogs"></i>
                </div>
                Requirements & Compatibility
            </h3>
            
            <div class="form-help-text">
                <i class="fas fa-car help-icon"></i>
                <strong>Compatibility:</strong> Specify which vehicle types this service works with and required skill level.
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    {{ form.required_skill_level|as_crispy_field }}
                </div>
                <div class="col-md-6">
                    {{ form.compatible_vehicle_types|as_crispy_field }}
                    <div class="form-text">
                        <strong>Examples:</strong> sedan, suv, hatchback, pickup, van, truck
                    </div>
                </div>
            </div>
        </div>

        <!-- Service Settings -->
        <div class="form-section">
            <h3 class="section-title">
                <div class="section-icon">
                    <i class="fas fa-sliders-h"></i>
                </div>
                Service Settings
            </h3>
            
            <div class="checkbox-grid">
                <div class="checkbox-item">
                    {{ form.requires_booking }}
                    <label for="{{ form.requires_booking.id_for_label }}">{{ form.requires_booking.label }}</label>
                </div>
                <div class="checkbox-item">
                    {{ form.is_popular }}
                    <label for="{{ form.is_popular.id_for_label }}">{{ form.is_popular.label }}</label>
                </div>
                <div class="checkbox-item">
                    {{ form.is_premium }}
                    <label for="{{ form.is_premium.id_for_label }}">{{ form.is_premium.label }}</label>
                </div>
                <div class="checkbox-item">
                    {{ form.is_active }}
                    <label for="{{ form.is_active.id_for_label }}">{{ form.is_active.label }}</label>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <div class="form-info">
                <i class="fas fa-info-circle text-muted"></i>
                <span class="text-muted">All fields marked with * are required</span>
            </div>
            <div class="btn-group">
                <a href="/business/{{ request.tenant.slug }}/services/" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i>
                    Cancel
                </a>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <i class="fas fa-save"></i>
                    Save Service
                </button>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Image preview functionality
    const imageInput = document.getElementById('{{ form.image.id_for_label }}');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    
    if (imageInput) {
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.style.display = 'none';
            }
        });
    }
    
    // Form validation
    const form = document.getElementById('serviceForm');
    const submitBtn = document.getElementById('submitBtn');
    
    form.addEventListener('submit', function(e) {
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        submitBtn.disabled = true;
    });
    
    // Price validation
    const basePrice = document.getElementById('{{ form.base_price.id_for_label }}');
    const minPrice = document.getElementById('{{ form.min_price.id_for_label }}');
    const maxPrice = document.getElementById('{{ form.max_price.id_for_label }}');
    
    function validatePrices() {
        const base = parseFloat(basePrice.value) || 0;
        const min = parseFloat(minPrice.value) || 0;
        const max = parseFloat(maxPrice.value) || 0;
        
        if (min > 0 && min > base) {
            showFieldError(minPrice, 'Minimum price cannot be greater than base price');
            return false;
        }
        
        if (max > 0 && max < base) {
            showFieldError(maxPrice, 'Maximum price cannot be less than base price');
            return false;
        }
        
        if (min > 0 && max > 0 && min > max) {
            showFieldError(maxPrice, 'Maximum price cannot be less than minimum price');
            return false;
        }
        
        clearFieldErrors([basePrice, minPrice, maxPrice]);
        return true;
    }
    
    [basePrice, minPrice, maxPrice].forEach(field => {
        if (field) {
            field.addEventListener('blur', validatePrices);
        }
    });
    
    // Duration validation
    const estimatedDuration = document.getElementById('{{ form.estimated_duration.id_for_label }}');
    const minDuration = document.getElementById('{{ form.min_duration.id_for_label }}');
    const maxDuration = document.getElementById('{{ form.max_duration.id_for_label }}');
    
    function validateDurations() {
        const estimated = parseInt(estimatedDuration.value) || 0;
        const min = parseInt(minDuration.value) || 0;
        const max = parseInt(maxDuration.value) || 0;
        
        if (min > 0 && min > estimated) {
            showFieldError(minDuration, 'Minimum duration cannot be greater than estimated duration');
            return false;
        }
        
        if (max > 0 && max < estimated) {
            showFieldError(maxDuration, 'Maximum duration cannot be less than estimated duration');
            return false;
        }
        
        if (min > 0 && max > 0 && min > max) {
            showFieldError(maxDuration, 'Maximum duration cannot be less than minimum duration');
            return false;
        }
        
        clearFieldErrors([estimatedDuration, minDuration, maxDuration]);
        return true;
    }
    
    [estimatedDuration, minDuration, maxDuration].forEach(field => {
        if (field) {
            field.addEventListener('blur', validateDurations);
        }
    });
    
    function showFieldError(field, message) {
        clearFieldErrors([field]);
        field.classList.add('is-invalid');
        const errorDiv = document.createElement('div');
        errorDiv.className = 'invalid-feedback';
        errorDiv.textContent = message;
        field.parentNode.appendChild(errorDiv);
    }
    
    function clearFieldErrors(fields) {
        fields.forEach(field => {
            if (field) {
                field.classList.remove('is-invalid');
                const errorDiv = field.parentNode.querySelector('.invalid-feedback');
                if (errorDiv) {
                    errorDiv.remove();
                }
            }
        });
    }
});
</script>
{% endblock %}