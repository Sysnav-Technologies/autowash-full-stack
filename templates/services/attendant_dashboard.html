<!-- templates/services/attendant_dashboard.html -->
{% extends 'base/base.html' %}
{% load static %}

{% block title %}My Dashboard - {{ block.super }}{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">
            <i class="fas fa-user-cog text-primary"></i>
            My Dashboard
        </h1>
        <p class="page-description">Welcome back, {{ request.employee.full_name }}! Here's your service overview.</p>
    </div>
    
    <div class="page-actions">
        <a href="/business/{{ request.tenant.slug }}/services/orders/quick/" class="btn btn-success">
            <i class="fas fa-bolt"></i>
            Quick Order
        </a>
        <a href="/business/{{ request.tenant.slug }}/services/my-services/" class="btn btn-outline-primary">
            <i class="fas fa-list"></i>
            All My Services
        </a>
    </div>
</div>

<!-- Performance Stats -->
<div class="stats-grid">
    <div class="stat-card stat-card-primary">
        <div class="stat-icon">
            <i class="fas fa-clipboard-check"></i>
        </div>
        <div class="stat-content">
            <h3>{{ stats.orders_today }}</h3>
            <p>Orders Today</p>
            <small class="stat-change">
                {% if stats.completed_today > 0 %}
                <i class="fas fa-check text-success"></i>
                {{ stats.completed_today }} completed
                {% else %}
                No completed orders yet
                {% endif %}
            </small>
        </div>
    </div>
    
    <div class="stat-card stat-card-success">
        <div class="stat-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-content">
            <h3>{{ stats.completed_today }}</h3>
            <p>Completed Today</p>
            <small class="stat-change">
                {% if stats.in_progress > 0 %}
                <i class="fas fa-cog fa-spin text-primary"></i>
                {{ stats.in_progress }} in progress
                {% else %}
                No services in progress
                {% endif %}
            </small>
        </div>
    </div>
    
    <div class="stat-card stat-card-info">
        <div class="stat-icon">
            <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="stat-content">
            <h3>KES {{ stats.total_revenue_today|floatformat:0 }}</h3>
            <p>Revenue Today</p>
            <small class="stat-change">From completed services</small>
        </div>
    </div>
    
    <div class="stat-card stat-card-warning">
        <div class="stat-icon">
            <i class="fas fa-clock"></i>
        </div>
        <div class="stat-content">
            <h3 id="current-time">--:--</h3>
            <p>Current Time</p>
            <small class="stat-change" id="shift-status">Shift status</small>
        </div>
    </div>
</div>

<div class="row">
    <!-- Current Assignments -->
    <div class="col-lg-8">
        <div class="content-card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-tasks"></i>
                    My Current Assignments
                </h5>
                <div class="card-actions">
                    <button class="btn btn-sm btn-success" onclick="startNextService()">
                        <i class="fas fa-play"></i>
                        Start Next Service
                    </button>
                </div>
            </div>
            
            <div class="card-body">
                {% if my_orders %}
                <div class="assignments-list">
                    {% for order in my_orders %}
                    <div class="assignment-card" data-order-id="{{ order.id }}">
                        <div class="assignment-header">
                            <div class="assignment-info">
                                <h6 class="assignment-number">{{ order.order_number }}</h6>
                                <span class="badge badge-{{ order.status }}">{{ order.get_status_display }}</span>
                                {% if order.priority != 'normal' %}
                                <span class="priority-badge priority-{{ order.priority }}">
                                    {{ order.get_priority_display }}
                                </span>
                                {% endif %}
                            </div>
                            <div class="assignment-time">
                                {% if order.status == 'in_progress' and order.actual_start_time %}
                                <span class="time-elapsed" data-start-time="{{ order.actual_start_time.isoformat }}">
                                    <i class="fas fa-clock"></i>
                                    <span class="elapsed-time">--:--</span>
                                </span>
                                {% else %}
                                <span class="time-created">
                                    <i class="fas fa-calendar"></i>
                                    {{ order.created_at|date:"H:i" }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="assignment-details">
                            <div class="customer-vehicle">
                                <div class="customer-info">
                                    <strong>{{ order.customer.full_name }}</strong>
                                    <br><small>{{ order.customer.phone }}</small>
                                </div>
                                <div class="vehicle-info">
                                    <strong>{{ order.vehicle.registration_number }}</strong>
                                    <br><small>{{ order.vehicle.make }} {{ order.vehicle.model }}</small>
                                </div>
                            </div>
                            
                            <div class="services-list">
                                {% for item in order.order_items.all %}
                                <span class="service-tag">
                                    {{ item.service.name }}{% if item.quantity > 1 %} x{{ item.quantity }}{% endif %}
                                </span>
                                {% endfor %}
                            </div>
                            
                            <div class="order-summary">
                                <span class="order-total">KES {{ order.total_amount }}</span>
                                <span class="order-duration">{{ order.estimated_duration }} min</span>
                            </div>
                        </div>
                        
                        <div class="assignment-actions">
                            {% if order.status == 'confirmed' %}
                            <button class="btn btn-sm btn-success" onclick="startService('{{ order.id }}')">
                                <i class="fas fa-play"></i>
                                Start Service
                            </button>
                            {% elif order.status == 'in_progress' %}
                            <button class="btn btn-sm btn-warning" onclick="pauseService('{{ order.id }}')">
                                <i class="fas fa-pause"></i>
                                Pause
                            </button>
                            <button class="btn btn-sm btn-success" onclick="completeService('{{ order.id }}')">
                                <i class="fas fa-check"></i>
                                Complete
                            </button>
                            {% endif %}
                            
                            <a href="/business/{{ request.tenant.slug }}/services/orders/{{ order.pk }}/" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i>
                                View Details
                            </a>
                        </div>
                        
                        {% if order.special_instructions %}
                        <div class="assignment-notes">
                            <i class="fas fa-sticky-note"></i>
                            <strong>Instructions:</strong> {{ order.special_instructions }}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-assignments">
                    <div class="empty-assignments-icon">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                    <h6>No Current Assignments</h6>
                    <p>You don't have any active service assignments right now.</p>
                    <a href="/business/{{ request.tenant.slug }}/services/orders/quick/" class="btn btn-success">
                        <i class="fas fa-bolt"></i>
                        Create Quick Order
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Service Items in Progress -->
        {% if my_service_items %}
        <div class="content-card mt-4">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-cog"></i>
                    Service Items in Progress
                </h5>
            </div>
            
            <div class="card-body">
                <div class="service-items-list">
                    {% for item in my_service_items %}
                    <div class="service-item-card">
                        <div class="service-item-info">
                            <h6>{{ item.service.name }}</h6>
                            <p>Order: {{ item.order.order_number }} - {{ item.order.customer.full_name }}</p>
                        </div>
                        <div class="service-item-status">
                            {% if item.started_at %}
                            <span class="status-in-progress">
                                <i class="fas fa-cog fa-spin"></i>
                                In Progress
                            </span>
                            {% else %}
                            <span class="status-pending">
                                <i class="fas fa-clock"></i>
                                Pending
                            </span>
                            {% endif %}
                        </div>
                        <div class="service-item-actions">
                            {% if not item.started_at %}
                            <button class="btn btn-sm btn-success" onclick="startServiceItem('{{ item.id }}')">
                                <i class="fas fa-play"></i>
                                Start
                            </button>
                            {% else %}
                            <button class="btn btn-sm btn-primary" onclick="completeServiceItem('{{ item.id }}')">
                                <i class="fas fa-check"></i>
                                Complete
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Today's Queue & Quick Actions -->
    <div class="col-lg-4">
        <!-- Today's Queue -->
        <div class="content-card">
            <div class="card-header">
                <h6 class="card-title">
                    <i class="fas fa-list-ol"></i>
                    Today's Queue
                </h6>
                <div class="card-actions">
                    <a href="/business/{{ request.tenant.slug }}/services/queue/" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-external-link-alt"></i>
                        View All
                    </a>
                </div>
            </div>
            
            <div class="card-body">
                {% if today_queue %}
                <div class="queue-list">
                    {% for entry in today_queue %}
                    <div class="queue-item {% if entry.order.assigned_attendant == request.employee %}queue-item-mine{% endif %}">
                        <div class="queue-number">
                            <span class="queue-badge">{{ entry.queue_number }}</span>
                        </div>
                        <div class="queue-info">
                            <div class="queue-order">{{ entry.order.order_number }}</div>
                            <div class="queue-customer">{{ entry.order.customer.full_name }}</div>
                            <div class="queue-status">
                                <span class="badge badge-{{ entry.status }}">{{ entry.get_status_display }}</span>
                            </div>
                        </div>
                        <div class="queue-time">
                            {% if entry.status == 'waiting' %}
                            <small class="text-muted">Est. {{ entry.estimated_wait_time }} min</small>
                            {% elif entry.status == 'in_service' %}
                            <small class="text-success">Active</small>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-queue">
                    <i class="fas fa-list-ol"></i>
                    <p>No orders in queue today</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="content-card mt-4">
            <div class="card-header">
                <h6 class="card-title">
                    <i class="fas fa-bolt"></i>
                    Quick Actions
                </h6>
            </div>
            
            <div class="card-body">
                <div class="quick-actions-grid">
                    <button class="quick-action-btn" onclick="openQuickCustomerRegister()">
                        <i class="fas fa-user-plus"></i>
                        <span>Register Customer</span>
                    </button>
                    
                    <button class="quick-action-btn" onclick="openQuickServiceAssign()">
                        <i class="fas fa-hand-point-right"></i>
                        <span>Assign Service</span>
                    </button>
                    
                    <button class="quick-action-btn" onclick="openPaymentProcess()">
                        <i class="fas fa-credit-card"></i>
                        <span>Process Payment</span>
                    </button>
                    
                    <button class="quick-action-btn" onclick="printReceipt()">
                        <i class="fas fa-print"></i>
                        <span>Print Receipt</span>
                    </button>
                    
                    <button class="quick-action-btn" onclick="openCustomerSearch()">
                        <i class="fas fa-search"></i>
                        <span>Find Customer</span>
                    </button>
                    
                    <button class="quick-action-btn" onclick="viewMyPerformance()">
                        <i class="fas fa-chart-line"></i>
                        <span>My Performance</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Today's Performance -->
        <div class="content-card mt-4">
            <div class="card-header">
                <h6 class="card-title">
                    <i class="fas fa-trophy"></i>
                    Today's Performance
                </h6>
            </div>
            
            <div class="card-body">
                <div class="performance-metrics">
                    <div class="metric">
                        <div class="metric-label">Services Completed</div>
                        <div class="metric-value">{{ stats.completed_today }}</div>
                        <div class="metric-target">Target: 8</div>
                    </div>
                    
                    <div class="metric">
                        <div class="metric-label">Revenue Generated</div>
                        <div class="metric-value">KES {{ stats.total_revenue_today|floatformat:0 }}</div>
                        <div class="metric-target">Target: KES 5,000</div>
                    </div>
                    
                    <div class="metric">
                        <div class="metric-label">Average Service Time</div>
                        <div class="metric-value">-- min</div>
                        <div class="metric-target">Target: 45 min</div>
                    </div>
                    
                    <div class="metric">
                        <div class="metric-label">Customer Satisfaction</div>
                        <div class="metric-value">--</div>
                        <div class="metric-target">Target: 4.5â˜…</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Attendance -->
        <div class="content-card mt-4">
            <div class="card-header">
                <h6 class="card-title">
                    <i class="fas fa-clock"></i>
                    Attendance
                </h6>
            </div>
            
            <div class="card-body">
                <div class="attendance-status">
                    <div class="attendance-info">
                        <div class="check-in-time">
                            <strong>Check-in:</strong> <span id="check-in-time">--:--</span>
                        </div>
                        <div class="hours-worked">
                            <strong>Hours Worked:</strong> <span id="hours-worked">0:00</span>
                        </div>
                    </div>
                    
                    <div class="attendance-actions">
                        <button class="btn btn-sm btn-success" onclick="checkIn()">
                            <i class="fas fa-sign-in-alt"></i>
                            Check In
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="takeBreak()">
                            <i class="fas fa-coffee"></i>
                            Break
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="checkOut()">
                            <i class="fas fa-sign-out-alt"></i>
                            Check Out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: var(--shadow-sm);
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--primary-500);
}

.stat-card-primary::before { background: var(--primary-500); }
.stat-card-success::before { background: var(--success-500); }
.stat-card-info::before { background: var(--info-500); }
.stat-card-warning::before { background: var(--warning-500); }

.stat-icon {
    width: 3rem;
    height: 3rem;
    border-radius: var(--radius-lg);
    background: var(--gray-100);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-600);
    font-size: 1.25rem;
}

.stat-content h3 {
    margin: 0;
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--gray-900);
}

.stat-content p {
    margin: 0;
    font-size: 0.875rem;
    color: var(--gray-600);
    font-weight: 500;
}

.stat-change {
    font-size: 0.75rem;
    color: var(--gray-500);
    display: flex;
    align-items: center;
    gap: 0.25rem;
    margin-top: 0.25rem;
}

.assignments-list {
    space-y: 1rem;
}

.assignment-card {
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    background: white;
    transition: all var(--transition-fast);
}

.assignment-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
}

.assignment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.assignment-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.assignment-number {
    margin: 0;
    font-weight: 600;
    color: var(--primary-600);
}

.assignment-time {
    font-size: 0.875rem;
    color: var(--gray-600);
}

.time-elapsed {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    color: var(--success-600);
    font-weight: 500;
}

.assignment-details {
    margin-bottom: 1rem;
}

.customer-vehicle {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--gray-100);
}

.customer-info,
.vehicle-info {
    font-size: 0.875rem;
}

.services-list {
    margin-bottom: 1rem;
}

.service-tag {
    display: inline-block;
    background: var(--primary-100);
    color: var(--primary-700);
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    margin: 0.125rem;
}

.order-summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.875rem;
}

.order-total {
    font-weight: 600;
    color: var(--gray-900);
}

.order-duration {
    color: var(--gray-600);
}

.assignment-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.assignment-notes {
    background: var(--info-50);
    border: 1px solid var(--info-200);
    border-radius: var(--radius-md);
    padding: 0.75rem;
    margin-top: 1rem;
    font-size: 0.875rem;
    color: var(--info-800);
}

.empty-assignments {
    text-align: center;
    padding: 3rem 1rem;
}

.empty-assignments-icon {
    font-size: 3rem;
    color: var(--gray-300);
    margin-bottom: 1rem;
}

.queue-list {
    space-y: 0.75rem;
}

.queue-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
    background: white;
}

.queue-item-mine {
    background: var(--primary-50);
    border-color: var(--primary-200);
}

.queue-badge {
    background: var(--primary-600);
    color: white;
    border-radius: 50%;
    width: 1.5rem;
    height: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
}

.queue-info {
    flex: 1;
}

.queue-order {
    font-weight: 600;
    color: var(--gray-900);
    font-size: 0.875rem;
}

.queue-customer {
    color: var(--gray-600);
    font-size: 0.75rem;
}

.queue-status {
    margin-top: 0.25rem;
}

.empty-queue {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--gray-500);
}

.empty-queue i {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    opacity: 0.5;
}

.quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
}

.quick-action-btn {
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
}

.quick-action-btn:hover {
    background: var(--primary-50);
    border-color: var(--primary-200);
    transform: translateY(-1px);
}

.quick-action-btn i {
    font-size: 1.25rem;
    color: var(--primary-600);
}

.quick-action-btn span {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--gray-700);
}

.performance-metrics {
    space-y: 1rem;
}

.metric {
    text-align: center;
    padding: 1rem;
    background: var(--gray-50);
    border-radius: var(--radius-md);
}

.metric-label {
    font-size: 0.75rem;
    color: var(--gray-600);
    margin-bottom: 0.25rem;
}

.metric-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 0.25rem;
}

.metric-target {
    font-size: 0.625rem;
    color: var(--gray-500);
}

.attendance-status {
    text-align: center;
}

.attendance-info {
    margin-bottom: 1rem;
    font-size: 0.875rem;
}

.attendance-info > div {
    margin-bottom: 0.5rem;
}

.attendance-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    flex-wrap: wrap;
}

.service-items-list {
    space-y: 0.75rem;
}

.service-item-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
    background: white;
}

.service-item-info h6 {
    margin: 0;
    font-size: 0.875rem;
    color: var(--gray-900);
}

.service-item-info p {
    margin: 0;
    font-size: 0.75rem;
    color: var(--gray-600);
}

.status-in-progress {
    color: var(--primary-600);
    font-size: 0.75rem;
    font-weight: 500;
}

.status-pending {
    color: var(--warning-600);
    font-size: 0.75rem;
    font-weight: 500;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .customer-vehicle {
        grid-template-columns: 1fr;
        gap: 0.5rem;
    }
    
    .assignment-actions {
        justify-content: center;
    }
    
    .quick-actions-grid {
        grid-template-columns: 1fr;
    }
    
    .attendance-actions {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    updateCurrentTime();
    updateElapsedTimes();
    loadAttendanceStatus();
    
    // Update time every minute
    setInterval(updateCurrentTime, 60000);
    setInterval(updateElapsedTimes, 60000);
});

function updateCurrentTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', { 
        hour12: false, 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    document.getElementById('current-time').textContent = timeString;
    
    // Update shift status
    const hour = now.getHours();
    const shiftStatus = document.getElementById('shift-status');
    if (hour >= 8 && hour < 17) {
        shiftStatus.textContent = 'Day Shift';
        shiftStatus.className = 'stat-change text-success';
    } else if (hour >= 17 && hour < 22) {
        shiftStatus.textContent = 'Evening Shift';
        shiftStatus.className = 'stat-change text-warning';
    } else {
        shiftStatus.textContent = 'Off Hours';
        shiftStatus.className = 'stat-change text-muted';
    }
}

function updateElapsedTimes() {
    document.querySelectorAll('.time-elapsed').forEach(element => {
        const startTime = new Date(element.dataset.startTime);
        const now = new Date();
        const elapsed = Math.floor((now - startTime) / 1000 / 60); // minutes
        
        const hours = Math.floor(elapsed / 60);
        const minutes = elapsed % 60;
        const timeString = `${hours}:${minutes.toString().padStart(2, '0')}`;
        
        element.querySelector('.elapsed-time').textContent = timeString;
    });
}

function loadAttendanceStatus() {
    fetch(`/business/{{ request.tenant.slug }}/employees/ajax/attendance-status/`)
        .then(response => response.json())
        .then(data => {
            if (data.check_in_time) {
                document.getElementById('check-in-time').textContent = data.check_in_time;
            }
            if (data.hours_worked) {
                document.getElementById('hours-worked').textContent = data.hours_worked;
            }
        })
        .catch(error => {
            console.error('Error loading attendance status:', error);
        });
}

// Service management functions
function startNextService() {
    fetch(`/business/{{ request.tenant.slug }}/services/ajax/start-next/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessToast('Service started successfully');
            if (data.redirect_url) {
                setTimeout(() => {
                    window.location.href = data.redirect_url;
                }, 1500);
            } else {
                setTimeout(() => location.reload(), 1500);
            }
        } else {
            showErrorToast(data.message || 'No services in queue');
        }
    })
    .catch(error => {
        showErrorToast('Error starting service');
    });
}

function startService(orderId) {
    fetch(`/business/{{ request.tenant.slug }}/services/orders/${orderId}/start/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessToast('Service started successfully');
            setTimeout(() => location.reload(), 1000);
        } else {
            showErrorToast(data.message || 'Error starting service');
        }
    })
    .catch(error => {
        showErrorToast('Error starting service');
    });
}

function pauseService(orderId) {
    fetch(`/business/{{ request.tenant.slug }}/services/orders/${orderId}/pause/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessToast('Service paused');
            setTimeout(() => location.reload(), 1000);
        } else {
            showErrorToast(data.message || 'Error pausing service');
        }
    })
    .catch(error => {
        showErrorToast('Error pausing service');
    });
}

function completeService(orderId) {
    if (confirm('Are you sure you want to complete this service?')) {
        fetch(`/business/{{ request.tenant.slug }}/services/orders/${orderId}/complete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessToast('Service completed successfully');
                setTimeout(() => location.reload(), 1000);
            } else {
                showErrorToast(data.message || 'Error completing service');
            }
        })
        .catch(error => {
            showErrorToast('Error completing service');
        });
    }
}

// Quick action functions
function openQuickCustomerRegister() {
    window.location.href = '/business/{{ request.tenant.slug }}/services/quick/customer-register/';
}

function openQuickServiceAssign() {
    window.location.href = '/business/{{ request.tenant.slug }}/services/quick/service-assign/';
}

function openPaymentProcess() {
    window.location.href = '/business/{{ request.tenant.slug }}/payments/create/';
}

function printReceipt() {
    window.location.href = '/business/{{ request.tenant.slug }}/payments/receipts/';
}

function openCustomerSearch() {
    // Open customer search modal (implement as needed)
    showInfoToast('Customer search feature - opening...');
}

function viewMyPerformance() {
    window.location.href = '/business/{{ request.tenant.slug }}/employees/my-performance/';
}

// Attendance functions
function checkIn() {
    fetch(`/business/{{ request.tenant.slug }}/employees/ajax/check-in/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessToast('Checked in successfully');
            loadAttendanceStatus();
        } else {
            showErrorToast(data.message || 'Error checking in');
        }
    })
    .catch(error => {
        showErrorToast('Error checking in');
    });
}

function takeBreak() {
    fetch(`/business/{{ request.tenant.slug }}/employees/ajax/break-start/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessToast('Break started');
            loadAttendanceStatus();
        } else {
            showErrorToast(data.message || 'Error starting break');
        }
    })
    .catch(error => {
        showErrorToast('Error starting break');
    });
}

function checkOut() {
    if (confirm('Are you sure you want to check out?')) {
        fetch(`/business/{{ request.tenant.slug }}/employees/ajax/check-out/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessToast('Checked out successfully');
                loadAttendanceStatus();
            } else {
                showErrorToast(data.message || 'Error checking out');
            }
        })
        .catch(error => {
            showErrorToast('Error checking out');
        });
    }
}

// Utility functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showSuccessToast(message) {
    showToast(message, 'success');
}

function showErrorToast(message) {
    showToast(message, 'error');
}

function showInfoToast(message) {
    showToast(message, 'info');
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
            <span>${message}</span>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 4000);
}
</script>

<!-- Toast Styles -->
<style>
.toast {
    position: fixed;
    top: 2rem;
    right: 2rem;
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-lg);
    padding: 1rem;
    box-shadow: var(--shadow-lg);
    z-index: 9999;
    min-width: 300px;
    animation: slideInRight 0.3s ease-out;
}

.toast.toast-success { border-left: 4px solid var(--success-500); }
.toast.toast-error { border-left: 4px solid var(--danger-500); }
.toast.toast-info { border-left: 4px solid var(--info-500); }

.toast-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.toast-close {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: none;
    border: none;
    color: var(--gray-400);
    cursor: pointer;
    padding: 0.25rem;
    border-radius: var(--radius-sm);
}

@keyframes slideInRight {
    from { opacity: 0; transform: translateX(100%); }
    to { opacity: 1; transform: translateX(0); }
}
</style>
{% endblock %}