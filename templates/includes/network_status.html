<!-- Network Status Indicator -->
{% if network_status.protection_active %}
<div class="alert alert-warning alert-dismissible fade show network-status-alert" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <strong>Network Protection Active:</strong> Database modifications are temporarily disabled due to slow connection to prevent duplicates.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% elif network_status.slow_connection %}
<div class="alert alert-info alert-dismissible fade show network-status-alert" role="alert">
    <i class="fas fa-wifi me-2"></i>
    <strong>Slow Connection Detected:</strong> Please be patient with form submissions.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<style>
.network-status-alert {
    position: fixed;
    top: 10px;
    right: 10px;
    z-index: 9999;
    max-width: 400px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.network-status-alert.alert-warning {
    background-color: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
}

.network-status-alert.alert-info {
    background-color: #d1ecf1;
    border-color: #bee5eb;
    color: #0c5460;
}
</style>

<script>
// Network status monitoring
(function() {
    let lastRequestTime = Date.now();
    let slowRequestCount = 0;
    
    // Monitor AJAX requests for network issues
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
        const startTime = Date.now();
        
        return originalFetch.apply(this, args).finally(() => {
            const requestTime = Date.now() - startTime;
            
            if (requestTime > 3000) { // 3 seconds threshold
                slowRequestCount++;
                
                if (slowRequestCount >= 2) {
                    showNetworkWarning();
                }
            } else {
                slowRequestCount = Math.max(0, slowRequestCount - 1);
            }
        });
    };
    
    // Monitor form submissions
    document.addEventListener('submit', function(e) {
        const form = e.target;
        if (form.dataset.submitting === 'true') {
            e.preventDefault();
            showDuplicateWarning();
            return false;
        }
        
        form.dataset.submitting = 'true';
        
        // Reset after 5 seconds
        setTimeout(() => {
            form.dataset.submitting = 'false';
        }, 5000);
    });
    
    function showNetworkWarning() {
        if (document.querySelector('.network-warning-dynamic')) return;
        
        const alert = document.createElement('div');
        alert.className = 'alert alert-warning alert-dismissible fade show network-warning-dynamic';
        alert.style.cssText = 'position: fixed; top: 70px; right: 10px; z-index: 9999; max-width: 400px;';
        alert.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Slow Connection:</strong> Please wait and avoid multiple submissions.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alert);
        
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 10000);
    }
    
    function showDuplicateWarning() {
        if (document.querySelector('.duplicate-warning-dynamic')) return;
        
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show duplicate-warning-dynamic';
        alert.style.cssText = 'position: fixed; top: 130px; right: 10px; z-index: 9999; max-width: 400px;';
        alert.innerHTML = `
            <i class="fas fa-ban me-2"></i>
            <strong>Duplicate Submission:</strong> Please wait before submitting again.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alert);
        
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }
})();
</script>