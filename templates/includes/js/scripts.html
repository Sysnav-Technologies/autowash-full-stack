<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- AOS Animation -->
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

<!-- Custom JavaScript -->
<script>
$(document).ready(function() {
    // Initialize AOS
    if (typeof AOS !== 'undefined') {
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true,
            offset: 100
        });
    }
    
    // Auto-hide messages after 5 seconds
    setTimeout(function() {
        $('.message-alert').each(function() {
            $(this).addClass('fade-out');
            setTimeout(() => {
                $(this).remove();
            }, 500);
        });
    }, 5000);
    
    // AJAX setup for Django CSRF
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", $('[name=csrfmiddlewaretoken]').val());
            }
        }
    });
    
    // Loading states for forms
    $(document).on('submit', 'form', function() {
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        
        submitBtn.prop('disabled', true);
        submitBtn.html('<span class="spinner-border spinner-border-sm me-2"></span>Processing...');
        
        // Re-enable after 10 seconds as fallback
        setTimeout(() => {
            submitBtn.prop('disabled', false);
            submitBtn.html(originalText);
        }, 10000);
    });
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Initialize popovers
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl);
    });
});

{% if user.is_authenticated and request.tenant and request.tenant.schema_name != 'public' %}
// Dashboard specific functionality
$(document).ready(function() {
    // Sidebar toggle functionality
    $('#sidebarToggle').on('click', function() {
        const sidebar = $('#sidebar');
        const mainContent = $('#main-content');
        
        if (window.innerWidth <= 768) {
            // Mobile behavior
            sidebar.toggleClass('mobile-open');
        } else {
            // Desktop behavior
            sidebar.toggleClass('collapsed');
            mainContent.toggleClass('expanded');
            
            // Store preference in localStorage if available
            try {
                localStorage.setItem('sidebar-collapsed', sidebar.hasClass('collapsed'));
            } catch (e) {
                // localStorage not available
            }
        }
    });
    
    // Close mobile sidebar when clicking outside
    $(document).on('click', function(event) {
        if (window.innerWidth <= 768) {
            const sidebar = $('#sidebar');
            const sidebarToggle = $('#sidebarToggle');
            
            if (!sidebar.is(event.target) && sidebar.has(event.target).length === 0 &&
                !sidebarToggle.is(event.target) && sidebarToggle.has(event.target).length === 0) {
                sidebar.removeClass('mobile-open');
            }
        }
    });
    
    // Restore sidebar state from localStorage if available
    try {
        const isCollapsed = localStorage.getItem('sidebar-collapsed') === 'true';
        if (isCollapsed && window.innerWidth > 768) {
            $('#sidebar').addClass('collapsed');
            $('#main-content').addClass('expanded');
        }
    } catch (e) {
        // localStorage not available
    }
    
    // Auto-open active dropdown on page load
    $('.nav-link.active').closest('.nav-dropdown').addClass('open');
});
{% endif %}

// Global functions
function toggleDropdown(dropdownId) {
    const dropdown = document.getElementById(dropdownId);
    if (dropdown) {
        dropdown.classList.toggle('open');
        
        // Close other dropdowns
        document.querySelectorAll('.nav-dropdown').forEach(d => {
            if (d.id !== dropdownId) {
                d.classList.remove('open');
            }
        });
    }
}

function toggleTheme() {
    const body = document.body;
    const isDark = body.classList.contains('dark-theme');
    const themeIcon = document.getElementById('theme-icon');
    const themeText = document.getElementById('theme-text');
    
    if (isDark) {
        body.classList.remove('dark-theme');
        themeIcon.className = 'fas fa-moon';
        themeText.textContent = 'Dark Mode';
        try {
            localStorage.setItem('theme', 'light');
        } catch (e) {}
    } else {
        body.classList.add('dark-theme');
        themeIcon.className = 'fas fa-sun';
        themeText.textContent = 'Light Mode';
        try {
            localStorage.setItem('theme', 'dark');
        } catch (e) {}
    }
}

// Load theme from localStorage
try {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-theme');
        const themeIcon = document.getElementById('theme-icon');
        const themeText = document.getElementById('theme-text');
        if (themeIcon) themeIcon.className = 'fas fa-sun';
        if (themeText) themeText.textContent = 'Light Mode';
    }
} catch (e) {
    // localStorage not available
}

// Search functionality
function initializeSearch() {
    const searchInput = document.getElementById('globalSearch');
    const searchResults = document.getElementById('searchResults');
    
    if (!searchInput || !searchResults) return;
    
    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            searchResults.style.display = 'none';
            return;
        }
        
        searchTimeout = setTimeout(() => {
            performSearch(query);
        }, 300);
    });
    
    // Hide search results when clicking outside
    document.addEventListener('click', function(event) {
        if (!searchInput.contains(event.target) && !searchResults.contains(event.target)) {
            searchResults.style.display = 'none';
        }
    });
}

function performSearch(query) {
    // This would be implemented based on your search endpoints
    const searchResults = document.getElementById('searchResults');
    
    // Show loading state
    searchResults.innerHTML = '<div class="p-3 text-center"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
    searchResults.style.display = 'block';
    
    // Example AJAX call (customize based on your endpoints)
    $.ajax({
        url: '/api/search/',
        method: 'GET',
        data: { q: query },
        success: function(data) {
            displaySearchResults(data.results);
        },
        error: function() {
            searchResults.innerHTML = '<div class="p-3 text-muted">Search error occurred</div>';
        }
    });
}

function displaySearchResults(results) {
    const searchResults = document.getElementById('searchResults');
    
    if (!results || results.length === 0) {
        searchResults.innerHTML = '<div class="p-3 text-muted">No results found</div>';
        return;
    }
    
    let html = '';
    results.forEach(result => {
        html += `
            <a href="${result.url}" class="search-result-item">
                <i class="fas fa-${result.icon} text-${result.type}"></i>
                <div>
                    <div class="search-result-title">${result.title}</div>
                    <div class="search-result-description">${result.description}</div>
                </div>
            </a>
        `;
    });
    
    searchResults.innerHTML = html;
}

// Real-time notifications
function initializeNotifications() {
    // This would connect to your WebSocket or polling system
    // Example implementation for polling
    setInterval(checkForNewNotifications, 30000); // Check every 30 seconds
}

function checkForNewNotifications() {
    $.ajax({
        url: '/api/notifications/check/',
        method: 'GET',
        success: function(data) {
            if (data.new_count > 0) {
                updateNotificationBadge(data.new_count);
                showNotificationToast(data.latest_notification);
            }
        },
        error: function() {
            // Silently fail
        }
    });
}

function updateNotificationBadge(count) {
    const badge = document.querySelector('.notification-badge');
    if (badge) {
        badge.textContent = count;
        badge.style.display = count > 0 ? 'flex' : 'none';
    }
}

function showNotificationToast(notification) {
    // Create and show toast notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas fa-${notification.icon} text-${notification.type}"></i>
            <div>
                <div class="toast-title">${notification.title}</div>
                <div class="toast-message">${notification.message}</div>
            </div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeSearch();
    initializeNotifications();
});

// Keyboard shortcuts
document.addEventListener('keydown', function(event) {
    // Ctrl/Cmd + K for search
    if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
        event.preventDefault();
        const searchInput = document.getElementById('globalSearch');
        if (searchInput) {
            searchInput.focus();
        }
    }
    
    // ESC to close modals and dropdowns
    if (event.key === 'Escape') {
        // Close search results
        const searchResults = document.getElementById('searchResults');
        if (searchResults) {
            searchResults.style.display = 'none';
        }
        
        // Close dropdowns
        document.querySelectorAll('.nav-dropdown.open').forEach(dropdown => {
            dropdown.classList.remove('open');
        });
    }
});

// Print functionality
function printPage() {
    window.print();
}

function printElement(elementId) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Print</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    @media print {
                        body { margin: 0; padding: 20px; }
                        .no-print { display: none !important; }
                    }
                </style>
            </head>
            <body>
                ${element.outerHTML}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
    printWindow.close();
}

// Export functionality
function exportToCSV(tableId, filename = 'export.csv') {
    const table = document.getElementById(tableId);
    if (!table) return;
    
    let csv = [];
    const rows = table.querySelectorAll('tr');
    
    for (let i = 0; i < rows.length; i++) {
        const row = [];
        const cols = rows[i].querySelectorAll('td, th');
        
        for (let j = 0; j < cols.length; j++) {
            let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/(\s\s)/gm, ' ');
            data = data.replace(/"/g, '""');
            row.push('"' + data + '"');
        }
        csv.push(row.join(','));
    }
    
    const csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
    const downloadLink = document.createElement('a');
    downloadLink.download = filename;
    downloadLink.href = window.URL.createObjectURL(csvFile);
    downloadLink.style.display = 'none';
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
}

// Dark theme styles
const darkThemeStyles = `
<style id="dark-theme-styles">
.dark-theme {
    --gray-50: #1f2937;
    --gray-100: #374151;
    --gray-200: #4b5563;
    --gray-300: #6b7280;
    --gray-400: #9ca3af;
    --gray-500: #d1d5db;
    --gray-600: #e5e7eb;
    --gray-700: #f3f4f6;
    --gray-800: #f9fafb;
    --gray-900: #ffffff;
}

.dark-theme .sidebar {
    background: var(--gray-100);
    border-right-color: var(--gray-200);
}

.dark-theme .topbar {
    background: var(--gray-100);
    border-bottom-color: var(--gray-200);
}

.dark-theme .card {
    background: var(--gray-100);
    border-color: var(--gray-200);
}

.dark-theme .dropdown-menu {
    background: var(--gray-100);
    border-color: var(--gray-200);
}

.dark-theme .form-control,
.dark-theme .form-select {
    background: var(--gray-100);
    border-color: var(--gray-200);
    color: var(--gray-900);
}

.dark-theme .table {
    background: var(--gray-100);
}

.dark-theme .table thead th {
    background: var(--gray-200);
}
</style>
`;

// Inject dark theme styles
document.head.insertAdjacentHTML('beforeend', darkThemeStyles);
</script>