{% extends "base/base.html" %}
{% load static %}

{% block title %}Business Reports - {{ tenant.name }}{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.css" rel="stylesheet">
<style>
    .reports-container {
        background: #f8f9fa;
        min-height: 100vh;
        padding: 20px 0;
    }
    
    .filter-panel {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 25px;
        margin-bottom: 25px;
        border-left: 4px solid #3b82f6;
    }
    
    .report-content {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 30px;
    }
    
    .business-header {
        background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 25px;
        text-align: center;
    }
    
    .business-header h1 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: bold;
    }
    
    .business-header .subtitle {
        opacity: 0.9;
        font-size: 1.1rem;
        margin-top: 10px;
    }
    
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        transition: transform 0.2s ease;
    }
    
    .summary-card:hover {
        transform: translateY(-5px);
    }
    
    .summary-card.revenue {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    
    .summary-card.orders {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .summary-card.customers {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .summary-card.avg {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .summary-card.expense {
        background: linear-gradient(135deg, #ff7b7b 0%, #667eea 100%);
    }
    
    .summary-card.profit {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    .summary-card h3 {
        margin: 0;
        font-size: 2.2rem;
        font-weight: bold;
    }
    
    .summary-card p {
        margin: 10px 0 0;
        opacity: 0.9;
        font-size: 1rem;
    }
    
    .summary-card .icon {
        font-size: 2rem;
        margin-bottom: 15px;
        opacity: 0.8;
    }
    
    .data-table {
        overflow-x: auto;
        margin-top: 30px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }
    
    .table {
        margin-bottom: 0;
    }
    
    .table thead th {
        background: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .btn-download {
        margin-right: 10px;
        margin-bottom: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: none;
        padding: 10px 20px;
        font-weight: 600;
    }
    
    .btn-download:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .filter-form .form-control, .filter-form .form-select {
        border-radius: 8px;
        border: 1px solid #d1d5db;
        padding: 10px 15px;
    }
    
    .filter-form .form-control:focus, .filter-form .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
    }
    
    .filter-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        align-items: end;
    }
    
    .kenya-badge {
        display: inline-block;
        background: #006633;
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-left: 10px;
    }
    
    .currency {
        font-weight: 600;
        color: #059669;
    }
    
    .report-type-badge {
        background: #3b82f6;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        display: inline-block;
        margin-bottom: 20px;
    }
    
    .section-header {
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 15px;
        margin-bottom: 25px;
    }
    
    .section-header h4 {
        color: #1f2937;
        font-weight: 700;
        margin: 0;
    }
    
    .no-data {
        text-align: center;
        padding: 60px 20px;
        color: #6b7280;
    }
    
    .no-data i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
    }
    
    .signature-section {
        border-top: 2px solid #e5e7eb;
        padding-top: 30px;
        margin-top: 40px;
        page-break-inside: avoid;
    }
    
    .signature-box {
        padding: 20px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 20px;
        background: #f8f9fa;
    }
    
    .signature-box h6 {
        margin-bottom: 15px;
        color: #374151;
        font-weight: 600;
    }
    
    .signature-line {
        margin: 20px 0 15px;
        text-align: center;
    }
    
    .signature-line span {
        border-bottom: 2px solid #374151;
        padding-bottom: 5px;
        display: inline-block;
        width: 300px;
    }
    
    .report-footer {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 8px;
        margin-top: 30px;
        border-top: 3px solid #3b82f6 !important;
    }
    
    .footer-info p {
        color: #374151;
        font-size: 0.95rem;
    }
    
    .footer-branding h6 {
        color: #1f2937;
        font-weight: 700;
    }
    
    .footer-branding small {
        color: #6b7280;
        font-style: italic;
    }
    
    @media print {
        .signature-section {
            display: block !important;
        }
        
        .d-print-block {
            display: block !important;
        }
    }
    
    @media (max-width: 768px) {
        .summary-cards {
            grid-template-columns: 1fr;
        }
        
        .filter-section {
            grid-template-columns: 1fr;
        }
        
        .business-header h1 {
            font-size: 2rem;
        }
        
        .btn-download {
            width: 100%;
            margin-bottom: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="reports-container">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <!-- Business Header -->
                <div class="business-header">
                    <h1>
                        <i class="fas fa-chart-bar me-3"></i>
                        {{ tenant.name }} - Business Reports
                    </h1>
                    <div class="subtitle">
                        Professional Business Intelligence & Analytics
                        <span class="kenya-badge">
                            <i class="fas fa-flag me-1"></i>
                            Kenya
                        </span>
                    </div>
                </div>
                
                <!-- Filter Panel -->
                <div class="filter-panel">
                    <h5 class="mb-3">
                        <i class="fas fa-filter me-2"></i>
                        Report Filters
                    </h5>
                    <form method="get" class="filter-form">
                        <div class="filter-section">
                            <div>
                                <label class="form-label fw-bold">Report Type</label>
                                <select name="report_type" class="form-select" onchange="this.form.submit()">
                                    {% for value, label in report_types %}
                                        <option value="{{ value }}" {% if value == report_type %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div>
                                <label class="form-label fw-bold">Start Date</label>
                                <input type="date" name="start_date" class="form-control" 
                                       value="{{ start_date }}" onchange="this.form.submit()">
                            </div>
                            
                            <div>
                                <label class="form-label fw-bold">End Date</label>
                                <input type="date" name="end_date" class="form-control" 
                                       value="{{ end_date }}" onchange="this.form.submit()">
                            </div>
                            
                            {% if report_type == 'employee_performance' or report_type == 'individual_employee' %}
                            <div>
                                <label class="form-label fw-bold">Employee</label>
                                <select name="employee_id" class="form-select" onchange="this.form.submit()">
                                    {% if report_type == 'employee_performance' %}
                                        <option value="">All Employees</option>
                                    {% else %}
                                        <option value="">Select Employee</option>
                                    {% endif %}
                                    {% for employee in employees %}
                                        <option value="{{ employee.id }}" {% if employee.id|stringformat:"s" == employee_id %}selected{% endif %}>
                                            {{ employee.first_name }} {{ employee.last_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}
                            
                            {% if report_type == 'service_analysis' %}
                            <div>
                                <label class="form-label fw-bold">Service</label>
                                <select name="service_id" class="form-select" onchange="this.form.submit()">
                                    <option value="">All Services</option>
                                    {% for service in services %}
                                        <option value="{{ service.id }}" {% if service.id|stringformat:"s" == service_id %}selected{% endif %}>
                                            {{ service.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}
                            
                            {% if report_type == 'customer_analytics' %}
                            <div>
                                <label class="form-label fw-bold">Customer</label>
                                <select name="customer_id" class="form-select" onchange="this.form.submit()">
                                    <option value="">All Customers</option>
                                    {% for customer in customers %}
                                        <option value="{{ customer.id }}" {% if customer.id|stringformat:"s" == customer_id %}selected{% endif %}>
                                            {{ customer.first_name }} {{ customer.last_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}
                        </div>
                    </form>
                </div>
                
                <!-- Report Content -->
                <div class="report-content">
                    <!-- Report Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <span class="report-type-badge">{{ report_data.title }}</span>
                            <h2 class="mt-2 mb-1">{{ report_data.title }}</h2>
                            <p class="text-muted mb-0">
                                <i class="fas fa-calendar me-1"></i>
                                {{ report_data.period }}
                            </p>
                            <small class="text-muted">
                                Generated on {{ report_data.generated_at|date:"F d, Y \a\t g:i A" }}
                            </small>
                        </div>
                        
                        <!-- Download Buttons -->
                        {% if pdf_available or excel_available %}
                        <div class="download-buttons">
                            {% if pdf_available %}
                            <a href="/business/{{ request.tenant.slug }}/reports/download/{{ report_type }}/?start_date={{ start_date }}&end_date={{ end_date }}&format=pdf{% if employee_id %}&employee_id={{ employee_id }}{% endif %}{% if service_id %}&service_id={{ service_id }}{% endif %}{% if customer_id %}&customer_id={{ customer_id }}{% endif %}" 
                               class="btn btn-danger btn-download">
                                <i class="fas fa-file-pdf me-1"></i> Download PDF
                            </a>
                            {% endif %}
                            {% if excel_available %}
                            <a href="/business/{{ request.tenant.slug }}/reports/download/{{ report_type }}/?start_date={{ start_date }}&end_date={{ end_date }}&format=excel{% if employee_id %}&employee_id={{ employee_id }}{% endif %}{% if service_id %}&service_id={{ service_id }}{% endif %}{% if customer_id %}&customer_id={{ customer_id }}{% endif %}" 
                               class="btn btn-success btn-download">
                                <i class="fas fa-file-excel me-1"></i> Download Excel
                            </a>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Summary Cards -->
                    {% if report_data.summary %}
                    <div class="section-header">
                        <h4>
                            <i class="fas fa-chart-pie me-2"></i>
                            Executive Summary
                        </h4>
                    </div>
                    <div class="summary-cards">
                        {% for key, value in report_data.summary.items %}
                            <div class="summary-card {% if 'revenue' in key or 'amount' in key or 'sales' in key or 'inflow' in key %}revenue{% elif 'order' in key or 'count' in key %}orders{% elif 'customer' in key or 'employee' in key %}customers{% elif 'expense' in key or 'outflow' in key %}expense{% elif 'profit' in key %}profit{% else %}avg{% endif %}">
                                <div class="icon">
                                    {% if 'revenue' in key or 'sales' in key or 'inflow' in key %}
                                        <i class="fas fa-money-bill-wave"></i>
                                    {% elif 'expense' in key or 'outflow' in key %}
                                        <i class="fas fa-receipt"></i>
                                    {% elif 'profit' in key %}
                                        <i class="fas fa-chart-line"></i>
                                    {% elif 'order' in key %}
                                        <i class="fas fa-shopping-cart"></i>
                                    {% elif 'customer' in key %}
                                        <i class="fas fa-users"></i>
                                    {% elif 'employee' in key %}
                                        <i class="fas fa-user-tie"></i>
                                    {% elif 'rate' in key or 'percentage' in key %}
                                        <i class="fas fa-percentage"></i>
                                    {% else %}
                                        <i class="fas fa-chart-bar"></i>
                                    {% endif %}
                                </div>
                                <h3>
                                    {% if 'amount' in key or 'revenue' in key or 'sales' in key or 'expense' in key or 'profit' in key or 'value' in key or 'inflow' in key or 'outflow' in key %}
                                        <span class="currency">KES {{ value|floatformat:2 }}</span>
                                    {% elif 'rate' in key or 'percentage' in key or 'margin' in key %}
                                        {{ value|floatformat:1 }}%
                                    {% else %}
                                        {{ value|floatformat:0 }}
                                    {% endif %}
                                </h3>
                                <p>{{ key|title }}</p>
                            </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- Detailed Data Sections -->
                    {% if report_data.top_services %}
                    <div class="section-header">
                        <h4>
                            <i class="fas fa-star me-2"></i>
                            Top Performing Services
                        </h4>
                    </div>
                    <div class="data-table">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Service Name</th>
                                    <th>Orders</th>
                                    <th>Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for service in report_data.top_services|slice:":10" %}
                                <tr>
                                    <td>{{ service.service__name }}</td>
                                    <td>{{ service.count }}</td>
                                    <td class="currency">KES {{ service.revenue|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                    
                    {% if report_data.top_customers %}
                    <div class="section-header">
                        <h4>
                            <i class="fas fa-crown me-2"></i>
                            Top Customers
                        </h4>
                    </div>
                    <div class="data-table">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Period Spent</th>
                                    <th>Orders</th>
                                    <th>Last Order</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for customer in report_data.top_customers|slice:":10" %}
                                <tr>
                                    <td>{{ customer.first_name }} {{ customer.last_name }}</td>
                                    <td class="currency">KES {{ customer.period_spent|floatformat:2 }}</td>
                                    <td>{{ customer.order_count }}</td>
                                    <td>{{ customer.last_order|date:"M d, Y" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                    
                    {% if report_data.employee_performance %}
                    <div class="section-header">
                        <h4>
                            <i class="fas fa-user-tie me-2"></i>
                            Employee Performance
                        </h4>
                    </div>
                    <div class="data-table">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Employee</th>
                                    <th>Orders</th>
                                    <th>Revenue</th>
                                    <th>Avg Order Value</th>
                                    <th>Completion Rate</th>
                                    <th>Commission</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for emp in report_data.employee_performance|slice:":10" %}
                                <tr>
                                    <td>{{ emp.employee.first_name }} {{ emp.employee.last_name }}</td>
                                    <td>{{ emp.total_orders }}</td>
                                    <td class="currency">KES {{ emp.total_revenue|floatformat:2 }}</td>
                                    <td class="currency">KES {{ emp.avg_order_value|floatformat:2 }}</td>
                                    <td>{{ emp.completion_rate|floatformat:1 }}%</td>
                                    <td class="currency">KES {{ emp.total_commission|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                    
                    <!-- Individual Employee Detailed Report -->
                    {% if report_type == 'individual_employee' and report_data.employee_details %}
                    <div class="section-header">
                        <h4>
                            <i class="fas fa-user-circle me-2"></i>
                            Employee Details - {{ report_data.employee_details.name }}
                        </h4>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> Employee Information</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>Name:</strong> {{ report_data.employee_details.name }}</p>
                                    <p><strong>Email:</strong> {{ report_data.employee_details.email }}</p>
                                    <p><strong>Phone:</strong> {{ report_data.employee_details.phone }}</p>
                                    <p><strong>Department:</strong> {{ report_data.employee_details.department|default:"N/A" }}</p>
                                    <p><strong>Hire Date:</strong> {{ report_data.employee_details.hire_date|date:"M d, Y"|default:"N/A" }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-chart-bar"></i> Period Performance Summary</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>Total Orders:</strong> {{ report_data.employee_details.total_orders }}</p>
                                    <p><strong>Total Revenue:</strong> <span class="currency">KES {{ report_data.employee_details.total_revenue|floatformat:2 }}</span></p>
                                    <p><strong>Average Order Value:</strong> <span class="currency">KES {{ report_data.employee_details.avg_order_value|floatformat:2 }}</span></p>
                                    <p><strong>Completion Rate:</strong> {{ report_data.employee_details.completion_rate|floatformat:1 }}%</p>
                                    <p><strong>Total Commission:</strong> <span class="currency">KES {{ report_data.employee_details.total_commission|floatformat:2 }}</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Employee Service Breakdown -->
                    {% if report_data.employee_details.service_breakdown %}
                    <div class="section-header">
                        <h4>
                            <i class="fas fa-tools me-2"></i>
                            Service Breakdown
                        </h4>
                    </div>
                    <div class="data-table">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Service Name</th>
                                    <th>Category</th>
                                    <th>Orders Count</th>
                                    <th>Total Quantity</th>
                                    <th>Total Revenue</th>
                                    <th>Avg Revenue per Order</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for service in report_data.employee_details.service_breakdown %}
                                <tr>
                                    <td>{{ service.service_name }}</td>
                                    <td>{{ service.category|default:"N/A" }}</td>
                                    <td>{{ service.order_count }}</td>
                                    <td>{{ service.total_quantity }}</td>
                                    <td class="currency">KES {{ service.total_revenue|floatformat:2 }}</td>
                                    <td class="currency">KES {{ service.avg_revenue|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                    
                    <!-- Employee Daily Performance -->
                    {% if report_data.employee_details.daily_performance %}
                    <div class="section-header">
                        <h4>
                            <i class="fas fa-calendar-alt me-2"></i>
                            Daily Performance
                        </h4>
                    </div>
                    <div class="data-table">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Orders</th>
                                    <th>Revenue</th>
                                    <th>Performance Rating</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for day in report_data.employee_details.daily_performance %}
                                <tr>
                                    <td>{{ day.date|date:"M d, Y" }}</td>
                                    <td>{{ day.order_count }}</td>
                                    <td class="currency">KES {{ day.revenue|floatformat:2 }}</td>
                                    <td>
                                        {% if day.order_count >= 5 %}
                                            <span class="badge bg-success">Excellent</span>
                                        {% elif day.order_count >= 3 %}
                                            <span class="badge bg-warning">Good</span>
                                        {% elif day.order_count >= 1 %}
                                            <span class="badge bg-info">Average</span>
                                        {% else %}
                                            <span class="badge bg-secondary">No Activity</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                    
                    <!-- Employee Signature Section (for PDF downloads) -->
                    {% if report_type == 'individual_employee' %}
                    <div class="signature-section mt-5 d-print-block">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="signature-box">
                                    <h6>Employee Signature</h6>
                                    <div class="signature-line">
                                        <span>_________________________________</span>
                                    </div>
                                    <p class="mt-2 mb-0">{{ report_data.employee_details.name }}</p>
                                    <small class="text-muted">Date: ___________</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="signature-box">
                                    <h6>Supervisor Signature</h6>
                                    <div class="signature-line">
                                        <span>_________________________________</span>
                                    </div>
                                    <p class="mt-2 mb-0">Supervisor</p>
                                    <small class="text-muted">Date: ___________</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                    {% if report_data.category_breakdown %}
                    <div class="section-header">
                        <h4>
                            <i class="fas fa-chart-pie me-2"></i>
                            Category Breakdown
                        </h4>
                    </div>
                    <div class="data-table">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Amount</th>
                                    <th>Count</th>
                                    <th>Average</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in report_data.category_breakdown|slice:":10" %}
                                <tr>
                                    <td>{{ item.category__name|default:"Uncategorized" }}</td>
                                    <td class="currency">KES {{ item.amount|floatformat:2 }}</td>
                                    <td>{{ item.count }}</td>
                                    <td class="currency">KES {{ item.avg_amount|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                    
                    {% if report_data.daily_breakdown %}
                    <div class="section-header">
                        <h4>
                            <i class="fas fa-calendar-day me-2"></i>
                            Daily Breakdown
                        </h4>
                    </div>
                    <div class="data-table">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Orders</th>
                                    <th>Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for day in report_data.daily_breakdown|slice:":30" %}
                                <tr>
                                    <td>{{ day.date|date:"M d, Y" }}</td>
                                    <td>{{ day.orders }}</td>
                                    <td class="currency">KES {{ day.revenue|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                    
                    <!-- Enhanced Breakdowns for New Report Types -->
                    {% if report_data.detailed_breakdown %}
                    
                        <!-- Income Statement Breakdown -->
                        {% if report_data.revenue %}
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-chart-line"></i> Revenue Breakdown</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Service Revenue Breakdown</h6>
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Service</th>
                                                    <th>Count</th>
                                                    <th>Revenue</th>
                                                    <th>Avg Value</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for service in report_data.revenue.service_breakdown|slice:":10" %}
                                                <tr>
                                                    <td>{{ service.service__name }}</td>
                                                    <td>{{ service.count }}</td>
                                                    <td class="currency">KES {{ service.revenue|floatformat:2 }}</td>
                                                    <td class="currency">KES {{ service.avg_value|floatformat:2 }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Cost Breakdown</h6>
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Category</th>
                                                    <th>Type</th>
                                                    <th>Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for cost in report_data.costs.operating_expenses|slice:":10" %}
                                                <tr>
                                                    <td>{{ cost.category__name }}</td>
                                                    <td>{{ cost.expense_type }}</td>
                                                    <td class="currency">KES {{ cost.total|floatformat:2 }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Individual Employee Performance -->
                        {% if report_data.employee %}
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-user-tie"></i> {{ report_data.employee.name }} Performance</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <h6>Employee Info</h6>
                                        <p><strong>Position:</strong> {{ report_data.employee.position }}</p>
                                        <p><strong>Employee ID:</strong> {{ report_data.employee.employee_id }}</p>
                                    </div>
                                    <div class="col-md-8">
                                        <h6>Performance Metrics</h6>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="summary-card orders">
                                                    <h3>{{ report_data.performance.total_services }}</h3>
                                                    <p>Total Services</p>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="summary-card revenue">
                                                    <h3>{{ report_data.performance.completion_rate|floatformat:1 }}%</h3>
                                                    <p>Completion Rate</p>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="summary-card revenue">
                                                    <h3>KES {{ report_data.performance.revenue_generated|floatformat:2 }}</h3>
                                                    <p>Revenue Generated</p>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="summary-card profit">
                                                    <h3>{{ report_data.performance.average_rating|floatformat:1 }}</h3>
                                                    <p>Avg Rating</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Service Breakdown -->
                                {% if report_data.breakdown.service_breakdown %}
                                <div class="mt-4">
                                    <h6>Service Breakdown</h6>
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Service</th>
                                                <th>Count</th>
                                                <th>Revenue</th>
                                                <th>Avg Time</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for service in report_data.breakdown.service_breakdown %}
                                            <tr>
                                                <td>{{ service.service__name }}</td>
                                                <td>{{ service.count }}</td>
                                                <td class="currency">KES {{ service.revenue|floatformat:2 }}</td>
                                                <td>{{ service.avg_time|floatformat:0 }} min</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Period Summary Breakdowns -->
                        {% if report_data.period_type %}
                        <div class="row">
                            {% if report_data.business_overview %}
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="fas fa-building"></i> Business Overview</h6>
                                    </div>
                                    <div class="card-body">
                                        {% for key, value in report_data.business_overview.summary.items %}
                                        <div class="d-flex justify-content-between">
                                            <span>{{ key|title }}</span>
                                            <strong>
                                                {% if 'amount' in key or 'revenue' in key or 'profit' in key %}
                                                    KES {{ value|floatformat:2 }}
                                                {% else %}
                                                    {{ value }}
                                                {% endif %}
                                            </strong>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if report_data.sales_analysis %}
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="fas fa-chart-line"></i> Sales Analysis</h6>
                                    </div>
                                    <div class="card-body">
                                        {% for key, value in report_data.sales_analysis.summary.items %}
                                        <div class="d-flex justify-content-between">
                                            <span>{{ key|title }}</span>
                                            <strong>
                                                {% if 'amount' in key or 'revenue' in key or 'sales' in key %}
                                                    KES {{ value|floatformat:2 }}
                                                {% else %}
                                                    {{ value }}
                                                {% endif %}
                                            </strong>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if report_data.financial_summary %}
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="fas fa-money-bill-wave"></i> Financial Summary</h6>
                                    </div>
                                    <div class="card-body">
                                        {% for key, value in report_data.financial_summary.summary.items %}
                                        <div class="d-flex justify-content-between">
                                            <span>{{ key|title }}</span>
                                            <strong>
                                                {% if 'amount' in key or 'revenue' in key or 'profit' in key %}
                                                    KES {{ value|floatformat:2 }}
                                                {% else %}
                                                    {{ value }}
                                                {% endif %}
                                            </strong>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    
                    {% endif %}
                    
                    <!-- Detailed Data Lists - Added for comprehensive reporting -->
                    
                    <!-- Detailed Payments List -->
                    {% if report_data.detailed_payments %}
                    <div class="section-header">
                        <h4>
                            <i class="fas fa-money-bill-wave me-2"></i>
                            Detailed Payments
                        </h4>
                    </div>
                    <div class="data-table">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Payment Method</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Reference</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in report_data.detailed_payments|slice:":20" %}
                                <tr>
                                    <td>{{ payment.created_at|date:"M d, Y g:i A" }}</td>
                                    <td>{{ payment.service_order.customer.first_name }} {{ payment.service_order.customer.last_name }}</td>
                                    <td>{{ payment.method }}</td>
                                    <td class="currency">KES {{ payment.amount|floatformat:2 }}</td>
                                    <td>
                                        <span class="badge {% if payment.status == 'completed' %}bg-success{% elif payment.status == 'pending' %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ payment.status|capfirst }}
                                        </span>
                                    </td>
                                    <td>{{ payment.transaction_ref|default:"N/A" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if report_data.detailed_payments|length > 20 %}
                        <div class="text-center mt-3">
                            <small class="text-muted">Showing first 20 of {{ report_data.detailed_payments|length }} total payments</small>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Detailed Service Orders List -->
                    {% if report_data.detailed_orders %}
                    <div class="section-header">
                        <h4>
                            <i class="fas fa-clipboard-list me-2"></i>
                            Detailed Service Orders
                        </h4>
                    </div>
                    <div class="data-table">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Order #</th>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Service</th>
                                    <th>Employee</th>
                                    <th>Status</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in report_data.detailed_orders|slice:":20" %}
                                <tr>
                                    <td>#{{ order.id }}</td>
                                    <td>{{ order.created_at|date:"M d, Y g:i A" }}</td>
                                    <td>{{ order.customer.first_name }} {{ order.customer.last_name }}</td>
                                    <td>{{ order.service.name }}</td>
                                    <td>{{ order.assigned_attendant.first_name|default:"Unassigned" }} {{ order.assigned_attendant.last_name|default:"" }}</td>
                                    <td>
                                        <span class="badge {% if order.status == 'completed' %}bg-success{% elif order.status == 'in_progress' %}bg-info{% elif order.status == 'pending' %}bg-warning{% else %}bg-secondary{% endif %}">
                                            {{ order.status|capfirst }}
                                        </span>
                                    </td>
                                    <td class="currency">KES {{ order.total_price|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if report_data.detailed_orders|length > 20 %}
                        <div class="text-center mt-3">
                            <small class="text-muted">Showing first 20 of {{ report_data.detailed_orders|length }} total orders</small>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Detailed Customers List -->
                    {% if report_data.detailed_customers %}
                    <div class="section-header">
                        <h4>
                            <i class="fas fa-users me-2"></i>
                            Detailed Customer Activity
                        </h4>
                    </div>
                    <div class="data-table">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Total Orders</th>
                                    <th>Total Spent</th>
                                    <th>Last Order</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for customer in report_data.detailed_customers|slice:":20" %}
                                <tr>
                                    <td>{{ customer.first_name }} {{ customer.last_name }}</td>
                                    <td>{{ customer.email|default:"N/A" }}</td>
                                    <td>{{ customer.phone_number|default:"N/A" }}</td>
                                    <td>{{ customer.order_count }}</td>
                                    <td class="currency">KES {{ customer.total_spent|floatformat:2 }}</td>
                                    <td>{{ customer.last_order|date:"M d, Y"|default:"Never" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if report_data.detailed_customers|length > 20 %}
                        <div class="text-center mt-3">
                            <small class="text-muted">Showing first 20 of {{ report_data.detailed_customers|length }} total customers</small>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Detailed Expenses List -->
                    {% if report_data.detailed_expenses %}
                    <div class="section-header">
                        <h4>
                            <i class="fas fa-receipt me-2"></i>
                            Detailed Expenses
                        </h4>
                    </div>
                    <div class="data-table">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Category</th>
                                    <th>Employee</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for expense in report_data.detailed_expenses|slice:":20" %}
                                <tr>
                                    <td>{{ expense.date|date:"M d, Y" }}</td>
                                    <td>{{ expense.description }}</td>
                                    <td>{{ expense.category.name|default:"Uncategorized" }}</td>
                                    <td>{{ expense.employee.first_name|default:"N/A" }} {{ expense.employee.last_name|default:"" }}</td>
                                    <td class="currency">KES {{ expense.amount|floatformat:2 }}</td>
                                    <td>
                                        <span class="badge {% if expense.status == 'approved' %}bg-success{% elif expense.status == 'pending' %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ expense.status|capfirst }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if report_data.detailed_expenses|length > 20 %}
                        <div class="text-center mt-3">
                            <small class="text-muted">Showing first 20 of {{ report_data.detailed_expenses|length }} total expenses</small>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Detailed Inventory Items List -->
                    {% if report_data.detailed_inventory %}
                    <div class="section-header">
                        <h4>
                            <i class="fas fa-boxes me-2"></i>
                            Detailed Inventory Movement
                        </h4>
                    </div>
                    <div class="data-table">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Category</th>
                                    <th>Stock In</th>
                                    <th>Stock Out</th>
                                    <th>Current Stock</th>
                                    <th>Unit Value</th>
                                    <th>Total Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in report_data.detailed_inventory|slice:":20" %}
                                <tr>
                                    <td>{{ item.name }}</td>
                                    <td>{{ item.category.name|default:"Uncategorized" }}</td>
                                    <td>{{ item.stock_in|default:0 }}</td>
                                    <td>{{ item.stock_out|default:0 }}</td>
                                    <td>{{ item.current_stock }}</td>
                                    <td class="currency">KES {{ item.base_price|floatformat:2 }}</td>
                                    <td class="currency">KES {{ item.total_value|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if report_data.detailed_inventory|length > 20 %}
                        <div class="text-center mt-3">
                            <small class="text-muted">Showing first 20 of {{ report_data.detailed_inventory|length }} total items</small>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Enhanced Report Footer with Professional Formatting -->
                    {% if report_data %}
                    <div class="report-footer mt-5 pt-4 border-top">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="footer-info">
                                    <p class="mb-1">
                                        <strong>Report Generated:</strong> {{ report_data.generated_at|date:"F d, Y \a\t g:i A" }}
                                    </p>
                                    <p class="mb-1">
                                        <strong>Report Period:</strong> {{ start_date|date:"M d, Y" }} - {{ end_date|date:"M d, Y" }}
                                    </p>
                                    <p class="mb-0">
                                        <strong>Generated by:</strong> AutoWash Business Management System
                                    </p>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="footer-branding">
                                    <h6 class="mb-1">{{ tenant.name }}</h6>
                                    <small class="text-muted">Business Reports</small>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12 text-center">
                                <small class="text-muted">
                                     {{ "now"|date:"Y" }} {{ tenant.name }}. All rights reserved.
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Inventory Items Report -->
                    {% if report_data.breakdown.item_details %}
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-boxes"></i> Inventory Items Details</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Item Name</th>
                                            <th>Stock Status</th>
                                            <th>In</th>
                                            <th>Out</th>
                                            <th>Net Movement</th>
                                            <th>Current Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item_stat in report_data.breakdown.item_details|slice:":20" %}
                                        <tr>
                                            <td>{{ item_stat.item.name }}</td>
                                            <td>
                                                <span class="badge {% if item_stat.stock_status == 'Out of Stock' %}bg-danger{% elif item_stat.stock_status == 'Low Stock' %}bg-warning{% else %}bg-success{% endif %}">
                                                    {{ item_stat.stock_status }}
                                                </span>
                                            </td>
                                            <td>{{ item_stat.transactions_in }}</td>
                                            <td>{{ item_stat.transactions_out }}</td>
                                            <td>{{ item_stat.net_movement }}</td>
                                            <td class="currency">KES {{ item_stat.current_value|floatformat:2 }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Service List Report -->
                    {% if report_data.breakdown.service_details %}
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-cogs"></i> Service Performance Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Service Name</th>
                                            <th>Category</th>
                                            <th>Usage Count</th>
                                            <th>Revenue</th>
                                            <th>Avg Price</th>
                                            <th>Popularity Rank</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for service_stat in report_data.breakdown.service_details|slice:":15" %}
                                        <tr>
                                            <td>{{ service_stat.service.name }}</td>
                                            <td>{{ service_stat.category }}</td>
                                            <td>{{ service_stat.usage_count }}</td>
                                            <td class="currency">KES {{ service_stat.revenue|floatformat:2 }}</td>
                                            <td class="currency">KES {{ service_stat.avg_price|floatformat:2 }}</td>
                                            <td>
                                                <span class="badge {% if service_stat.popularity_rank <= 3 %}bg-success{% elif service_stat.popularity_rank <= 7 %}bg-warning{% else %}bg-secondary{% endif %}">
                                                    #{{ service_stat.popularity_rank }}
                                                </span>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Vehicle Analysis Report -->
                    {% if report_data.breakdown.vehicle_details %}
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-car"></i> Vehicle Performance Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Vehicle</th>
                                            <th>Owner</th>
                                            <th>Total Orders</th>
                                            <th>Total Revenue</th>
                                            <th>Avg Order Value</th>
                                            <th>Last Service</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for vehicle_stat in report_data.breakdown.vehicle_details|slice:":20" %}
                                        <tr>
                                            <td>{{ vehicle_stat.vehicle.make }} {{ vehicle_stat.vehicle.model }} - {{ vehicle_stat.vehicle.plate_number }}</td>
                                            <td>{{ vehicle_stat.owner.first_name }} {{ vehicle_stat.owner.last_name }}</td>
                                            <td>{{ vehicle_stat.total_orders }}</td>
                                            <td class="currency">KES {{ vehicle_stat.total_revenue|floatformat:2 }}</td>
                                            <td class="currency">KES {{ vehicle_stat.avg_order_value|floatformat:2 }}</td>
                                            <td>{{ vehicle_stat.last_service.created_at|date:"M d, Y" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Payment Methods Report -->
                    {% if report_data.breakdown.payment_method_breakdown %}
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-credit-card"></i> Payment Method Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Payment Method</th>
                                            <th>Transaction Count</th>
                                            <th>Total Amount</th>
                                            <th>Average Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for payment in report_data.breakdown.payment_method_breakdown %}
                                        <tr>
                                            <td>
                                                <i class="fas {% if payment.payment_method == 'mpesa' %}fa-mobile-alt text-success{% elif payment.payment_method == 'cash' %}fa-money-bill text-info{% elif payment.payment_method == 'card' %}fa-credit-card text-primary{% else %}fa-wallet text-secondary{% endif %} me-2"></i>
                                                {{ payment.payment_method|title }}
                                            </td>
                                            <td>{{ payment.transaction_count }}</td>
                                            <td class="currency">KES {{ payment.total_amount|floatformat:2 }}</td>
                                            <td class="currency">KES {{ payment.avg_amount|floatformat:2 }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Employee Attendance & Productivity Report -->
                    {% if report_data.breakdown.employee_performance %}
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-users"></i> Employee Performance Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Employee</th>
                                            <th>Orders</th>
                                            <th>Completion Rate</th>
                                            <th>Revenue</th>
                                            <th>Avg Rating</th>
                                            <th>Avg Time (min)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for emp_stat in report_data.breakdown.employee_performance|slice:":10" %}
                                        <tr>
                                            <td>{{ emp_stat.employee.first_name }} {{ emp_stat.employee.last_name }}</td>
                                            <td>{{ emp_stat.total_orders }}</td>
                                            <td>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar {% if emp_stat.completion_rate >= 90 %}bg-success{% elif emp_stat.completion_rate >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                         role="progressbar" style="width: {{ emp_stat.completion_rate }}%">
                                                        {{ emp_stat.completion_rate|floatformat:1 }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="currency">KES {{ emp_stat.total_revenue|floatformat:2 }}</td>
                                            <td>
                                                {% if emp_stat.avg_rating %}
                                                    <span class="text-warning">
                                                        {% for i in "12345" %}
                                                            {% if forloop.counter <= emp_stat.avg_rating %}
                                                                <i class="fas fa-star"></i>
                                                            {% else %}
                                                                <i class="far fa-star"></i>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </span>
                                                    {{ emp_stat.avg_rating|floatformat:1 }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </td>
                                            <td>{{ emp_stat.avg_completion_time_minutes|default:"N/A" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- No Data Message -->
                    {% if not report_data.summary and not report_data.top_services and not report_data.employee_performance %}
                    <div class="no-data">
                        <i class="fas fa-chart-line"></i>
                        <h5>No Data Available</h5>
                        <p>No data found for the selected date range and filters.<br>
                        Try adjusting your filters or date range to see results.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
    // Auto-refresh functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Add loading states to download buttons
        document.querySelectorAll('.btn-download').forEach(button => {
            button.addEventListener('click', function() {
                const icon = this.querySelector('i');
                const originalClass = icon.className;
                icon.className = 'fas fa-spinner fa-spin me-1';
                
                setTimeout(() => {
                    icon.className = originalClass;
                }, 3000);
            });
        });
        
        // Enhanced form submissions with loading states
        document.querySelectorAll('select[onchange]').forEach(select => {
            select.addEventListener('change', function() {
                const form = this.closest('form');
                const button = document.createElement('div');
                button.className = 'text-center mt-3';
                button.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
                form.appendChild(button);
            });
        });
    });
</script>
{% endblock %}
