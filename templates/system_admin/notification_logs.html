{% extends "system_admin/base.html" %}
{% load static %}

{% block title %}Notification Logs{% endblock %}

{% block extra_css %}
<link href="{% static 'css/dashboard.css' %}" rel="stylesheet">
<style>
.filter-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.logs-table {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    overflow: hidden;
}

.table th {
    background: #f8f9fa;
    border: none;
    font-weight: 600;
    color: #495057;
    padding: 1rem;
}

.table td {
    padding: 1rem;
    vertical-align: middle;
    border-color: #e9ecef;
}

.status-badge {
    padding: 0.375rem 0.75rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-sent {
    background: #d4edda;
    color: #155724;
}

.status-failed {
    background: #f8d7da;
    color: #721c24;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.status-bounced {
    background: #ffeaa7;
    color: #6c5700;
}

.type-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 500;
    text-transform: uppercase;
}

.type-email {
    background: #e7f3ff;
    color: #0066cc;
}

.type-sms {
    background: #e8f5e8;
    color: #2d5a2d;
}

.notification-content {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.tenant-badge {
    background: #f1f3f4;
    color: #5f6368;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    text-decoration: none;
}

.tenant-badge:hover {
    background: #e8eaed;
    color: #202124;
    text-decoration: none;
}

.action-buttons .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.stats-card .stats-number {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.stats-card .stats-label {
    opacity: 0.9;
    font-size: 0.9rem;
}

.export-button {
    background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: 600;
}

.stats-success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.stats-failed {
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
}

.stats-delivery {
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-2">üìä Notification Logs</h1>
            <p class="text-muted mb-0">Monitor and analyze all notification activities</p>
        </div>
        <div>
            <a href="{% url 'system_admin:notification_management' %}" class="btn btn-outline-primary me-2">
                <i class="fas fa-arrow-left"></i> Back to Management
            </a>
            <button class="btn export-button" onclick="exportLogs()">
                <i class="fas fa-download"></i> Export Logs
            </button>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="stats-card">
                <div class="stats-number">{{ total_notifications|default:"0" }}</div>
                <div class="stats-label">Total Notifications</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stats-card stats-success">
                <div class="stats-number">{{ success_rate|default:"0" }}%</div>
                <div class="stats-label">Success Rate</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stats-card stats-failed">
                <div class="stats-number">{{ failed_notifications|default:"0" }}</div>
                <div class="stats-label">Failed Today</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stats-card stats-delivery">
                <div class="stats-number">{{ avg_delivery_time|default:"0" }}s</div>
                <div class="stats-label">Avg Delivery Time</div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-card">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label for="date_from" class="form-label">From Date</label>
                <input type="date" class="form-control" id="date_from" name="date_from" 
                       value="{{ request.GET.date_from }}">
            </div>
            <div class="col-md-3">
                <label for="date_to" class="form-label">To Date</label>
                <input type="date" class="form-control" id="date_to" name="date_to" 
                       value="{{ request.GET.date_to }}">
            </div>
            <div class="col-md-2">
                <label for="type" class="form-label">Type</label>
                <select class="form-select" id="type" name="type">
                    <option value="">All Types</option>
                    <option value="email" {% if request.GET.type == 'email' %}selected{% endif %}>Email</option>
                    <option value="sms" {% if request.GET.type == 'sms' %}selected{% endif %}>SMS</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="status" class="form-label">Status</label>
                <select class="form-select" id="status" name="status">
                    <option value="">All Status</option>
                    <option value="sent" {% if request.GET.status == 'sent' %}selected{% endif %}>Sent</option>
                    <option value="failed" {% if request.GET.status == 'failed' %}selected{% endif %}>Failed</option>
                    <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="bounced" {% if request.GET.status == 'bounced' %}selected{% endif %}>Bounced</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-filter"></i> Filter
                </button>
                <a href="{% url 'system_admin:notification_logs' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> Clear
                </a>
            </div>
        </form>
    </div>

    <!-- Notification Logs Table -->
    <div class="logs-table">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Type</th>
                        <th>Recipient</th>
                        <th>Subject/Content</th>
                        <th>Tenant</th>
                        <th>Status</th>
                        <th>Delivery Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in notification_logs %}
                    <tr>
                        <td>
                            <div class="fw-bold">{{ log.created_at|date:"M d, Y" }}</div>
                            <small class="text-muted">{{ log.created_at|time:"H:i:s" }}</small>
                        </td>
                        <td>
                            <span class="type-badge type-{{ log.type }}">
                                {{ log.type|upper }}
                            </span>
                        </td>
                        <td>
                            <div class="fw-bold">{{ log.recipient_name|default:"Unknown" }}</div>
                            <small class="text-muted">{{ log.recipient_email|default:log.recipient_phone }}</small>
                        </td>
                        <td>
                            <div class="notification-content" title="{{ log.subject|default:log.content }}">
                                {{ log.subject|default:log.content|truncatechars:50 }}
                            </div>
                        </td>
                        <td>
                            {% if log.tenant %}
                                <a href="/business/{{ log.tenant.slug }}/services/dashboard/" 
                                   class="tenant-badge" title="View {{ log.tenant.name }} dashboard">
                                    {{ log.tenant.name|truncatechars:15 }}
                                </a>
                            {% else %}
                                <span class="tenant-badge">System</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="status-badge status-{{ log.status }}">
                                {% if log.status == 'sent' %}‚úì Sent
                                {% elif log.status == 'failed' %}‚úó Failed
                                {% elif log.status == 'pending' %}‚è≥ Pending
                                {% elif log.status == 'bounced' %}‚Ü© Bounced
                                {% else %}{{ log.status|title }}
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            {% if log.delivery_time %}
                                {{ log.delivery_time }}s
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-outline-info btn-sm" 
                                        onclick="viewDetails('{{ log.id }}')" 
                                        title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if log.status == 'failed' %}
                                <button class="btn btn-outline-warning btn-sm" 
                                        onclick="retryNotification('{{ log.id }}')" 
                                        title="Retry">
                                    <i class="fas fa-redo"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-danger btn-sm" 
                                        onclick="deleteLog('{{ log.id }}')" 
                                        title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <div class="text-muted">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <p class="mb-0">No notification logs found</p>
                                <small>Try adjusting your filters or check back later</small>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if is_paginated %}
        <div class="d-flex justify-content-between align-items-center p-3 border-top">
            <div class="text-muted">
                Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ paginator.count }} logs
            </div>
            <nav aria-label="Page navigation">
                <ul class="pagination mb-0">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">First</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">Previous</a>
                        </li>
                    {% endif %}
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">Next</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ paginator.num_pages }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}">Last</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<!-- View Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Notification Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="notificationDetails">
                <!-- Details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function viewDetails(logId) {
    // Simulate loading notification details
    const details = `
        <div class="row">
            <div class="col-md-6">
                <h6>Notification Information</h6>
                <table class="table table-sm">
                    <tr><th>ID:</th><td>${logId}</td></tr>
                    <tr><th>Type:</th><td>Email</td></tr>
                    <tr><th>Status:</th><td><span class="status-badge status-sent">‚úì Sent</span></td></tr>
                    <tr><th>Created:</th><td>Dec 15, 2024 14:30:25</td></tr>
                    <tr><th>Delivered:</th><td>Dec 15, 2024 14:30:28</td></tr>
                    <tr><th>Delivery Time:</th><td>3.2 seconds</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Recipient Information</h6>
                <table class="table table-sm">
                    <tr><th>Name:</th><td>John Doe</td></tr>
                    <tr><th>Email:</th><td>john.doe@example.com</td></tr>
                    <tr><th>Tenant:</th><td>Sparkle Car Wash</td></tr>
                    <tr><th>User Type:</th><td>Customer</td></tr>
                </table>
            </div>
        </div>
        <div class="mt-3">
            <h6>Message Content</h6>
            <div class="border rounded p-3 bg-light">
                <strong>Subject:</strong> Your car wash service has been completed<br><br>
                <strong>Content:</strong> Dear John, your vehicle cleaning service at Sparkle Car Wash has been completed. Thank you for choosing our services!
            </div>
        </div>
        <div class="mt-3">
            <h6>Technical Details</h6>
            <div class="border rounded p-3 bg-light">
                <small>
                    <strong>Message ID:</strong> msg_${logId}_${Date.now()}<br>
                    <strong>Provider:</strong> SMTP (smtp.gmail.com)<br>
                    <strong>Response:</strong> 250 2.0.0 OK Message accepted<br>
                    <strong>Attempts:</strong> 1/3
                </small>
            </div>
        </div>
    `;
    
    document.getElementById('notificationDetails').innerHTML = details;
    new bootstrap.Modal(document.getElementById('detailsModal')).show();
}

function retryNotification(logId) {
    if (confirm('Are you sure you want to retry this notification?')) {
        // Simulate retry
        const button = event.target.closest('button');
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;
        
        setTimeout(function() {
            alert('‚úÖ Notification retry initiated successfully!');
            location.reload();
        }, 1000);
    }
}

function deleteLog(logId) {
    if (confirm('Are you sure you want to delete this log entry? This action cannot be undone.')) {
        // Simulate deletion
        const row = event.target.closest('tr');
        row.style.opacity = '0.5';
        
        setTimeout(function() {
            row.remove();
            alert('‚úÖ Log entry deleted successfully!');
        }, 500);
    }
}

function exportLogs() {
    // Simulate export
    const button = document.querySelector('.export-button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
    button.disabled = true;
    
    setTimeout(function() {
        // Create a dummy CSV content
        const csvContent = "data:text/csv;charset=utf-8," + 
            "Timestamp,Type,Recipient,Subject,Tenant,Status,Delivery Time\n" +
            "2024-12-15 14:30:25,Email,john@example.com,Service Complete,Sparkle Car Wash,Sent,3.2s\n" +
            "2024-12-15 14:25:10,SMS,+1234567890,Order Confirmation,Quick Wash,Sent,1.8s\n";
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `notification_logs_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        button.innerHTML = originalText;
        button.disabled = false;
        
        alert('‚úÖ Logs exported successfully!');
    }, 2000);
}

// Auto-refresh functionality
let autoRefresh = false;
let refreshInterval;

function toggleAutoRefresh() {
    autoRefresh = !autoRefresh;
    const button = document.getElementById('autoRefreshBtn');
    
    if (autoRefresh) {
        button.innerHTML = '<i class="fas fa-pause"></i> Stop Auto-refresh';
        button.classList.remove('btn-outline-info');
        button.classList.add('btn-warning');
        
        refreshInterval = setInterval(function() {
            location.reload();
        }, 30000); // Refresh every 30 seconds
    } else {
        button.innerHTML = '<i class="fas fa-sync"></i> Auto-refresh';
        button.classList.remove('btn-warning');
        button.classList.add('btn-outline-info');
        
        clearInterval(refreshInterval);
    }
}

// Add auto-refresh button to header
$(document).ready(function() {
    const autoRefreshBtn = '<button id="autoRefreshBtn" class="btn btn-outline-info btn-sm me-2" onclick="toggleAutoRefresh()">' +
                          '<i class="fas fa-sync"></i> Auto-refresh</button>';
    $('.d-flex.justify-content-between.align-items-center.mb-4 .btn.export-button').before(autoRefreshBtn);
});
</script>
{% endblock %}
