{% extends 'base/base.html' %}
{% load static %}

{% block title %}Backup & Export - {{ business.name }}{% endblock %}

{% block extra_css %}
<style>
    .settings-form {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 30px;
    }
    
    .form-section {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
    }
    
    .form-section:last-child {
        border-bottom: none;
    }
    
    .section-title {
        color: #333;
        margin-bottom: 15px;
        font-weight: 600;
    }
    
    .help-text {
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .backup-item {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.2s ease;
    }
    
    .backup-item:hover {
        border-color: #007bff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .backup-status {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-completed {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-processing {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-failed {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .create-backup-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .format-option {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .format-option:hover {
        border-color: #007bff;
    }
    
    .format-option.selected {
        border-color: #007bff;
        background-color: #e3f2fd;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb bg-transparent p-0 m-0">
                <li class="breadcrumb-item"><a href="/business/{{ request.tenant.slug }}/business/settings/">Settings</a></li>
                <li class="breadcrumb-item active">Backup & Export</li>
            </ol>
        </nav>
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-download mr-2"></i>Backup & Export
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Create New Backup -->
        <div class="create-backup-section">
            <h5><i class="fas fa-plus mr-2"></i>Create New Backup</h5>
            <p class="text-muted">Create a backup of your business data for safekeeping or migration.</p>
            
            <form id="createBackupForm">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-6">
                        <label>Backup Type</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="backup_type" id="full_backup" value="full" checked>
                            <label class="form-check-label" for="full_backup">
                                <strong>Full Backup</strong><br>
                                <small class="text-muted">All business data including customers, services, payments, etc.</small>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="backup_type" id="partial_backup" value="partial">
                            <label class="form-check-label" for="partial_backup">
                                <strong>Partial Backup</strong><br>
                                <small class="text-muted">Select specific data tables to backup</small>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label>Export Format</label>
                        <div class="format-option" data-format="sql">
                            <input type="radio" name="backup_format" value="sql" checked>
                            <strong>SQL Database</strong><br>
                            <small class="text-muted">Raw database backup for migration</small>
                        </div>
                        <div class="format-option" data-format="json">
                            <input type="radio" name="backup_format" value="json">
                            <strong>JSON Export</strong><br>
                            <small class="text-muted">Structured data for analysis</small>
                        </div>
                        <div class="format-option" data-format="excel">
                            <input type="radio" name="backup_format" value="excel">
                            <strong>Excel Spreadsheet</strong><br>
                            <small class="text-muted">Easy viewing and editing</small>
                        </div>
                        <div class="format-option" data-format="csv">
                            <input type="radio" name="backup_format" value="csv">
                            <strong>CSV Files</strong><br>
                            <small class="text-muted">Comma-separated values</small>
                        </div>
                    </div>
                </div>
                
                <!-- Partial Backup Options (hidden by default) -->
                <div id="partialOptions" style="display: none;">
                    <h6>Select Data to Backup:</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="tables" value="customers" id="table_customers" checked>
                                <label class="form-check-label" for="table_customers">Customers</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="tables" value="services" id="table_services" checked>
                                <label class="form-check-label" for="table_services">Services</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="tables" value="bookings" id="table_bookings" checked>
                                <label class="form-check-label" for="table_bookings">Bookings</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="tables" value="payments" id="table_payments" checked>
                                <label class="form-check-label" for="table_payments">Payments</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="tables" value="inventory" id="table_inventory">
                                <label class="form-check-label" for="table_inventory">Inventory</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="tables" value="employees" id="table_employees">
                                <label class="form-check-label" for="table_employees">Employees</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Email Options -->
                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" name="email_backup" id="email_backup">
                    <label class="form-check-label" for="email_backup">
                        Email backup to me
                    </label>
                </div>
                <div id="emailOptions" style="display: none;" class="mt-2">
                    <input type="email" class="form-control" name="email_address" placeholder="Enter email address">
                </div>
                
                <button type="submit" class="btn btn-primary mt-3">
                    <i class="fas fa-download mr-1"></i>Create Backup
                </button>
            </form>
        </div>

        <!-- Backup Settings -->
        <form method="post" class="settings-form">
            {% csrf_token %}
            <input type="hidden" name="backup_settings" value="1">
            
            <div class="form-section">
                <h5 class="section-title">
                    <i class="fas fa-cog mr-2"></i>Automatic Backup Settings
                </h5>
                
                <div class="form-check mb-3">
                    {{ form.auto_backup_enabled }}
                    <label class="form-check-label" for="{{ form.auto_backup_enabled.id_for_label }}">
                        Enable Automatic Backups
                    </label>
                    <small class="help-text d-block">Automatically create backups on a regular schedule</small>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.backup_frequency.id_for_label }}">Backup Frequency</label>
                            {{ form.backup_frequency }}
                            <small class="help-text">How often to create automatic backups</small>
                            {% if form.backup_frequency.errors %}
                                <div class="invalid-feedback d-block">{{ form.backup_frequency.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="{{ form.backup_retention_days.id_for_label }}">Retention Period (Days)</label>
                            {{ form.backup_retention_days }}
                            <small class="help-text">How long to keep automatic backups</small>
                            {% if form.backup_retention_days.errors %}
                                <div class="invalid-feedback d-block">{{ form.backup_retention_days.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.backup_email.id_for_label }}">Backup Notification Email</label>
                    {{ form.backup_email }}
                    <small class="help-text">Email address to notify when automatic backups complete</small>
                    {% if form.backup_email.errors %}
                        <div class="invalid-feedback d-block">{{ form.backup_email.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="d-flex justify-content-between">
                <a href="/business/{{ request.tenant.slug }}/business/settings/" class="btn btn-secondary">
                    <i class="fas fa-arrow-left mr-1"></i>Back to Settings
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save mr-1"></i>Save Backup Settings
                </button>
            </div>
        </form>

        <!-- Recent Backups -->
        <div class="settings-form mt-4">
            <h5><i class="fas fa-history mr-2"></i>Recent Backups</h5>
            {% for backup in recent_backups %}
            <div class="backup-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <strong>{{ backup.backup_type|title }} Backup</strong>
                            <span class="backup-status status-{{ backup.status }} ml-2">{{ backup.status }}</span>
                        </div>
                        <div class="small text-muted">
                            <i class="fas fa-file-archive mr-1"></i>{{ backup.file_size_formatted }}
                            <i class="fas fa-calendar ml-3 mr-1"></i>{{ backup.created_at|date:"M d, Y H:i" }}
                            <i class="fas fa-file-code ml-3 mr-1"></i>{{ backup.backup_format|upper }}
                        </div>
                    </div>
                    <div class="ml-3">
                        {% if backup.status == 'completed' %}
                        <a href="/business/{{ request.tenant.slug }}/business/settings/api/backup/{{ backup.backup_id }}/download/" class="btn btn-sm btn-outline-primary" title="Download backup">
                            <i class="fas fa-download"></i>
                        </a>
                        <button class="btn btn-sm btn-outline-danger ml-2" onclick="deleteBackup('{{ backup.backup_id }}')" title="Delete backup">
                            <i class="fas fa-trash"></i>
                        </button>
                        {% elif backup.status == 'processing' %}
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="sr-only">Processing...</span>
                        </div>
                        {% else %}
                        <span class="text-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-4">
                <i class="fas fa-archive text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-2">No backups created yet</p>
                <p class="small text-muted">Create your first backup using the form above</p>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0"><i class="fas fa-info mr-2"></i>Backup Information</h6>
            </div>
            <div class="card-body">
                <h6>Backup Types</h6>
                <p class="small text-muted"><strong>Full:</strong> Complete business data backup</p>
                <p class="small text-muted"><strong>Partial:</strong> Selected data only</p>
                
                <h6>Export Formats</h6>
                <p class="small text-muted"><strong>SQL:</strong> Direct database backup for migration</p>
                <p class="small text-muted"><strong>JSON:</strong> Structured data format</p>
                <p class="small text-muted"><strong>Excel:</strong> Spreadsheet format for analysis</p>
                <p class="small text-muted"><strong>CSV:</strong> Simple comma-separated format</p>
                
                <h6>Data Security</h6>
                <p class="small text-muted">All backups are encrypted and securely stored. Download links expire after 24 hours.</p>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="m-0"><i class="fas fa-shield-alt mr-2"></i>Backup Status</h6>
            </div>
            <div class="card-body">
                <p><strong>Auto Backup:</strong> {% if tenant_settings.auto_backup_enabled %}<span class="text-success">Enabled</span>{% else %}<span class="text-muted">Disabled</span>{% endif %}</p>
                <p><strong>Frequency:</strong> {{ tenant_settings.backup_frequency|title }}</p>
                <p><strong>Retention:</strong> {{ tenant_settings.backup_retention_days }} days</p>
                <p><strong>Total Backups:</strong> {{ recent_backups|length }}</p>
                {% if recent_backups %}
                <p><strong>Last Backup:</strong><br>{{ recent_backups.0.created_at|date:"M d, Y" }}</p>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="m-0"><i class="fas fa-lightbulb mr-2"></i>Best Practices</h6>
            </div>
            <div class="card-body">
                <ul class="small text-muted">
                    <li>Enable automatic backups for data protection</li>
                    <li>Download important backups to external storage</li>
                    <li>Test backup restoration periodically</li>
                    <li>Use SQL format for complete system migration</li>
                    <li>Use Excel/CSV for data analysis and reporting</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle backup type selection
    document.querySelectorAll('input[name="backup_type"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
            const partialOptions = document.getElementById('partialOptions');
            if (this.value === 'partial') {
                partialOptions.style.display = 'block';
            } else {
                partialOptions.style.display = 'none';
            }
        });
    });
    
    // Handle email backup option
    document.getElementById('email_backup').addEventListener('change', function() {
        const emailOptions = document.getElementById('emailOptions');
        emailOptions.style.display = this.checked ? 'block' : 'none';
    });
    
    // Handle format selection styling
    document.querySelectorAll('.format-option').forEach(function(option) {
        option.addEventListener('click', function() {
            document.querySelectorAll('.format-option').forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            const radio = this.querySelector('input[type="radio"]');
            if (radio) radio.checked = true;
        });
    });
    
    // Handle backup creation form
    document.getElementById('createBackupForm').addEventListener('submit', function(e) {
        e.preventDefault();
        createBackup();
    });
});

function createBackup() {
    const form = document.getElementById('createBackupForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Collect selected tables for partial backup
    if (data.backup_type === 'partial') {
        const selectedTables = Array.from(document.querySelectorAll('input[name="tables"]:checked'))
            .map(cb => cb.value);
        data.selected_tables = selectedTables;
    }
    
    // Show loading state
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Creating Backup...';
    submitBtn.disabled = true;
    
    fetch('/business/{{ request.tenant.slug }}/business/settings/api/backup/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Backup created successfully! Size: ' + data.size);
            location.reload(); // Refresh to show new backup
        } else {
            alert('Error creating backup: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error creating backup: ' + error.message);
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function deleteBackup(backupId) {
    if (confirm('Are you sure you want to delete this backup? This action cannot be undone.')) {
        fetch(`/business/{{ request.tenant.slug }}/business/settings/api/backup/${backupId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting backup: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error deleting backup: ' + error.message);
        });
    }
}
</script>
{% endblock %}
