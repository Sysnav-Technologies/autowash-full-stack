{% extends "base/base.html" %}
{% load static %}

{% block title %}Invoice {{ invoice.invoice_number }} - {{ block.super }}{% endblock %}

{% block page_title %}Invoice Details{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title">
                    <i class="fas fa-file-invoice text-primary"></i>
                    Invoice {{ invoice.invoice_number }}
                </h1>
                <p class="page-subtitle">{{ invoice.supplier.name }} - {{ invoice.invoice_date|date:"M d, Y" }}</p>
            </div>
            
            <div class="d-flex align-items-center">
                <a href="/business/{{ request.tenant.slug }}/suppliers/invoices/" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-arrow-left"></i> Back to List
                </a>
                
                <div class="dropdown me-2">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-download"></i> Download
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/business/{{ request.tenant.slug }}/suppliers/invoices/{{ invoice.id }}/print/" target="_blank">
                            <i class="fas fa-print"></i> Print Version
                        </a></li>
                        <li><a class="dropdown-item" href="/business/{{ request.tenant.slug }}/suppliers/invoices/{{ invoice.id }}/pdf/" target="_blank">
                            <i class="fas fa-file-pdf"></i> Download PDF
                        </a></li>
                    </ul>
                </div>
                
                {% if invoice.status == 'draft' %}
                <a href="/business/{{ request.tenant.slug }}/suppliers/invoices/{{ invoice.id }}/edit/" class="btn btn-primary">
                    <i class="fas fa-edit"></i> Edit Invoice
                </a>
                {% elif invoice.payment_status != 'paid' %}
                <a href="/business/{{ request.tenant.slug }}/suppliers/payments/new/?invoice={{ invoice.id }}" class="btn btn-primary">
                    <i class="fas fa-credit-card"></i> Record Payment
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Invoice Details -->
        <div class="col-lg-8">
            <div class="content-card">
                <div class="card-header">
                    <h5 class="card-title">Invoice Information</h5>
                </div>
                
                <div class="card-body">
                    <!-- Invoice Header -->
                    <div class="invoice-header">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="invoice-from">
                                    <h6>From:</h6>
                                    <strong>{{ request.tenant.business_name }}</strong><br>
                                    {{ request.tenant.address|default:"" }}<br>
                                    {% if request.tenant.phone %}Phone: {{ request.tenant.phone }}<br>{% endif %}
                                    {% if request.tenant.email %}Email: {{ request.tenant.email }}<br>{% endif %}
                                    {% if request.tenant.vat_number %}VAT: {{ request.tenant.vat_number }}{% endif %}
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <div class="invoice-to">
                                    <h6>To:</h6>
                                    <strong>{{ invoice.supplier.name }}</strong><br>
                                    {{ invoice.supplier.address|default:"" }}<br>
                                    {% if invoice.supplier.phone %}Phone: {{ invoice.supplier.phone }}<br>{% endif %}
                                    {% if invoice.supplier.email %}Email: {{ invoice.supplier.email }}<br>{% endif %}
                                    {% if invoice.supplier.vat_number %}VAT: {{ invoice.supplier.vat_number }}{% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="invoice-meta">
                                    <strong>Invoice Number:</strong> {{ invoice.invoice_number }}<br>
                                    <strong>Invoice Date:</strong> {{ invoice.invoice_date|date:"M d, Y" }}<br>
                                    <strong>Due Date:</strong> {{ invoice.due_date|date:"M d, Y" }}<br>
                                    {% if invoice.purchase_order %}
                                    <strong>Purchase Order:</strong> {{ invoice.purchase_order.po_number }}<br>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <div class="invoice-status">
                                    <div class="mb-2">
                                        <span class="badge badge-lg badge-{{ invoice.status|yesno:'success,warning,danger' }}">
                                            {% if invoice.status == 'paid' %}
                                                Paid
                                            {% elif invoice.status == 'pending' %}
                                                Pending
                                            {% elif invoice.status == 'overdue' %}
                                                Overdue
                                            {% elif invoice.status == 'draft' %}
                                                Draft
                                            {% else %}
                                                Cancelled
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div>
                                        <span class="badge badge-lg badge-{{ invoice.payment_status|yesno:'success,warning,danger' }}">
                                            {% if invoice.payment_status == 'paid' %}
                                                <i class="fas fa-check"></i> Payment Complete
                                            {% elif invoice.payment_status == 'partial' %}
                                                <i class="fas fa-clock"></i> Partially Paid
                                            {% else %}
                                                <i class="fas fa-times"></i> Unpaid
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Invoice Items -->
                    <div class="invoice-items mt-4">
                        <h6>Invoice Items</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Description</th>
                                        <th class="text-center">Quantity</th>
                                        <th class="text-end">Unit Price</th>
                                        <th class="text-end">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in invoice.items.all %}
                                    <tr>
                                        <td>
                                            <strong>{{ item.description }}</strong>
                                            {% if item.notes %}
                                            <br><small class="text-muted">{{ item.notes }}</small>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">{{ item.quantity }}</td>
                                        <td class="text-end">KSh {{ item.unit_price|floatformat:2 }}</td>
                                        <td class="text-end">KSh {{ item.total_amount|floatformat:2 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3" class="text-end"><strong>Subtotal:</strong></td>
                                        <td class="text-end"><strong>KSh {{ invoice.subtotal|floatformat:2 }}</strong></td>
                                    </tr>
                                    {% if invoice.vat_rate %}
                                    <tr>
                                        <td colspan="3" class="text-end">VAT ({{ invoice.vat_rate }}%):</td>
                                        <td class="text-end">KSh {{ invoice.vat_amount|floatformat:2 }}</td>
                                    </tr>
                                    {% endif %}
                                    {% if invoice.discount_amount %}
                                    <tr>
                                        <td colspan="3" class="text-end">Discount:</td>
                                        <td class="text-end">-KSh {{ invoice.discount_amount|floatformat:2 }}</td>
                                    </tr>
                                    {% endif %}
                                    <tr class="table-primary">
                                        <td colspan="3" class="text-end"><strong>Total Amount:</strong></td>
                                        <td class="text-end"><strong>KSh {{ invoice.total_amount|floatformat:2 }}</strong></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    {% if invoice.notes %}
                    <div class="invoice-notes mt-4">
                        <h6>Notes</h6>
                        <p class="text-muted">{{ invoice.notes|linebreaks }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Payment Information -->
            <div class="content-card mb-3">
                <div class="card-header">
                    <h6 class="card-title">Payment Information</h6>
                </div>
                <div class="card-body">
                    <div class="payment-summary">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total Amount:</span>
                            <strong>KSh {{ invoice.total_amount|floatformat:2 }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Paid Amount:</span>
                            <span class="text-success">KSh {{ invoice.paid_amount|default:0|floatformat:2 }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Balance Due:</span>
                            <strong class="text-danger">KSh {{ invoice.balance_due|floatformat:2 }}</strong>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <span>Payment Status:</span>
                            <span class="badge badge-{{ invoice.payment_status|yesno:'success,warning,danger' }}">
                                {{ invoice.payment_status|title }}
                            </span>
                        </div>
                    </div>
                    
                    {% if invoice.payment_status != 'paid' %}
                    <div class="mt-3">
                        <a href="/business/{{ request.tenant.slug }}/suppliers/payments/new/?invoice={{ invoice.id }}" 
                           class="btn btn-success w-100">
                            <i class="fas fa-credit-card"></i> Record Payment
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Payment History -->
            {% if payments %}
            <div class="content-card mb-3">
                <div class="card-header">
                    <h6 class="card-title">Payment History</h6>
                </div>
                <div class="card-body">
                    {% for payment in payments %}
                    <div class="payment-record">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>KSh {{ payment.amount|floatformat:2 }}</strong>
                                <br><small class="text-muted">{{ payment.payment_date|date:"M d, Y" }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge badge-{{ payment.payment_method|default:'secondary' }}">
                                    {{ payment.payment_method|title }}
                                </span>
                                {% if payment.reference_number %}
                                <br><small class="text-muted">Ref: {{ payment.reference_number }}</small>
                                {% endif %}
                            </div>
                        </div>
                        {% if not forloop.last %}<hr>{% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Actions -->
            <div class="content-card">
                <div class="card-header">
                    <h6 class="card-title">Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="/business/{{ request.tenant.slug }}/suppliers/invoices/{{ invoice.id }}/print/" 
                           target="_blank" class="btn btn-outline-primary">
                            <i class="fas fa-print"></i> Print Invoice
                        </a>
                        <a href="/business/{{ request.tenant.slug }}/suppliers/invoices/{{ invoice.id }}/pdf/" 
                           target="_blank" class="btn btn-outline-primary">
                            <i class="fas fa-file-pdf"></i> Download PDF
                        </a>
                        {% if invoice.status == 'draft' %}
                        <a href="/business/{{ request.tenant.slug }}/suppliers/invoices/{{ invoice.id }}/edit/" 
                           class="btn btn-outline-warning">
                            <i class="fas fa-edit"></i> Edit Invoice
                        </a>
                        <button type="button" class="btn btn-outline-danger" onclick="deleteInvoice()">
                            <i class="fas fa-trash"></i> Delete Invoice
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.content-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border: 1px solid #e9ecef;
}

.invoice-header {
    padding: 1rem 0;
}

.invoice-from, .invoice-to {
    line-height: 1.6;
}

.invoice-meta {
    line-height: 1.8;
}

.invoice-status {
    text-align: right;
}

.badge-lg {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
}

.table-bordered {
    border: 2px solid #dee2e6;
}

.table-bordered th,
.table-bordered td {
    border: 1px solid #dee2e6;
    padding: 0.75rem;
}

.table-light {
    background-color: #f8f9fa;
}

.payment-record {
    padding: 0.5rem 0;
}

.payment-summary {
    font-size: 0.95rem;
}

.badge-success { background-color: #28a745; }
.badge-warning { background-color: #ffc107; color: #212529; }
.badge-danger { background-color: #dc3545; }
.badge-secondary { background-color: #6c757d; }
</style>
{% endblock %}

{% block extra_js %}
<script>
function deleteInvoice() {
    if (confirm('Are you sure you want to delete this invoice? This action cannot be undone.')) {
        fetch(`/business/{{ request.tenant.slug }}/suppliers/invoices/{{ invoice.id }}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/business/{{ request.tenant.slug }}/suppliers/invoices/';
            } else {
                alert('Error deleting invoice');
            }
        });
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
