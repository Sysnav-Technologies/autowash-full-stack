{% extends "base/base.html" %}
{% load static %}

{% block title %}{% if evaluation %}Edit{% else %}New{% endif %} Supplier Evaluation - {{ block.super }}{% endblock %}

{% block page_title %}{% if evaluation %}Edit{% else %}New{% endif %} Supplier Evaluation{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title">
                    <i class="fas fa-clipboard-check text-primary"></i>
                    {% if evaluation %}Edit{% else %}New{% endif %} Supplier Evaluation
                </h1>
                <p class="page-subtitle">
                    {% if evaluation %}
                        Editing evaluation for {{ evaluation.supplier.name }}
                    {% else %}
                        Create a comprehensive supplier performance evaluation
                    {% endif %}
                </p>
            </div>
            
            <div class="d-flex align-items-center">
                <a href="/business/{{ request.tenant.slug }}/suppliers/evaluations/" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to List
                </a>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="content-card">
                <div class="card-header">
                    <h5 class="card-title">Evaluation Details</h5>
                </div>
                
                <div class="card-body">
                    <form method="post" id="evaluationForm">
                        {% csrf_token %}
                        
                        <!-- Basic Information -->
                        <div class="section-header">
                            <h6>Basic Information</h6>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="supplier" class="form-label">Supplier *</label>
                                <select name="supplier" id="supplier" class="form-control" required {% if evaluation %}disabled{% endif %}>
                                    <option value="">Select Supplier</option>
                                    {% for supplier in suppliers %}
                                    <option value="{{ supplier.id }}" 
                                            {% if evaluation and supplier.id == evaluation.supplier.id %}selected{% endif %}
                                            {% if not evaluation and supplier.id == selected_supplier_id %}selected{% endif %}>
                                        {{ supplier.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                {% if evaluation %}
                                <input type="hidden" name="supplier" value="{{ evaluation.supplier.id }}">
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="evaluator" class="form-label">Evaluator *</label>
                                <input type="text" class="form-control" id="evaluator" name="evaluator" 
                                       value="{% if evaluation %}{{ evaluation.evaluated_by.get_full_name|default:evaluation.evaluated_by.username }}{% else %}{{ request.user.get_full_name|default:request.user.username }}{% endif %}" 
                                       readonly>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="period_start" class="form-label">Evaluation Period Start *</label>
                                <input type="date" class="form-control" id="period_start" name="period_start" 
                                       value="{% if evaluation %}{{ evaluation.period_start|date:'Y-m-d' }}{% endif %}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="period_end" class="form-label">Evaluation Period End *</label>
                                <input type="date" class="form-control" id="period_end" name="period_end" 
                                       value="{% if evaluation %}{{ evaluation.period_end|date:'Y-m-d' }}{% endif %}" required>
                            </div>
                        </div>
                        
                        <!-- Performance Metrics -->
                        <div class="section-header">
                            <h6>Performance Metrics</h6>
                        </div>
                        
                        <!-- Quality Assessment -->
                        <div class="metric-section">
                            <h6 class="metric-title">Quality Assessment</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="quality_score" class="form-label">Quality Score (1-5) *</label>
                                    <input type="number" class="form-control score-input" id="quality_score" name="quality_score" 
                                           min="1" max="5" step="0.1" 
                                           value="{% if evaluation %}{{ evaluation.quality_score }}{% endif %}" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Quality Rating</label>
                                    <div class="rating-display" id="quality_rating">
                                        {% for i in "12345" %}
                                        <i class="fas fa-star rating-star" data-rating="{{ i }}"></i>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="quality_notes" class="form-label">Quality Notes</label>
                                <textarea class="form-control" id="quality_notes" name="quality_notes" rows="3" 
                                          placeholder="Comments on product/service quality, consistency, specifications adherence...">{% if evaluation %}{{ evaluation.quality_notes }}{% endif %}</textarea>
                            </div>
                        </div>
                        
                        <!-- Delivery Performance -->
                        <div class="metric-section">
                            <h6 class="metric-title">Delivery Performance</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="delivery_score" class="form-label">Delivery Score (1-5) *</label>
                                    <input type="number" class="form-control score-input" id="delivery_score" name="delivery_score" 
                                           min="1" max="5" step="0.1" 
                                           value="{% if evaluation %}{{ evaluation.delivery_score }}{% endif %}" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Delivery Rating</label>
                                    <div class="rating-display" id="delivery_rating">
                                        {% for i in "12345" %}
                                        <i class="fas fa-star rating-star" data-rating="{{ i }}"></i>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="delivery_notes" class="form-label">Delivery Notes</label>
                                <textarea class="form-control" id="delivery_notes" name="delivery_notes" rows="3" 
                                          placeholder="Comments on timeliness, packaging, handling, logistics...">{% if evaluation %}{{ evaluation.delivery_notes }}{% endif %}</textarea>
                            </div>
                        </div>
                        
                        <!-- Service Quality -->
                        <div class="metric-section">
                            <h6 class="metric-title">Service Quality</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="service_score" class="form-label">Service Score (1-5) *</label>
                                    <input type="number" class="form-control score-input" id="service_score" name="service_score" 
                                           min="1" max="5" step="0.1" 
                                           value="{% if evaluation %}{{ evaluation.service_score }}{% endif %}" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Service Rating</label>
                                    <div class="rating-display" id="service_rating">
                                        {% for i in "12345" %}
                                        <i class="fas fa-star rating-star" data-rating="{{ i }}"></i>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="service_notes" class="form-label">Service Notes</label>
                                <textarea class="form-control" id="service_notes" name="service_notes" rows="3" 
                                          placeholder="Comments on customer service, responsiveness, support quality...">{% if evaluation %}{{ evaluation.service_notes }}{% endif %}</textarea>
                            </div>
                        </div>
                        
                        <!-- Overall Assessment -->
                        <div class="section-header">
                            <h6>Overall Assessment</h6>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="overall_rating" class="form-label">Overall Rating *</label>
                                <input type="number" class="form-control" id="overall_rating" name="overall_rating" 
                                       min="1" max="5" step="0.1" readonly
                                       value="{% if evaluation %}{{ evaluation.overall_rating }}{% endif %}">
                                <small class="form-text text-muted">Automatically calculated from individual scores</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Overall Rating</label>
                                <div class="rating-display large" id="overall_rating_display">
                                    {% for i in "12345" %}
                                    <i class="fas fa-star rating-star" data-rating="{{ i }}"></i>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="strengths" class="form-label">Strengths</label>
                            <textarea class="form-control" id="strengths" name="strengths" rows="3" 
                                      placeholder="What does this supplier do well? Key strengths and advantages...">{% if evaluation %}{{ evaluation.strengths }}{% endif %}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="weaknesses" class="form-label">Areas for Improvement</label>
                            <textarea class="form-control" id="weaknesses" name="weaknesses" rows="3" 
                                      placeholder="What areas need improvement? Suggestions for enhancement...">{% if evaluation %}{{ evaluation.weaknesses }}{% endif %}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="recommendations" class="form-label">Recommendations</label>
                            <textarea class="form-control" id="recommendations" name="recommendations" rows="3" 
                                      placeholder="Future recommendations, continued partnership status, action items...">{% if evaluation %}{{ evaluation.recommendations }}{% endif %}</textarea>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="button" class="btn btn-outline-secondary" onclick="saveDraft()">
                                    <i class="fas fa-save"></i> Save as Draft
                                </button>
                            </div>
                            <div>
                                <button type="button" class="btn btn-secondary me-2" onclick="history.back()">
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-check"></i> Complete Evaluation
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.content-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border: 1px solid #e9ecef;
}

.section-header {
    background: #f8f9fa;
    padding: 1rem;
    margin: 0 -1.5rem 1.5rem -1.5rem;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.section-header h6 {
    margin: 0;
    color: #495057;
    font-weight: 600;
}

.metric-section {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    border: 1px solid #e9ecef;
}

.metric-title {
    color: #495057;
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #dee2e6;
}

.score-input {
    font-size: 1.2rem;
    font-weight: bold;
    text-align: center;
}

.rating-display {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem 0;
}

.rating-display.large {
    font-size: 1.5rem;
}

.rating-star {
    cursor: pointer;
    transition: color 0.2s;
    color: #ddd;
}

.rating-star.active {
    color: #ffc107;
}

.rating-star:hover {
    color: #ffc107;
}

.form-label {
    font-weight: 600;
    color: #495057;
}

.form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

textarea.form-control {
    resize: vertical;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize rating displays
    updateRatingDisplay('quality_score', 'quality_rating');
    updateRatingDisplay('delivery_score', 'delivery_rating');
    updateRatingDisplay('service_score', 'service_rating');
    updateOverallRating();
    
    // Add event listeners for score inputs
    document.getElementById('quality_score').addEventListener('input', function() {
        updateRatingDisplay('quality_score', 'quality_rating');
        updateOverallRating();
    });
    
    document.getElementById('delivery_score').addEventListener('input', function() {
        updateRatingDisplay('delivery_score', 'delivery_rating');
        updateOverallRating();
    });
    
    document.getElementById('service_score').addEventListener('input', function() {
        updateRatingDisplay('service_score', 'service_rating');
        updateOverallRating();
    });
    
    // Set default period if creating new evaluation
    {% if not evaluation %}
    setDefaultPeriod();
    {% endif %}
});

function updateRatingDisplay(scoreInputId, ratingDisplayId) {
    const scoreInput = document.getElementById(scoreInputId);
    const ratingDisplay = document.getElementById(ratingDisplayId);
    const score = parseFloat(scoreInput.value) || 0;
    
    const stars = ratingDisplay.querySelectorAll('.rating-star');
    stars.forEach((star, index) => {
        if (index < Math.floor(score)) {
            star.classList.add('active');
        } else if (index === Math.floor(score) && score % 1 >= 0.5) {
            star.classList.add('active');
        } else {
            star.classList.remove('active');
        }
    });
}

function updateOverallRating() {
    const qualityScore = parseFloat(document.getElementById('quality_score').value) || 0;
    const deliveryScore = parseFloat(document.getElementById('delivery_score').value) || 0;
    const serviceScore = parseFloat(document.getElementById('service_score').value) || 0;
    
    const overallRating = (qualityScore + deliveryScore + serviceScore) / 3;
    
    document.getElementById('overall_rating').value = overallRating.toFixed(1);
    
    // Update overall rating display
    const stars = document.querySelectorAll('#overall_rating_display .rating-star');
    stars.forEach((star, index) => {
        if (index < Math.floor(overallRating)) {
            star.classList.add('active');
        } else if (index === Math.floor(overallRating) && overallRating % 1 >= 0.5) {
            star.classList.add('active');
        } else {
            star.classList.remove('active');
        }
    });
}

function setDefaultPeriod() {
    const today = new Date();
    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    const lastDayOfLastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
    
    document.getElementById('period_start').value = lastMonth.toISOString().split('T')[0];
    document.getElementById('period_end').value = lastDayOfLastMonth.toISOString().split('T')[0];
}

function saveDraft() {
    const form = document.getElementById('evaluationForm');
    const formData = new FormData(form);
    formData.append('save_draft', 'true');
    
    fetch(form.action || window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Draft saved successfully!');
        } else {
            alert('Error saving draft. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving draft. Please try again.');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Form validation
document.getElementById('evaluationForm').addEventListener('submit', function(e) {
    const supplier = document.getElementById('supplier').value;
    const periodStart = document.getElementById('period_start').value;
    const periodEnd = document.getElementById('period_end').value;
    const qualityScore = document.getElementById('quality_score').value;
    const deliveryScore = document.getElementById('delivery_score').value;
    const serviceScore = document.getElementById('service_score').value;
    
    if (!supplier || !periodStart || !periodEnd || !qualityScore || !deliveryScore || !serviceScore) {
        e.preventDefault();
        alert('Please fill in all required fields.');
        return;
    }
    
    if (new Date(periodStart) >= new Date(periodEnd)) {
        e.preventDefault();
        alert('Period start date must be before period end date.');
        return;
    }
});
</script>
{% endblock %}
