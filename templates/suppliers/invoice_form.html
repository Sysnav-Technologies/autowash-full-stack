{% extends "base/base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{% if invoice %}Edit Invoice {{ invoice.invoice_number }}{% else %}Create New Invoice{% endif %} - {{ block.super }}{% endblock %}

{% block page_title %}{% if invoice %}Edit Invoice{% else %}New Invoice{% endif %}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
.form-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.form-card {
    background: white;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    overflow: hidden;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.form-card-header {
    background: #f8fafc;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e2e8f0;
    font-weight: 600;
    color: #1e293b;
}

.items-table {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #e2e8f0;
}

.items-table th {
    background: #f1f5f9;
    font-weight: 600;
    color: #475569;
    padding: 1rem 0.75rem;
    border-bottom: 2px solid #e2e8f0;
}

.items-table td {
    padding: 0.75rem;
    border-bottom: 1px solid #f1f5f9;
}

.item-row {
    transition: all 0.2s ease;
}

.item-row:hover {
    background-color: #f8fafc;
}

.item-row.removing {
    background-color: #fef2f2;
    opacity: 0.7;
}

.btn-add-item {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border: none;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-add-item:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

.btn-remove-item {
    background: #ef4444;
    border: none;
    color: white;
    padding: 0.5rem;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.btn-remove-item:hover {
    background: #dc2626;
    transform: scale(1.05);
}

.summary-card {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 12px;
    border: 1px solid #cbd5e1;
    padding: 1.5rem;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #e2e8f0;
}

.summary-row:last-child {
    border-bottom: none;
    font-weight: 700;
    font-size: 1.1rem;
    color: #1e293b;
}

.form-control:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.15);
}

.select2-container--default .select2-selection--single {
    height: 38px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 36px;
    padding-left: 12px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="form-header text-center">
        <h1 class="mb-3">
            <i class="fas fa-file-invoice me-2"></i>
            {% if invoice %}Edit Invoice {{ invoice.invoice_number }}{% else %}Create New Invoice{% endif %}
        </h1>
        <p class="mb-0">
            {% if invoice %}
                Modify invoice details and items for {{ invoice.supplier.name }}
            {% else %}
                Create a comprehensive supplier invoice with detailed line items
            {% endif %}
        </p>
    </div>

    <form method="post" id="invoice-form" enctype="multipart/form-data">
        {% csrf_token %}
        {{ items_formset.management_form }}
        
        <div class="row">
            <div class="col-lg-8">
                <!-- Basic Information -->
                <div class="form-card">
                    <div class="form-card-header">
                        <i class="fas fa-info-circle me-2"></i>
                        Basic Information
                    </div>
                    <div class="p-3">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.supplier.id_for_label }}" class="form-label">Supplier *</label>
                                {{ form.supplier|add_class:"form-select" }}
                                {% if form.supplier.errors %}
                                    <div class="text-danger small">{{ form.supplier.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.purchase_order.id_for_label }}" class="form-label">Purchase Order</label>
                                {{ form.purchase_order|add_class:"form-select" }}
                                {% if form.purchase_order.errors %}
                                    <div class="text-danger small">{{ form.purchase_order.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.invoice_number.id_for_label }}" class="form-label">Invoice Number *</label>
                                {{ form.invoice_number|add_class:"form-control" }}
                                {% if form.invoice_number.errors %}
                                    <div class="text-danger small">{{ form.invoice_number.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.supplier_invoice_number.id_for_label }}" class="form-label">Supplier Invoice #</label>
                                {{ form.supplier_invoice_number|add_class:"form-control" }}
                                {% if form.supplier_invoice_number.errors %}
                                    <div class="text-danger small">{{ form.supplier_invoice_number.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.status.id_for_label }}" class="form-label">Status</label>
                                {{ form.status|add_class:"form-select" }}
                                {% if form.status.errors %}
                                    <div class="text-danger small">{{ form.status.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.invoice_date.id_for_label }}" class="form-label">Invoice Date *</label>
                                {{ form.invoice_date|add_class:"form-control" }}
                                {% if form.invoice_date.errors %}
                                    <div class="text-danger small">{{ form.invoice_date.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.due_date.id_for_label }}" class="form-label">Due Date *</label>
                                {{ form.due_date|add_class:"form-control" }}
                                {% if form.due_date.errors %}
                                    <div class="text-danger small">{{ form.due_date.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.received_date.id_for_label }}" class="form-label">Received Date</label>
                                {{ form.received_date|add_class:"form-control" }}
                                {% if form.received_date.errors %}
                                    <div class="text-danger small">{{ form.received_date.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Invoice Items -->
                <div class="form-card">
                    <div class="form-card-header d-flex justify-content-between align-items-center">
                        <span>
                            <i class="fas fa-list me-2"></i>
                            Invoice Items
                        </span>
                        <button type="button" class="btn btn-add-item btn-sm" id="add-item">
                            <i class="fas fa-plus me-1"></i>
                            Add Item
                        </button>
                    </div>
                    <div class="p-0">
                        <div class="table-responsive">
                            <table class="table table-sm items-table mb-0">
                                <thead>
                                    <tr>
                                        <th style="width: 25%;">Description</th>
                                        <th style="width: 15%;">Quantity</th>
                                        <th style="width: 15%;">Unit Price</th>
                                        <th style="width: 15%;">Total</th>
                                        <th style="width: 20%;">Notes</th>
                                        <th style="width: 10%;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="items-tbody">
                                    {% for form in items_formset %}
                                        <tr class="item-row" data-form-index="{{ forloop.counter0 }}">
                                            <td>
                                                {{ form.description|add_class:"form-control" }}
                                                {% if form.description.errors %}
                                                    <div class="text-danger small">{{ form.description.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.quantity|add_class:"form-control quantity-input" }}
                                                {% if form.quantity.errors %}
                                                    <div class="text-danger small">{{ form.quantity.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.unit_price|add_class:"form-control unit-price-input" }}
                                                {% if form.unit_price.errors %}
                                                    <div class="text-danger small">{{ form.unit_price.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <input type="text" class="form-control item-total" readonly value="0.00">
                                            </td>
                                            <td>
                                                {{ form.notes|add_class:"form-control" }}
                                                {% if form.notes.errors %}
                                                    <div class="text-danger small">{{ form.notes.errors.0 }}</div>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                <button type="button" class="btn btn-remove-item btn-sm" title="Remove Item">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                {{ form.DELETE }}
                                                {{ form.id }}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Additional Information -->
                <div class="form-card">
                    <div class="form-card-header">
                        <i class="fas fa-sticky-note me-2"></i>
                        Additional Information
                    </div>
                    <div class="p-3">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                                {{ form.description|add_class:"form-control" }}
                                {% if form.description.errors %}
                                    <div class="text-danger small">{{ form.description.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.notes.id_for_label }}" class="form-label">Internal Notes</label>
                                {{ form.notes|add_class:"form-control" }}
                                {% if form.notes.errors %}
                                    <div class="text-danger small">{{ form.notes.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.invoice_file.id_for_label }}" class="form-label">Invoice File</label>
                            {{ form.invoice_file|add_class:"form-control" }}
                            {% if form.invoice_file.errors %}
                                <div class="text-danger small">{{ form.invoice_file.errors.0 }}</div>
                            {% endif %}
                            {% if invoice and invoice.invoice_file %}
                                <small class="form-text text-muted">
                                    Current file: <a href="{{ invoice.invoice_file.url }}" target="_blank">{{ invoice.invoice_file.name }}</a>
                                </small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Sidebar -->
            <div class="col-lg-4">
                <div class="sticky-top" style="top: 20px;">
                    <div class="form-card">
                        <div class="form-card-header">
                            <i class="fas fa-calculator me-2"></i>
                            Invoice Summary
                        </div>
                        <div class="p-3">
                            <div class="summary-card">
                                <div class="summary-row">
                                    <span>Subtotal:</span>
                                    <strong id="subtotal-display">KSh 0.00</strong>
                                </div>
                                
                                <div class="summary-row">
                                    <span>VAT/Tax:</span>
                                    <div class="input-group input-group-sm" style="width: 120px;">
                                        {{ form.tax_amount|add_class:"form-control form-control-sm text-end" }}
                                    </div>
                                </div>
                                
                                <div class="summary-row">
                                    <span>Discount:</span>
                                    <div class="input-group input-group-sm" style="width: 120px;">
                                        {{ form.discount_amount|add_class:"form-control form-control-sm text-end" }}
                                    </div>
                                </div>
                                
                                <div class="summary-row">
                                    <span>Shipping:</span>
                                    <div class="input-group input-group-sm" style="width: 120px;">
                                        {{ form.shipping_cost|add_class:"form-control form-control-sm text-end" }}
                                    </div>
                                </div>
                                
                                <div class="summary-row">
                                    <span>Total Amount:</span>
                                    <strong id="total-display" style="font-size: 1.2rem; color: #059669;">KSh 0.00</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="form-card">
                        <div class="form-card-header">
                            <i class="fas fa-cogs me-2"></i>
                            Actions
                        </div>
                        <div class="p-3">
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-secondary" onclick="saveDraft()">
                                    <i class="fas fa-save me-2"></i>Save as Draft
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-check me-2"></i>
                                    {% if invoice %}Update{% else %}Create{% endif %} Invoice
                                </button>
                                <a href="/business/{{ request.tenant.slug }}/suppliers/invoices/" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Back to List
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Item Row Template (Hidden) -->
<template id="item-row-template">
    <tr class="item-row" data-form-index="__prefix__">
        <td>
            <input type="text" name="items-__prefix__-description" class="form-control" placeholder="Item description" required>
        </td>
        <td>
            <input type="number" name="items-__prefix__-quantity" class="form-control quantity-input" step="0.01" min="0.01" value="1" required>
        </td>
        <td>
            <input type="number" name="items-__prefix__-unit_price" class="form-control unit-price-input" step="0.01" min="0.01" required>
        </td>
        <td>
            <input type="text" class="form-control item-total" readonly value="0.00">
        </td>
        <td>
            <input type="text" name="items-__prefix__-notes" class="form-control" placeholder="Notes">
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-remove-item btn-sm" title="Remove Item">
                <i class="fas fa-trash"></i>
            </button>
            <input type="hidden" name="items-__prefix__-DELETE">
            <input type="hidden" name="items-__prefix__-id">
        </td>
    </tr>
</template>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    let formIndex = {{ items_formset.total_form_count }};
    const maxForms = {{ items_formset.max_num }};
    
    // Initialize Select2
    $('#{{ form.supplier.id_for_label }}').select2({
        placeholder: 'Select a supplier...',
        allowClear: true
    });
    
    $('#{{ form.purchase_order.id_for_label }}').select2({
        placeholder: 'Select a purchase order...',
        allowClear: true
    });
    
    // Set default dates for new invoices
    {% if not invoice %}
    setDefaultDates();
    {% endif %}
    
    // Calculate totals on page load
    calculateTotals();
    
    // Event handlers
    $(document).on('input', '.quantity-input, .unit-price-input, #{{ form.tax_amount.id_for_label }}, #{{ form.discount_amount.id_for_label }}, #{{ form.shipping_cost.id_for_label }}', function() {
        calculateRowTotal($(this).closest('.item-row'));
        calculateTotals();
    });
    
    $('#add-item').click(function() {
        if (formIndex < maxForms) {
            addNewItemRow();
        } else {
            alert('Maximum number of items reached.');
        }
    });
    
    $(document).on('click', '.btn-remove-item', function() {
        removeItemRow($(this).closest('.item-row'));
    });
    
    // Form validation
    $('#invoice-form').submit(function(e) {
        if (!validateForm()) {
            e.preventDefault();
        }
    });
    
    function addNewItemRow() {
        const template = $('#item-row-template').html();
        const newRow = template.replace(/__prefix__/g, formIndex);
        
        $('#items-tbody').append(newRow);
        
        formIndex++;
        updateFormIndex();
        
        // Focus on the new description field
        $(`input[name="items-${formIndex-1}-description"]`).focus();
    }
    
    function removeItemRow(row) {
        const deleteInput = row.find('input[name$="-DELETE"]');
        
        if (deleteInput.length > 0) {
            // Mark for deletion if it's an existing item
            deleteInput.val('1');
            row.hide().addClass('removing');
        } else {
            // Remove from DOM if it's a new item
            row.remove();
        }
        
        calculateTotals();
        updateFormIndex();
    }
    
    function updateFormIndex() {
        const visibleRows = $('.item-row:visible').length;
        $('#{{ items_formset.management_form.total_forms.id_for_label }}').val(formIndex);
    }
    
    function calculateRowTotal(row) {
        if (row.length === 0) return;
        
        const quantity = parseFloat(row.find('.quantity-input').val()) || 0;
        const unitPrice = parseFloat(row.find('.unit-price-input').val()) || 0;
        const total = quantity * unitPrice;
        
        row.find('.item-total').val(total.toFixed(2));
    }
    
    function calculateTotals() {
        let subtotal = 0;
        
        // Calculate subtotal from all visible rows
        $('.item-row:visible').each(function() {
            calculateRowTotal($(this));
            const total = parseFloat($(this).find('.item-total').val()) || 0;
            subtotal += total;
        });
        
        const tax = parseFloat($('#{{ form.tax_amount.id_for_label }}').val()) || 0;
        const discount = parseFloat($('#{{ form.discount_amount.id_for_label }}').val()) || 0;
        const shipping = parseFloat($('#{{ form.shipping_cost.id_for_label }}').val()) || 0;
        
        const grandTotal = subtotal + tax + shipping - discount;
        
        // Update displays
        $('#subtotal-display').text(`KSh ${subtotal.toFixed(2)}`);
        $('#total-display').text(`KSh ${grandTotal.toFixed(2)}`);
    }
    
    function setDefaultDates() {
        const today = new Date();
        const thirtyDaysLater = new Date(today.getTime() + (30 * 24 * 60 * 60 * 1000));
        
        $('#{{ form.invoice_date.id_for_label }}').val(today.toISOString().split('T')[0]);
        $('#{{ form.due_date.id_for_label }}').val(thirtyDaysLater.toISOString().split('T')[0]);
    }
    
    function validateForm() {
        let isValid = true;
        
        // Check if at least one item exists
        if ($('.item-row:visible').length === 0) {
            alert('Please add at least one invoice item.');
            return false;
        }
        
        // Validate required fields in visible rows
        $('.item-row:visible').each(function() {
            const description = $(this).find('input[name$="-description"]').val().trim();
            const quantity = parseFloat($(this).find('.quantity-input').val());
            const unitPrice = parseFloat($(this).find('.unit-price-input').val());
            
            if (!description || quantity <= 0 || unitPrice <= 0) {
                alert('Please fill in all required fields for each item.');
                isValid = false;
                return false;
            }
        });
        
        return isValid;
    }
    
    function saveDraft() {
        // Set status to draft before submitting
        $('#{{ form.status.id_for_label }}').val('draft');
        
        if (validateForm()) {
            $('#invoice-form').submit();
        }
    }
});
</script>
{% endblock %}
