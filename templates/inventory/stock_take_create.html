{% extends 'base/base.html' %}
{% load static %}

{% block title %}
    Create Stock Take - Inventory - {{ request.tenant.name }}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/inventory.css' %}">
<style>
    .stock-take-wizard {
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        border: 1px solid #e9ecef;
    }
    
    .wizard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
    }
    
    .wizard-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 10px;
    }
    
    .wizard-subtitle {
        opacity: 0.9;
        margin-bottom: 0;
    }
    
    .form-container {
        padding: 40px;
    }
    
    .section-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 12px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f8f9fa;
    }
    
    .section-title i {
        color: #667eea;
        font-size: 1.5rem;
    }
    
    .form-group {
        margin-bottom: 25px;
    }
    
    .form-label {
        font-weight: 600;
        color: #34495e;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .required-field {
        color: #e74c3c;
        font-size: 0.8rem;
    }
    
    .form-control, .form-select {
        border-radius: 12px;
        border: 2px solid #e9ecef;
        padding: 15px 18px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #fdfdfd;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
        background: white;
    }
    
    .selection-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }
    
    .selection-card {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .selection-card:hover {
        border-color: #667eea;
        background: #f0f3ff;
        transform: translateY(-2px);
    }
    
    .selection-card.selected {
        border-color: #667eea;
        background: linear-gradient(135deg, #e8f0ff 0%, #f0f3ff 100%);
    }
    
    .selection-card i {
        font-size: 2.5rem;
        color: #667eea;
        margin-bottom: 15px;
    }
    
    .selection-card h5 {
        color: #2c3e50;
        margin-bottom: 10px;
        font-weight: 600;
    }
    
    .selection-card p {
        color: #7f8c8d;
        margin-bottom: 0;
        font-size: 0.9rem;
    }
    
    .multi-select-container {
        max-height: 300px;
        overflow-y: auto;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        background: #fdfdfd;
    }
    
    .multi-select-item {
        padding: 12px 15px;
        border-bottom: 1px solid #f8f9fa;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .multi-select-item:hover {
        background: #f8f9fa;
    }
    
    .multi-select-item:last-child {
        border-bottom: none;
    }
    
    .item-info {
        flex: 1;
    }
    
    .item-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 2px;
    }
    
    .item-details {
        font-size: 0.85rem;
        color: #7f8c8d;
    }
    
    .item-stock {
        font-weight: 600;
        color: #667eea;
    }
    
    .counters-select {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
    }
    
    .counter-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px;
        margin-bottom: 10px;
        background: white;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }
    
    .counter-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #667eea;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    
    .submit-section {
        background: #f8f9fa;
        padding: 30px 40px;
        border-top: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .btn {
        padding: 12px 25px;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        color: white;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .help-text {
        font-size: 0.85rem;
        color: #7f8c8d;
        margin-top: 8px;
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <div class="page-breadcrumb">
            <a href="/business/{{ request.tenant.slug }}/inventory/" class="breadcrumb-link">Inventory</a>
            <i class="fas fa-chevron-right"></i>
            <a href="/business/{{ request.tenant.slug }}/inventory/stock-takes/" class="breadcrumb-link">Stock Takes</a>
            <i class="fas fa-chevron-right"></i>
            <span class="breadcrumb-current">Create Stock Take</span>
        </div>
    </div>
</div>

<div class="stock-take-wizard">
    <div class="wizard-header">
        <h1 class="wizard-title">
            <i class="fas fa-clipboard-list"></i>
            Create New Stock Take
        </h1>
        <p class="wizard-subtitle">
            Set up a comprehensive inventory count to ensure accurate stock levels
        </p>
    </div>

    <form method="post" id="stockTakeForm">
        {% csrf_token %}
        
        <div class="form-container">
            <!-- Basic Information -->
            <div class="section-title">
                <i class="fas fa-info-circle"></i>
                Basic Information
            </div>
            
            <div class="row">
                <div class="col-md-8">
                    <div class="form-group">
                        <label for="id_name" class="form-label">
                            Stock Take Name <span class="required-field">*</span>
                        </label>
                        {{ form.name }}
                        <div class="help-text">Enter a descriptive name for this stock take</div>
                        {% if form.name.errors %}
                            <div class="text-danger">{{ form.name.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="id_description" class="form-label">Description</label>
                        {{ form.description }}
                        <div class="help-text">Optional description of the stock take purpose</div>
                        {% if form.description.errors %}
                            <div class="text-danger">{{ form.description.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="id_scheduled_date" class="form-label">
                            Scheduled Date <span class="required-field">*</span>
                        </label>
                        {{ form.scheduled_date }}
                        <div class="help-text">When should this stock take be performed</div>
                        {% if form.scheduled_date.errors %}
                            <div class="text-danger">{{ form.scheduled_date.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Items Selection -->
            <div class="section-title">
                <i class="fas fa-boxes"></i>
                Items to Count
            </div>
            
            <div class="selection-cards">
                <div class="selection-card" data-option="all">
                    <i class="fas fa-globe"></i>
                    <h5>All Items</h5>
                    <p>Count all active inventory items in the system</p>
                </div>
                <div class="selection-card" data-option="categories">
                    <i class="fas fa-tags"></i>
                    <h5>By Categories</h5>
                    <p>Select specific categories to count</p>
                </div>
                <div class="selection-card" data-option="specific">
                    <i class="fas fa-list"></i>
                    <h5>Specific Items</h5>
                    <p>Choose individual items to count</p>
                </div>
            </div>
            
            <div class="form-group">
                {{ form.include_all_items }}
                <div id="categoriesSection" class="multi-select-container" style="display: none;">
                    <h6 class="p-3 mb-0 bg-light">Select Categories:</h6>
                    {% for category in categories %}
                    <div class="multi-select-item">
                        <input type="checkbox" name="categories" value="{{ category.id }}" id="cat_{{ category.id }}">
                        <label for="cat_{{ category.id }}" class="item-info">
                            <div class="item-name">{{ category.name }}</div>
                            <div class="item-details">{{ category.items.count }} items</div>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                
                <div id="itemsSection" class="multi-select-container" style="display: none;">
                    <h6 class="p-3 mb-0 bg-light">Select Items:</h6>
                    {% for item in items %}
                    <div class="multi-select-item">
                        <input type="checkbox" name="items" value="{{ item.id }}" id="item_{{ item.id }}">
                        <label for="item_{{ item.id }}" class="item-info">
                            <div class="item-name">{{ item.name }}</div>
                            <div class="item-details">
                                {{ item.sku }} • Current Stock: <span class="item-stock">{{ item.current_stock }} {{ item.unit.abbreviation }}</span>
                            </div>
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Counter Assignment -->
            <div class="section-title">
                <i class="fas fa-users"></i>
                Assign Counters
            </div>
            
            <div class="counters-select">
                <h6 class="mb-3">Select employees to perform the count:</h6>
                {% for employee in employees %}
                <div class="counter-item">
                    <input type="checkbox" name="counters" value="{{ employee.id }}" id="emp_{{ employee.id }}">
                    <div class="counter-avatar">
                        {{ employee.get_full_name|first }}
                    </div>
                    <label for="emp_{{ employee.id }}" class="item-info">
                        <div class="item-name">{{ employee.get_full_name }}</div>
                        <div class="item-details">{{ employee.role|title }}</div>
                    </label>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Submit Section -->
        <div class="submit-section">
            <a href="/business/{{ request.tenant.slug }}/inventory/stock-takes/" class="btn btn-secondary">
                <i class="fas fa-times"></i>
                Cancel
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i>
                Create Stock Take
            </button>
        </div>
    </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectionCards = document.querySelectorAll('.selection-card');
    const includeAllField = document.getElementById('id_include_all_items');
    const categoriesSection = document.getElementById('categoriesSection');
    const itemsSection = document.getElementById('itemsSection');
    
    // Handle selection card clicks
    selectionCards.forEach(card => {
        card.addEventListener('click', function() {
            const option = this.dataset.option;
            
            // Remove selected class from all cards
            selectionCards.forEach(c => c.classList.remove('selected'));
            
            // Add selected class to clicked card
            this.classList.add('selected');
            
            // Update form based on selection
            if (option === 'all') {
                includeAllField.checked = true;
                categoriesSection.style.display = 'none';
                itemsSection.style.display = 'none';
            } else if (option === 'categories') {
                includeAllField.checked = false;
                categoriesSection.style.display = 'block';
                itemsSection.style.display = 'none';
            } else if (option === 'specific') {
                includeAllField.checked = false;
                categoriesSection.style.display = 'none';
                itemsSection.style.display = 'block';
            }
        });
    });
    
    // Set default selection
    selectionCards[0].click();
    
    // Set today's date as default
    const dateInput = document.getElementById('id_scheduled_date');
    if (dateInput && !dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
    }
    
    // Generate default name based on date
    const nameInput = document.getElementById('id_name');
    if (nameInput && !nameInput.value) {
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        });
        nameInput.value = `Stock Take - ${dateStr}`;
    }
});
</script>
{% endblock %}
