{% extends "base/base.html" %}
{% load static %}
{% load inventory_filters %}

{% block title %}{{ item.name }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
.item-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.detail-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.section-title {
    font-size: 18px;
    font-weight: 600;
    color: #111827;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f3f4f6;
}

.item-image-large {
    width: 100%;
    height: 300px;
    background: #f9fafb;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    border: 1px solid #e5e7eb;
}

.item-image-large img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.stock-status-card {
    text-align: center;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
}

.status-in-stock {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.status-low-stock {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
}

.status-out-of-stock {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
}

.stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.stat-item {
    background: #f9fafb;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    border: 1px solid #e5e7eb;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #111827;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 14px;
    color: #6b7280;
    font-weight: 500;
}

.info-table {
    width: 100%;
}

.info-table th {
    background: #f9fafb;
    padding: 12px;
    font-weight: 600;
    color: #374151;
    border: 1px solid #e5e7eb;
    width: 30%;
}

.info-table td {
    padding: 12px;
    border: 1px solid #e5e7eb;
    color: #111827;
}

.badge-large {
    font-size: 14px;
    padding: 8px 16px;
    border-radius: 20px;
}

.action-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.btn-action {
    flex: 1;
    min-width: 140px;
    padding: 10px 16px;
    font-weight: 500;
    border-radius: 8px;
    transition: all 0.2s;
}

.movement-item {
    display: flex;
    align-items: center;
    justify-content: between;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
}

.movement-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-size: 16px;
}

.movement-in {
    background: #d1fae5;
    color: #065f46;
}

.movement-out {
    background: #fee2e2;
    color: #991b1b;
}

.movement-adjustment {
    background: #dbeafe;
    color: #1e40af;
}

.quick-actions {
    position: sticky;
    top: 20px;
}

.alert-box {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid;
}

.alert-warning {
    background: #fef3c7;
    border-color: #f59e0b;
    color: #92400e;
}

.alert-danger {
    background: #fee2e2;
    border-color: #ef4444;
    color: #991b1b;
}

.chart-container {
    height: 300px;
    position: relative;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="item-header">
        <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-3">
                    <h1 class="h3 mb-0 me-3">{{ item.name }}</h1>
                    <span class="badge badge-large {% if item.is_out_of_stock %}bg-danger{% elif item.is_low_stock %}bg-warning{% else %}bg-success{% endif %}">
                        {% if item.is_out_of_stock %}Out of Stock{% elif item.is_low_stock %}Low Stock{% else %}In Stock{% endif %}
                    </span>
                </div>
                <p class="mb-2 opacity-90">
                    <strong>SKU:</strong> {{ item.sku }} | 
                    <strong>Category:</strong> {{ item.category.name }} | 
                    <strong>Type:</strong> {{ item.get_item_type_display }}
                </p>
                {% if item.description %}
                <p class="mb-0 opacity-80">{{ item.description }}</p>
                {% endif %}
            </div>
            <div class="d-flex gap-2 align-items-start">
                <a href="/business/{{ request.tenant.slug }}/inventory/items/" class="btn btn-light">
                    <i class="fas fa-arrow-left me-2"></i>Back to Items
                </a>
                <div class="btn-group">
                    <button type="button" class="btn btn-light dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-cog me-2"></i>Actions
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/business/{{ request.tenant.slug }}/inventory/items/{{ item.pk }}/edit/">
                            <i class="fas fa-edit me-2"></i>Edit Item
                        </a></li>
                        <li><a class="dropdown-item" href="/business/{{ request.tenant.slug }}/inventory/stock/adjustments/{{ item.pk }}/">
                            <i class="fas fa-adjust me-2"></i>Adjust Stock
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="confirmDelete()">
                            <i class="fas fa-trash me-2"></i>Delete Item
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts -->
    {% if item.is_out_of_stock %}
    <div class="alert-box alert-danger">
        <i class="fas fa-exclamation-circle me-2"></i>
        <strong>Out of Stock:</strong> This item is currently out of stock and needs immediate replenishment.
        <a href="/business/{{ request.tenant.slug }}/inventory/stock/adjustments/{{ item.pk }}/" class="btn btn-sm btn-danger ms-2">
            Add Stock
        </a>
    </div>
    {% elif item.is_low_stock %}
    <div class="alert-box alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Low Stock Alert:</strong> This item is below the minimum stock level ({{ item.minimum_stock_level|floatformat:0 }}).
        <a href="/business/{{ request.tenant.slug }}/inventory/stock/adjustments/{{ item.pk }}/" class="btn btn-sm btn-warning ms-2">
            Add Stock
        </a>
    </div>
    {% endif %}

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Stock Statistics -->
            <div class="detail-card">
                <h2 class="section-title">
                    <i class="fas fa-chart-bar me-2"></i>Stock Overview
                </h2>
                
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value">{{ item.current_stock|floatformat:0 }}</div>
                        <div class="stat-label">Current Stock</div>
                        <small class="text-muted">{{ item.unit.abbreviation }}</small>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ item.minimum_stock_level|floatformat:0 }}</div>
                        <div class="stat-label">Minimum Level</div>
                        <small class="text-muted">{{ item.unit.abbreviation }}</small>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ item.stock_value|currency }}</div>
                        <div class="stat-label">Stock Value</div>
                        <small class="text-muted">Current Ã— Cost</small>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ item.unit_cost|currency }}</div>
                        <div class="stat-label">Unit Cost</div>
                        <small class="text-muted">Per {{ item.unit.abbreviation }}</small>
                    </div>
                </div>
            </div>

            <!-- Item Details -->
            <div class="detail-card">
                <h2 class="section-title">
                    <i class="fas fa-info-circle me-2"></i>Item Information
                </h2>
                
                <table class="info-table">
                    <tr>
                        <th>Name</th>
                        <td>{{ item.name }}</td>
                    </tr>
                    <tr>
                        <th>SKU</th>
                        <td>{{ item.sku }}</td>
                    </tr>
                    <tr>
                        <th>Category</th>
                        <td>{{ item.category.name }}</td>
                    </tr>
                    <tr>
                        <th>Item Type</th>
                        <td>{{ item.get_item_type_display }}</td>
                    </tr>
                    <tr>
                        <th>Unit of Measure</th>
                        <td>{{ item.unit.name }} ({{ item.unit.abbreviation }})</td>
                    </tr>
                    {% if item.barcode %}
                    <tr>
                        <th>Barcode</th>
                        <td>{{ item.barcode }}</td>
                    </tr>
                    {% endif %}
                    {% if item.weight %}
                    <tr>
                        <th>Weight</th>
                        <td>{{ item.weight }} kg</td>
                    </tr>
                    {% endif %}
                    {% if item.dimensions %}
                    <tr>
                        <th>Dimensions</th>
                        <td>{{ item.dimensions }}</td>
                    </tr>
                    {% endif %}
                    {% if item.storage_location %}
                    <tr>
                        <th>Storage Location</th>
                        <td>{{ item.storage_location }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <th>Status</th>
                        <td>
                            {% if item.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Created</th>
                        <td>{{ item.created_at|date:"M d, Y H:i" }}</td>
                    </tr>
                    <tr>
                        <th>Last Updated</th>
                        <td>{{ item.updated_at|date:"M d, Y H:i" }}</td>
                    </tr>
                </table>
            </div>

            <!-- Recent Stock Movements -->
            <div class="detail-card">
                <h2 class="section-title">
                    <i class="fas fa-exchange-alt me-2"></i>Recent Stock Movements
                </h2>
                
                {% if recent_movements %}
                {% for movement in recent_movements %}
                <div class="movement-item">
                    <div class="movement-icon {% if movement.movement_type == 'in' %}movement-in{% elif movement.movement_type == 'out' %}movement-out{% else %}movement-adjustment{% endif %}">
                        {% if movement.movement_type == 'in' %}
                        <i class="fas fa-arrow-up"></i>
                        {% elif movement.movement_type == 'out' %}
                        <i class="fas fa-arrow-down"></i>
                        {% else %}
                        <i class="fas fa-edit"></i>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-medium">{{ movement.get_movement_type_display }}</div>
                        <small class="text-muted">{{ movement.created_at|date:"M d, Y H:i" }}</small>
                        {% if movement.reference %}
                        <br><small class="text-muted">Ref: {{ movement.reference }}</small>
                        {% endif %}
                    </div>
                    <div class="text-end">
                        <div class="fw-medium {% if movement.movement_type == 'in' %}text-success{% elif movement.movement_type == 'out' %}text-danger{% endif %}">
                            {% if movement.movement_type == 'in' %}+{% elif movement.movement_type == 'out' %}-{% endif %}{{ movement.quantity|floatformat:0 }}
                        </div>
                        <small class="text-muted">{{ item.unit.abbreviation }}</small>
                    </div>
                </div>
                {% endfor %}
                <div class="text-center mt-3">
                    <a href="/business/{{ request.tenant.slug }}/inventory/stock/movements/?item={{ item.pk }}" class="btn btn-outline-primary btn-sm">
                        View All Movements
                    </a>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No stock movements recorded yet</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Item Image -->
            <div class="detail-card">
                <div class="item-image-large">
                    {% if item.image %}
                    <img src="{{ item.image.url }}" alt="{{ item.name }}">
                    {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-box fa-4x mb-3"></i>
                        <p>No image available</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="detail-card quick-actions">
                <h3 class="section-title">Quick Actions</h3>
                
                <div class="action-buttons">
                    <a href="/business/{{ request.tenant.slug }}/inventory/items/{{ item.pk }}/edit/" class="btn btn-action btn-primary">
                        <i class="fas fa-edit me-2"></i>Edit Item
                    </a>
                    <a href="/business/{{ request.tenant.slug }}/inventory/stock/adjustments/{{ item.pk }}/" class="btn btn-action btn-success">
                        <i class="fas fa-plus me-2"></i>Add Stock
                    </a>
                    <a href="/business/{{ request.tenant.slug }}/services/quick-order/?add_item={{ item.pk }}" class="btn btn-action btn-info">
                        <i class="fas fa-shopping-cart me-2"></i>Quick Order
                    </a>
                    <button class="btn btn-action btn-outline-primary" onclick="printBarcode()">
                        <i class="fas fa-barcode me-2"></i>Print Barcode
                    </button>
                </div>
            </div>

            <!-- Pricing Info -->
            <div class="detail-card">
                <h3 class="section-title">Pricing Information</h3>
                
                <table class="info-table">
                    <tr>
                        <th>Unit Cost</th>
                        <td>{{ item.unit_cost|currency }}</td>
                    </tr>
                    <tr>
                        <th>Selling Price</th>
                        <td>{{ item.selling_price|currency }}</td>
                    </tr>
                    <tr>
                        <th>Profit per Unit</th>
                        <td class="{% if item.selling_price > item.unit_cost %}text-success{% else %}text-danger{% endif %}">
                            {{ item.selling_price|subtract:item.unit_cost|currency }}
                        </td>
                    </tr>
                    {% if item.selling_price > 0 and item.unit_cost > 0 %}
                    <tr>
                        <th>Margin %</th>
                        <td>
                            {{ item.selling_price|profit_margin:item.unit_cost }}%
                        </td>
                    </tr>
                    {% endif %}
                </table>
            </div>

            <!-- Stock Alerts -->
            {% if item.needs_reorder %}
            <div class="detail-card">
                <h3 class="section-title text-warning">Reorder Alert</h3>
                <p class="text-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Stock has reached reorder point ({{ item.reorder_point|floatformat:0 }}).
                </p>
                <p><strong>Suggested Order:</strong> {{ item.reorder_quantity|floatformat:0 }} {{ item.unit.abbreviation }}</p>
                {% if item.primary_supplier %}
                <p><strong>Supplier:</strong> {{ item.primary_supplier.name }}</p>
                {% endif %}
                <a href="/business/{{ request.tenant.slug }}/suppliers/purchase-orders/create/?item={{ item.pk }}" class="btn btn-warning btn-sm">
                    <i class="fas fa-shopping-cart me-1"></i>Create Purchase Order
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function confirmDelete() {
    if (confirm('Are you sure you want to delete this item? This action cannot be undone.')) {
        // Create form to submit delete request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/business/{{ request.tenant.slug }}/inventory/items/{{ item.pk }}/delete/';
        
        // Add CSRF token
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = '{{ csrf_token }}';
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

function printBarcode() {
    // Open barcode print window
    window.open('/business/{{ request.tenant.slug }}/inventory/items/{{ item.pk }}/barcode/', 'barcode', 'width=400,height=300');
}

// Stock level chart would go here if needed
document.addEventListener('DOMContentLoaded', function() {
    // Initialize any charts or interactive elements
});
</script>
{% endblock %}
