{% extends 'base/base.html' %}
{% load inventory_filters %}

{% block title %}Daily Operations Dashboard - Inventory{% endblock %}

{% block extra_css %}
<style>
    .page-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: calc(100vh - 100px);
        padding: 40px 0;
    }
    
    .operations-header {
        background: white;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
    }
    
    .operations-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(90deg, #fd7e14, #ffc107);
    }
    
    .date-info {
        display: flex;
        align-items: center;
        justify-content: between;
        margin-bottom: 20px;
    }
    
    .current-date {
        font-size: 1.8rem;
        font-weight: 700;
        color: #333;
        margin: 0;
    }
    
    .shift-info {
        background: rgba(253, 126, 20, 0.1);
        color: #fd7e14;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .operations-status {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .status-card {
        text-align: center;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 15px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    .status-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .status-card.active {
        background: rgba(40, 167, 69, 0.1);
        border-color: #28a745;
        color: #155724;
    }
    
    .status-card.pending {
        background: rgba(255, 193, 7, 0.1);
        border-color: #ffc107;
        color: #856404;
    }
    
    .status-card.completed {
        background: rgba(23, 162, 184, 0.1);
        border-color: #17a2b8;
        color: #0c5460;
    }
    
    .status-value {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 5px;
    }
    
    .status-label {
        font-size: 0.9rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .operations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }
    
    .operation-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .operation-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
    }
    
    .bay-operations-card::before {
        background: linear-gradient(90deg, #28a745, #20c997);
    }
    
    .consumption-card::before {
        background: linear-gradient(90deg, #dc3545, #e83e8c);
    }
    
    .transfer-card::before {
        background: linear-gradient(90deg, #007bff, #6f42c1);
    }
    
    .reconciliation-card::before {
        background: linear-gradient(90deg, #fd7e14, #ffc107);
    }
    
    .card-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .card-content {
        margin-bottom: 20px;
    }
    
    .bay-list {
        display: grid;
        gap: 12px;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .bay-item {
        display: flex;
        justify-content: between;
        align-items: center;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 10px;
        border: 1px solid #e9ecef;
        transition: background-color 0.3s ease;
    }
    
    .bay-item:hover {
        background: #e9ecef;
    }
    
    .bay-name {
        font-weight: 600;
        color: #333;
    }
    
    .bay-status {
        font-size: 0.8rem;
        padding: 4px 8px;
        border-radius: 10px;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .bay-status.occupied {
        background: rgba(40, 167, 69, 0.1);
        color: #28a745;
    }
    
    .bay-status.available {
        background: rgba(108, 117, 125, 0.1);
        color: #6c757d;
    }
    
    .bay-status.maintenance {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }
    
    .consumption-list {
        max-height: 180px;
        overflow-y: auto;
    }
    
    .consumption-item {
        display: flex;
        justify-content: between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f1f3f4;
    }
    
    .consumption-item:last-child {
        border-bottom: none;
    }
    
    .item-name {
        font-weight: 600;
        color: #333;
        font-size: 0.9rem;
    }
    
    .quantity-consumed {
        font-weight: 600;
        color: #dc3545;
        font-size: 0.9rem;
    }
    
    .card-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .btn {
        padding: 10px 16px;
        border-radius: 8px;
        font-weight: 500;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.9rem;
        flex: 1;
        justify-content: center;
        min-width: 120px;
    }
    
    .btn-primary {
        background: #6f42c1;
        color: white;
    }
    
    .btn-primary:hover {
        background: #6610f2;
        color: white;
        transform: translateY(-1px);
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background: #218838;
        color: white;
        transform: translateY(-1px);
    }
    
    .btn-info {
        background: #17a2b8;
        color: white;
    }
    
    .btn-info:hover {
        background: #138496;
        color: white;
        transform: translateY(-1px);
    }
    
    .btn-warning {
        background: #ffc107;
        color: #212529;
    }
    
    .btn-warning:hover {
        background: #e0a800;
        color: #212529;
        transform: translateY(-1px);
    }
    
    .btn-outline {
        background: white;
        color: #6c757d;
        border: 1px solid #dee2e6;
    }
    
    .btn-outline:hover {
        background: #f8f9fa;
        color: #495057;
        border-color: #adb5bd;
    }
    
    .empty-state {
        text-align: center;
        padding: 30px;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 2.5rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }
    
    .alert {
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .alert-info {
        background: rgba(23, 162, 184, 0.1);
        color: #0c5460;
        border: 1px solid rgba(23, 162, 184, 0.3);
    }
    
    .alert-warning {
        background: rgba(255, 193, 7, 0.1);
        color: #856404;
        border: 1px solid rgba(255, 193, 7, 0.3);
    }
    
    .alert-success {
        background: rgba(40, 167, 69, 0.1);
        color: #155724;
        border: 1px solid rgba(40, 167, 69, 0.3);
    }
    
    .quick-stats {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
    }
    
    .stat-item {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
    }
    
    .stat-value {
        display: block;
        font-size: 1.8rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 0.8rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
    }
    
    .breadcrumb {
        background: transparent;
        padding: 0;
        margin: 0 0 8px 0;
        font-size: 0.9rem;
    }
    
    .breadcrumb-item a {
        color: rgba(255,255,255,0.8);
        text-decoration: none;
    }
    
    .breadcrumb-item a:hover {
        color: white;
    }
    
    .breadcrumb-item.active {
        color: rgba(255,255,255,0.6);
    }
    
    .page-header {
        color: white;
        margin-bottom: 40px;
        text-align: center;
    }
    
    .page-header h1 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: 700;
    }
    
    .page-header p {
        margin: 8px 0 0 0;
        opacity: 0.9;
        font-size: 1.1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="container-fluid">
        <!-- Page Header -->
        <div class="page-header">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb justify-content-center">
                    <li class="breadcrumb-item">
                        <a href="/business/{{ request.tenant.slug }}/dashboard/">Dashboard</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="/business/{{ request.tenant.slug }}/inventory/">Inventory</a>
                    </li>
                    <li class="breadcrumb-item active">Daily Operations</li>
                </ol>
            </nav>
            <h1>Daily Operations Dashboard</h1>
            <p>Comprehensive inventory management for {{ today|date:"F d, Y" }}</p>
        </div>

        <!-- Operations Header -->
        <div class="operations-header">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h2 class="current-date">{{ today|date:"l, F d, Y" }}</h2>
                    {% if shift_supervisor %}
                    <div class="shift-info">
                        <i class="fas fa-user-tie"></i>
                        Shift Supervisor: {{ shift_supervisor.user.get_full_name }}
                    </div>
                    {% endif %}
                </div>
                <div class="d-flex gap-3">
                    {% if not reconciliation_completed %}
                    <a href="/business/{{ request.tenant.slug }}/inventory/daily-operations/reconciliation/start/" class="btn btn-warning">
                        <i class="fas fa-calculator"></i>
                        Start Reconciliation
                    </a>
                    {% endif %}
                    <a href="/business/{{ request.tenant.slug }}/inventory/" class="btn btn-outline">
                        <i class="fas fa-boxes"></i>
                        Inventory
                    </a>
                </div>
            </div>
            
            <div class="operations-status">
                <div class="status-card {% if bay_operations %}active{% else %}pending{% endif %}">
                    <div class="status-value">{{ active_bays|default:0 }}</div>
                    <div class="status-label">Active Bays</div>
                </div>
                <div class="status-card {% if total_consumption > 0 %}active{% else %}pending{% endif %}">
                    <div class="status-value">{{ total_consumption|currency }}</div>
                    <div class="status-label">Consumption Value</div>
                </div>
                <div class="status-card {% if completed_services > 0 %}active{% else %}pending{% endif %}">
                    <div class="status-value">{{ completed_services|default:0 }}</div>
                    <div class="status-label">Services Completed</div>
                </div>
                <div class="status-card {% if reconciliation_completed %}completed{% else %}pending{% endif %}">
                    <div class="status-value">{% if reconciliation_completed %}✓{% else %}—{% endif %}</div>
                    <div class="status-label">Reconciliation</div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        {% if daily_stats %}
        <div class="quick-stats">
            <h3 class="card-title">
                <i class="fas fa-chart-line"></i>
                Today's Performance
            </h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-value">{{ daily_stats.revenue|currency }}</span>
                    <span class="stat-label">Revenue</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">{{ daily_stats.customers_served|default:0 }}</span>
                    <span class="stat-label">Customers</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">{{ daily_stats.items_consumed|default:0 }}</span>
                    <span class="stat-label">Items Used</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">{{ daily_stats.efficiency|default:0 }}%</span>
                    <span class="stat-label">Efficiency</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">{{ daily_stats.average_service_time|default:0 }}</span>
                    <span class="stat-label">Avg Time (min)</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">{{ daily_stats.staff_present|default:0 }}</span>
                    <span class="stat-label">Staff Present</span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Alerts -->
        {% if low_stock_alerts %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <strong>Low Stock Alert:</strong> {{ low_stock_alerts|length }} item{{ low_stock_alerts|pluralize }} 
                need restocking before end of shift.
                <a href="/business/{{ request.tenant.slug }}/inventory/alerts/" class="ms-2">View Details</a>
            </div>
        </div>
        {% endif %}

        <!-- Operations Grid -->
        <div class="operations-grid">
            <!-- Bay Operations -->
            <div class="operation-card bay-operations-card">
                <h3 class="card-title">
                    <i class="fas fa-car-wash"></i>
                    Bay Operations
                </h3>
                
                <div class="card-content">
                    {% if service_bays %}
                    <div class="bay-list">
                        {% for bay in service_bays %}
                        <div class="bay-item">
                            <div class="bay-name">{{ bay.name }}</div>
                            <div class="bay-status {{ bay.status|lower }}">
                                {% if bay.status == 'occupied' %}
                                <i class="fas fa-car"></i> Occupied
                                {% elif bay.status == 'available' %}
                                <i class="fas fa-check"></i> Available
                                {% else %}
                                <i class="fas fa-tools"></i> Maintenance
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <i class="fas fa-car-wash"></i>
                        <p>No service bays configured</p>
                    </div>
                    {% endif %}
                </div>
                
                <div class="card-actions">
                    <a href="/business/{{ request.tenant.slug }}/inventory/daily-operations/allocate/" class="btn btn-success">
                        <i class="fas fa-arrow-right"></i>
                        Allocate Items
                    </a>
                    <a href="/business/{{ request.tenant.slug }}/services/" class="btn btn-outline">
                        <i class="fas fa-cog"></i>
                        Manage Bays
                    </a>
                </div>
            </div>

            <!-- Consumption Tracking -->
            <div class="operation-card consumption-card">
                <h3 class="card-title">
                    <i class="fas fa-chart-line"></i>
                    Item Consumption
                </h3>
                
                <div class="card-content">
                    {% if recent_consumption %}
                    <div class="consumption-list">
                        {% for consumption in recent_consumption %}
                        <div class="consumption-item">
                            <div class="item-name">{{ consumption.inventory_item.name }}</div>
                            <div class="quantity-consumed">
                                -{{ consumption.quantity_consumed|floatformat:1 }} {{ consumption.inventory_item.unit.abbreviation }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <i class="fas fa-chart-line"></i>
                        <p>No consumption recorded today</p>
                    </div>
                    {% endif %}
                </div>
                
                <div class="card-actions">
                    <a href="/business/{{ request.tenant.slug }}/inventory/daily-operations/consumption/" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        Record Usage
                    </a>
                    <a href="/business/{{ request.tenant.slug }}/inventory/stock/movements/" class="btn btn-outline">
                        <i class="fas fa-list"></i>
                        View History
                    </a>
                </div>
            </div>

            <!-- Inventory Transfers -->
            <div class="operation-card transfer-card">
                <h3 class="card-title">
                    <i class="fas fa-exchange-alt"></i>
                    Inventory Transfers
                </h3>
                
                <div class="card-content">
                    {% if recent_transfers %}
                    <div class="consumption-list">
                        {% for transfer in recent_transfers %}
                        <div class="consumption-item">
                            <div class="item-name">{{ transfer.item.name }}</div>
                            <div class="quantity-consumed">
                                {{ transfer.quantity|floatformat:1 }} {{ transfer.item.unit.abbreviation }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <i class="fas fa-exchange-alt"></i>
                        <p>No transfers recorded today</p>
                    </div>
                    {% endif %}
                </div>
                
                <div class="card-actions">
                    <a href="/business/{{ request.tenant.slug }}/inventory/daily-operations/transfer/" class="btn btn-info">
                        <i class="fas fa-arrows-alt-h"></i>
                        Transfer Items
                    </a>
                    <a href="/business/{{ request.tenant.slug }}/inventory/daily-operations/return/" class="btn btn-outline">
                        <i class="fas fa-undo"></i>
                        Return to Stock
                    </a>
                </div>
            </div>

            <!-- End-of-Day Reconciliation -->
            <div class="operation-card reconciliation-card">
                <h3 class="card-title">
                    <i class="fas fa-calculator"></i>
                    Reconciliation
                </h3>
                
                <div class="card-content">
                    {% if reconciliation_started %}
                        {% if reconciliation_completed %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <div>
                                <strong>Reconciliation Complete</strong><br>
                                Variance: {{ reconciliation.total_variance|currency }}
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-clock"></i>
                            <div>
                                <strong>Reconciliation In Progress</strong><br>
                                {{ reconciliation.completed_items }}/{{ reconciliation.total_items }} items checked
                            </div>
                        </div>
                        {% endif %}
                    {% else %}
                    <div class="empty-state">
                        <i class="fas fa-calculator"></i>
                        <p>Reconciliation not started</p>
                        <small>Verify actual vs system stock levels</small>
                    </div>
                    {% endif %}
                </div>
                
                <div class="card-actions">
                    {% if not reconciliation_started %}
                    <a href="/business/{{ request.tenant.slug }}/inventory/daily-operations/reconciliation/start/" class="btn btn-warning">
                        <i class="fas fa-play"></i>
                        Start Reconciliation
                    </a>
                    {% elif not reconciliation_completed %}
                    <a href="/business/{{ request.tenant.slug }}/inventory/daily-operations/reconciliation/complete/" class="btn btn-success">
                        <i class="fas fa-check"></i>
                        Complete
                    </a>
                    {% else %}
                    <a href="/business/{{ request.tenant.slug }}/inventory/reports/reconciliation/" class="btn btn-outline">
                        <i class="fas fa-file-alt"></i>
                        View Report
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-refresh every 5 minutes
setTimeout(function() {
    window.location.reload();
}, 300000);

// Real-time bay status updates (if needed)
function updateBayStatus() {
    fetch('/business/{{ request.tenant.slug }}/inventory/ajax/bay-status/')
        .then(response => response.json())
        .then(data => {
            // Update bay statuses
            data.bays.forEach(bay => {
                const bayElement = document.querySelector(`[data-bay-id="${bay.id}"]`);
                if (bayElement) {
                    const statusElement = bayElement.querySelector('.bay-status');
                    statusElement.className = `bay-status ${bay.status.toLowerCase()}`;
                    statusElement.innerHTML = getBayStatusHTML(bay.status);
                }
            });
        })
        .catch(error => console.error('Error updating bay status:', error));
}

function getBayStatusHTML(status) {
    switch(status) {
        case 'occupied':
            return '<i class="fas fa-car"></i> Occupied';
        case 'available':
            return '<i class="fas fa-check"></i> Available';
        default:
            return '<i class="fas fa-tools"></i> Maintenance';
    }
}

// Update bay status every 30 seconds
setInterval(updateBayStatus, 30000);
</script>
{% endblock %}
