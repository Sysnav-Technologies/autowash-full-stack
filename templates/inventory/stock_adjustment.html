{% extends 'base/base.html' %}
{% load static %}
{% load humanize %}
{% load inventory_filters %}

{% block title %}Stock Adjustment - {{ request.tenant.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/inventory.css' %}">
<style>
    .adjustment-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .adjustment-form .card {
        border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        border-radius: 12px;
    }
    
    .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px 12px 0 0 !important;
        padding: 20px 25px;
    }
    
    .card-header h5 {
        margin: 0;
        font-weight: 500;
    }
    
    .item-search-container {
        position: relative;
    }
    
    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    
    .search-result-item {
        padding: 15px 20px;
        cursor: pointer;
        border-bottom: 1px solid #f1f3f4;
        transition: background-color 0.2s ease;
    }
    
    .search-result-item:last-child {
        border-bottom: none;
    }
    
    .search-result-item:hover {
        background: #f8f9fa;
    }
    
    .search-result-item .item-name {
        font-weight: 500;
        color: #333;
    }
    
    .search-result-item .item-meta {
        font-size: 0.9rem;
        color: #6c757d;
        margin-top: 4px;
    }
    
    .selected-item-display {
        background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
        border: 1px solid #bbdefb;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
    }
    
    .item-avatar {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 600;
    }
    
    .calculation-preview {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 20px;
        margin-top: 25px;
    }
    
    .calculation-row {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 15px 0;
        font-size: 1.1rem;
    }
    
    .calculation-symbol {
        margin: 0 20px;
        font-size: 1.5rem;
        font-weight: 600;
        color: #667eea;
    }
    
    .recent-adjustments {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .adjustment-item {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }
    
    .adjustment-item:hover {
        border-color: #667eea;
        box-shadow: 0 2px 10px rgba(102, 126, 234, 0.1);
    }
    
    .adjustment-badge {
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .adjustment-badge.increase {
        background: rgba(40, 167, 69, 0.1);
        color: #28a745;
        border: 1px solid rgba(40, 167, 69, 0.2);
    }
    
    .adjustment-badge.decrease {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
        border: 1px solid rgba(220, 53, 69, 0.2);
    }
    
    .guidelines-card {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        border: 1px solid #ffeeba;
        border-radius: 12px;
    }
    
    .guidelines-card .card-header {
        background: transparent;
        color: #856404;
        border-bottom: 1px solid #ffeaa7;
    }
    
    .btn-clear-selection {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        color: #6c757d;
        border-radius: 6px;
        padding: 8px 15px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }
    
    .btn-clear-selection:hover {
        background: #e9ecef;
        color: #495057;
        border-color: #adb5bd;
    }
    
    .quantity-input-group {
        position: relative;
    }
    
    .quantity-unit {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        font-weight: 500;
        pointer-events: none;
    }
    
    .form-control.with-unit {
        padding-right: 60px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid adjustment-container">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">Stock Adjustment</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="/business/{{ request.tenant.slug }}/dashboard/">Dashboard</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="/business/{{ request.tenant.slug }}/inventory/">Inventory</a>
                    </li>
                    <li class="breadcrumb-item active">Stock Adjustment</li>
                </ol>
            </nav>
        </div>
        <div class="d-flex gap-2">
            <a href="/business/{{ request.tenant.slug }}/inventory/stock/movements/" class="btn btn-outline-info">
                <i class="fas fa-list"></i>
                View Movements
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <!-- Adjustment Form -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-edit"></i>
                        Create Stock Adjustment
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" class="adjustment-form">
                        {% csrf_token %}
                        <input type="hidden" name="adjustment_type" value="manual">
                        
                        {% if not item %}
                        <!-- Item Selection -->
                        <div class="form-group mb-4">
                            <label class="form-label">
                                Select Item <span class="text-danger">*</span>
                            </label>
                            <div class="item-search-container">
                                <input type="text" 
                                       class="form-control" 
                                       id="item-search" 
                                       placeholder="Search by name, SKU, or barcode..."
                                       autocomplete="off">
                                <div class="search-results" id="item-search-results"></div>
                                <input type="hidden" name="item" id="selected-item-id">
                            </div>
                        </div>
                        
                        <!-- Selected Item Display -->
                        <div class="selected-item-display" id="selected-item-display" style="display: none;">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <div class="item-avatar me-3">
                                        <i class="fas fa-box"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-1" id="selected-item-name">Item Name</h5>
                                        <div class="text-muted">
                                            <span class="me-3">SKU: <span id="selected-item-sku">-</span></span>
                                            <span class="me-3">Stock: <span id="selected-item-stock">0</span> <span id="selected-item-unit">units</span></span>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" class="btn-clear-selection" onclick="clearItemSelection()">
                                    <i class="fas fa-times"></i>
                                    Change
                                </button>
                            </div>
                        </div>
                        {% else %}
                        <!-- Pre-selected Item -->
                        <input type="hidden" name="item" value="{{ item.id }}">
                        <div class="selected-item-display">
                            <div class="d-flex align-items-center">
                                <div class="item-avatar me-3">
                                    {{ item.name|first|upper }}
                                </div>
                                <div>
                                    <h5 class="mb-1">{{ item.name }}</h5>
                                    <div class="text-muted">
                                        <span class="me-3">SKU: {{ item.sku }}</span>
                                        <span class="me-3">Current Stock: {{ item.current_stock }} {{ item.unit.abbreviation }}</span>
                                        <span>Cost: {{ item.unit_cost|currency }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Adjustment Details -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        Quantity Adjustment <span class="text-danger">*</span>
                                    </label>
                                    <div class="quantity-input-group">
                                        <input type="number" 
                                               name="quantity" 
                                               class="form-control with-unit" 
                                               placeholder="Enter quantity (+ or -)"
                                               step="0.01"
                                               required>
                                        <span class="quantity-unit" id="quantity-unit">units</span>
                                    </div>
                                    <small class="form-text text-muted">
                                        Use positive numbers to increase stock, negative to decrease
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">
                                        Unit Cost <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">KSH</span>
                                        <input type="number" 
                                               name="unit_cost" 
                                               class="form-control" 
                                               placeholder="0.00"
                                               step="0.01"
                                               min="0"
                                               required>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Reason -->
                        <div class="form-group mb-4">
                            <label class="form-label">
                                Reason <span class="text-danger">*</span>
                            </label>
                            <textarea name="reason" 
                                      class="form-control" 
                                      rows="3" 
                                      placeholder="Explain why this adjustment is needed..."
                                      required></textarea>
                        </div>
                        
                        <!-- Calculation Preview -->
                        <div class="calculation-preview" id="calculation-preview" style="display: none;">
                            <h6 class="mb-3">
                                <i class="fas fa-calculator"></i>
                                Adjustment Preview
                            </h6>
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <div class="mb-2">
                                        <div class="h5 mb-1" id="current-stock-display">-</div>
                                        <small class="text-muted">Current Stock</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-2">
                                        <div class="h5 mb-1" id="adjustment-quantity-display">-</div>
                                        <small class="text-muted">Adjustment</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-2">
                                        <div class="h5 mb-1" id="new-stock-display">-</div>
                                        <small class="text-muted">New Stock</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between">
                            <a href="{% if item %}/business/{{ request.tenant.slug }}/inventory/items/{{ item.id }}/{% else %}/business/{{ request.tenant.slug }}/inventory/{% endif %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i>
                                Cancel
                            </a>
                            <button type="submit" class="btn btn-primary" id="submit-btn" disabled>
                                <i class="fas fa-save"></i>
                                Create Adjustment
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Recent Adjustments -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-history"></i>
                        Recent Adjustments
                    </h6>
                </div>
                <div class="card-body">
                    <div class="recent-adjustments" id="recent-adjustments">
                        <div class="text-center py-4">
                            <i class="fas fa-clock fa-2x text-muted mb-3"></i>
                            <p class="text-muted">Select an item to view recent adjustments</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Guidelines -->
            <div class="card guidelines-card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle"></i>
                        Guidelines
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-plus text-success me-2"></i>
                            <strong>Positive quantities</strong> increase stock
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-minus text-danger me-2"></i>
                            <strong>Negative quantities</strong> decrease stock
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-file-alt text-info me-2"></i>
                            <strong>Always provide</strong> a clear reason
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-primary me-2"></i>
                            <strong>Double-check</strong> quantities before saving
                        </li>
                    </ul>
                    
                    <hr>
                    
                    <h6>Common Adjustment Types:</h6>
                    <ul class="list-unstyled small">
                        <li><strong>Stock In:</strong> Receiving inventory, returns</li>
                        <li><strong>Stock Out:</strong> Sales, damage, theft</li>
                        <li><strong>Correction:</strong> Count discrepancies</li>
                        <li><strong>Transfer:</strong> Location changes</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let selectedItem = null;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize form
    {% if item %}
        selectedItem = {
            id: '{{ item.id }}',
            name: '{{ item.name }}',
            sku: '{{ item.sku }}',
            current_stock: {{ item.current_stock }},
            unit: '{{ item.unit.abbreviation }}',
            unit_cost: {{ item.unit_cost }}
        };
        updateCalculationPreview();
        loadRecentAdjustments(selectedItem.id);
    {% endif %}
    
    // Quantity and unit cost change handlers
    const quantityInput = document.querySelector('input[name="quantity"]');
    const unitCostInput = document.querySelector('input[name="unit_cost"]');
    
    if (quantityInput) {
        quantityInput.addEventListener('input', updateCalculationPreview);
    }
    if (unitCostInput) {
        unitCostInput.addEventListener('input', updateCalculationPreview);
    }
    
    // Item search functionality
    const itemSearch = document.getElementById('item-search');
    if (itemSearch) {
        itemSearch.addEventListener('input', debounce(searchItems, 300));
        
        // Hide search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.item-search-container')) {
                document.getElementById('item-search-results').style.display = 'none';
            }
        });
    }
});

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function searchItems() {
    const query = document.getElementById('item-search').value.trim();
    const resultsDiv = document.getElementById('item-search-results');
    
    if (query.length < 2) {
        resultsDiv.style.display = 'none';
        return;
    }
    
    // Fetch with proper AJAX headers
    fetch(`/business/{{ request.tenant.slug }}/inventory/ajax/items/search/?q=${encodeURIComponent(query)}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            displaySearchResults(data.items || []);
        })
        .catch(error => {
            console.error('Search error:', error);
            resultsDiv.innerHTML = '<div class="search-result-item">Error searching items</div>';
            resultsDiv.style.display = 'block';
        });
}

function displaySearchResults(items) {
    const resultsDiv = document.getElementById('item-search-results');
    
    if (items.length === 0) {
        resultsDiv.innerHTML = '<div class="search-result-item">No items found</div>';
    } else {
        resultsDiv.innerHTML = items.map(item => `
            <div class="search-result-item" onclick="selectItem('${item.id}', '${item.name}', '${item.sku}', ${item.current_stock}, '${item.unit_abbreviation}', ${item.unit_cost})">
                <div class="item-name">${item.name}</div>
                <div class="item-meta">SKU: ${item.sku} • Stock: ${item.current_stock} ${item.unit_abbreviation}</div>
            </div>
        `).join('');
    }
    
    resultsDiv.style.display = 'block';
}

function selectItem(id, name, sku, currentStock, unit, unitCost) {
    selectedItem = {
        id: id,
        name: name,
        sku: sku,
        current_stock: currentStock,
        unit: unit,
        unit_cost: unitCost
    };
    
    // Update hidden field
    document.getElementById('selected-item-id').value = id;
    
    // Update display
    document.getElementById('selected-item-name').textContent = name;
    document.getElementById('selected-item-sku').textContent = sku;
    document.getElementById('selected-item-stock').textContent = currentStock;
    document.getElementById('selected-item-unit').textContent = unit;
    
    // Update unit in quantity input
    document.getElementById('quantity-unit').textContent = unit;
    
    // Set unit cost
    document.querySelector('input[name="unit_cost"]').value = unitCost;
    
    // Show selected item display
    document.getElementById('selected-item-display').style.display = 'block';
    document.getElementById('item-search').style.display = 'none';
    document.getElementById('item-search-results').innerHTML = '';
    
    // Load recent adjustments
    loadRecentAdjustments(id);
    
    // Update calculation preview
    updateCalculationPreview();
}

function clearItemSelection() {
    selectedItem = null;
    document.getElementById('selected-item-id').value = '';
    document.getElementById('selected-item-display').style.display = 'none';
    document.getElementById('item-search').style.display = 'block';
    document.getElementById('item-search').value = '';
    document.getElementById('calculation-preview').style.display = 'none';
    document.getElementById('submit-btn').disabled = true;
    
    // Clear recent adjustments
    document.getElementById('recent-adjustments').innerHTML = `
        <div class="text-center py-4">
            <i class="fas fa-clock fa-2x text-muted mb-3"></i>
            <p class="text-muted">Select an item to view recent adjustments</p>
        </div>
    `;
}

function updateCalculationPreview() {
    if (!selectedItem) return;
    
    const quantityInput = document.querySelector('input[name="quantity"]');
    const quantity = parseFloat(quantityInput.value) || 0;
    
    if (quantity !== 0) {
        const currentStock = selectedItem.current_stock;
        const newStock = currentStock + quantity;
        
        document.getElementById('current-stock-display').textContent = `${currentStock} ${selectedItem.unit}`;
        document.getElementById('adjustment-quantity-display').textContent = `${quantity > 0 ? '+' : ''}${quantity} ${selectedItem.unit}`;
        document.getElementById('new-stock-display').textContent = `${newStock} ${selectedItem.unit}`;
        
        // Color coding
        const newStockElement = document.getElementById('new-stock-display');
        if (newStock < 0) {
            newStockElement.className = 'h5 mb-1 text-danger';
        } else if (newStock === 0) {
            newStockElement.className = 'h5 mb-1 text-warning';
        } else {
            newStockElement.className = 'h5 mb-1 text-success';
        }
        
        document.getElementById('calculation-preview').style.display = 'block';
        document.getElementById('submit-btn').disabled = false;
    } else {
        document.getElementById('calculation-preview').style.display = 'none';
        document.getElementById('submit-btn').disabled = true;
    }
}

function loadRecentAdjustments(itemId) {
    fetch(`/business/{{ request.tenant.slug }}/inventory/ajax/recent-adjustments/?item_id=${itemId}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            displayRecentAdjustments(data.adjustments || []);
        })
        .catch(error => {
            console.error('Error loading recent adjustments:', error);
            document.getElementById('recent-adjustments').innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                    <p class="text-muted">Unable to load recent adjustments</p>
                </div>
            `;
        });
}

function displayRecentAdjustments(adjustments) {
    const container = document.getElementById('recent-adjustments');
    
    if (adjustments.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-history fa-2x text-muted mb-3"></i>
                <p class="text-muted">No recent adjustments</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = adjustments.map(adj => `
        <div class="adjustment-item">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="adjustment-badge ${adj.quantity > 0 ? 'increase' : 'decrease'}">
                    ${adj.quantity > 0 ? '+' : ''}${adj.quantity} ${adj.unit}
                </span>
                <small class="text-muted">${adj.date}</small>
            </div>
            <div class="small text-muted">${adj.reason}</div>
            <div class="small text-muted">By: ${adj.created_by}</div>
        </div>
    `).join('');
}
</script>
{% endblock %}
