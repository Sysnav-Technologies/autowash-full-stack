{% extends 'base/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ stock_take.reference }} - Stock Take Detail - {{ request.tenant.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/inventory.css' %}">
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <div class="page-breadcrumb">
            <a href="/business/{{ request.tenant.slug }}/inventory/" class="breadcrumb-link">Inventory</a>
            <i class="fas fa-chevron-right"></i>
            <a href="/business/{{ request.tenant.slug }}/inventory/stock-takes/" class="breadcrumb-link">Stock Takes</a>
            <i class="fas fa-chevron-right"></i>
            <span class="breadcrumb-current">{{ stock_take.reference }}</span>
        </div>
        <h1 class="page-title">
            <i class="fas fa-clipboard-check"></i>
            {{ stock_take.reference }}
            {% if stock_take.status == 'draft' %}
                <span class="badge bg-secondary ms-2">Draft</span>
            {% elif stock_take.status == 'in_progress' %}
                <span class="badge bg-warning ms-2">In Progress</span>
            {% elif stock_take.status == 'completed' %}
                <span class="badge bg-success ms-2">Completed</span>
            {% endif %}
        </h1>
        <div class="page-actions">
            {% if stock_take.status == 'draft' %}
                <form method="post" action="/business/{{ request.tenant.slug }}/inventory/stock-takes/{{ stock_take.id }}/start/" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary" onclick="return confirm('Start this stock take? This action cannot be undone.')">
                        <i class="fas fa-play"></i>
                        Start Stock Take
                    </button>
                </form>
            {% elif stock_take.status == 'in_progress' %}
                <form method="post" action="/business/{{ request.tenant.slug }}/inventory/stock-takes/{{ stock_take.id }}/complete/" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning" onclick="return confirm('Complete this stock take? Any uncounted items will be marked as zero.')">
                        <i class="fas fa-check"></i>
                        Complete Stock Take
                    </button>
                </form>
            {% elif stock_take.status == 'completed' %}
                <a href="/business/{{ request.tenant.slug }}/inventory/stock-takes/{{ stock_take.id }}/report/" class="btn btn-primary">
                    <i class="fas fa-file-alt"></i>
                    View Report
                </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Stock Take Information -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Stock Take Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td class="fw-semibold">Reference:</td>
                                <td>{{ stock_take.reference }}</td>
                            </tr>
                            <tr>
                                <td class="fw-semibold">Description:</td>
                                <td>{{ stock_take.description }}</td>
                            </tr>
                            <tr>
                                <td class="fw-semibold">Status:</td>
                                <td>
                                    {% if stock_take.status == 'draft' %}
                                        <span class="badge bg-secondary">Draft</span>
                                    {% elif stock_take.status == 'in_progress' %}
                                        <span class="badge bg-warning">In Progress</span>
                                    {% elif stock_take.status == 'completed' %}
                                        <span class="badge bg-success">Completed</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="fw-semibold">Total Items:</td>
                                <td>{{ stock_take.items_count }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <td class="fw-semibold">Created:</td>
                                <td>{{ stock_take.created_at|date:"M d, Y H:i" }}</td>
                            </tr>
                            <tr>
                                <td class="fw-semibold">Created By:</td>
                                <td>{{ stock_take.created_by.get_full_name|default:stock_take.created_by.username }}</td>
                            </tr>
                            <tr>
                                <td class="fw-semibold">Started:</td>
                                <td>
                                    {% if stock_take.started_at %}
                                        {{ stock_take.started_at|date:"M d, Y H:i" }}
                                    {% else %}
                                        <span class="text-muted">Not started</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="fw-semibold">Completed:</td>
                                <td>
                                    {% if stock_take.completed_at %}
                                        {{ stock_take.completed_at|date:"M d, Y H:i" }}
                                    {% else %}
                                        <span class="text-muted">Not completed</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                {% if stock_take.notes %}
                    <div class="mt-3">
                        <strong>Notes:</strong>
                        <p class="text-muted">{{ stock_take.notes }}</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Progress Overview</h6>
            </div>
            <div class="card-body">
                {% if stock_take.status == 'completed' %}
                    <div class="progress mb-3">
                        <div class="progress-bar bg-success w-100">100%</div>
                    </div>
                {% elif stock_take.status == 'in_progress' %}
                    <div class="progress mb-3">
                        <div class="progress-bar" style="width: {{ stock_take.progress_percentage }}%">
                            {{ stock_take.progress_percentage }}%
                        </div>
                    </div>
                {% else %}
                    <div class="progress mb-3">
                        <div class="progress-bar" style="width: 0%">0%</div>
                    </div>
                {% endif %}
                
                <div class="stats-small">
                    <div class="stat-item">
                        <span class="stat-label">Counted:</span>
                        <span class="stat-value">{{ counted_items }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Remaining:</span>
                        <span class="stat-value">{{ remaining_items }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Discrepancies:</span>
                        <span class="stat-value text-warning">{{ discrepancy_count }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Items List -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Items to Count</h5>
            {% if stock_take.status == 'in_progress' %}
                <div class="search-box">
                    <input type="text" 
                           id="item_search" 
                           class="form-control form-control-sm" 
                           placeholder="Search items..."
                           style="width: 250px;">
                </div>
            {% endif %}
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Current Stock</th>
                        <th>Unit</th>
                        {% if stock_take.status == 'in_progress' %}
                            <th>Counted Qty</th>
                            <th>Actions</th>
                        {% elif stock_take.status == 'completed' %}
                            <th>Counted Qty</th>
                            <th>Difference</th>
                            <th>Status</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody id="items_table_body">
                    {% for count in stock_take_counts %}
                    <tr data-item-name="{{ count.item.name|lower }}" data-item-sku="{{ count.item.sku|lower }}">
                        <td>
                            <div class="d-flex align-items-center">
                                <div>
                                    <div class="fw-semibold">{{ count.item.name }}</div>
                                    <small class="text-muted">{{ count.item.sku }}</small>
                                </div>
                            </div>
                        </td>
                        <td>{{ count.system_quantity }}</td>
                        <td>{{ count.item.unit.symbol }}</td>
                        
                        {% if stock_take.status == 'in_progress' %}
                            <td>
                                {% if count.is_counted %}
                                    <span class="text-success fw-semibold">{{ count.counted_quantity }}</span>
                                {% else %}
                                    <span class="text-muted">Not counted</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if not count.is_counted %}
                                    <button class="btn btn-primary btn-sm" 
                                            onclick="openCountModal('{{ count.id }}', '{{ count.item.name }}', {{ count.system_quantity }}, '{{ count.item.unit.symbol }}')">
                                        <i class="fas fa-edit"></i>
                                        Count
                                    </button>
                                {% else %}
                                    <button class="btn btn-outline-primary btn-sm" 
                                            onclick="openCountModal('{{ count.id }}', '{{ count.item.name }}', {{ count.system_quantity }}, '{{ count.item.unit.symbol }}', {{ count.counted_quantity }})">
                                        <i class="fas fa-edit"></i>
                                        Update
                                    </button>
                                {% endif %}
                            </td>
                        
                        {% elif stock_take.status == 'completed' %}
                            <td>
                                {% if count.is_counted %}
                                    {{ count.counted_quantity }}
                                {% else %}
                                    <span class="text-muted">0</span>
                                {% endif %}
                            </td>
                            <td>
                                {% with diff=count.difference %}
                                    {% if diff > 0 %}
                                        <span class="text-success">+{{ diff }}</span>
                                    {% elif diff < 0 %}
                                        <span class="text-danger">{{ diff }}</span>
                                    {% else %}
                                        <span class="text-muted">0</span>
                                    {% endif %}
                                {% endwith %}
                            </td>
                            <td>
                                {% if count.is_counted %}
                                    {% if count.difference == 0 %}
                                        <span class="badge bg-success">Match</span>
                                    {% else %}
                                        <span class="badge bg-warning">Discrepancy</span>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-secondary">Not Counted</span>
                                {% endif %}
                            </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Count Modal -->
{% if stock_take.status == 'in_progress' %}
<div class="modal fade" id="countModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Count Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="countForm">
                    <input type="hidden" id="count_id" name="count_id">
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Item:</label>
                        <p id="item_name" class="mb-0"></p>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">System Quantity:</label>
                        <p id="system_quantity" class="mb-0"></p>
                    </div>
                    
                    <div class="mb-3">
                        <label for="counted_quantity" class="form-label">Counted Quantity *</label>
                        <div class="input-group">
                            <input type="number" 
                                   id="counted_quantity" 
                                   name="counted_quantity" 
                                   class="form-control" 
                                   step="0.01" 
                                   min="0" 
                                   required>
                            <span class="input-group-text" id="unit_symbol"></span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea id="notes" 
                                  name="notes" 
                                  class="form-control" 
                                  rows="3" 
                                  placeholder="Optional notes about the count..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitCount()">Save Count</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
{% if stock_take.status == 'in_progress' %}
<script>
function openCountModal(countId, itemName, systemQuantity, unitSymbol, currentCount = '') {
    document.getElementById('count_id').value = countId;
    document.getElementById('item_name').textContent = itemName;
    document.getElementById('system_quantity').textContent = systemQuantity + ' ' + unitSymbol;
    document.getElementById('unit_symbol').textContent = unitSymbol;
    document.getElementById('counted_quantity').value = currentCount;
    document.getElementById('notes').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('countModal'));
    modal.show();
}

function submitCount() {
    const form = document.getElementById('countForm');
    const formData = new FormData(form);
    
    const countId = formData.get('count_id');
    const countedQuantity = formData.get('counted_quantity');
    const notes = formData.get('notes');
    
    if (!countedQuantity || countedQuantity < 0) {
        alert('Please enter a valid quantity.');
        return;
    }
    
    // Submit the count
    fetch(`/business/{{ request.tenant.slug }}/inventory/stock-takes/{{ stock_take.id }}/count/${countId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            counted_quantity: parseFloat(countedQuantity),
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // Refresh the page to show updated counts
        } else {
            alert('Error saving count: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving count. Please try again.');
    });
}

// Search functionality
document.getElementById('item_search').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#items_table_body tr');
    
    rows.forEach(row => {
        const itemName = row.dataset.itemName;
        const itemSku = row.dataset.itemSku;
        const matches = itemName.includes(searchTerm) || itemSku.includes(searchTerm);
        row.style.display = matches ? '' : 'none';
    });
});
</script>
{% endif %}

<style>
.stats-small .stat-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

.stat-label {
    font-weight: 500;
}

.search-box {
    flex-shrink: 0;
}

.progress-bar {
    transition: width 0.3s ease;
}
</style>
{% endblock %}
