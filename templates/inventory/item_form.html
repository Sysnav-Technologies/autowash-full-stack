{% extends "base/base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% load inventory_filters %}

{% block title %}{% if item %}Edit {{ item.name }}{% else %}Add New Item{% endif %} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
.form-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.form-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.section-title {
    font-size: 18px;
    font-weight: 600;
    color: #111827;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f3f4f6;
}

.image-preview {
    width: 150px;
    height: 150px;
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f9fafb;
    position: relative;
    overflow: hidden;
    margin-bottom: 15px;
}

.image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.image-preview-placeholder {
    text-align: center;
    color: #6b7280;
}

.form-actions {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    position: sticky;
    bottom: 20px;
}

.required-field {
    color: #ef4444;
}

.help-text {
    font-size: 13px;
    color: #6b7280;
    margin-top: 4px;
}

.price-input-group {
    position: relative;
}

.currency-prefix {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #6b7280;
    font-weight: 500;
    z-index: 5;
}

.currency-input {
    padding-left: 45px;
}

.stock-alert {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    color: #92400e;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 15px;
}

.form-grid {
    display: grid;
    gap: 20px;
}

.grid-2 {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
}

.grid-3 {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    font-weight: 500;
    color: #374151;
    margin-bottom: 8px;
}

.form-control, .form-select {
    border: 1px solid #d1d5db;
    border-radius: 8px;
    padding: 10px 12px;
    font-size: 14px;
}

.form-control:focus, .form-select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
}

.btn-primary {
    background: #3b82f6;
    border-color: #3b82f6;
    padding: 10px 20px;
    font-weight: 500;
}

.btn-primary:hover {
    background: #2563eb;
    border-color: #2563eb;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="form-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-2">{% if item %}Edit Item{% else %}Add New Item{% endif %}</h1>
                <p class="mb-0 opacity-90">
                    {% if item %}Update the details for {{ item.name }}{% else %}Create a new inventory item{% endif %}
                </p>
            </div>
            <a href="/business/{{ request.tenant.slug }}/inventory/items/" class="btn btn-light">
                <i class="fas fa-arrow-left me-2"></i>Back to Items
            </a>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" id="itemForm">
        {% csrf_token %}
        
        <!-- Basic Information -->
        <div class="form-section">
            <h2 class="section-title">
                <i class="fas fa-info-circle me-2"></i>Basic Information
            </h2>
            
            <div class="row">
                <div class="col-md-8">
                    <div class="form-grid grid-2">
                        <div class="form-group">
                            <label for="{{ form.name.id_for_label }}" class="form-label">
                                Item Name <span class="required-field">*</span>
                            </label>
                            {{ form.name }}
                            {% if form.name.help_text %}
                            <div class="help-text">{{ form.name.help_text }}</div>
                            {% endif %}
                            {% if form.name.errors %}
                            <div class="text-danger small">{{ form.name.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.sku.id_for_label }}" class="form-label">
                                SKU <small class="text-muted">(optional)</small>
                            </label>
                            {{ form.sku }}
                            <div class="help-text">Stock Keeping Unit - Leave blank to auto-generate</div>
                            {% if form.sku.errors %}
                            <div class="text-danger small">{{ form.sku.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                        {{ form.description }}
                        {% if form.description.help_text %}
                        <div class="help-text">{{ form.description.help_text }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-grid grid-3">
                        <div class="form-group">
                            <label for="{{ form.category.id_for_label }}" class="form-label">
                                Category <span class="required-field">*</span>
                            </label>
                            {{ form.category }}
                            {% if form.category.errors %}
                            <div class="text-danger small">{{ form.category.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.item_type.id_for_label }}" class="form-label">Item Type</label>
                            {{ form.item_type }}
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.unit.id_for_label }}" class="form-label">
                                Unit <span class="required-field">*</span>
                            </label>
                            {{ form.unit }}
                            {% if form.unit.errors %}
                            <div class="text-danger small">{{ form.unit.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">Item Image</label>
                        <div class="image-preview" id="imagePreview">
                            {% if item.image %}
                            <img src="{{ item.image.url }}" alt="{{ item.name }}" id="previewImg">
                            {% else %}
                            <div class="image-preview-placeholder" id="placeholderDiv">
                                <i class="fas fa-camera fa-2x mb-2"></i>
                                <div>Click to upload image</div>
                            </div>
                            {% endif %}
                        </div>
                        {{ form.image }}
                        <small class="text-muted">Recommended: 400x400px, max 5MB</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stock Information -->
        <div class="form-section">
            <h2 class="section-title">
                <i class="fas fa-boxes me-2"></i>Stock Information
            </h2>
            
            {% if item and item.is_low_stock %}
            <div class="stock-alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Low Stock Alert:</strong> This item is below the minimum stock level.
            </div>
            {% endif %}
            
            <div class="form-grid grid-3">
                <div class="form-group">
                    <label for="{{ form.current_stock.id_for_label }}" class="form-label">Current Stock</label>
                    {{ form.current_stock }}
                    {% if item %}
                    <div class="help-text">Current: {{ item.current_stock|floatformat:2 }} {{ item.unit.abbreviation }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.minimum_stock_level.id_for_label }}" class="form-label">Minimum Level</label>
                    {{ form.minimum_stock_level }}
                    <div class="help-text">Reorder when stock reaches this level</div>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.maximum_stock_level.id_for_label }}" class="form-label">Maximum Level</label>
                    {{ form.maximum_stock_level }}
                    <div class="help-text">Maximum storage capacity</div>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.reorder_point.id_for_label }}" class="form-label">Reorder Point</label>
                    {{ form.reorder_point }}
                    <div class="help-text">When to create purchase order</div>
                </div>
                
                <div class="form-group">
                    <label for="{{ form.reorder_quantity.id_for_label }}" class="form-label">Reorder Quantity</label>
                    {{ form.reorder_quantity }}
                    <div class="help-text">How much to order</div>
                </div>
            </div>
        </div>

        <!-- Pricing -->
        <div class="form-section">
            <h2 class="section-title">
                <i class="fas fa-tag me-2"></i>Pricing Information
            </h2>
            
            <div class="form-grid grid-2">
                <div class="form-group">
                    <label for="{{ form.unit_cost.id_for_label }}" class="form-label">Unit Cost (KSH)</label>
                    <input type="number" step="0.01" class="form-control" 
                           name="{{ form.unit_cost.name }}" 
                           id="{{ form.unit_cost.id_for_label }}"
                           value="{{ form.unit_cost.value|default:'' }}"
                           placeholder="0.00">
                    <div class="help-text">Cost price per unit</div>
                    {% if item %}
                    <div class="help-text">Stock Value: {{ item.stock_value|currency }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.selling_price.id_for_label }}" class="form-label">Selling Price (KSH)</label>
                    <input type="number" step="0.01" class="form-control" 
                           name="{{ form.selling_price.name }}" 
                           id="{{ form.selling_price.id_for_label }}"
                           value="{{ form.selling_price.value|default:'' }}"
                           placeholder="0.00">
                    <div class="help-text">Price charged to customers</div>
                    <div id="marginDisplay" class="help-text text-success"></div>
                </div>
            </div>
        </div>

        <!-- Additional Details -->
        <div class="form-section">
            <h2 class="section-title">
                <i class="fas fa-cogs me-2"></i>Additional Details
            </h2>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-grid grid-2">
                        <div class="form-group">
                            <label for="{{ form.barcode.id_for_label }}" class="form-label">Barcode</label>
                            {{ form.barcode }}
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.weight.id_for_label }}" class="form-label">Weight (kg)</label>
                            {{ form.weight }}
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.dimensions.id_for_label }}" class="form-label">Dimensions</label>
                            {{ form.dimensions }}
                            <div class="help-text">Length x Width x Height</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.storage_location.id_for_label }}" class="form-label">Storage Location</label>
                            {{ form.storage_location }}
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="{{ form.storage_requirements.id_for_label }}" class="form-label">Storage Requirements</label>
                        {{ form.storage_requirements }}
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Options</label>
                        <div class="form-check">
                            {{ form.is_active }}
                            <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                Item is active
                            </label>
                        </div>
                        <div class="form-check">
                            {{ form.is_taxable }}
                            <label class="form-check-label" for="{{ form.is_taxable.id_for_label }}">
                                Item is taxable
                            </label>
                        </div>
                        <div class="form-check">
                            {{ form.track_serial_numbers }}
                            <label class="form-check-label" for="{{ form.track_serial_numbers.id_for_label }}">
                                Track serial numbers
                            </label>
                        </div>
                        <div class="form-check">
                            {{ form.track_expiry }}
                            <label class="form-check-label" for="{{ form.track_expiry.id_for_label }}">
                                Track expiry dates
                            </label>
                        </div>
                        <div class="form-check">
                            {{ form.quality_check_required }}
                            <label class="form-check-label" for="{{ form.quality_check_required.id_for_label }}">
                                Quality check required
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    {% if item %}
                    <small class="text-muted">
                        Last updated: {{ item.updated_at|date:"M d, Y H:i" }}
                    </small>
                    {% endif %}
                </div>
                <div class="d-flex gap-2">
                    <a href="/business/{{ request.tenant.slug }}/inventory/items/" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>{% if item %}Update Item{% else %}Create Item{% endif %}
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Image preview
    const imageInput = document.getElementById('{{ form.image.id_for_label }}');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const placeholderDiv = document.getElementById('placeholderDiv');

    if (imageInput) {
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (previewImg) {
                        previewImg.src = e.target.result;
                    } else {
                        if (placeholderDiv) {
                            placeholderDiv.remove();
                        }
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.alt = 'Preview';
                        img.id = 'previewImg';
                        imagePreview.appendChild(img);
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // Profit margin calculation
    const unitCostInput = document.getElementById('{{ form.unit_cost.id_for_label }}');
    const sellingPriceInput = document.getElementById('{{ form.selling_price.id_for_label }}');
    const marginDisplay = document.getElementById('marginDisplay');

    function calculateMargin() {
        if (unitCostInput && sellingPriceInput && marginDisplay) {
            const unitCost = parseFloat(unitCostInput.value) || 0;
            const sellingPrice = parseFloat(sellingPriceInput.value) || 0;
            
            if (unitCost > 0 && sellingPrice > 0) {
                const profit = sellingPrice - unitCost;
                const margin = (profit / sellingPrice) * 100;
                marginDisplay.innerHTML = `Profit: KSH ${profit.toFixed(2)} (${margin.toFixed(1)}% margin)`;
                
                if (margin < 0) {
                    marginDisplay.className = 'help-text text-danger';
                } else if (margin < 20) {
                    marginDisplay.className = 'help-text text-warning';
                } else {
                    marginDisplay.className = 'help-text text-success';
                }
            } else {
                marginDisplay.innerHTML = '';
            }
        }
    }

    if (unitCostInput && sellingPriceInput) {
        unitCostInput.addEventListener('input', calculateMargin);
        sellingPriceInput.addEventListener('input', calculateMargin);
        calculateMargin(); // Calculate on page load
    }

    // Auto-generate SKU (removed - will be handled server-side)
    // SKU will be automatically generated on the server when the form is submitted
    // if no SKU is provided
});
</script>
{% endblock %}
