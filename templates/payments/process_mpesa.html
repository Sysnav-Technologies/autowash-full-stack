{% extends 'base/base.html' %}
{% load static %}

{% block title %}M-Pesa Payment - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .mpesa-container {
        max-width: 600px;
        margin: 0 auto;
    }
    
    .mpesa-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .mpesa-header {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 2rem;
        text-align: center;
    }
    
    .mpesa-logo {
        width: 80px;
        height: 80px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        font-size: 2rem;
        color: #10b981;
    }
    
    .payment-summary {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1.5rem 0;
    }
    
    .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #dcfce7;
    }
    
    .summary-item:last-child {
        border-bottom: none;
        font-weight: 700;
        font-size: 1.1rem;
        color: #059669;
    }
    
    .phone-display {
        background: #065f46;
        color: white;
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        font-size: 1.2rem;
        font-weight: 600;
        margin: 1rem 0;
        font-family: 'Courier New', monospace;
    }
    
    .status-pending {
        background: #fef3c7;
        border: 1px solid #fbbf24;
        color: #92400e;
    }
    
    .status-processing {
        background: #dbeafe;
        border: 1px solid #3b82f6;
        color: #1e40af;
    }
    
    .status-completed {
        background: #dcfce7;
        border: 1px solid #10b981;
        color: #059669;
    }
    
    .status-failed {
        background: #fee2e2;
        border: 1px solid #ef4444;
        color: #dc2626;
    }
    
    .status-indicator {
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
        margin: 1rem 0;
        font-weight: 600;
    }
    
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e5e7eb;
        border-top: 4px solid #10b981;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .instructions {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 10px;
        padding: 1.5rem;
        margin: 1.5rem 0;
    }
    
    .btn-mpesa {
        background: linear-gradient(135deg, #10b981, #059669);
        border: none;
        color: white;
        border-radius: 10px;
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-mpesa:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        color: white;
    }
    
    .countdown {
        font-size: 1.2rem;
        font-weight: 700;
        color: #dc2626;
        text-align: center;
        margin: 1rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="mpesa-container">
        <div class="mpesa-card">
            <!-- Header -->
            <div class="mpesa-header">
                <div class="mpesa-logo">
                    <i class="fas fa-mobile-alt"></i>
                </div>
                <h2 class="mb-2">M-Pesa Payment</h2>
                <p class="mb-0 opacity-90">{{ request.tenant.name }}</p>
            </div>
            
            <div class="card-body p-4">
                <!-- Payment Summary -->
                <div class="payment-summary">
                    <h5 class="mb-3 text-center">
                        <i class="fas fa-receipt text-success me-2"></i>Payment Details
                    </h5>
                    <div class="summary-item">
                        <span>Payment ID:</span>
                        <span>{{ payment.payment_id }}</span>
                    </div>
                    {% if payment.customer %}
                    <div class="summary-item">
                        <span>Customer:</span>
                        <span>{{ payment.customer.display_name }}</span>
                    </div>
                    {% endif %}
                    {% if payment.service_order %}
                    <div class="summary-item">
                        <span>Service Order:</span>
                        <span>{{ payment.service_order.order_number }}</span>
                    </div>
                    {% endif %}
                    <div class="summary-item">
                        <span>Amount:</span>
                        <span>KES {{ payment.amount|floatformat:2 }}</span>
                    </div>
                    {% if payment.processing_fee > 0 %}
                    <div class="summary-item">
                        <span>Processing Fee:</span>
                        <span>KES {{ payment.processing_fee|floatformat:2 }}</span>
                    </div>
                    <div class="summary-item">
                        <span>Total Amount:</span>
                        <span>KES {{ payment.amount|add:payment.processing_fee|floatformat:2 }}</span>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Phone Number Display -->
                <div class="phone-display">
                    <i class="fas fa-mobile-alt me-2"></i>{{ payment.customer_phone }}
                </div>
                
                <!-- Payment Status -->
                <div class="status-indicator status-{{ payment.status }}">
                    {% if payment.status == 'pending' %}
                        <div class="spinner mb-2"></div>
                        <div>Waiting for Payment Request...</div>
                        <small>We're sending the payment request to your phone</small>
                    {% elif payment.status == 'processing' %}
                        <div class="spinner mb-2"></div>
                        <div>Processing Payment...</div>
                        <small>Please complete the payment on your phone</small>
                    {% elif payment.status == 'completed' %}
                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                        <div>Payment Successful!</div>
                        <small>Transaction ID: {{ payment.transaction_id }}</small>
                    {% elif payment.status == 'failed' %}
                        <i class="fas fa-times-circle fa-2x mb-2"></i>
                        <div>Payment Failed</div>
                        <small>{{ payment.failure_reason|default:"Payment was not completed" }}</small>
                    {% endif %}
                </div>
                
                <!-- Instructions -->
                {% if payment.status == 'pending' or payment.status == 'processing' %}
                <div class="instructions">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-info-circle text-primary me-2"></i>How to Complete Payment
                    </h6>
                    <ol class="mb-0">
                        <li class="mb-2">You will receive a payment request on your phone</li>
                        <li class="mb-2">Enter your M-Pesa PIN to confirm</li>
                        <li class="mb-2">Wait for confirmation SMS</li>
                        <li>Payment will be automatically verified</li>
                    </ol>
                </div>
                
                <!-- Countdown Timer -->
                <div class="countdown" id="countdown">
                    Payment expires in: <span id="timeRemaining">05:00</span>
                </div>
                {% endif %}
                
                <!-- Form for Processing -->
                {% if payment.status == 'pending' %}
                <form method="post" id="mpesaForm">
                    {% csrf_token %}
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="tel" class="form-control" id="mpesaPhone" name="phone_number" 
                                       value="{{ payment.customer_phone }}" placeholder="254712345678" required>
                                <label>M-Pesa Phone Number</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="number" class="form-control" id="amount" name="amount" 
                                       value="{{ payment.amount }}" readonly>
                                <label>Amount (KES)</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="submit" class="btn btn-mpesa btn-lg">
                            <i class="fas fa-paper-plane me-2"></i>Send Payment Request
                        </button>
                    </div>
                </form>
                {% endif %}
                
                <!-- Action Buttons -->
                <div class="text-center mt-4">
                    {% if payment.status == 'pending' or payment.status == 'processing' %}
                    <button class="btn btn-outline-primary me-2" onclick="checkPaymentStatus()">
                        <i class="fas fa-sync me-2"></i>Check Status
                    </button>
                    {% endif %}
                    
                    {% if payment.status == 'completed' %}
                    <a href="/business/{{ request.tenant.slug }}/payments/{{ payment.payment_id }}/receipt/" 
                       class="btn btn-success me-2">
                        <i class="fas fa-receipt me-2"></i>View Receipt
                    </a>
                    {% endif %}
                    
                    <a href="/business/{{ request.tenant.slug }}/payments/" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Payments
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let countdownTimer;
let timeRemaining = 300; // 5 minutes in seconds

function startCountdown() {
    countdownTimer = setInterval(function() {
        timeRemaining--;
        
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        
        document.getElementById('timeRemaining').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeRemaining <= 0) {
            clearInterval(countdownTimer);
            document.getElementById('countdown').innerHTML = 
                '<span class="text-danger">Payment request expired. Please try again.</span>';
        }
    }, 1000);
}

function checkPaymentStatus() {
    fetch(`/business/{{ request.tenant.slug }}/payments/ajax/{{ payment.payment_id }}/mpesa-status/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'completed') {
                location.reload();
            } else if (data.status === 'failed') {
                clearInterval(countdownTimer);
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error checking payment status:', error);
        });
}

// Auto-refresh status for pending/processing payments
{% if payment.status == 'pending' or payment.status == 'processing' %}
document.addEventListener('DOMContentLoaded', function() {
    startCountdown();
    
    // Check status every 10 seconds
    setInterval(checkPaymentStatus, 10000);
});
{% endif %}

// Form submission
document.getElementById('mpesaForm')?.addEventListener('submit', function(e) {
    console.log('Form submission started');
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const phoneInput = e.target.querySelector('input[name="phone_number"]');
    
    // Basic validation
    if (!phoneInput.value.trim()) {
        e.preventDefault();
        alert('Please enter a phone number');
        return false;
    }
    
    // Update button state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending Request...';
    
    // Log form data for debugging
    const formData = new FormData(e.target);
    console.log('Form data:', Object.fromEntries(formData));
});
</script>
{% endblock %}
