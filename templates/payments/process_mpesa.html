{% extends 'base/base.html' %}
{% load static %}

{% block title %}M-Pesa Payment - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .mpesa-container {
        max-width: 600px;
        margin: 0 auto;
    }
    
    .mpesa-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .mpesa-header {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 2rem;
        text-align: center;
    }
    
    .mpesa-logo {
        width: 60px;
        height: 60px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        font-size: 1.5rem;
        color: #10b981;
    }
    
    .payment-summary {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1.5rem 0;
    }
    
    .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #dcfce7;
    }
    
    .summary-item:last-child {
        border-bottom: none;
        font-weight: 700;
        color: #059669;
        font-size: 1.1rem;
    }
    
    .btn-mpesa {
        background: linear-gradient(135deg, #10b981, #059669);
        border: none;
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
    }
    
    .btn-mpesa:hover {
        background: linear-gradient(135deg, #059669, #047857);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        color: white;
    }
    
    .form-floating label {
        color: #6b7280;
    }
    
    .form-control:focus {
        border-color: #10b981;
        box-shadow: 0 0 0 0.25rem rgba(16, 185, 129, 0.25);
    }
    
    .attendant-note {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
    }
    
    .option-card {
        border: 2px solid #e5e7eb !important;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .option-card:hover {
        border-color: #10b981 !important;
        background-color: #f0fdf4;
    }
    
    .option-card.selected {
        border-color: #10b981 !important;
        background-color: #f0fdf4;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
    }
    
    .payment-code-field {
        transition: all 0.3s ease;
    }
    
    .payment-code-field.hidden {
        opacity: 0.3;
        pointer-events: none;
    }
    
    .status-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="mpesa-container">
        <div class="mpesa-card">
            <!-- Header -->
            <div class="mpesa-header">
                <div class="mpesa-logo">
                    <i class="fas fa-mobile-alt"></i>
                </div>
                <h3 class="mb-2">M-Pesa Payment</h3>
                <p class="mb-0 opacity-90">Process customer payment</p>
            </div>
            
            <div class="p-4">
                <!-- Payment Summary -->
                <div class="payment-summary">
                    <h6 class="fw-bold mb-3 text-success">
                        <i class="fas fa-receipt me-2"></i>Payment Details
                    </h6>
                    {% if payment.customer %}
                    <div class="summary-item">
                        <span>Customer:</span>
                        <strong>{{ payment.customer.display_name }}</strong>
                    </div>
                    {% endif %}
                    <div class="summary-item">
                        <span>Payment ID:</span>
                        <strong>{{ payment.payment_id }}</strong>
                    </div>
                    {% if payment.description %}
                    <div class="summary-item">
                        <span>Description:</span>
                        <strong>{{ payment.description }}</strong>
                    </div>
                    {% endif %}
                    <div class="summary-item">
                        <span>Amount:</span>
                        <strong>KES {{ payment.amount|floatformat:2 }}</strong>
                    </div>
                </div>
                
                {% if payment.status == 'pending' %}
                    <!-- Form for Processing -->
                    <form method="post" id="mpesaForm">
                        {% csrf_token %}
                        
                        {% if has_gateway %}
                        <div class="attendant-note">
                            <h6 class="text-primary mb-2">
                                <i class="fas fa-user-tie me-2"></i>Payment Options Available
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="option-card border rounded p-3 mb-3" id="automaticOption" onclick="selectPaymentMode('automatic')">
                                        <h6 class="text-success"><i class="fas fa-mobile-alt me-2"></i>Automatic (Gateway)</h6>
                                        <ol class="mb-0 small">
                                            <li>Enter customer's M-Pesa number</li>
                                            <li>Leave payment code empty</li>
                                            <li>Customer receives prompt on phone</li>
                                        </ol>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="option-card border rounded p-3 mb-3" id="manualOption" onclick="selectPaymentMode('manual')">
                                        <h6 class="text-info"><i class="fas fa-keyboard me-2"></i>Manual Entry</h6>
                                        <ol class="mb-0 small">
                                            <li>Customer pays to your till number</li>
                                            <li>Customer gets confirmation SMS with code</li>
                                            <li>Enter the transaction code here</li>
                                            <li>Payment processed immediately</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="attendant-note">
                            <h6 class="text-warning mb-2">
                                <i class="fas fa-keyboard me-2"></i>Manual Payment Required
                            </h6>
                            <div class="row">
                                <div class="col-12">
                                    <div class="option-card border rounded p-3 mb-3 selected" id="manualOption">
                                        <h6 class="text-warning"><i class="fas fa-keyboard me-2"></i>Manual Entry (Only Option)</h6>
                                        <ol class="mb-0 small">
                                            <li>Customer pays to your till number</li>
                                            <li>Customer gets confirmation SMS with code</li>
                                            <li>Enter the transaction code here</li>
                                            <li>Payment processed immediately</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if not has_gateway %}
                        <div class="attendant-note">
                            <h6 class="text-warning mb-2">
                                <i class="fas fa-exclamation-triangle me-2"></i>No Gateway Configured
                            </h6>
                            <div class="alert alert-warning">
                                <strong>Manual payment process:</strong>
                                <ol class="mb-2 mt-2">
                                    <li><strong>Ask customer to send payment</strong> via M-Pesa to your till number</li>
                                    <li><strong>Customer will receive confirmation SMS</strong> with transaction code (e.g., NLJ7RT61SX)</li>
                                    <li><strong>Get the transaction code from customer</strong> and enter it below</li>
                                    <li><strong>Click process</strong> to complete the payment</li>
                                </ol>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    The transaction code is required to verify the payment was made
                                </small>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="mb-4">
                            <div class="form-floating">
                                <input type="tel" class="form-control form-control-lg" id="mpesaPhone" name="phone_number" 
                                       value="{{ payment.customer_phone|default:'' }}" 
                                       placeholder="254712345678"
                                       title="Enter customer's M-Pesa phone number">
                                <label><i class="fas fa-mobile-alt me-2"></i>Customer's M-Pesa Phone Number <span id="phoneRequired">(Required)</span></label>
                            </div>
                            <small class="text-muted">Format: 254xxxxxxxxx or 0xxxxxxxxx <span id="phoneOptional" style="display: none;">(Optional for manual payments)</span></small>
                        </div>
                        
                        <div class="mb-4" id="paymentCodeField">
                            <div class="form-floating">
                                <input type="text" class="form-control form-control-lg" id="paymentCode" name="payment_code" 
                                       placeholder="NLJ7RT61SX" 
                                       title="Enter M-Pesa transaction code">
                                <label><i class="fas fa-receipt me-2"></i>M-Pesa Transaction Code <span class="text-muted">(Optional)</span></label>
                            </div>
                            <small class="text-muted" id="paymentCodeHelp">
                                Leave empty to process without transaction code, or enter code for verification
                            </small>
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" class="btn btn-mpesa btn-lg px-5 py-3 w-100">
                                <i class="fas fa-paper-plane me-2"></i>Process M-Pesa Payment
                            </button>
                        </div>
                    </form>
                    
                {% elif payment.status == 'processing' %}
                    <!-- Processing Status -->
                    <div class="text-center py-4">
                        <div class="text-primary status-icon">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <h4 class="text-primary">Processing Payment</h4>
                        <p class="text-muted">Payment request sent to {{ payment.customer_phone }}</p>
                        <div class="attendant-note">
                            <strong>Next Steps:</strong> Ask customer to check their phone and complete the M-Pesa payment
                        </div>
                    </div>
                    
                {% elif payment.status == 'completed' %}
                    <!-- Payment Completed -->
                    <div class="text-center py-4">
                        <div class="text-success status-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h4 class="text-success">Payment Successful!</h4>
                        <p class="text-muted">The M-Pesa payment has been completed.</p>
                        <a href="javascript:history.back()" class="btn btn-success">
                            <i class="fas fa-arrow-left me-2"></i>Back to Payments
                        </a>
                    </div>
                    
                {% elif payment.status == 'failed' %}
                    <!-- Payment Failed -->
                    <div class="text-center py-4">
                        <div class="text-danger status-icon">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <h4 class="text-danger">Payment Failed</h4>
                        <p class="text-muted">The M-Pesa payment could not be processed.</p>
                        {% if payment.failure_reason %}
                        <div class="alert alert-danger">
                            {{ payment.failure_reason }}
                        </div>
                        {% endif %}
                        <a href="javascript:history.back()" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Payments
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Auto-refresh for pending/processing payments -->
{% if payment.status == 'processing' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-refresh every 5 seconds to check payment status
    setTimeout(function() {
        location.reload();
    }, 5000);
});
</script>
{% endif %}

<script>
let currentPaymentMode = 'automatic'; // Default mode

function selectPaymentMode(mode) {
    currentPaymentMode = mode;
    
    const automaticOption = document.getElementById('automaticOption');
    const manualOption = document.getElementById('manualOption');
    const paymentCodeField = document.getElementById('paymentCodeField');
    const paymentCodeInput = document.getElementById('paymentCode');
    const paymentCodeHelp = document.getElementById('paymentCodeHelp');
    const submitBtn = document.querySelector('button[type="submit"]');
    const phoneInput = document.getElementById('mpesaPhone');
    const phoneRequired = document.getElementById('phoneRequired');
    const phoneOptional = document.getElementById('phoneOptional');
    
    // Remove selected class from both options
    automaticOption.classList.remove('selected');
    manualOption.classList.remove('selected');
    
    if (mode === 'automatic') {
        // Select automatic mode
        automaticOption.classList.add('selected');
        paymentCodeField.classList.add('payment-code-field', 'hidden');
        paymentCodeInput.required = false;
        paymentCodeInput.value = '';
        paymentCodeHelp.textContent = 'Payment code not needed - customer will receive STK push';
        submitBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Send Payment Request';
        
        // Phone is required for automatic payments
        phoneInput.required = true;
        phoneInput.setAttribute('pattern', '(254[0-9]\\d{8}|0[0-9]\\d{8})');
        phoneRequired.style.display = 'inline';
        phoneOptional.style.display = 'none';
    } else {
        // Select manual mode
        manualOption.classList.add('selected');
        paymentCodeField.classList.remove('hidden');
        paymentCodeField.classList.add('payment-code-field');
        paymentCodeInput.required = false; // Made optional for manual payments
        paymentCodeHelp.textContent = 'Leave empty to process without code, or enter M-Pesa transaction code for verification';
        submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Process Manual Payment';
        
        // Phone is optional for manual payments
        phoneInput.required = false;
        phoneInput.removeAttribute('pattern'); // Remove pattern validation for optional field
        phoneRequired.style.display = 'none';
        phoneOptional.style.display = 'inline';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('mpesaForm');
    
    if (form) {
        const phoneInput = form.querySelector('input[name="phone_number"]');
        const paymentCodeInput = form.querySelector('input[name="payment_code"]');
        const submitBtn = form.querySelector('button[type="submit"]');
        const hasGateway = {% if has_gateway %}true{% else %}false{% endif %};
        
        // Set initial mode based on gateway availability
        if (hasGateway) {
            // Gateway available - default to automatic mode
            selectPaymentMode('automatic');
        } else {
            // No gateway available - force manual mode only
            currentPaymentMode = 'manual';
            const paymentCodeField = document.getElementById('paymentCodeField');
            const paymentCodeInput = document.getElementById('paymentCode');
            const submitBtn = document.querySelector('button[type="submit"]');
            const phoneInput = document.getElementById('mpesaPhone');
            const phoneRequired = document.getElementById('phoneRequired');
            const phoneOptional = document.getElementById('phoneOptional');
            
            // Set manual mode permanently - all fields optional
            paymentCodeField.classList.remove('hidden');
            paymentCodeField.classList.add('payment-code-field');
            paymentCodeInput.required = false; // Optional for no-gateway scenario
            phoneInput.required = false; // Optional for manual payments
            phoneInput.removeAttribute('pattern'); // Remove pattern validation
            submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Process Manual Payment';
            
            // Update phone field indicators
            if (phoneRequired && phoneOptional) {
                phoneRequired.style.display = 'none';
                phoneOptional.style.display = 'inline';
            }
            
            // Mark the manual option as selected
            const manualOption = document.getElementById('manualOption');
            if (manualOption) {
                manualOption.classList.add('selected');
            }
        }
        
        form.addEventListener('submit', function(e) {
            // For automatic payments, phone number is required
            if (currentPaymentMode === 'automatic' && !phoneInput.value.trim()) {
                e.preventDefault();
                alert('Please enter customer\'s M-Pesa phone number for automatic payment');
                phoneInput.focus();
                return;
            }
            
            // For manual payments, both phone and payment code are optional
            // The server will handle missing values with appropriate defaults
            
            // Update button based on whether it's manual or automatic processing
            submitBtn.disabled = true;
            if (currentPaymentMode === 'manual' || paymentCodeInput.value.trim()) {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing Manual Payment...';
            } else {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending Payment Request...';
            }
        });
        
        // Format phone number as user types
        phoneInput.addEventListener('input', function() {
            let value = this.value.replace(/\D/g, ''); // Remove non-digits
            
            // Convert 0712345678 to 254712345678
            if (value.startsWith('0') && value.length === 10) {
                value = '254' + value.substring(1);
            }
            
            this.value = value;
        });
        
        // Update button text based on payment code presence (only if gateway available)
        if (paymentCodeInput && hasGateway) {
            paymentCodeInput.addEventListener('input', function() {
                const hasCode = this.value.trim().length > 0;
                if (hasCode && currentPaymentMode === 'automatic') {
                    selectPaymentMode('manual');
                } else if (!hasCode && currentPaymentMode === 'manual') {
                    selectPaymentMode('automatic');
                }
            });
        }
    }
});
</script>
{% endblock %}
