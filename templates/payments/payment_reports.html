{% extends 'base/base.html' %}
{% load static %}

{% block title %}Payment Reports - {{ block.super }}{% endblock %}

{% block breadcrumbs %}
{{ block.super }}
<li class="breadcrumb-item">
    <a href="/business/{{ request.tenant.slug }}/payments/">Payments</a>
</li>
<li class="breadcrumb-item active">Reports</li>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Page Header -->
    <div class="col-12">
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="h3 mb-2">Payment Reports</h1>
                    <p class="text-muted mb-0">Analyze payment trends and performance metrics</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="exportReport('pdf')">
                            <i class="fas fa-file-pdf me-2"></i>PDF
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="exportReport('excel')">
                            <i class="fas fa-file-excel me-2"></i>Excel
                        </button>
                        <a href="/business/{{ request.tenant.slug }}/payments/export/" class="btn btn-primary">
                            <i class="fas fa-download me-2"></i>Export CSV
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="get" id="reportFilters">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="dateRange" class="form-label">Date Range</label>
                            <select class="form-select" id="dateRange" name="date_range">
                                <option value="today" {% if request.GET.date_range == 'today' %}selected{% endif %}>Today</option>
                                <option value="yesterday" {% if request.GET.date_range == 'yesterday' %}selected{% endif %}>Yesterday</option>
                                <option value="this_week" {% if request.GET.date_range == 'this_week' %}selected{% endif %}>This Week</option>
                                <option value="last_week" {% if request.GET.date_range == 'last_week' %}selected{% endif %}>Last Week</option>
                                <option value="this_month" {% if request.GET.date_range == 'this_month' %}selected{% endif %}>This Month</option>
                                <option value="last_month" {% if request.GET.date_range == 'last_month' %}selected{% endif %}>Last Month</option>
                                <option value="custom" {% if request.GET.date_range == 'custom' %}selected{% endif %}>Custom Range</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate" name="start_date" value="{{ request.GET.start_date }}">
                        </div>
                        <div class="col-md-2">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate" name="end_date" value="{{ request.GET.end_date }}">
                        </div>
                        <div class="col-md-2">
                            <label for="paymentMethod" class="form-label">Payment Method</label>
                            <select class="form-select" id="paymentMethod" name="payment_method">
                                <option value="">All Methods</option>
                                {% for method in payment_methods %}
                                <option value="{{ method.id }}" {% if request.GET.payment_method == method.id|slugify %}selected{% endif %}>
                                    {{ method.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="">All Status</option>
                                <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Completed</option>
                                <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
                                <option value="failed" {% if request.GET.status == 'failed' %}selected{% endif %}>Failed</option>
                                <option value="refunded" {% if request.GET.status == 'refunded' %}selected{% endif %}>Refunded</option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="text-primary mb-2">
                    <i class="fas fa-money-bill-wave fa-2x"></i>
                </div>
                <h4 class="mb-1">{{ total_revenue|floatformat:2 }}</h4>
                <p class="text-muted mb-0">Total Revenue</p>
                <small class="text-success">
                    <i class="fas fa-arrow-up"></i> {{ revenue_growth }}%
                </small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="text-success mb-2">
                    <i class="fas fa-check-circle fa-2x"></i>
                </div>
                <h4 class="mb-1">{{ completed_payments }}</h4>
                <p class="text-muted mb-0">Completed Payments</p>
                <small class="text-success">
                    {{ completion_rate }}% success rate
                </small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="text-warning mb-2">
                    <i class="fas fa-clock fa-2x"></i>
                </div>
                <h4 class="mb-1">{{ pending_payments }}</h4>
                <p class="text-muted mb-0">Pending Payments</p>
                <small class="text-warning">
                    {{ pending_amount|floatformat:2 }} pending
                </small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="text-info mb-2">
                    <i class="fas fa-calculator fa-2x"></i>
                </div>
                <h4 class="mb-1">{{ average_payment|floatformat:2 }}</h4>
                <p class="text-muted mb-0">Average Payment</p>
                <small class="text-info">
                    {{ total_transactions }} transactions
                </small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Payment Trends Chart -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>Payment Trends
                </h5>
            </div>
            <div class="card-body">
                <canvas id="paymentTrendsChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Payment Methods Breakdown -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Payment Methods
                </h5>
            </div>
            <div class="card-body">
                <canvas id="paymentMethodsChart" height="300"></canvas>
                <div class="mt-3">
                    {% for method_stat in payment_method_stats %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            <span class="badge me-2" style="background-color: {{ method_stat.color }}; width: 12px; height: 12px;"></span>
                            <span>{{ method_stat.name }}</span>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">{{ method_stat.percentage }}%</div>
                            <small class="text-muted">{{ method_stat.amount|floatformat:2 }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Transactions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Recent Transactions
                    </h5>
                    <a href="/business/{{ request.tenant.slug }}/payments/list/" class="btn btn-sm btn-outline-primary">
                        View All <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if recent_transactions %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Transaction ID</th>
                                    <th>Customer</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in recent_transactions %}
                                <tr>
                                    <td>{{ transaction.created_at|date:"M d, Y H:i" }}</td>
                                    <td>
                                        <a href="/business/{{ request.tenant.slug }}/payments/{{ transaction.id }}/" class="text-decoration-none">
                                            {{ transaction.transaction_id }}
                                        </a>
                                    </td>
                                    <td>
                                        {% if transaction.customer %}
                                            {{ transaction.customer.full_name }}
                                        {% else %}
                                            <span class="text-muted">Walk-in Customer</span>
                                        {% endif %}
                                    </td>
                                    <td class="fw-bold">{{ transaction.amount|floatformat:2 }}</td>
                                    <td>
                                        <span class="badge bg-light text-dark">{{ transaction.payment_method }}</span>
                                    </td>
                                    <td>
                                        {% if transaction.status == 'completed' %}
                                            <span class="badge bg-success">Completed</span>
                                        {% elif transaction.status == 'pending' %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% elif transaction.status == 'failed' %}
                                            <span class="badge bg-danger">Failed</span>
                                        {% elif transaction.status == 'refunded' %}
                                            <span class="badge bg-info">Refunded</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="/business/{{ request.tenant.slug }}/payments/{{ transaction.id }}/" class="btn btn-outline-primary" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if transaction.status == 'completed' %}
                                            <a href="/business/{{ request.tenant.slug }}/payments/{{ transaction.id }}/receipt/" class="btn btn-outline-success" title="View Receipt">
                                                <i class="fas fa-receipt"></i>
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Transactions Found</h5>
                        <p class="text-muted">Adjust your filters to see more results</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.badge[style] {
    border-radius: 50%;
}

canvas {
    max-height: 300px;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Payment Trends Chart
const trendsCtx = document.getElementById('paymentTrendsChart').getContext('2d');
const paymentTrendsChart = new Chart(trendsCtx, {
    type: 'line',
    data: {
        labels: {{ trend_labels|safe }},
        datasets: [{
            label: 'Revenue',
            data: {{ trend_data|safe }},
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toLocaleString();
                    }
                }
            }
        }
    }
});

// Payment Methods Chart
const methodsCtx = document.getElementById('paymentMethodsChart').getContext('2d');
const paymentMethodsChart = new Chart(methodsCtx, {
    type: 'doughnut',
    data: {
        labels: {{ method_labels|safe }},
        datasets: [{
            data: {{ method_data|safe }},
            backgroundColor: {{ method_colors|safe }},
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Export functions
function exportReport(format) {
    const params = new URLSearchParams(window.location.search);
    params.set('format', format);
    window.open(`/business/{{ request.tenant.slug }}/payments/reports/export/?${params.toString()}`, '_blank');
}

// Handle date range changes
document.getElementById('dateRange').addEventListener('change', function() {
    const customFields = document.querySelectorAll('#startDate, #endDate');
    if (this.value === 'custom') {
        customFields.forEach(field => field.disabled = false);
    } else {
        customFields.forEach(field => field.disabled = true);
    }
});

// Initialize form
document.addEventListener('DOMContentLoaded', function() {
    const dateRange = document.getElementById('dateRange');
    if (dateRange.value !== 'custom') {
        document.querySelectorAll('#startDate, #endDate').forEach(field => field.disabled = true);
    }
});
</script>
{% endblock %}
