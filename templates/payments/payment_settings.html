{% extends 'base/base.html' %}
{% load static %}

{% block title %}Payment Settings - {{ block.super }}{% endblock %}

{% block breadcrumbs %}
{{ block.super }}
<li class="breadcrumb-item">
    <a href="/business/{{ request.tenant.slug }}/payments/">Payments</a>
</li>
<li class="breadcrumb-item active">Settings</li>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Page Header -->
    <div class="col-12">
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="h3 mb-2">Payment Settings</h1>
                    <p class="text-muted mb-0">Configure payment processing and gateway settings</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <button type="button" class="btn btn-primary" onclick="saveAllSettings()">
                        <i class="fas fa-save me-2"></i>Save All Settings
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- General Settings -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cog me-2"></i>General Settings
                </h5>
            </div>
            <div class="card-body">
                <form id="generalSettingsForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="defaultCurrency" class="form-label">Default Currency</label>
                        <select class="form-select" id="defaultCurrency" name="default_currency">
                            <option value="USD" {% if settings.default_currency == 'USD' %}selected{% endif %}>USD - US Dollar</option>
                            <option value="KES" {% if settings.default_currency == 'KES' %}selected{% endif %}>KES - Kenyan Shilling</option>
                            <option value="EUR" {% if settings.default_currency == 'EUR' %}selected{% endif %}>EUR - Euro</option>
                            <option value="GBP" {% if settings.default_currency == 'GBP' %}selected{% endif %}>GBP - British Pound</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="paymentTimeout" class="form-label">Payment Timeout (minutes)</label>
                        <input type="number" class="form-control" id="paymentTimeout" name="payment_timeout" 
                               value="{{ settings.payment_timeout|default:15 }}" min="5" max="60">
                        <div class="form-text">Time before a payment request expires</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="minPaymentAmount" class="form-label">Minimum Payment Amount</label>
                        <input type="number" class="form-control" id="minPaymentAmount" name="min_payment_amount" 
                               value="{{ settings.min_payment_amount|default:1 }}" step="0.01" min="0">
                    </div>
                    
                    <div class="mb-3">
                        <label for="maxPaymentAmount" class="form-label">Maximum Payment Amount</label>
                        <input type="number" class="form-control" id="maxPaymentAmount" name="max_payment_amount" 
                               value="{{ settings.max_payment_amount|default:10000 }}" step="0.01" min="0">
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="autoReconcile" name="auto_reconcile" 
                               {% if settings.auto_reconcile %}checked{% endif %}>
                        <label class="form-check-label" for="autoReconcile">
                            Enable Auto Reconciliation
                        </label>
                        <div class="form-text">Automatically reconcile payments with bank statements</div>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="sendReceipts" name="send_receipts" 
                               {% if settings.send_receipts %}checked{% endif %}>
                        <label class="form-check-label" for="sendReceipts">
                            Send Email Receipts
                        </label>
                        <div class="form-text">Automatically email receipts to customers</div>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="requireSignature" name="require_signature" 
                               {% if settings.require_signature %}checked{% endif %}>
                        <label class="form-check-label" for="requireSignature">
                            Require Customer Signature
                        </label>
                        <div class="form-text">Require signature for payments above a certain amount</div>
                    </div>
                    
                    <div class="mb-3" id="signatureAmountDiv" style="{% if not settings.require_signature %}display: none;{% endif %}">
                        <label for="signatureAmount" class="form-label">Signature Required Above</label>
                        <input type="number" class="form-control" id="signatureAmount" name="signature_amount" 
                               value="{{ settings.signature_amount|default:100 }}" step="0.01" min="0">
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Payment Gateway Settings -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-credit-card me-2"></i>Payment Gateways
                </h5>
            </div>
            <div class="card-body">
                <!-- M-Pesa Settings -->
                <div class="mb-4">
                    <h6 class="fw-bold text-primary mb-3">
                        <i class="fas fa-mobile-alt me-2"></i>M-Pesa Configuration
                    </h6>
                    <form id="mpesaSettingsForm">
                        {% csrf_token %}
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="mpesaEnabled" name="mpesa_enabled" 
                                   {% if mpesa_settings.enabled %}checked{% endif %}>
                            <label class="form-check-label" for="mpesaEnabled">
                                Enable M-Pesa Payments
                            </label>
                        </div>
                        
                        <div id="mpesaConfig" style="{% if not mpesa_settings.enabled %}display: none;{% endif %}">
                            <div class="mb-3">
                                <label for="mpesaShortcode" class="form-label">Business Shortcode</label>
                                <input type="text" class="form-control" id="mpesaShortcode" name="mpesa_shortcode" 
                                       value="{{ mpesa_settings.shortcode }}" placeholder="Enter shortcode">
                            </div>
                            
                            <div class="mb-3">
                                <label for="mpesaPasskey" class="form-label">Passkey</label>
                                <input type="password" class="form-control" id="mpesaPasskey" name="mpesa_passkey" 
                                       value="{{ mpesa_settings.passkey }}" placeholder="Enter passkey">
                            </div>
                            
                            <div class="mb-3">
                                <label for="mpesaEnvironment" class="form-label">Environment</label>
                                <select class="form-select" id="mpesaEnvironment" name="mpesa_environment">
                                    <option value="sandbox" {% if mpesa_settings.environment == 'sandbox' %}selected{% endif %}>Sandbox</option>
                                    <option value="production" {% if mpesa_settings.environment == 'production' %}selected{% endif %}>Production</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="testMpesaConnection()">
                                    <i class="fas fa-plug me-2"></i>Test Connection
                                </button>
                                <span id="mpesaTestResult" class="ms-2"></span>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Card Payment Settings -->
                <div class="mb-4">
                    <h6 class="fw-bold text-success mb-3">
                        <i class="fas fa-credit-card me-2"></i>Card Payment Configuration
                    </h6>
                    <form id="cardSettingsForm">
                        {% csrf_token %}
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="cardEnabled" name="card_enabled" 
                                   {% if card_settings.enabled %}checked{% endif %}>
                            <label class="form-check-label" for="cardEnabled">
                                Enable Card Payments
                            </label>
                        </div>
                        
                        <div id="cardConfig" style="{% if not card_settings.enabled %}display: none;{% endif %}">
                            <div class="mb-3">
                                <label for="cardProvider" class="form-label">Payment Provider</label>
                                <select class="form-select" id="cardProvider" name="card_provider">
                                    <option value="stripe" {% if card_settings.provider == 'stripe' %}selected{% endif %}>Stripe</option>
                                    <option value="paypal" {% if card_settings.provider == 'paypal' %}selected{% endif %}>PayPal</option>
                                    <option value="pesapal" {% if card_settings.provider == 'pesapal' %}selected{% endif %}>PesaPal</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="cardApiKey" class="form-label">API Key</label>
                                <input type="password" class="form-control" id="cardApiKey" name="card_api_key" 
                                       value="{{ card_settings.api_key }}" placeholder="Enter API key">
                            </div>
                            
                            <div class="mb-3">
                                <label for="cardSecretKey" class="form-label">Secret Key</label>
                                <input type="password" class="form-control" id="cardSecretKey" name="card_secret_key" 
                                       value="{{ card_settings.secret_key }}" placeholder="Enter secret key">
                            </div>
                            
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="testCardConnection()">
                                    <i class="fas fa-plug me-2"></i>Test Connection
                                </button>
                                <span id="cardTestResult" class="ms-2"></span>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Bank Transfer Settings -->
                <div class="mb-4">
                    <h6 class="fw-bold text-info mb-3">
                        <i class="fas fa-university me-2"></i>Bank Transfer Configuration
                    </h6>
                    <form id="bankSettingsForm">
                        {% csrf_token %}
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="bankEnabled" name="bank_enabled" 
                                   {% if bank_settings.enabled %}checked{% endif %}>
                            <label class="form-check-label" for="bankEnabled">
                                Enable Bank Transfers
                            </label>
                        </div>
                        
                        <div id="bankConfig" style="{% if not bank_settings.enabled %}display: none;{% endif %}">
                            <div class="mb-3">
                                <label for="bankName" class="form-label">Bank Name</label>
                                <input type="text" class="form-control" id="bankName" name="bank_name" 
                                       value="{{ bank_settings.bank_name }}" placeholder="Enter bank name">
                            </div>
                            
                            <div class="mb-3">
                                <label for="accountNumber" class="form-label">Account Number</label>
                                <input type="text" class="form-control" id="accountNumber" name="account_number" 
                                       value="{{ bank_settings.account_number }}" placeholder="Enter account number">
                            </div>
                            
                            <div class="mb-3">
                                <label for="accountName" class="form-label">Account Name</label>
                                <input type="text" class="form-control" id="accountName" name="account_name" 
                                       value="{{ bank_settings.account_name }}" placeholder="Enter account name">
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Settings -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bell me-2"></i>Notification Settings
                </h5>
            </div>
            <div class="card-body">
                <form id="notificationSettingsForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="fw-bold mb-3">Email Notifications</h6>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="emailPaymentSuccess" name="email_payment_success" 
                                       {% if notification_settings.email_payment_success %}checked{% endif %}>
                                <label class="form-check-label" for="emailPaymentSuccess">
                                    Payment Success
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="emailPaymentFailed" name="email_payment_failed" 
                                       {% if notification_settings.email_payment_failed %}checked{% endif %}>
                                <label class="form-check-label" for="emailPaymentFailed">
                                    Payment Failed
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="emailRefund" name="email_refund" 
                                       {% if notification_settings.email_refund %}checked{% endif %}>
                                <label class="form-check-label" for="emailRefund">
                                    Refund Processed
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="fw-bold mb-3">SMS Notifications</h6>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="smsPaymentSuccess" name="sms_payment_success" 
                                       {% if notification_settings.sms_payment_success %}checked{% endif %}>
                                <label class="form-check-label" for="smsPaymentSuccess">
                                    Payment Success
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="smsPaymentReminder" name="sms_payment_reminder" 
                                       {% if notification_settings.sms_payment_reminder %}checked{% endif %}>
                                <label class="form-check-label" for="smsPaymentReminder">
                                    Payment Reminders
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="smsReceipt" name="sms_receipt" 
                                       {% if notification_settings.sms_receipt %}checked{% endif %}>
                                <label class="form-check-label" for="smsReceipt">
                                    SMS Receipts
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.form-check-label {
    font-weight: 500;
}

.test-result-success {
    color: #198754;
}

.test-result-error {
    color: #dc3545;
}

.gateway-config {
    border-left: 3px solid #dee2e6;
    padding-left: 1rem;
    margin-left: 0.5rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Toggle gateway configuration sections
document.getElementById('mpesaEnabled').addEventListener('change', function() {
    const config = document.getElementById('mpesaConfig');
    config.style.display = this.checked ? 'block' : 'none';
});

document.getElementById('cardEnabled').addEventListener('change', function() {
    const config = document.getElementById('cardConfig');
    config.style.display = this.checked ? 'block' : 'none';
});

document.getElementById('bankEnabled').addEventListener('change', function() {
    const config = document.getElementById('bankConfig');
    config.style.display = this.checked ? 'block' : 'none';
});

document.getElementById('requireSignature').addEventListener('change', function() {
    const div = document.getElementById('signatureAmountDiv');
    div.style.display = this.checked ? 'block' : 'none';
});

// Test gateway connections
function testMpesaConnection() {
    const button = event.target;
    const result = document.getElementById('mpesaTestResult');
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
    result.innerHTML = '';
    
    const formData = new FormData(document.getElementById('mpesaSettingsForm'));
    
    fetch(`/business/{{ request.tenant.slug }}/payments/settings/test-mpesa/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            result.innerHTML = '<span class="badge bg-success">Connected</span>';
        } else {
            result.innerHTML = '<span class="badge bg-danger">Failed</span>';
        }
    })
    .catch(error => {
        result.innerHTML = '<span class="badge bg-danger">Error</span>';
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-plug me-2"></i>Test Connection';
    });
}

function testCardConnection() {
    const button = event.target;
    const result = document.getElementById('cardTestResult');
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
    result.innerHTML = '';
    
    const formData = new FormData(document.getElementById('cardSettingsForm'));
    
    fetch(`/business/{{ request.tenant.slug }}/payments/settings/test-card/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            result.innerHTML = '<span class="badge bg-success">Connected</span>';
        } else {
            result.innerHTML = '<span class="badge bg-danger">Failed</span>';
        }
    })
    .catch(error => {
        result.innerHTML = '<span class="badge bg-danger">Error</span>';
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-plug me-2"></i>Test Connection';
    });
}

// Save all settings
function saveAllSettings() {
    const forms = [
        'generalSettingsForm',
        'mpesaSettingsForm', 
        'cardSettingsForm',
        'bankSettingsForm',
        'notificationSettingsForm'
    ];
    
    const allFormData = new FormData();
    
    forms.forEach(formId => {
        const form = document.getElementById(formId);
        const formData = new FormData(form);
        for (let [key, value] of formData.entries()) {
            allFormData.append(key, value);
        }
    });
    
    // Add CSRF token
    allFormData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`/business/{{ request.tenant.slug }}/payments/settings/save/`, {
        method: 'POST',
        body: allFormData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>Settings saved successfully!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container-fluid').insertBefore(alert, document.querySelector('.row'));
            
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                alert.remove();
            }, 3000);
        } else {
            alert('Error saving settings: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving settings');
    });
}

// Auto-save on change (optional)
document.querySelectorAll('input, select').forEach(element => {
    element.addEventListener('change', function() {
        // You can implement auto-save here if desired
        // saveAllSettings();
    });
});
</script>
{% endblock %}
