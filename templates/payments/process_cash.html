<!-- templates/payments/process_cash.html -->
{% extends 'base/base.html' %}
{% load static %}

{% block title %}Cash Payment - {{ payment.payment_id }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
.cash-header {
    background: linear-gradient(135deg, #ecfdf5, #d1fae5);
    border: 1px solid #10b981;
    border-radius: 0.75rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.cash-form {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    padding: 1.5rem;
}

.payment-summary {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f1f5f9;
}

.summary-row:last-child {
    border-bottom: none;
    font-weight: 600;
    font-size: 1.125rem;
    color: #059669;
}

.currency-section {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1.25rem;
    margin: 1.5rem 0;
}

.currency-group {
    margin-bottom: 1.5rem;
}

.currency-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
}

.currency-item:last-child {
    margin-bottom: 0;
}

.currency-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 500;
}

.currency-icon {
    width: 2rem;
    height: 2rem;
    background: #f3f4f6;
    border-radius: 0.375rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    color: #6b7280;
}

.currency-input {
    width: 4rem;
    text-align: center;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    padding: 0.5rem;
}

.currency-value {
    font-weight: 600;
    color: #059669;
    min-width: 5rem;
    text-align: right;
}

.change-calculator {
    background: #fef3c7;
    border: 1px solid #fcd34d;
    border-radius: 0.5rem;
    padding: 1rem;
    margin: 1rem 0;
}

.amount-input {
    font-size: 1.25rem;
    font-weight: 600;
    text-align: center;
    border: 2px solid #d1d5db;
    border-radius: 0.5rem;
    padding: 0.75rem;
}

.amount-input:focus {
    border-color: #10b981;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.change-display {
    font-size: 1.5rem;
    font-weight: 700;
    color: #059669;
    text-align: center;
    padding: 1rem;
    background: white;
    border-radius: 0.5rem;
    margin-top: 1rem;
}

.quick-amount-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.quick-amount-btn {
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    background: white;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
    font-size: 0.875rem;
    font-weight: 500;
}

.quick-amount-btn:hover {
    background: #f3f4f6;
    border-color: #9ca3af;
}

.quick-amount-btn.selected {
    background: #10b981;
    color: white;
    border-color: #10b981;
}

.total-breakdown {
    background: #ecfdf5;
    border: 1px solid #a7f3d0;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-top: 1rem;
}

.breakdown-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.breakdown-row:last-child {
    margin-bottom: 0;
    padding-top: 0.5rem;
    border-top: 1px solid #a7f3d0;
    font-weight: 600;
}

@media (max-width: 768px) {
    .currency-item {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
        gap: 0.5rem;
    }
    
    .currency-value {
        text-align: center;
    }
    
    .quick-amount-buttons {
        grid-template-columns: repeat(3, 1fr);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="cash-header">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <h1 class="h3 mb-2">
                <i class="fas fa-money-bills text-success me-2"></i>
                Cash Payment
            </h1>
            <p class="text-muted mb-0">
                Payment ID: {{ payment.payment_id }} â€¢ Amount: KES {{ payment.amount|floatformat:2 }}
                {% if payment.customer %}
                â€¢ Customer: {{ payment.customer.display_name }}
                {% endif %}
            </p>
        </div>
        
        <div class="d-flex gap-2">
            <a href="/business/{{ request.tenant.slug }}/payments/{{ payment.payment_id }}/" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to Payment
            </a>
        </div>
    </div>
</div>

<form method="post" id="cashPaymentForm">
    {% csrf_token %}
    
    <div class="row">
        <div class="col-lg-8">
            <div class="cash-form">
                <!-- Payment Summary -->
                <div class="payment-summary">
                    <h5 class="mb-3">
                        <i class="fas fa-receipt text-primary me-2"></i>
                        Payment Summary
                    </h5>
                    
                    <div class="summary-row">
                        <span>Payment Amount:</span>
                        <strong>KES {{ payment.amount|floatformat:2 }}</strong>
                    </div>
                    
                    {% if payment.processing_fee > 0 %}
                    <div class="summary-row">
                        <span>Processing Fee:</span>
                        <span>KES {{ payment.processing_fee|floatformat:2 }}</span>
                    </div>
                    
                    <div class="summary-row">
                        <span>Net Amount:</span>
                        <strong>KES {{ payment.net_amount|floatformat:2 }}</strong>
                    </div>
                    {% endif %}
                    
                    <div class="summary-row">
                        <span>Total to Collect:</span>
                        <strong>KES {{ payment.amount|floatformat:2 }}</strong>
                    </div>
                </div>
                
                <!-- Amount Tendered -->
                <div class="change-calculator">
                    <h6 class="mb-3">
                        <i class="fas fa-calculator text-warning me-2"></i>
                        Cash Collection
                    </h6>
                    
                    <!-- Quick Amount Buttons -->
                    <div class="quick-amount-buttons">
                        <button type="button" class="quick-amount-btn" onclick="setQuickAmount({{ payment.amount }})">
                            Exact
                        </button>
                        <button type="button" class="quick-amount-btn" onclick="setQuickAmount({{ payment.amount|add:50 }})">
                            +50
                        </button>
                        <button type="button" class="quick-amount-btn" onclick="setQuickAmount({{ payment.amount|add:100 }})">
                            +100
                        </button>
                        <button type="button" class="quick-amount-btn" onclick="setQuickAmount({{ payment.amount|add:200 }})">
                            +200
                        </button>
                        <button type="button" class="quick-amount-btn" onclick="setQuickAmount({{ payment.amount|add:500 }})">
                            +500
                        </button>
                        <button type="button" class="quick-amount-btn" onclick="setQuickAmount({{ payment.amount|add:1000 }})">
                            +1000
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="amount_tendered" class="form-label">Amount Tendered</label>
                        <input type="number" 
                               class="form-control amount-input" 
                               id="amount_tendered" 
                               name="amount_tendered" 
                               step="0.01" 
                               min="{{ payment.amount }}" 
                               value="{{ payment.amount }}"
                               oninput="calculateChange()"
                               required>
                    </div>
                    
                    <div class="change-display" id="changeDisplay">
                        Change: KES 0.00
                    </div>
                    
                    <input type="hidden" id="change_given" name="change_given" value="0">
                </div>
                
                <!-- Currency Breakdown -->
                <div class="currency-section">
                    <h6 class="mb-3">
                        <i class="fas fa-coins text-secondary me-2"></i>
                        Currency Breakdown <small class="text-muted">(Optional)</small>
                    </h6>
                    
                    <div class="currency-group">
                        <h6 class="text-muted mb-3">Notes</h6>
                        
                        <div class="currency-item">
                            <div class="currency-label">
                                <div class="currency-icon">ðŸ’µ</div>
                                <span>KES 1,000</span>
                            </div>
                            <input type="number" 
                                   class="currency-input" 
                                   id="notes_1000" 
                                   name="notes_1000" 
                                   min="0" 
                                   value="0"
                                   onchange="updateCurrencyTotal()">
                            <div class="currency-value" id="notes_1000_value">KES 0</div>
                        </div>
                        
                        <div class="currency-item">
                            <div class="currency-label">
                                <div class="currency-icon">ðŸ’µ</div>
                                <span>KES 500</span>
                            </div>
                            <input type="number" 
                                   class="currency-input" 
                                   id="notes_500" 
                                   name="notes_500" 
                                   min="0" 
                                   value="0"
                                   onchange="updateCurrencyTotal()">
                            <div class="currency-value" id="notes_500_value">KES 0</div>
                        </div>
                        
                        <div class="currency-item">
                            <div class="currency-label">
                                <div class="currency-icon">ðŸ’µ</div>
                                <span>KES 200</span>
                            </div>
                            <input type="number" 
                                   class="currency-input" 
                                   id="notes_200" 
                                   name="notes_200" 
                                   min="0" 
                                   value="0"
                                   onchange="updateCurrencyTotal()">
                            <div class="currency-value" id="notes_200_value">KES 0</div>
                        </div>
                        
                        <div class="currency-item">
                            <div class="currency-label">
                                <div class="currency-icon">ðŸ’µ</div>
                                <span>KES 100</span>
                            </div>
                            <input type="number" 
                                   class="currency-input" 
                                   id="notes_100" 
                                   name="notes_100" 
                                   min="0" 
                                   value="0"
                                   onchange="updateCurrencyTotal()">
                            <div class="currency-value" id="notes_100_value">KES 0</div>
                        </div>
                        
                        <div class="currency-item">
                            <div class="currency-label">
                                <div class="currency-icon">ðŸ’µ</div>
                                <span>KES 50</span>
                            </div>
                            <input type="number" 
                                   class="currency-input" 
                                   id="notes_50" 
                                   name="notes_50" 
                                   min="0" 
                                   value="0"
                                   onchange="updateCurrencyTotal()">
                            <div class="currency-value" id="notes_50_value">KES 0</div>
                        </div>
                    </div>
                    
                    <div class="currency-group">
                        <h6 class="text-muted mb-3">Coins</h6>
                        
                        <div class="currency-item">
                            <div class="currency-label">
                                <div class="currency-icon">ðŸª™</div>
                                <span>KES 40</span>
                            </div>
                            <input type="number" 
                                   class="currency-input" 
                                   id="coins_40" 
                                   name="coins_40" 
                                   min="0" 
                                   value="0"
                                   onchange="updateCurrencyTotal()">
                            <div class="currency-value" id="coins_40_value">KES 0</div>
                        </div>
                        
                        <div class="currency-item">
                            <div class="currency-label">
                                <div class="currency-icon">ðŸª™</div>
                                <span>KES 20</span>
                            </div>
                            <input type="number" 
                                   class="currency-input" 
                                   id="coins_20" 
                                   name="coins_20" 
                                   min="0" 
                                   value="0"
                                   onchange="updateCurrencyTotal()">
                            <div class="currency-value" id="coins_20_value">KES 0</div>
                        </div>
                        
                        <div class="currency-item">
                            <div class="currency-label">
                                <div class="currency-icon">ðŸª™</div>
                                <span>KES 10</span>
                            </div>
                            <input type="number" 
                                   class="currency-input" 
                                   id="coins_10" 
                                   name="coins_10" 
                                   min="0" 
                                   value="0"
                                   onchange="updateCurrencyTotal()">
                            <div class="currency-value" id="coins_10_value">KES 0</div>
                        </div>
                        
                        <div class="currency-item">
                            <div class="currency-label">
                                <div class="currency-icon">ðŸª™</div>
                                <span>KES 5</span>
                            </div>
                            <input type="number" 
                                   class="currency-input" 
                                   id="coins_5" 
                                   name="coins_5" 
                                   min="0" 
                                   value="0"
                                   onchange="updateCurrencyTotal()">
                            <div class="currency-value" id="coins_5_value">KES 0</div>
                        </div>
                        
                        <div class="currency-item">
                            <div class="currency-label">
                                <div class="currency-icon">ðŸª™</div>
                                <span>KES 1</span>
                            </div>
                            <input type="number" 
                                   class="currency-input" 
                                   id="coins_1" 
                                   name="coins_1" 
                                   min="0" 
                                   value="0"
                                   onchange="updateCurrencyTotal()">
                            <div class="currency-value" id="coins_1_value">KES 0</div>
                        </div>
                    </div>
                    
                    <!-- Currency Total -->
                    <div class="total-breakdown">
                        <div class="breakdown-row">
                            <span>Notes Total:</span>
                            <strong id="notesTotal">KES 0</strong>
                        </div>
                        <div class="breakdown-row">
                            <span>Coins Total:</span>
                            <strong id="coinsTotal">KES 0</strong>
                        </div>
                        <div class="breakdown-row">
                            <span>Currency Total:</span>
                            <strong id="currencyTotal">KES 0</strong>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Information -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="till_number" class="form-label">Till Number</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="till_number" 
                                   name="till_number" 
                                   placeholder="Till 01">
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="cashier" class="form-label">Cashier</label>
                            <input type="text" 
                                   class="form-control" 
                                   value="{{ request.user.get_full_name|default:request.user.username }}" 
                                   readonly>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="notes" class="form-label">Notes</label>
                    <textarea class="form-control" 
                              id="notes" 
                              name="notes" 
                              rows="3" 
                              placeholder="Any additional notes about this cash transaction..."></textarea>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Transaction Summary -->
            <div class="cash-form">
                <h5 class="mb-3">
                    <i class="fas fa-clipboard-check text-success me-2"></i>
                    Transaction Summary
                </h5>
                
                <div class="payment-summary">
                    <div class="summary-row">
                        <span>Payment ID:</span>
                        <strong>{{ payment.payment_id }}</strong>
                    </div>
                    
                    <div class="summary-row">
                        <span>Amount Due:</span>
                        <strong>KES {{ payment.amount|floatformat:2 }}</strong>
                    </div>
                    
                    <div class="summary-row">
                        <span>Amount Tendered:</span>
                        <strong id="summaryTendered">KES {{ payment.amount|floatformat:2 }}</strong>
                    </div>
                    
                    <div class="summary-row">
                        <span>Change Due:</span>
                        <strong id="summaryChange" class="text-warning">KES 0.00</strong>
                    </div>
                    
                    {% if payment.customer %}
                    <div class="summary-row">
                        <span>Customer:</span>
                        <strong>{{ payment.customer.display_name }}</strong>
                    </div>
                    {% endif %}
                    
                    {% if payment.service_order %}
                    <div class="summary-row">
                        <span>Service Order:</span>
                        <strong>{{ payment.service_order.order_number }}</strong>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Action Buttons -->
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-success btn-lg" id="completeCashBtn">
                        <i class="fas fa-check me-2"></i>
                        Complete Cash Payment
                    </button>
                    
                    <button type="button" class="btn btn-outline-secondary" onclick="resetCalculator()">
                        <i class="fas fa-undo me-2"></i>
                        Reset Calculator
                    </button>
                    
                    <a href="/business/{{ request.tenant.slug }}/payments/{{ payment.payment_id }}/" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>
                        Cancel
                    </a>
                </div>
                
                <!-- Payment Instructions -->
                <div class="mt-3 p-3 bg-light rounded">
                    <h6 class="text-muted mb-2">
                        <i class="fas fa-info-circle me-2"></i>
                        Instructions
                    </h6>
                    <ul class="list-unstyled text-muted mb-0 small">
                        <li>â€¢ Count cash carefully before processing</li>
                        <li>â€¢ Verify change amount before giving to customer</li>
                        <li>â€¢ Currency breakdown is optional but recommended</li>
                        <li>â€¢ Keep receipt for cash reconciliation</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
const paymentAmount = {{ payment.amount }};
const denominations = {
    notes_1000: 1000,
    notes_500: 500,
    notes_200: 200,
    notes_100: 100,
    notes_50: 50,
    coins_40: 40,
    coins_20: 20,
    coins_10: 10,
    coins_5: 5,
    coins_1: 1
};

function calculateChange() {
    const tendered = parseFloat(document.getElementById('amount_tendered').value) || 0;
    const change = Math.max(0, tendered - paymentAmount);
    
    // Update change display
    document.getElementById('changeDisplay').innerHTML = `Change: KES ${change.toFixed(2)}`;
    document.getElementById('change_given').value = change.toFixed(2);
    
    // Update summary
    document.getElementById('summaryTendered').textContent = `KES ${tendered.toFixed(2)}`;
    document.getElementById('summaryChange').textContent = `KES ${change.toFixed(2)}`;
    
    // Update change color
    const changeEl = document.getElementById('summaryChange');
    if (change > 0) {
        changeEl.className = 'text-warning';
    } else {
        changeEl.className = 'text-success';
    }
    
    // Validate minimum amount
    const submitBtn = document.getElementById('completeCashBtn');
    if (tendered < paymentAmount) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Insufficient Amount';
        submitBtn.className = 'btn btn-danger btn-lg';
    } else {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Complete Cash Payment';
        submitBtn.className = 'btn btn-success btn-lg';
    }
}

function setQuickAmount(amount) {
    // Remove previous selection
    document.querySelectorAll('.quick-amount-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    // Set amount and update
    document.getElementById('amount_tendered').value = amount.toFixed(2);
    
    // Mark button as selected
    event.target.classList.add('selected');
    
    // Calculate change
    calculateChange();
}

function updateCurrencyTotal() {
    let notesTotal = 0;
    let coinsTotal = 0;
    
    // Calculate notes
    ['notes_1000', 'notes_500', 'notes_200', 'notes_100', 'notes_50'].forEach(id => {
        const count = parseInt(document.getElementById(id).value) || 0;
        const value = count * denominations[id];
        notesTotal += value;
        document.getElementById(id + '_value').textContent = `KES ${value.toLocaleString()}`;
    });
    
    // Calculate coins
    ['coins_40', 'coins_20', 'coins_10', 'coins_5', 'coins_1'].forEach(id => {
        const count = parseInt(document.getElementById(id).value) || 0;
        const value = count * denominations[id];
        coinsTotal += value;
        document.getElementById(id + '_value').textContent = `KES ${value.toLocaleString()}`;
    });
    
    const currencyTotal = notesTotal + coinsTotal;
    
    // Update totals
    document.getElementById('notesTotal').textContent = `KES ${notesTotal.toLocaleString()}`;
    document.getElementById('coinsTotal').textContent = `KES ${coinsTotal.toLocaleString()}`;
    document.getElementById('currencyTotal').textContent = `KES ${currencyTotal.toLocaleString()}`;
    
    // Auto-update tendered amount if currency breakdown matches
    if (currencyTotal > 0) {
        document.getElementById('amount_tendered').value = currencyTotal.toFixed(2);
        calculateChange();
    }
}

function resetCalculator() {
    // Reset amount tendered
    document.getElementById('amount_tendered').value = paymentAmount.toFixed(2);
    
    // Reset all currency inputs
    Object.keys(denominations).forEach(id => {
        document.getElementById(id).value = 0;
    });
    
    // Clear quick amount selection
    document.querySelectorAll('.quick-amount-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    // Update totals and change
    updateCurrencyTotal();
    calculateChange();
    
    // Clear notes
    document.getElementById('notes').value = '';
    document.getElementById('till_number').value = '';
}

function suggestChange(changeAmount) {
    if (changeAmount <= 0) return;
    
    let remaining = changeAmount;
    const suggestions = {};
    
    // Suggest optimal change breakdown
    const changeOrder = ['notes_1000', 'notes_500', 'notes_200', 'notes_100', 'notes_50', 
                        'coins_40', 'coins_20', 'coins_10', 'coins_5', 'coins_1'];
    
    changeOrder.forEach(denom => {
        const value = denominations[denom];
        if (remaining >= value) {
            const count = Math.floor(remaining / value);
            suggestions[denom] = count;
            remaining -= count * value;
        }
    });
    
    // Display suggestion
    let suggestionText = 'Change suggestion: ';
    Object.keys(suggestions).forEach(denom => {
        if (suggestions[denom] > 0) {
            const value = denominations[denom];
            suggestionText += `${suggestions[denom]}Ã—KES${value} `;
        }
    });
    
    if (Object.keys(suggestions).length > 0) {
        showToast(suggestionText, 'info');
    }
}

// Form submission
document.getElementById('cashPaymentForm').addEventListener('submit', function(e) {
    const tendered = parseFloat(document.getElementById('amount_tendered').value);
    
    if (tendered < paymentAmount) {
        e.preventDefault();
        showToast('Amount tendered is less than payment amount', 'error');
        return;
    }
    
    const change = tendered - paymentAmount;
    if (change > 0) {
        suggestChange(change);
    }
    
    // Show loading state
    const btn = document.getElementById('completeCashBtn');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
    btn.disabled = true;
});

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    calculateChange();
    updateCurrencyTotal();
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.altKey) {
        switch(e.key) {
            case '1':
                e.preventDefault();
                setQuickAmount(paymentAmount);
                break;
            case '2':
                e.preventDefault();
                setQuickAmount(paymentAmount + 50);
                break;
            case '3':
                e.preventDefault();
                setQuickAmount(paymentAmount + 100);
                break;
            case 'r':
                e.preventDefault();
                resetCalculator();
                break;
        }
    }
});
</script>
{% endblock %}