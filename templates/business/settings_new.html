{% extends 'base/base.html' %}
{% load static %}

{% block title %}Business Settings - {{ business.name }}{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="/{{ business.subdomain }}/dashboard/">Dashboard</a></li>
<li class="breadcrumb-item active">Settings</li>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Settings Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="fw-bold mb-1">Business Settings</h4>
                            <p class="text-muted mb-0">Manage your business configuration and preferences</p>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="/{{ business.subdomain }}/businesses/settings/backup/" class="btn btn-outline-primary">
                                <i class="fas fa-download me-2"></i>Backup Data
                            </a>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#settingsWizardModal">
                                <i class="fas fa-magic me-2"></i>Quick Setup
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Cards Grid -->
    <div class="row g-4">
        <!-- Business Information -->
        <div class="col-lg-4 col-md-6">
            <div class="card border-0 shadow-sm h-100 settings-card" data-aos="fade-up">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="settings-icon bg-primary">
                            <i class="fas fa-building text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="fw-bold mb-0">Business Profile</h6>
                            <small class="text-muted">Basic information & details</small>
                        </div>
                    </div>
                    <p class="text-muted small mb-3">Manage your business name, description, contact information, and operating hours.</p>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="small text-muted">Completion</span>
                            <span class="badge bg-success">85%</span>
                        </div>
                        <div class="progress mt-1" style="height: 4px;">
                            <div class="progress-bar bg-success" style="width: 85%"></div>
                        </div>
                    </div>
                    
                    <a href="/{{ business.subdomain }}/businesses/settings/business/" class="btn btn-outline-primary w-100">
                        <i class="fas fa-edit me-2"></i>Configure
                    </a>
                </div>
            </div>
        </div>

        <!-- Notifications -->
        <div class="col-lg-4 col-md-6">
            <div class="card border-0 shadow-sm h-100 settings-card" data-aos="fade-up" data-aos-delay="100">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="settings-icon bg-success">
                            <i class="fas fa-bell text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="fw-bold mb-0">Notifications</h6>
                            <small class="text-muted">Alerts & communication</small>
                        </div>
                    </div>
                    <p class="text-muted small mb-3">Configure SMS, email notifications, and customer communication preferences.</p>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="small text-muted">Status</span>
                            <span class="badge bg-warning">Partial</span>
                        </div>
                        <div class="progress mt-1" style="height: 4px;">
                            <div class="progress-bar bg-warning" style="width: 60%"></div>
                        </div>
                    </div>
                    
                    <a href="/{{ business.subdomain }}/businesses/settings/notifications/" class="btn btn-outline-success w-100">
                        <i class="fas fa-cogs me-2"></i>Configure
                    </a>
                </div>
            </div>
        </div>

        <!-- Service Settings -->
        <div class="col-lg-4 col-md-6">
            <div class="card border-0 shadow-sm h-100 settings-card" data-aos="fade-up" data-aos-delay="200">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="settings-icon bg-info">
                            <i class="fas fa-cog text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="fw-bold mb-0">Service Settings</h6>
                            <small class="text-muted">Operations & workflow</small>
                        </div>
                    </div>
                    <p class="text-muted small mb-3">Configure service assignments, customer approval requirements, and reminders.</p>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="small text-muted">Completion</span>
                            <span class="badge bg-primary">70%</span>
                        </div>
                        <div class="progress mt-1" style="height: 4px;">
                            <div class="progress-bar bg-info" style="width: 70%"></div>
                        </div>
                    </div>
                    
                    <a href="/{{ business.subdomain }}/businesses/settings/services/" class="btn btn-outline-info w-100">
                        <i class="fas fa-settings me-2"></i>Configure
                    </a>
                </div>
            </div>
        </div>

        <!-- Payment Settings -->
        <div class="col-lg-4 col-md-6">
            <div class="card border-0 shadow-sm h-100 settings-card" data-aos="fade-up" data-aos-delay="300">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="settings-icon bg-warning">
                            <i class="fas fa-credit-card text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="fw-bold mb-0">Payment Settings</h6>
                            <small class="text-muted">Methods & processing</small>
                        </div>
                    </div>
                    <p class="text-muted small mb-3">Set up payment methods, tax rates, and payment confirmation requirements.</p>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="small text-muted">Methods Active</span>
                            <span class="badge bg-success">3/4</span>
                        </div>
                        <div class="progress mt-1" style="height: 4px;">
                            <div class="progress-bar bg-warning" style="width: 75%"></div>
                        </div>
                    </div>
                    
                    <a href="/{{ business.subdomain }}/businesses/settings/payment/" class="btn btn-outline-warning w-100">
                        <i class="fas fa-money-bill me-2"></i>Configure
                    </a>
                </div>
            </div>
        </div>

        <!-- Security Settings -->
        <div class="col-lg-4 col-md-6">
            <div class="card border-0 shadow-sm h-100 settings-card" data-aos="fade-up" data-aos-delay="400">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="settings-icon bg-danger">
                            <i class="fas fa-shield-alt text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="fw-bold mb-0">Security</h6>
                            <small class="text-muted">Access & protection</small>
                        </div>
                    </div>
                    <p class="text-muted small mb-3">Manage user access, security policies, and data protection settings.</p>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="small text-muted">Security Score</span>
                            <span class="badge bg-success">Good</span>
                        </div>
                        <div class="progress mt-1" style="height: 4px;">
                            <div class="progress-bar bg-success" style="width: 80%"></div>
                        </div>
                    </div>
                    
                    <a href="/{{ business.subdomain }}/businesses/settings/security/" class="btn btn-outline-danger w-100">
                        <i class="fas fa-lock me-2"></i>Configure
                    </a>
                </div>
            </div>
        </div>

        <!-- Data & Backup -->
        <div class="col-lg-4 col-md-6">
            <div class="card border-0 shadow-sm h-100 settings-card" data-aos="fade-up" data-aos-delay="500">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="settings-icon bg-secondary">
                            <i class="fas fa-database text-white"></i>
                        </div>
                        <div class="ms-3">
                            <h6 class="fw-bold mb-0">Data & Backup</h6>
                            <small class="text-muted">Backup & recovery</small>
                        </div>
                    </div>
                    <p class="text-muted small mb-3">Create backups, manage data exports, and configure automatic backup schedules.</p>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="small text-muted">Last Backup</span>
                            <span class="badge bg-info">2 days ago</span>
                        </div>
                        <div class="progress mt-1" style="height: 4px;">
                            <div class="progress-bar bg-secondary" style="width: 90%"></div>
                        </div>
                    </div>
                    
                    <a href="/{{ business.subdomain }}/businesses/settings/backup/" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-download me-2"></i>Manage
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h6 class="fw-bold mb-0">Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <button class="btn btn-light w-100 text-start" onclick="exportSettings()">
                                <i class="fas fa-file-export text-primary me-2"></i>
                                <div>
                                    <div class="fw-semibold">Export Settings</div>
                                    <small class="text-muted">Download configuration backup</small>
                                </div>
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-light w-100 text-start" onclick="importSettings()">
                                <i class="fas fa-file-import text-success me-2"></i>
                                <div>
                                    <div class="fw-semibold">Import Settings</div>
                                    <small class="text-muted">Restore from backup</small>
                                </div>
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-light w-100 text-start" onclick="resetSettings()">
                                <i class="fas fa-undo text-warning me-2"></i>
                                <div>
                                    <div class="fw-semibold">Reset to Defaults</div>
                                    <small class="text-muted">Restore factory settings</small>
                                </div>
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-light w-100 text-start" onclick="validateSettings()">
                                <i class="fas fa-check-circle text-info me-2"></i>
                                <div>
                                    <div class="fw-semibold">Validate Setup</div>
                                    <small class="text-muted">Check configuration</small>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Setup Wizard Modal -->
<div class="modal fade" id="settingsWizardModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Setup Wizard</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="wizard-steps">
                    <div class="step active" data-step="1">
                        <h6>Step 1: Business Information</h6>
                        <p class="text-muted">Ensure your business profile is complete.</p>
                        <div class="progress mb-3">
                            <div class="progress-bar" style="width: 25%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">Start Wizard</button>
            </div>
        </div>
    </div>
</div>

<style>
.settings-card {
    transition: all 0.3s ease;
    border: 1px solid #e5e7eb !important;
}

.settings-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15) !important;
}

.settings-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}

.progress {
    border-radius: 10px;
    background-color: #f1f3f4;
}

.progress-bar {
    border-radius: 10px;
}

.btn-outline-primary:hover, .btn-outline-success:hover, 
.btn-outline-info:hover, .btn-outline-warning:hover,
.btn-outline-danger:hover, .btn-outline-secondary:hover {
    transform: none;
}

.card-header {
    border-bottom: 1px solid #e5e7eb;
}

.wizard-steps .step {
    padding: 1rem;
    border-radius: 8px;
    background: #f8f9fa;
    margin-bottom: 1rem;
}

.wizard-steps .step.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

@media (max-width: 768px) {
    .settings-card {
        margin-bottom: 1rem;
    }
    
    .d-flex.gap-2 {
        flex-direction: column;
        gap: 0.5rem !important;
    }
}

/* Animation */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.settings-card {
    animation: fadeInUp 0.6s ease forwards;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add loading states to buttons
    const configButtons = document.querySelectorAll('a[href*="settings/"]');
    configButtons.forEach(button => {
        button.addEventListener('click', function() {
            const spinner = '<span class="spinner-border spinner-border-sm me-2"></span>';
            const icon = this.querySelector('i');
            if (icon) {
                icon.outerHTML = spinner;
            }
        });
    });
    
    // Quick action handlers
    window.exportSettings = function() {
        showLoading('Exporting settings...');
        fetch(`/{{ business.subdomain }}/businesses/settings/api/export/`)
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `{{ business.name }}_settings_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                hideLoading();
                showSuccess('Settings exported successfully!');
            })
            .catch(error => {
                hideLoading();
                showError('Failed to export settings.');
            });
    };
    
    window.importSettings = function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('settings_file', file);
                
                showLoading('Importing settings...');
                fetch(`/{{ business.subdomain }}/businesses/settings/api/import/`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    }
                })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showSuccess('Settings imported successfully!');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showError(data.message || 'Failed to import settings.');
                    }
                })
                .catch(error => {
                    hideLoading();
                    showError('Failed to import settings.');
                });
            }
        };
        input.click();
    };
    
    window.resetSettings = function() {
        if (confirm('Are you sure you want to reset all settings to defaults? This action cannot be undone.')) {
            showLoading('Resetting settings...');
            fetch(`/{{ business.subdomain }}/businesses/settings/api/reset/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    showSuccess('Settings reset successfully!');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showError(data.message || 'Failed to reset settings.');
                }
            })
            .catch(error => {
                hideLoading();
                showError('Failed to reset settings.');
            });
        }
    };
    
    window.validateSettings = function() {
        showLoading('Validating settings...');
        fetch(`/{{ business.subdomain }}/businesses/settings/api/validate/`)
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.valid) {
                    showSuccess(`Settings validation passed! Score: ${data.score}%`);
                } else {
                    showWarning(`Settings validation found ${data.issues.length} issues. Check individual sections.`);
                }
            })
            .catch(error => {
                hideLoading();
                showError('Failed to validate settings.');
            });
    };
});

// Utility functions
function showLoading(message) {
    // Create or update loading toast
    const toast = document.getElementById('loading-toast') || createToast('loading-toast', 'info');
    toast.querySelector('.toast-body').textContent = message;
    new bootstrap.Toast(toast).show();
}

function hideLoading() {
    const toast = document.getElementById('loading-toast');
    if (toast) {
        bootstrap.Toast.getInstance(toast)?.hide();
    }
}

function showSuccess(message) {
    const toast = createToast('success-toast', 'success');
    toast.querySelector('.toast-body').textContent = message;
    new bootstrap.Toast(toast).show();
}

function showError(message) {
    const toast = createToast('error-toast', 'danger');
    toast.querySelector('.toast-body').textContent = message;
    new bootstrap.Toast(toast).show();
}

function showWarning(message) {
    const toast = createToast('warning-toast', 'warning');
    toast.querySelector('.toast-body').textContent = message;
    new bootstrap.Toast(toast).show();
}

function createToast(id, type) {
    const existingToast = document.getElementById(id);
    if (existingToast) {
        existingToast.remove();
    }
    
    const toast = document.createElement('div');
    toast.id = id;
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(container);
    }
    container.appendChild(toast);
    
    return toast;
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}
</script>
{% endblock %}
